datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// =================================================================
// 1. CONFIGURATION & IDENTITY
// =================================================================

model ProviderConfig {
  // We keep 'id' as the provider name (e.g. "openai", "google")
  id          String   @id 
  label       String
  type        String   // "chat", "embedding"
  
  // apiKey removed
  
  baseURL     String?
  isEnabled   Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  models      Model[]
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  rootPath  String   
  
  // The "Constitution"
  systemPrompt String? @db.Text
  codeRules    String? @db.Text 
  glossary     Json?   @default("{}")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  cards     WorkOrderCard[]
}

// =================================================================
// 2. THE MODEL REGISTRY (PRESERVED - NO CHANGES)
// =================================================================

model Model {
  // Keeping CUIDs to prevent data loss since you like how this works
  id           String   @id @default(cuid())
  
  providerId   String 
  provider     ProviderConfig @relation(fields: [providerId], references: [id], onDelete: Cascade)

  name         String // Display name
  
  // The "Triple Layer" Data Strategy
  providerData Json   @default("{}") 
  aiData       Json   @default("{}") 

  capabilities ModelCapabilities?

  isActive     Boolean @default(true)
  costPer1k    Float?
  
  firstSeenAt  DateTime @default(now())
  lastSeenAt   DateTime @default(now())
  updatedAt    DateTime @updatedAt

  modelUsage       ModelUsage[]
  knowledgeVectors KnowledgeVector[]
  
  @@unique([providerId, name]) // This prevents duplicate models
}

model ModelCapabilities {
  id          String   @id @default(cuid())
  modelId     String   @unique
  model       Model    @relation(fields: [modelId], references: [id], onDelete: Cascade)

  // Hard Specs
  contextWindow Int?   @default(4096)
  maxOutput     Int?   @default(4096)
  
  // Capabilities
  hasVision         Boolean @default(false)
  supportsFunctionCalling Boolean @default(false)
  supportsJsonMode  Boolean @default(false)
  
  specs             Json?   @default("{}")

  updatedAt   DateTime @updatedAt
}

model ModelUsage {
  id             String    @id @default(cuid())
  createdAt      DateTime  @default(now())
  modelId        String
  roleId         String
  
  promptTokens     Int?
  completionTokens Int?
  cost             Float     @default(0)
  
  usageMetrics     Json?     @default("{}") 
  responseHeaders  Json?     
  metadata         Json?

  model          Model       @relation(fields: [modelId], references: [id])
  role           Role        @relation(fields: [roleId], references: [id])
}

// =================================================================
// 3. AGENTS & ROLES (Core)
// =================================================================

model Role {
  id          String   @id @default(cuid()) // Keeping CUIDs for now
  name        String   @unique
  description String?  @db.Text
  basePrompt  String   @db.Text
  
  categoryId  String?
  category    RoleCategory? @relation(fields: [categoryId], references: [id])
  
  tools       RoleTool[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  modelUsage  ModelUsage[]
  jobs        Job[]
  promptRefinements PromptRefinement[]
}

model RoleCategory {
  id        String   @id @default(cuid())
  name      String   @unique
  order     Int      @default(0)
  roles     Role[]
}

model Tool {
  id          String   @id @default(cuid())
  name        String   @unique 
  description String   @db.Text
  instruction String   @db.Text 
  schema      String   @db.Text 
  isEnabled   Boolean  @default(true)
  roles       RoleTool[]
}

model RoleTool {
  roleId String
  toolId String
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  tool   Tool @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@id([roleId, toolId])
}

// =================================================================
// 4. EXECUTION (Cleaned up Job table)
// =================================================================

model Job {
  id          String   @id @default(cuid())
  type        String   
  status      String   @default("pending")
  priority    String   @default("medium")
  
  description String?  @db.Text
  roleId      String?
  role        Role?    @relation(fields: [roleId], references: [id])

  input       Json?    @default("{}")
  output      Json?    
  logs        Json?    @default("[]") 

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  startedAt   DateTime?
  completedAt DateTime?
}

model KnowledgeVector {
  id          String   @id @default(cuid())
  
  // Context
  entityType  String   // "file", "memory"
  entityId    String   // path or ID
  content     String   @db.Text 
  
  // Vector Data
  modelId     String
  model       Model    @relation(fields: [modelId], references: [id])
  vector      Float[]  // PGVector array
  dimensions  Int      
  
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
}

model FileIndex {
  filePath    String   @id
  contentHash String
  updatedAt   DateTime @updatedAt
}

model WorkOrderCard {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  
  // "Context Intelligence" Bag
  contextStats   Json? 
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PromptRefinement {
  id             String   @id @default(cuid())
  roleId         String
  role           Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  originalPrompt String   @db.Text
  critique       String   @db.Text
  refinedPrompt  String?  @db.Text
  
  createdAt      DateTime @default(now())
}

model ModelFailure {
  id         String   @id @default(cuid())
  providerId String
  modelId    String
  failures   Int      @default(0)
  lastFailedAt DateTime @updatedAt
  @@unique([providerId, modelId])
}

// =================================================================
// 5. UI CONFIG (Keep if your UI relies on them)
// =================================================================

model CardConfig {
  cardId      String   @id
  customButtons CustomButton[]
  componentRoles ComponentRole[]
}

model CustomButton {
  id          String   @id @default(cuid())
  cardId      String
  cardConfig  CardConfig @relation(fields: [cardId], references: [cardId], onDelete: Cascade)
  label       String
  action      String   
  actionData  String
  icon        String?
}

model ComponentRole {
  id          String   @id @default(cuid())
  cardId      String
  cardConfig  CardConfig @relation(fields: [cardId], references: [cardId], onDelete: Cascade)
  component   String   
  roleId      String?
}
