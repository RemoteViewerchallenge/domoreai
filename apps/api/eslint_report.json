[{"filePath":"/home/guy/mono/apps/api/.eslintrc.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/drizzle.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/drizzle.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/inspect_data.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/inspect_data.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[460,463],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[460,463],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":29,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":29,"endColumn":8,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[709,709],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[709,709],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { PrismaClient } from '@prisma/client';\nimport * as dotenv from 'dotenv';\ndotenv.config({ path: '.env.local' });\ndotenv.config();\n\nconst prisma = new PrismaClient();\n\nasync function main() {\n  try {\n    const config = await prisma.orchestratorConfig.findUnique({ where: { id: 'global' } });\n    const tableName = config?.activeTableName || 'unified_models';\n    console.log(`Active Table: ${tableName}`);\n\n    const rows = await prisma.$queryRawUnsafe<any[]>(\n      `SELECT model_id, model_name, provider FROM \"${tableName}\" LIMIT 10`\n    );\n    \n    console.log('Sample Data:');\n    console.table(rows);\n    \n  } catch (e) {\n    console.error(e);\n  } finally {\n    await prisma.$disconnect();\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/reproduce_ws.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/scripts/check_resource.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/scripts/check_saved_queries.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/scripts/smoke-context.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/config/constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/db/schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/db/seed.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":102,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":102,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":102,"column":17,"nodeType":"Identifier","messageId":"unsafeCall","endLine":102,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { v4 as uuidv4 } from 'uuid';\nimport { db, shutdownDb } from '../db.js';\nimport { providerConfigs } from './schema.js';\nimport { encrypt } from '../utils/encryption.js';\nimport * as dotenv from 'dotenv';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport fs from 'fs';\nimport { eq, and } from 'drizzle-orm';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nconst log = (msg: string) => {\n  console.log(msg);\n};\n\ninterface BackupProvider {\n  id: string;\n  label: string;\n  type: string;\n  apiKey: string;\n  baseURL: string | null;\n  isEnabled: boolean;\n  requestsPerMinute: number | null;\n}\n\nlog('Starting seed script...');\n\n// Load environment variables from .env.local\n// We go up: src/db -> src -> api -> apps -> root (4 levels)\nconst envPath = path.resolve(__dirname, '../../../../.env.local');\nlog(`Loading env from: ${envPath}`);\ndotenv.config({ path: envPath });\n\nasync function main() {\n  log('Seeding database...');\n\n  // 1. Try to load from backup file\n  const backupFile = path.join(__dirname, 'providers_backup.json');\n  if (fs.existsSync(backupFile)) {\n    log(`Found backup file: ${backupFile}`);\n    const backupData = JSON.parse(fs.readFileSync(backupFile, 'utf-8')) as BackupProvider[];\n    \n    for (const p of backupData) {\n      log(`Restoring provider from backup: ${p.label}`);\n      await db.insert(providerConfigs).values({\n          id: p.id,\n          label: p.label,\n          type: p.type,\n          apiKey: p.apiKey,\n          baseURL: p.baseURL,\n          isEnabled: p.isEnabled,\n          requestsPerMinute: p.requestsPerMinute,\n          updatedAt: new Date(),\n      }).onConflictDoUpdate({\n          target: providerConfigs.id,\n          set: {\n            label: p.label,\n            type: p.type,\n            apiKey: p.apiKey,\n            baseURL: p.baseURL,\n            isEnabled: p.isEnabled,\n            requestsPerMinute: p.requestsPerMinute,\n            updatedAt: new Date(),\n          }\n      });\n    }\n    log('Backup restoration complete.');\n  } else {\n    log('No backup file found. Falling back to .env variables...');\n  }\n\n  log('Checking .env for additional providers...');\n  const providers = [\n    { keyName: 'OPENAI_API_KEY', type: 'openai', label: 'OpenAI (Auto)' },\n    { keyName: 'ANTHROPIC_API_KEY', type: 'anthropic', label: 'Anthropic (Auto)' },\n    { keyName: 'GOOGLE_GENERATIVE_AI_API_KEY', type: 'google', label: 'Google (Auto)' },\n    { keyName: 'MISTRAL_API_KEY', type: 'mistral', label: 'Mistral (Auto)' },\n    { keyName: 'OPENROUTER_API_KEY', type: 'openrouter', label: 'OpenRouter (Auto)' },\n  ];\n\n  for (const p of providers) {\n    const apiKey = process.env[p.keyName];\n    if (apiKey) {\n      console.log(`Found ${p.keyName}, upserting provider...`);\n      const encryptedKey = encrypt(apiKey);\n      \n      // Check if exists to avoid duplicates or overwrite\n      // We check by label and type to be sure\n      const existing = await db.select().from(providerConfigs)\n        .where(and(eq(providerConfigs.label, p.label), eq(providerConfigs.type, p.type)))\n        .limit(1);\n\n      if (existing.length > 0) {\n        await db.update(providerConfigs)\n          .set({ apiKey: encryptedKey, updatedAt: new Date() })\n          .where(eq(providerConfigs.id, existing[0].id));\n        console.log(`Updated ${p.label}`);\n      } else {\n        await db.insert(providerConfigs).values({\n            id: uuidv4(),\n            label: p.label,\n            type: p.type,\n            apiKey: encryptedKey,\n            isEnabled: true,\n            updatedAt: new Date(),\n        });\n        console.log(`Created ${p.label}`);\n      }\n    } else {\n      console.log(`Skipping ${p.label} (Key not found)`);\n    }\n  }\n}\n\nmain().catch(console.error).finally(async () => {\n    await shutdownDb();\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/errors/AppErrors.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/examples/ghost-records-integration.ts","messages":[{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async function 'callLLMProvider' has no 'await' expression.","line":264,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingAwait","endLine":264,"endColumn":31,"suggestions":[{"messageId":"removeAsync","fix":{"range":[7237,7391],"text":"function callLLMProvider(\n  providerId: string,\n  modelId: string,\n  request: unknown\n): { data: unknown; headers: Record<string, string> }"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'providerId' is defined but never used. Allowed unused args must match /^_/u.","line":265,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":265,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'modelId' is defined but never used. Allowed unused args must match /^_/u.","line":266,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":266,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used. Allowed unused args must match /^_/u.","line":267,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":267,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'headers' is defined but never used. Allowed unused args must match /^_/u.","line":273,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":273,"endColumn":49},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async function 'fetchModelsFromProviderAPI' has no 'await' expression.","line":279,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingAwait","endLine":279,"endColumn":42,"suggestions":[{"messageId":"removeAsync","fix":{"range":[7689,7798],"text":"function fetchModelsFromProviderAPI(provider: { baseURL?: string; apiKey: string }): unknown[]"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'provider' is defined but never used. Allowed unused args must match /^_/u.","line":279,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":279,"endColumn":51}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Example: Integrating Ghost Records Pattern with AgentRuntime\n * \n * This shows how to track model discoveries during agent execution\n */\n\nimport { ModelDiscoveryService } from '../services/ModelDiscoveryService.js';\nimport { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\n\n/**\n * Example 1: Track successful model inference in your orchestrator\n */\nexport async function executeAgentJob(\n  jobId: string,\n  roleId: string,\n  providerId: string,\n  modelId: string\n) {\n  try {\n    // Your existing job execution logic\n    const result = await callLLMProvider(providerId, modelId, {\n      messages: [{ role: 'user', content: 'Hello' }]\n    });\n\n    // ‚ú® NEW: Track successful inference\n    await ModelDiscoveryService.trackSuccessfulInference(\n      providerId,\n      modelId,\n      undefined, // Will use modelId as name\n      {\n        jobId,\n        roleId,\n        successfulAt: new Date().toISOString(),\n        // Optionally extract context window from response headers\n        contextWindow: extractContextWindowFromHeaders(result.headers)\n      }\n    );\n\n    return result;\n  } catch (error) {\n    console.error(`Model ${modelId} failed:`, error);\n    // Don't track failures here - let ModelFailure table handle that\n    throw error;\n  }\n}\n\n/**\n * Example 2: Select models with Ghost Records awareness\n */\nexport async function selectBestModel(\n  roleId: string,\n  capabilities: string[] = ['text']\n) {\n  // Only consider active models\n  const availableModels = await prisma.model.findMany({\n    where: {\n      isActive: true,      // ‚ú® Only confirmed-working models\n      isFree: true,        // Zero-Burn mode\n      capabilityTags: {\n        hasSome: capabilities\n      },\n      provider: {\n        isEnabled: true\n      }\n    },\n    include: {\n      provider: true\n    },\n    orderBy: [\n      // Prefer recently-seen models\n      { lastSeenAt: 'desc' }\n    ]\n  });\n\n  if (availableModels.length === 0) {\n    throw new Error('No active models available for this role');\n  }\n\n  // Prefer INDEX models over INFERENCE (more reliable)\n  const indexModels = availableModels.filter(m => m.source === 'INDEX');\n  const preferredModels = indexModels.length > 0 ? indexModels : availableModels;\n\n  return preferredModels[0];\n}\n\n/**\n * Example 3: Health check with Ghost Records protection\n */\nexport async function refreshProviderModels(providerId: string) {\n  try {\n    const provider = await prisma.providerConfig.findUnique({\n      where: { id: providerId }\n    });\n\n    if (!provider) {\n      throw new Error(`Provider ${providerId} not found`);\n    }\n\n    // Fetch models from provider API\n    const models = await fetchModelsFromProviderAPI({\n          ...provider,\n          baseURL: provider.baseURL ?? undefined\n        });\n\n    if (models.length === 0) {\n      console.warn(`‚ö†Ô∏è  ${provider.label} returned 0 models`);\n      console.warn(`   This might be an API timeout or rate limit`);\n      console.warn(`   Existing models are preserved by Ghost Records pattern`);\n      \n      // Don't proceed with ingestion - Ghost Records protects existing data\n      return {\n        success: false,\n        reason: 'empty_response',\n        modelsPreserved: true\n      };\n    }\n\n    // Safe to ingest\n    console.log(`‚úÖ ${provider.label} returned ${models.length} models`);\n    \n    // Your ingestion logic here...\n    // UnifiedIngestionService will update lastSeenAt for all found models\n    \n    return {\n      success: true,\n      modelsIngested: models.length\n    };\n  } catch (error) {\n    console.error(`Failed to refresh ${providerId}:`, error);\n    return {\n      success: false,\n      reason: 'api_error',\n      error: error instanceof Error ? error.message : String(error)\n    };\n  }\n}\n\n/**\n * Example 4: UI endpoint to show model status\n */\nexport async function getModelStatusForUI() {\n  const stats = await ModelDiscoveryService.getDiscoveryStats();\n  const recentlyInactive = await ModelDiscoveryService.listInactiveModels(20);\n\n  // Group by provider\n  const modelsByProvider = await prisma.providerConfig.findMany({\n    include: {\n      models: {\n        orderBy: { lastSeenAt: 'desc' }\n      }\n    }\n  });\n\n  return {\n    summary: stats,\n    recentlyInactive: recentlyInactive.map(m => ({\n      id: m.id,\n      name: m.name,\n      provider: m.provider.label,\n      source: m.source,\n      lastSeenAt: m.lastSeenAt,\n      daysSinceLastSeen: Math.floor(\n        (Date.now() - m.lastSeenAt.getTime()) / (1000 * 60 * 60 * 24)\n      )\n    })),\n    byProvider: modelsByProvider.map(p => ({\n      provider: p.label,\n      total: p.models.length,\n      active: p.models.filter(m => m.isActive).length,\n      inactive: p.models.filter(m => !m.isActive).length,\n      bySource: {\n        INDEX: p.models.filter(m => m.source === 'INDEX').length,\n        INFERENCE: p.models.filter(m => m.source === 'INFERENCE').length,\n        MANUAL: p.models.filter(m => m.source === 'MANUAL').length\n      }\n    }))\n  };\n}\n\n/**\n * Example 5: Scheduled maintenance job\n */\nexport async function dailyModelMaintenance() {\n  console.log('üîß Running daily model maintenance...');\n\n  // 1. Mark stale models (not seen in 24 hours)\n  const staleCount = await ModelDiscoveryService.markStaleModelsInactive(\n    undefined, // All providers\n    24         // Hours\n  );\n\n  if (staleCount > 0) {\n    console.log(`   Marked ${staleCount} models as inactive (not seen in 24h)`);\n  }\n\n  // 2. Delete very old inactive models (30+ days)\n  const deletedCount = await ModelDiscoveryService.deleteOldInactiveModels(30);\n\n  if (deletedCount > 0) {\n    console.log(`   Deleted ${deletedCount} old inactive models (30+ days)`);\n  }\n\n  // 3. Get stats\n  const stats = await ModelDiscoveryService.getDiscoveryStats();\n  console.log(`   Current status: ${stats.active} active, ${stats.inactive} inactive`);\n\n  // 4. Alert if too many inactive\n  const inactivePercentage = (stats.inactive / stats.total) * 100;\n  if (inactivePercentage > 10) {\n    console.warn(`‚ö†Ô∏è  ${inactivePercentage.toFixed(1)}% of models are inactive!`);\n    console.warn(`   Consider refreshing provider model lists`);\n  }\n\n  console.log('‚úÖ Maintenance complete');\n}\n\n/**\n * Example 6: Manual model addition\n */\nexport async function addManualModel(\n  providerId: string,\n  modelId: string,\n  modelName: string,\n  specs: {\n    contextWindow?: number;\n    maxOutput?: number;\n    isMultimodal?: boolean;\n  }\n) {\n  const now = new Date();\n\n  const model = await prisma.model.create({\n    data: {\n      providerId,\n      modelId,\n      name: modelName,\n      source: 'MANUAL', // ‚ú® This protects it from auto-deletion\n      firstSeenAt: now,\n      lastSeenAt: now,\n      isActive: true,\n      specs: {\n        contextWindow: specs.contextWindow || 4096,\n        maxOutput: specs.maxOutput || 4096,\n        isMultimodal: specs.isMultimodal || false\n      },\n      providerData: {\n        note: 'Manually added by user',\n        addedAt: now.toISOString()\n      },\n      capabilityTags: specs.isMultimodal ? ['text', 'vision'] : ['text']\n    }\n  });\n\n  console.log(`‚úÖ Added manual model: ${modelName} (${modelId})`);\n  console.log(`   This model will never be auto-deleted`);\n\n  return model;\n}\n\n// Helper functions (implement these based on your existing code)\n\nasync function callLLMProvider(\n  providerId: string,\n  modelId: string,\n  request: unknown\n): Promise<{ data: unknown; headers: Record<string, string> }> {\n  // Your existing LLM call logic\n  throw new Error('Not implemented');\n}\n\nfunction extractContextWindowFromHeaders(headers: Record<string, string>): number | undefined {\n  // Some providers include this in response headers\n  // e.g., OpenRouter: x-ratelimit-limit-tokens\n  return undefined;\n}\n\nasync function fetchModelsFromProviderAPI(provider: { baseURL?: string; apiKey: string }): Promise<unknown[]> {\n  // Your existing provider API call logic\n  throw new Error('Not implemented');\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/index.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'db' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":12},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'scheduler' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":19},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":109,"column":23,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":164,"endColumn":4},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":174,"column":18,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":180,"endColumn":6},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":193,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":193,"endColumn":15,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[6673,6673],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[6673,6673],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import './instrumentation.js'; // Must be top line\nimport { WebSocketService } from './services/websocket.service.js';\nimport { appRouter } from './routers/index.js';\nimport './services/IngestionAgent.js';\nimport { createExpressMiddleware } from '@trpc/server/adapters/express';\nimport express from 'express';\nimport cors from 'cors';\nimport morgan from 'morgan';\nimport http from 'http';\nimport { createTRPCContext as createContext } from './trpc.js';\nimport { db, shutdownDb } from './db.js'; \nimport { llmRouter } from './routers/llm.router.js';\nimport { ProviderManager } from './services/ProviderManager.js';\nimport { createVolcanoTelemetry } from 'volcano-sdk';\nimport { scheduler } from './services/JobScheduler.js';\nimport { backupService } from './services/BackupService.js';\nimport { persistentModelDoctor } from './services/PersistentModelDoctor.js';\nimport { API_PORT, API_HOST, DEFAULT_CORS_ORIGIN, ENCRYPTION_KEY_LENGTH, VOLCANO_TELEMETRY_ENABLED } from './config/constants.js';\n\n// Initialize Telemetry\nif (process.env.VOLCANO_TELEMETRY_ENABLED === VOLCANO_TELEMETRY_ENABLED) {\n  createVolcanoTelemetry({\n    serviceName: process.env.OTEL_SERVICE_NAME,\n    endpoint: process.env.OTEL_EXPORTER_OTLP_ENDPOINT,\n  });\n}\n\n/**\n * Initializes and starts the application server.\n */\nasync function startServer() {\n  const app = express();\n  const server = http.createServer(app);\n  const port = API_PORT;\n\n  const ENCRYPTION_KEY = process.env.ENCRYPTION_KEY || '';\n  if (!ENCRYPTION_KEY || ENCRYPTION_KEY.length !== ENCRYPTION_KEY_LENGTH) {\n    console.error(\n      'FATAL: ENCRYPTION_KEY is not set or is not a 64-character hex string. Please set a strong 32-byte key (as 64 hex chars) in your environment variables.'\n    );\n    // process.exit(1); // Don't exit, just warn for now to allow dev\n  }\n\n  // Apply essential middlewares\n  // Add request logging\n  app.use(morgan('dev'));\n\n  app.use(\n    cors({\n      origin: process.env.CORS_ORIGIN || DEFAULT_CORS_ORIGIN,\n    })\n  );\n  app.use(express.json());\n\n  // Setup tRPC endpoint\n  app.use(\n    '/trpc',\n    createExpressMiddleware({\n      router: appRouter,\n      createContext,\n      onError({ path, error }) {\n        console.error(`tRPC Error on '${path}':`, error);\n      },\n    })\n  );\n\n  // Initialize WebSocket service\n  const wsService = new WebSocketService(server);\n  // Register singleton so other services can broadcast events\n  try {\n    const { setWebSocketService } = await import('./services/websocket.singleton.js');\n    setWebSocketService(wsService);\n  } catch (err) {\n    console.warn('Failed to register WebSocketService singleton:', err);\n  }\n\n  // Initialize Provider Manager\n  await ProviderManager.initialize();\n  \n  // ==============================================================================\n  // RUN THE ANTI-CORRUPTION PIPELINE\n  // ==============================================================================\n  // Phase 1: Saves raw JSON files exactly as they are to RawDataLake\n  // Phase 2: Filters and normalizes data into the Model table\n  // - Strict filtering: Rejects paid OpenRouter models\n  // - Fail-open for Groq, Google, Mistral (assumes free tier)\n  // - Preserves all original data in providerData field\n  try {\n    console.log('üîÑ Running Unified Model Ingestion (Anti-Corruption Pipeline)...');\n    const { UnifiedIngestionService } = await import('./services/UnifiedIngestionService.js');\n    await UnifiedIngestionService.ingestAllModels();\n  } catch (err) {\n    console.error('‚ùå Model Ingestion Failed:', err);\n  }\n\n  // Mount RESTful API routers\n  app.use('/llm', llmRouter);\n\n  // Global error handler for REST routes\n  // This should be the last middleware added\n  app.use((err: Error, _req: express.Request, res: express.Response, _next: express.NextFunction) => {\n    console.error('Unhandled API Error:', err.stack);\n    res.status(500).json({\n      error: 'Internal Server Error',\n      message: err.message, // In production, you might want to avoid sending the raw message\n    });\n  });\n\n  server.listen(port, async () => {\n    console.log(`API server listening at ${API_HOST}:${port}`);\n    \n    // Display free model inventory\n    try {\n      const { prisma } = await import('./db.js');\n      const allModels = await prisma.model.findMany({\n        select: {\n          id: true,\n          name: true,\n          providerId: true,\n          isFree: true\n        }\n      });\n      \n      const freeModels = allModels.filter(m => m.isFree);\n      const freeByProvider = freeModels.reduce((acc, m) => {\n        const provider = m.providerId;\n        acc[provider] = (acc[provider] || 0) + 1;\n        return acc;\n      }, {} as Record<string, number>);\n      \n      console.log(`\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ  üöÄ C.O.R.E. API Started              ‚îÇ\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n‚îÇ  Total Models: ${String(allModels.length).padEnd(23)}‚îÇ\n‚îÇ  ‚úÖ Free Models: ${String(freeModels.length).padEnd(21)}‚îÇ\n${Object.entries(freeByProvider).map(([provider, count]) => \n  `‚îÇ     - ${provider}: ${String(count).padEnd(26 - provider.length)}‚îÇ`\n).join('\\n')}\n‚îÇ                                        ‚îÇ\n‚îÇ  üí∞ Zero-Burn Mode: ACTIVE            ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n      `);\n    } catch (err) {\n      console.warn('Could not fetch model inventory:', err);\n    }\n\n    // Start background services\n    console.log('\\nüîß Starting background services...');\n    \n    // Start automatic backup service\n    try {\n      await backupService.start();\n    } catch (err) {\n      console.warn('‚ö†Ô∏è Backup service failed to start:', err);\n    }\n\n    // Start persistent model doctor\n    try {\n      await persistentModelDoctor.start();\n    } catch (err) {\n      console.warn('‚ö†Ô∏è Persistent model doctor failed to start:', err);\n    }\n  });\n\n\n  const gracefulShutdown = (signal: string) => {\n    console.log(`\\n${signal} received. Shutting down gracefully...`);\n    \n    // Stop background services first\n    backupService.stop();\n    persistentModelDoctor.stop();\n    \n    server.close(async () => {\n      console.log('HTTP server closed.');      \n      wsService.close(); // Assuming WebSocketService has a .close() method\n      await shutdownDb();\n      console.log('Database connection closed.');\n      process.exit(0);\n    });\n  };\n\n  process.on('SIGINT', () => gracefulShutdown('SIGINT'));\n  process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));\n}\n\n// START THE AUTONOMY ENGINE\n// scheduler.start(5000); // Check for work every 5 seconds\n// NOTE: Disabled until jobs table is created via migration.\n// JobScheduler will gracefully handle missing tables when enabled.\n\nconsole.log('Server starting... (Force Restart 2)');\nstartServer();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/instrumentation.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":7,"column":3,"nodeType":"Property","messageId":"anyAssignment","endLine":10,"endColumn":5},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe construction of a(n) `any` typed value.","line":7,"column":13,"nodeType":"NewExpression","messageId":"unsafeNew","endLine":10,"endColumn":5},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[322,325],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[322,325],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .Resource on an `any` value.","line":7,"column":36,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":7,"endColumn":44},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":19,"column":23,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":21,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NodeSDK } from '@opentelemetry/sdk-node';\nimport { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';\nimport * as resources from '@opentelemetry/resources';\nimport { SemanticResourceAttributes } from '@opentelemetry/semantic-conventions';\n\nconst sdk = new NodeSDK({\n  resource: new (resources as any).Resource({\n    [SemanticResourceAttributes.SERVICE_NAME]: process.env.OTEL_SERVICE_NAME || 'domore-api',\n    [SemanticResourceAttributes.SERVICE_VERSION]: '1.0.0',\n  }),\n  traceExporter: new OTLPTraceExporter({\n    url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT || 'http://localhost:4318/v1/traces',\n  }),\n});\n\nsdk.start();\nconsole.log('[System] Telemetry SDK started');\n\nprocess.on('SIGTERM', async () => {\n  await sdk.shutdown();\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/interfaces/IAgent.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/interfaces/IAgentConfigRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/interfaces/IAgentFactory.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/interfaces/IMcpOrchestrator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/interfaces/IProviderManager.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/interfaces/IProviderRepository.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":2,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[91,94],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[91,94],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":3,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[143,146],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[143,146],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":4,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[180,183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[180,183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":5,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":5,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[240,243],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[240,243],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[268,271],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[268,271],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface IProviderRepository {\n  findProviderConfigByLabel(label: string): Promise<any>;\n  findProviderConfigById(id: string): Promise<any>;\n  createProviderConfig(values: any): Promise<void>;\n  getEnabledProviderConfigs(): Promise<any[]>;\n  upsertModel(data: any): Promise<void>;\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/interfaces/IRegistryClient.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/mcp-adapters.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[297,300],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[297,300],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'getModels' has no 'await' expression.","line":20,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":20,"endColumn":18,"suggestions":[{"messageId":"removeAsync","fix":{"range":[591,629],"text":"getModels(): LLMModel[]"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'getModels' has no 'await' expression.","line":40,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":40,"endColumn":18,"suggestions":[{"messageId":"removeAsync","fix":{"range":[1128,1166],"text":"getModels(): LLMModel[]"},"desc":"Remove 'async'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { type LLMModel } from './utils/ProviderFactory.js';\nimport { z } from 'zod';\n\n/**\n * We reuse the LLMModel interface to keep things consistent.\n * If MCP returns different fields, we can extend it here.\n */\nexport interface MCPAdapter {\n  providerName: string;\n  configSchema: z.ZodObject<any>;\n  getModels(config: { baseURL?: string; apiKey?: string }): Promise<LLMModel[]>;\n}\n\nexport class GatewayAdapter implements MCPAdapter {\n  providerName: string = 'mcp';\n  configSchema = z.object({\n    baseURL: z.string().url().optional(),\n    apiKey: z.string().min(1).optional(),\n  });\n  async getModels(): Promise<LLMModel[]> {\n    // Placeholder implementation - ensure strict types\n    return [\n      {\n        id: 'gateway-model-1',\n        providerId: 'mcp-gateway',\n        object: 'model',\n        created: Date.now(),\n        owned_by: 'gateway',\n      },\n    ];\n  }\n}\n\n// Example of a concrete implementation (adapt as needed for your real logic)\nexport class LocalAdapter implements MCPAdapter {\n  providerName: string = 'local';\n  configSchema = z.object({\n    // Define schema for local adapter if needed\n  });\n  async getModels(): Promise<LLMModel[]> {\n    return [];\n  }\n}","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/orchestrator/modelSelector.test.ts","messages":[{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async arrow function has no 'await' expression.","line":64,"column":23,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":64,"endColumn":25,"suggestions":[{"messageId":"removeAsync","fix":{"range":[1913,1919],"text":""},"desc":"Remove 'async'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// --- modelSelector.test.ts ---\n\nimport { describe, it, expect, vi, beforeEach, afterEach, test } from 'vitest';\nimport {\n  loadModelCatalog,\n  selectModel,\n  HardStopError,\n  RateLimitError,\n} from './modelSelector.js'; // Import the code to be tested\n\n// --- 1. The \"Hoisted\" Mock ---\n// This block runs *before* all other code, including imports.\n// This is the most important part.\nconst hoistedMocks = await vi.hoisted(async () => {\n  const { Volume } = await import('memfs');\n  // Create a new, empty in-memory file system\n  const vol = Volume.fromJSON({}, '/');\n  const mockRedisStore = new Map<string, string>();\n\n  // This is the magic: We mock 'node:fs' and 'node:fs/promises'\n  // to point to our in-memory 'vol' object.\n  return {\n    vol, // Export the volume so we can add files to it in our tests\n    fs: {\n      ...vol,\n      promises: vol.promises,\n    },\n    mockRedisStore,\n  };\n});\n\nconst { vol, fs, mockRedisStore } = hoistedMocks;\n\n// --- 2. Tell Vitest to Use the Mock ---\n// Now, anytime a file (like modelSelector.ts) imports 'node:fs',\n// Vitest will give it our 'fs' object from above.\nvi.mock('node:fs', () => fs);\nvi.mock('node:fs/promises',() => fs.promises);\n\n// --- 3. Mock Redis (as before) ---\n// This mock is simpler and can be done here.\nvi.mock('redis', () => {\n  const MockRedisClient = {\n    // Add mock functions your code actually calls\n    get: vi.fn((key: string) => mockRedisStore.get(key) || null),\n    set: vi.fn((key: string, value: string) => mockRedisStore.set(key, value)),\n    incr: vi.fn((key: string) => {\n      const val = (parseInt(mockRedisStore.get(key) || '0', 10)) + 1;\n      mockRedisStore.set(key, val.toString());\n      return val;\n    }),\n    connect: vi.fn(),\n    on: vi.fn(),\n  };\n  return {\n    createClient: vi.fn(() => MockRedisClient),\n  };\n});\n\n\n// --- 4. The Test Suite ---\n\ndescribe('ModelSelector Logic (with Mocks)', () => {\n  beforeEach(async () => {\n    // A. Reset the file system and redis store\n    vol.reset();\n    mockRedisStore.clear();\n\n    // C. Reset all mocks (like redis.get, etc.)\n    vi.clearAllMocks();\n\n    // D. *** ACTIVATE FAKE TIMERS HERE ***\n    // This is the *last* thing you do in setup.\n    // By doing it here, all mocks are already in place.\n    vi.useFakeTimers();\n\n    // E. Populate the mock file system with test data\n    vol.fromJSON(\n      {\n        '/models/google.json': JSON.stringify([\n          { id: 'gemini-1.5-pro-latest', provider: 'google', cost: 0.00, simulation: { onLimitExceeded: 'HARD_STOP', rateLimits: { freeTier: { RPM: 2, RPD: 50 } } } },\n          { id: 'gemini-1.0-pro', provider: 'google', cost: 0.00, simulation: { onLimitExceeded: 'HARD_STOP', rateLimits: { freeTier: { RPM: 5, RPD: 100 } } } },\n        ]),\n        '/models/openrouter.json': JSON.stringify([\n          { id: 'openrouter/anthropic/claude-3-haiku', provider: 'openrouter', cost: 0.00, simulation: { onLimitExceeded: 'SOFT_FAIL', rateLimits: { freeTier: { RPD: 100 } } } },\n          { id: 'openrouter/mistralai/mistral-7b-instruct', provider: 'openrouter', cost: 0.00, simulation: { onLimitExceeded: 'SOFT_FAIL', rateLimits: { freeTier: { RPD: 200 } } } },\n        ]),\n      },\n      '/'\n    );\n  });\n\n  afterEach(() => {\n    // Clean up timers\n    vi.useRealTimers();\n  });\n\n  // --- 5. The Tests ---\n\n  it('should load the model catalog from the mock file system', async () => {\n    // This test now uses the in-memory JSON files\n    const catalog = await loadModelCatalog([\n      '/models/google.json',\n      '/models/openrouter.json',\n    ]);\n    expect(catalog.length).toBe(4);\n    expect(catalog[0].id).toBe('gemini-1.5-pro-latest');\n  });\n\n  test(\"Hard Stop (Google RPD): It must prevent a 'Hard Stop' provider from exceeding its daily limit.\", async () => {\n    const modelId = 'gemini-1.5-pro-latest'; // 50 RPD\n    for (let i = 0; i < 50; i++) {\n      await selectModel({ modelName: modelId });\n      vi.advanceTimersByTime(60 * 1000); // Advance 1 minute to avoid hitting RPM limit\n    }\n    await expect(selectModel({ modelName: modelId })).rejects.toThrow(HardStopError);\n  });\n\n  test(\"'Soft Fail' & Rerouting (OpenRouter RPD): It must reroute to the next available asset when a 'Soft Fail' provider is exhausted.\", async () => {\n    const modelId = 'openrouter/mistralai/mistral-7b-instruct'; // 200 RPD\n    for (let i = 0; i < 200; i++) {\n      await selectModel({ modelName: modelId });\n      vi.advanceTimersByTime(60 * 1000);\n    }\n    const nextModel = await selectModel({ modelName: modelId });\n    expect(nextModel).toBeDefined();\n    expect(nextModel!.id).not.toBe(modelId);\n    // When mistral is exhausted, the next least-used (with 0 usage) is gemini-1.5-pro-latest\n    expect(nextModel!.id).toBe('gemini-1.5-pro-latest');\n  });\n\n  test(\"Hard Stop (Google RPM): It must respect the 'Hard Stop' RPM limit.\", async () => {\n    const modelId = 'gemini-1.5-pro-latest'; // 2 RPM\n    await selectModel({ modelName: modelId }); // Call 1 -> OK\n    await selectModel({ modelName: modelId }); // Call 2 -> OK\n    // Call 3 should fail\n    await expect(selectModel({ modelName: modelId })).rejects.toThrow(RateLimitError);\n  });\n\n  test(\"'Maximize Free Labour' (Least Used): It must select the least-used free asset to maximize utilization.\", async () => {\n    // Manually set usage counts in mock Redis\n    mockRedisStore.set('model:usage:openrouter/mistralai/mistral-7b-instruct', '50');\n    mockRedisStore.set('model:usage:gemini-1.0-pro', '10');\n    mockRedisStore.set('model:usage:gemini-1.5-pro-latest', '20');\n    mockRedisStore.set('model:usage:openrouter/anthropic/claude-3-haiku', '30');\n\n    // Request a model without specifying a preference to trigger the \"least used\" logic\n    const selectedModel = await selectModel({});\n    expect(selectedModel).toBeDefined();\n    expect(selectedModel!.id).toBe('gemini-1.0-pro');\n  });\n\n  test(\"'Daily Reset': It must reset daily limits after 24 hours.\", async () => {\n    const modelId = 'gemini-1.5-pro-latest'; // 50 RPD\n    for (let i = 0; i < 50; i++) {\n      await selectModel({ modelName: modelId });\n      vi.advanceTimersByTime(60 * 1000); // Advance 1 minute to avoid hitting RPM limit\n    }\n    await expect(selectModel({ modelName: modelId })).rejects.toThrow(HardStopError);\n\n    vi.advanceTimersByTime(24 * 60 * 60 * 1000); // Advance time by 24 hours\n\n    const modelAfterReset = await selectModel({ modelName: modelId });\n    expect(modelAfterReset).toBeDefined();\n    expect(modelAfterReset!.id).toBe(modelId);\n  });\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/orchestrator/modelSelector.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/rateLimiter.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":5,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":5,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[189,192],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[189,192],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1607,1610],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1607,1610],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .status on an `any` value.","line":42,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":42,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1724,1727],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1724,1727],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":47,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":47,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .response on an `any` value.","line":47,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":47,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .status on an `any` value.","line":47,"column":52,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":47,"endColumn":58}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"export interface IAtomicRedisClient {\n  get(key: string): Promise<string | null>;\n  incr(key: string): Promise<number>;\n  expire(key: string, seconds: number): Promise<boolean>;\n  multi(): any;\n}\n\nexport class RateLimiter {\n  private redis: IAtomicRedisClient;\n\n  constructor(redisClient: IAtomicRedisClient) {\n    this.redis = redisClient;\n  }\n\n  /**\n   * Atomically checks and increments the rate limit counter.\n   * Returns true if request is allowed, false if limit exceeded.\n   */\n  async checkAndIncrement(key: string, limit: number, windowSeconds: number): Promise<boolean> {\n    const current = await this.redis.incr(key);\n    \n    // If this is the first request (current === 1), set the expiry.\n    // Note: There is a tiny race here where if the process crashes after incr but before expire,\n    // the key might persist without expiry. Lua script avoids this, but this is generally acceptable.\n    // If strict atomicity for expiry is required, we'd need eval support in the interface.\n    if (current === 1) {\n      await this.redis.expire(key, windowSeconds);\n    }\n    \n    return current <= limit;\n  }\n}\n\nimport { ProviderManager } from './services/ProviderManager.js';\nimport { type BaseLLMProvider, type CompletionRequest } from './utils/BaseLLMProvider.js';\n\nexport async function executeWithRateLimit(provider: BaseLLMProvider, request: CompletionRequest): Promise<string> {\n  try {\n    if (!ProviderManager.isHealthy(provider.id)) {\n      // Create an error object that looks like an axios error\n      const error = new Error(`Provider ${provider.id} is on cooldown.`);\n      (error as any).status = 429;\n      throw error;\n    }\n    return await provider.generateCompletion(request);\n  } catch (error: any) {\n    const status = error.response?.status || error.status;\n    if (status === 429) { \n      console.warn(`[RateLimit] ${provider.id} exhausted. Marking as unhealthy.`);\n      ProviderManager.markUnhealthy(provider.id, 60); // Cooldown for 60 seconds\n    }\n    // Also mark provider as unhealthy on other server-side errors\n    if (status >= 500) {\n        console.warn(`[RateLimit] ${provider.id} returned a server error. Marking as unhealthy.`);\n        ProviderManager.markUnhealthy(provider.id, 30); // Shorter cooldown for general errors\n    }\n    throw error;\n  }\n}","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/redis.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/repositories/AgentConfigRepository.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/repositories/PrismaAgentConfigRepository.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":31,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":31,"endColumn":59},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1236,1239],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1236,1239],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":32,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":38,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":38,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":38,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1542,1545],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1542,1545],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { IAgentConfigRepository } from \"../interfaces/IAgentConfigRepository.js\";\nimport { prisma } from \"../db.js\";\nimport { Role, Model, Prisma } from \"@prisma/client\";\nimport type { ModelDef } from \"../interfaces/IAgentConfigRepository.js\";\n\nexport class PrismaAgentConfigRepository implements IAgentConfigRepository {\n  async getRole(roleId: string): Promise<Role | null> {\n    return prisma.role.findUnique({ where: { id: roleId } });\n  }\n\n  async getEffectiveRole(roleId: string): Promise<Role | null> {\n    const role = await this.getRole(roleId);\n    if (!role) return null;\n    return role; // Returning Role, caller handles metadata parsing if needed\n  }\n\n  async getModel(providerId: string, modelId: string): Promise<Model | null> {\n    return prisma.model.findUnique({\n      where: { providerId_modelId: { providerId, modelId } }\n    });\n  }\n\n  async createModel(modelDef: ModelDef): Promise<Model> {\n    return prisma.model.create({\n      data: {\n        modelId: modelDef.id,\n        provider: { connect: { id: modelDef.providerId } },\n        name: modelDef.name || modelDef.id,\n        costPer1k: modelDef.costPer1k ?? 0,\n        isFree: modelDef.isFree ?? false,\n        providerData: (modelDef.providerData ?? {}) as any,\n        specs: {\n            contextWindow: modelDef.contextWindow ?? 4096,\n            hasVision: modelDef.hasVision ?? false,\n            hasReasoning: modelDef.hasReasoning ?? false,\n            hasCoding: modelDef.hasCoding ?? false,\n            lastUpdated: new Date().toISOString()\n        } as any\n      }\n    });\n  }\n\n\n\n  async createRole(data: Prisma.RoleCreateInput): Promise<Role> {\n      return prisma.role.create({ data });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/repositories/ProviderRepository.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[324,327],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[324,327],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[490,493],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[490,493],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[635,638],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[635,638],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ id: string | SQL<unknown> | Placeholder<string, any>; label: string | SQL<unknown> | Placeholder<string, any>; type: string | SQL<unknown> | Placeholder<string, any>; ... 5 more ...; updatedAt?: SQL<...> | ... 2 more ... | undefined; }`.","line":20,"column":45,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":20,"endColumn":51},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[760,763],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[760,763],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[889,892],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[889,892],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ select?: ModelSelect<DefaultArgs> | null | undefined; include?: ModelInclude<DefaultArgs> | null | undefined; where: ModelWhereUniqueInput; create: (Without<...> & ModelUncheckedCreateInput) | (Without<...> & ModelCreateInput); update: (Without<...> & ModelUncheckedUpdateInput) | (Without<...> & ModelUpdateInput); }`.","line":28,"column":31,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":28,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { IProviderRepository } from \"../interfaces/IProviderRepository.js\";\nimport { db, prisma } from \"../db.js\";\nimport { providerConfigs } from \"../db/schema.js\";\nimport { eq } from \"drizzle-orm\";\n\nexport class ProviderRepository implements IProviderRepository {\n  async findProviderConfigByLabel(label: string): Promise<any> {\n    return db.query.providerConfigs.findFirst({\n      where: eq(providerConfigs.label, label)\n    });\n  }\n\n  async findProviderConfigById(id: string): Promise<any> {\n    return db.query.providerConfigs.findFirst({\n      where: eq(providerConfigs.id, id)\n    });\n  }\n\n  async createProviderConfig(values: any): Promise<void> {\n    await db.insert(providerConfigs).values(values);\n  }\n\n  async getEnabledProviderConfigs(): Promise<any[]> {\n    return db.select().from(providerConfigs).where(eq(providerConfigs.isEnabled, true));\n  }\n\n  async upsertModel(data: any): Promise<void> {\n    await prisma.model.upsert(data);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/agent.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/apiExplorer.router.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":24,"column":15,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":24,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":30,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":30,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1067,1070],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1067,1070],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":33,"column":34,"nodeType":"Property","messageId":"anyAssignment","endLine":33,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":33,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":33,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":41,"column":47,"nodeType":"Property","messageId":"anyAssignment","endLine":41,"endColumn":66}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from 'zod';\nimport { createTRPCRouter, publicProcedure } from '../trpc.js';\n\nexport const apiExplorerRouter = createTRPCRouter({\n  executeRequest: publicProcedure\n    .input(z.object({\n      method: z.enum(['GET', 'POST', 'PUT', 'DELETE', 'PATCH']),\n      url: z.string().url(),\n      headers: z.record(z.string()).optional(),\n      body: z.string().optional(),\n    }))\n    .mutation(async ({ input }) => {\n      try {\n        const startTime = Date.now();\n        const response = await fetch(input.url, {\n          method: input.method,\n          headers: { 'Content-Type': 'application/json', ...input.headers },\n          body: input.method !== 'GET' && input.body ? input.body : undefined,\n        });\n        const duration = Date.now() - startTime;\n        \n        let data;\n        const text = await response.text();\n        try { data = JSON.parse(text); } catch { data = { raw: text }; }\n\n        return {\n          success: response.ok,\n          status: response.status,\n          duration,\n          data,\n        };\n      } catch (error: any) {\n        return { success: false, error: error.message };\n      }\n    }),\n\n  saveResponse: publicProcedure\n    .input(z.object({ providerName: z.string(), data: z.any() }))\n    .mutation(async ({ ctx, input }) => {\n      return ctx.prisma.rawDataLake.create({\n        data: { provider: input.providerName, rawData: input.data }\n      });\n    })\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/browser.router.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":49,"column":61,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":49,"endColumn":77},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":49,"column":74,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":77,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1358,1361],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1358,1361],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from 'zod';\nimport { createTRPCRouter, publicProcedure } from '../trpc.js';\nimport { browserService } from '../services/browser.service.js';\n\nexport const browserRouter = createTRPCRouter({\n  navigate: publicProcedure\n    .input(z.object({ \n      sessionId: z.string(),\n      url: z.string().url() \n    }))\n    .mutation(async ({ input }) => {\n      return await browserService.navigate(input.sessionId, input.url);\n    }),\n\n  click: publicProcedure\n    .input(z.object({ \n      sessionId: z.string(),\n      x: z.number(),\n      y: z.number()\n    }))\n    .mutation(async ({ input }) => {\n      return await browserService.click(input.sessionId, input.x, input.y);\n    }),\n\n  scroll: publicProcedure\n    .input(z.object({ \n      sessionId: z.string(),\n      deltaY: z.number()\n    }))\n    .mutation(async ({ input }) => {\n      return await browserService.scroll(input.sessionId, input.deltaY);\n    }),\n\n  type: publicProcedure\n    .input(z.object({ \n      sessionId: z.string(),\n      text: z.string()\n    }))\n    .mutation(async ({ input }) => {\n      return await browserService.type(input.sessionId, input.text);\n    }),\n\n  pressKey: publicProcedure\n    .input(z.object({ \n      sessionId: z.string(),\n      key: z.string()\n    }))\n    .mutation(async ({ input }) => {\n      return await browserService.pressKey(input.sessionId, input.key as any);\n    }),\n\n  goBack: publicProcedure\n    .input(z.object({ sessionId: z.string() }))\n    .mutation(async ({ input }) => {\n      return await browserService.goBack(input.sessionId);\n    }),\n\n  goForward: publicProcedure\n    .input(z.object({ sessionId: z.string() }))\n    .mutation(async ({ input }) => {\n      return await browserService.goForward(input.sessionId);\n    }),\n\n  closeSession: publicProcedure\n    .input(z.object({ sessionId: z.string() }))\n    .mutation(async ({ input }) => {\n      await browserService.closeSession(input.sessionId);\n      return { success: true };\n    }),\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/card.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/codeGraph.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/context.router.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":16,"column":93,"nodeType":"Property","messageId":"anyAssignment","endLine":16,"endColumn":120},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":117,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":120,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[731,734],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[731,734],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from 'zod';\nimport { createTRPCRouter, publicProcedure } from '../trpc.js';\nimport { contextManager } from '../services/ContextManager.js';\n\nexport const contextRouter = createTRPCRouter({\n  getContext: publicProcedure\n    .input(z.object({ roleId: z.string() }))\n    .query(async ({ input }) => {\n      const ctx = await contextManager.getContext(input.roleId);\n      return ctx;\n    }),\n\n  setContext: publicProcedure\n    .input(z.object({ roleId: z.string(), tone: z.string().optional(), style: z.string().optional(), memory: z.record(z.string()).optional() }))\n    .mutation(async ({ input }) => {\n      await contextManager.setContext(input.roleId, { tone: input.tone, style: input.style, memory: input.memory as any });\n      return { success: true };\n    }),\n\n  setMemoryKey: publicProcedure\n    .input(z.object({ roleId: z.string(), key: z.string(), value: z.string() }))\n    .mutation(async ({ input }) => {\n      await contextManager.setMemoryKey(input.roleId, input.key, input.value);\n      return { success: true };\n    }),\n\n  removeMemoryKey: publicProcedure\n    .input(z.object({ roleId: z.string(), key: z.string() }))\n    .mutation(async ({ input }) => {\n      await contextManager.removeMemoryKey(input.roleId, input.key);\n      return { success: true };\n    }),\n\n  clearContext: publicProcedure\n    .input(z.object({ roleId: z.string() }))\n    .mutation(async ({ input }) => {\n      await contextManager.clearContext(input.roleId);\n      return { success: true };\n    }),\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/dataRefinement.router.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":5,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":5,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[198,201],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[198,201],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[214,217],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[214,217],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":14,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":14,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ tableName: string; jsonString: string; options?: any; }`.","line":19,"column":48,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":19,"endColumn":60},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[718,721],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[718,721],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ tableName: string; jsonString: string; options?: any; }`.","line":29,"column":53,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":29,"endColumn":65},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":62,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":65,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1139,1142],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1139,1142],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .$executeRawUnsafe on an `any` value.","line":32,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":32,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .$queryRawUnsafe on an `any` value.","line":33,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":33,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ tableName: string; jsonString: string; options?: any; }`.","line":43,"column":41,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":43,"endColumn":53},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1764,1767],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1764,1767],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":46,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":46,"endColumn":96},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":46,"column":25,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":46,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .$executeRawUnsafe on an `any` value.","line":46,"column":36,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":46,"endColumn":53},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":46,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1909,1912],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1909,1912],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":47,"column":12,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":47,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .some on an `any` value.","line":47,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":47,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":50,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":50,"endColumn":107},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":50,"column":25,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":50,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .filter on an `any` value.","line":50,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":50,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":51,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":51,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":51,"column":22,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":51,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .join on an `any` value.","line":51,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":51,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":52,"column":49,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":52,"endColumn":57}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":24,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport { importJsonToTableHandler } from './dataRefinement.router.js';\n\ndescribe('importJsonToTableHandler', () => {\n  let mockPrisma: any;\n  let ctx: any;\n\n  beforeEach(() => {\n    vi.clearAllMocks();\n    mockPrisma = {\n      $executeRawUnsafe: vi.fn().mockResolvedValue(null),\n      $queryRawUnsafe: vi.fn().mockResolvedValue([{ count: BigInt(1) }]),\n    };\n    ctx = { prisma: mockPrisma, session: null };\n  });\n\n  it('refuses to import into reserved table without explicit allow', async () => {\n    const input = { tableName: 'Role', jsonString: JSON.stringify([{ id: 'r1', name: 'Admin' }]) };\n    await expect(importJsonToTableHandler(ctx, input as any)).rejects.toThrow(/Refusing to import into reserved table/);\n  });\n\n  it('allows import into reserved table when allowReserved and auditReason provided', async () => {\n    const input = {\n      tableName: 'Role',\n      jsonString: JSON.stringify([{ id: 'r1', name: 'Admin' }]),\n      options: { allowReserved: true, auditReason: 'testing import' }\n    };\n\n    const res = await importJsonToTableHandler(ctx, input as any);\n    expect(res).toEqual({ success: true, tableName: 'Role', rowCount: 1 });\n    // Ensure audit table creation and insert were attempted\n    expect(mockPrisma.$executeRawUnsafe).toHaveBeenCalled();\n    expect(mockPrisma.$queryRawUnsafe).toHaveBeenCalled();\n  });\n\n  it('creates id TEXT PRIMARY KEY when preserveIds is true and adds ON CONFLICT when upsertOnConflict is set', async () => {\n    const input = {\n      tableName: 'roles2',\n      jsonString: JSON.stringify([{ id: 'r1', name: 'Admin' }]),\n      options: { preserveIds: true, upsertOnConflict: true }\n    };\n\n    await importJsonToTableHandler(ctx, input as any);\n\n    // The CREATE TABLE call should include 'id TEXT PRIMARY KEY'\n    const createCalls = mockPrisma.$executeRawUnsafe.mock.calls.map((c: any[]) => String(c[0]));\n    expect(createCalls.some((sql: string) => /id TEXT PRIMARY KEY/i.test(sql))).toBeTruthy();\n\n    // The insert SQL should include 'ON CONFLICT (id) DO UPDATE' because upsertOnConflict was true\n    const insertCalls = createCalls.filter((sql: string) => sql.trim().toUpperCase().startsWith('INSERT'));\n    const combined = insertCalls.join('\\n');\n    expect(/ON CONFLICT \\(id\\) DO UPDATE/i.test(combined)).toBeTruthy();\n  });\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/dataRefinement.router.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TurndownService' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cheerio' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":48,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1549,1552],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1549,1552],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":51,"column":33,"nodeType":"Property","messageId":"anyAssignment","endLine":51,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":51,"column":41,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":51,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":52,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":52,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2091,2094],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2091,2094],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":67,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":67,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":76,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":76,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2452,2455],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2452,2455],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any[]`.","line":79,"column":9,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":79,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":80,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":80,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":187,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":187,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6731,6734],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6731,6734],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":209,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":209,"endColumn":85},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":252,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":252,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9470,9473],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9470,9473],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":253,"column":57,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":253,"endColumn":64},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'input' is defined but never used. Allowed unused args must match /^_/u.","line":260,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":260,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":326,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":326,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12221,12224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12221,12224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":337,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":337,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12601,12604],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12601,12604],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":339,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12711,12714],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12711,12714],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":341,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":341,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":341,"column":66,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":341,"endColumn":73},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":367,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":367,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14235,14238],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14235,14238],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":368,"column":60,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":368,"endColumn":67},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async arrow function has no 'await' expression.","line":447,"column":68,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":447,"endColumn":70,"suggestions":[{"messageId":"removeAsync","fix":{"range":[17967,17973],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ctx' is defined but never used. Allowed unused args must match /^_/u.","line":456,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":456,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ctx' is defined but never used. Allowed unused args must match /^_/u.","line":476,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":476,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":562,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":562,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22108,22111],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22108,22111],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":564,"column":84,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":564,"endColumn":91},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ tableName: string; jsonString: string; options?: any; }`.","line":627,"column":50,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":627,"endColumn":62},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":627,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":627,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24482,24485],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24482,24485],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":635,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":635,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24716,24719],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24716,24719],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":640,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":640,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24908,24911],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24908,24911],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":641,"column":58,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":641,"endColumn":65},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":650,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":650,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25213,25216],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25213,25216],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":654,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":654,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":654,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":654,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25479,25482],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25479,25482],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":665,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":665,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25800,25803],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25800,25803],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":677,"column":49,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":677,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .data_type on an `any` value.","line":677,"column":53,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":677,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .is_nullable on an `any` value.","line":678,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":678,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .column_default on an `any` value.","line":679,"column":36,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":679,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .column_default on an `any` value.","line":679,"column":70,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":679,"endColumn":84},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .column_name on an `any` value.","line":682,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":682,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .ordinal_position on an `any` value.","line":682,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":682,"endColumn":72},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .column_name on an `any` value.","line":685,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":685,"endColumn":43},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":719,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":719,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28034,28037],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28034,28037],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":720,"column":67,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":720,"endColumn":74},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async arrow function has no 'await' expression.","line":726,"column":24,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":726,"endColumn":26,"suggestions":[{"messageId":"removeAsync","fix":{"range":[28222,28228],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":740,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":740,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28535,28538],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28535,28538],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":741,"column":70,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":741,"endColumn":77},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":807,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":807,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[31809,31812],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[31809,31812],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":817,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":817,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32130,32133],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32130,32133],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":817,"column":118,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":817,"endColumn":121,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32193,32196],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32193,32196],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":835,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":835,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32905,32908],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32905,32908],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":837,"column":7,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":837,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":851,"column":17,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":851,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":887,"column":19,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":887,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .prisma on an `any` value.","line":887,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":887,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{}`.","line":893,"column":33,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":893,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .preserveIds on an `any` value.","line":898,"column":50,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":898,"endColumn":61},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .preserveCreatedAt on an `any` value.","line":899,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":899,"endColumn":73},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":949,"column":19,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":949,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .prisma on an `any` value.","line":949,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":949,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":959,"column":21,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":959,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access ['id'] on an `any` value.","line":959,"column":31,"nodeType":"Literal","messageId":"unsafeMemberExpression","endLine":959,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access ['source_id'] on an `any` value.","line":959,"column":44,"nodeType":"Literal","messageId":"unsafeMemberExpression","endLine":959,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":961,"column":21,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":961,"endColumn":72},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access ['created_at'] on an `any` value.","line":961,"column":31,"nodeType":"Literal","messageId":"unsafeMemberExpression","endLine":961,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access ['source_created_at'] on an `any` value.","line":961,"column":52,"nodeType":"Literal","messageId":"unsafeMemberExpression","endLine":961,"endColumn":71},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":963,"column":21,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":963,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access [k] on an `any` value.","line":963,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":963,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":970,"column":61,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":970,"endColumn":63},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":970,"column":98,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":970,"endColumn":100},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":972,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":972,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .created_at on an `any` value.","line":975,"column":74,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":975,"endColumn":84},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .created_at on an `any` value.","line":977,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":977,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .upsertOnConflict on an `any` value.","line":989,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":989,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":995,"column":23,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":995,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .prisma on an `any` value.","line":995,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":995,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":1002,"column":34,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":1002,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .prisma on an `any` value.","line":1002,"column":38,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":1002,"endColumn":44},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":1008,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1008,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[41028,41031],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[41028,41031],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":82,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from 'zod';\nimport { createTRPCRouter, publicProcedure, protectedProcedure } from '../trpc.js';\nimport { encrypt } from '../utils/encryption.js'; \nimport { ProviderManager } from '../services/ProviderManager.js'; \nimport { ModelDoctor } from '../services/ModelDoctor.js';\nimport { spawn, execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport TurndownService from 'turndown';\nimport * as cheerio from 'cheerio';\n\n// Helper function to map SQL types to Prisma types\nfunction mapSqlTypeToPrisma(sqlType: string): string {\n  const typeMap: Record<string, string> = {\n    'integer': 'Int',\n    'bigint': 'BigInt',\n    'smallint': 'Int',\n    'serial': 'Int',\n    'bigserial': 'BigInt',\n    'real': 'Float',\n    'double precision': 'Float',\n    'numeric': 'Decimal',\n    'decimal': 'Decimal',\n    'character varying': 'String',\n    'varchar': 'String',\n    'character': 'String',\n    'char': 'String',\n    'text': 'String',\n    'boolean': 'Boolean',\n    'date': 'DateTime',\n    'time': 'DateTime',\n    'timestamp': 'DateTime',\n    'timestamp without time zone': 'DateTime',\n    'timestamp with time zone': 'DateTime',\n    'json': 'Json',\n    'jsonb': 'Json',\n    'uuid': 'String',\n  };\n\n  return typeMap[sqlType.toLowerCase()] || 'String'; // Default to String for unknown types\n}\n\nexport const dataRefinementRouter = createTRPCRouter({\n  \n  // --- 1. LIST TABLES (For your Sidebar) ---\n  listAllTables: publicProcedure.query(async ({ ctx }) => {\n    try {\n      const tables = await ctx.prisma.$queryRawUnsafe<any[]>(\n        `SELECT table_name as name FROM information_schema.tables WHERE table_schema = 'public' ORDER BY name`\n      );\n      return tables.map(t => ({ name: t.name, type: 'table' }));\n    } catch (error) {\n      return [];\n    }\n  }),\n\n  // --- 2. GET DATA (For your Grid) ---\n  getTableData: publicProcedure\n    .input(z.object({ tableName: z.string(), limit: z.number().optional() }))\n    .query(async ({ ctx, input }) => {\n      const limit = input.limit || 1000;\n      try {\n        const rows = await ctx.prisma.$queryRawUnsafe<any[]>(\n          `SELECT * FROM \"${input.tableName}\" LIMIT ${limit}`\n        );\n        return { rows };\n      } catch (error) {\n        return { rows: [] };\n      }\n    }),\n\n  previewTable: publicProcedure\n    .input(z.object({ tableName: z.string() }))\n    .query(async ({ ctx, input }) => {\n      try {\n        const rows = await ctx.prisma.$queryRawUnsafe<any[]>(\n          `SELECT * FROM \"${input.tableName}\" LIMIT 100`\n        );\n        return rows;\n      } catch (error) {\n        return [];\n      }\n    }),\n\n  // --- 3. THE \"DO IT ALL\" MUTATION ---\n  addProviderAndIngest: publicProcedure\n    .input(z.object({\n      label: z.string(),\n      type: z.string(),\n      apiKey: z.string(),\n      baseURL: z.string().optional(),\n      tableName: z.string().optional(), // User can specify table name\n    }))\n    .mutation(async ({ ctx, input }) => {\n      const { RawModelService } = await import('../services/RawModelService.js');\n      \n      // A. Save Config\n      const encryptedKey = input.apiKey ? encrypt(input.apiKey) : '';\n      const newProvider = await ctx.prisma.providerConfig.create({\n        data: {\n          label: input.label,\n          type: input.type,\n          apiKey: encryptedKey,\n          baseURL: input.baseURL,\n          isEnabled: true,\n        }\n      });\n      // Reinitialize providers so new provider is available immediately\n      await ProviderManager.initialize();\n      \n      // B. Fetch Raw JSON (The \"Blob\")\n      const snapshot = await RawModelService.fetchAndSnapshot(newProvider.id);\n      \n      // C. AUTOMATICALLY FLATTEN INTO A TABLE (The \"Separated Rows\")\n      // Use user-provided name or default to a safe name based on provider label\n      const safeLabel = input.label.replace(/[^a-zA-Z0-9_]/g, '_').toLowerCase();\n      const newTableName = input.tableName || `refined_${safeLabel}`;\n      \n      try {\n        // 1. Drop old table to start fresh (if it exists)\n        await ctx.prisma.$executeRawUnsafe(`DROP TABLE IF EXISTS \"${newTableName}\"`);\n\n        // 2. Run the Magic SQL to extract rows\n        // DYNAMICALLY EXTRACT ALL KEYS WITHOUT GUESSING\n        \n        // Step A: Inspect the JSON to find ALL possible keys in the array\n        // We use the specific snapshot.id to ensure we target the right data\n        const keysResult = await ctx.prisma.$queryRawUnsafe<{key: string}[]>(`\n          SELECT DISTINCT jsonb_object_keys(elem) as key\n          FROM \"RawDataLake\",\n               jsonb_array_elements(\n                  CASE \n                    WHEN jsonb_typeof(\"rawData\") = 'array' THEN \"rawData\"\n                    WHEN \"rawData\" ? 'data' THEN \"rawData\"->'data'\n                    WHEN \"rawData\" ? 'models' THEN \"rawData\"->'models' -- Google/Vertex often uses 'models'\n                    WHEN \"rawData\" ? 'items' THEN \"rawData\"->'items'   -- Another common standard\n                    ELSE '[]'::jsonb \n                  END\n               ) as elem\n          WHERE \"RawDataLake\".id = '${snapshot.id}'\n        `);\n\n        // Step B: Build a dynamic CREATE TABLE statement\n        // Filter out 'id' from the dynamic list to avoid collision with our PK\n        const keys = keysResult.map(k => k.key).filter(k => k !== 'id');\n        \n        // Always include an ID (PK)\n        let columnsSql = `gen_random_uuid()::text as id, `;\n\n        // Explicitly preserve the provider's 'id' as 'model_id' if it exists\n        const hasId = keysResult.some(k => k.key === 'id');\n        if (hasId) {\n            columnsSql += `elem->>'id' as \"model_id\", `;\n        }\n        \n        if (keys.length > 0) {\n           columnsSql += keys.map(k => `elem->>'${k}' as \"${k}\"`).join(', ');\n        } else {\n           if (!hasId) columnsSql += `'unknown' as _status`; \n        }\n\n        const dynamicQuery = `\n          CREATE TABLE \"${newTableName}\" AS\n          SELECT \n            ${columnsSql}\n          FROM \"RawDataLake\",\n               jsonb_array_elements(\n                  CASE \n                    WHEN jsonb_typeof(\"rawData\") = 'array' THEN \"rawData\"\n                    WHEN \"rawData\" ? 'data' THEN \"rawData\"->'data'\n                    WHEN \"rawData\" ? 'models' THEN \"rawData\"->'models'\n                    WHEN \"rawData\" ? 'items' THEN \"rawData\"->'items'\n                    ELSE '[]'::jsonb \n                  END\n               ) as elem\n          WHERE \"RawDataLake\".id = '${snapshot.id}'\n        `;\n\n        await ctx.prisma.$executeRawUnsafe(dynamicQuery);\n\n        // Return the CLEAN table name, so the UI switches to it immediately\n        return { \n          success: true,\n          tableName: newTableName \n        };\n\n      } catch (error: any) {\n        console.error(\"Auto-flatten failed:\", error);\n        // Fallback to raw table if flattening fails, but with an error message\n        return { \n          success: false,\n          tableName: 'RawDataLake',\n          error: \"Fetched data but couldn't flatten it. Check RawDataLake.\"\n        };\n      }\n    }),\n\n  // --- 4. EDITING TOOLS (Delete, Update) ---\n  deleteTable: publicProcedure\n    .input(z.object({ tableName: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      await ctx.prisma.$executeRawUnsafe(`DROP TABLE IF EXISTS \"${input.tableName}\" CASCADE`);\n      return { success: true };\n    }),\n\n  updateCell: publicProcedure\n    .input(z.object({ tableName: z.string(), rowId: z.string(), column: z.string(), value: z.any() }))\n    .mutation(async ({ ctx, input }) => {\n      const val = typeof input.value === 'string' ? `'${input.value}'` : input.value;\n      await ctx.prisma.$executeRawUnsafe(`UPDATE \"${input.tableName}\" SET \"${input.column}\" = ${val} WHERE id = '${input.rowId}'`);\n      return { success: true };\n    }),\n\n  // --- 5. SCHEMA MANAGEMENT ---\n  addColumn: publicProcedure\n    .input(z.object({ tableName: z.string(), columnName: z.string(), type: z.string().default('TEXT') }))\n    .mutation(async ({ ctx, input }) => {\n      await ctx.prisma.$executeRawUnsafe(`ALTER TABLE \"${input.tableName}\" ADD COLUMN \"${input.columnName}\" ${input.type}`);\n      return { success: true };\n    }),\n\n  dropColumn: publicProcedure\n    .input(z.object({ tableName: z.string(), columnName: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      await ctx.prisma.$executeRawUnsafe(`ALTER TABLE \"${input.tableName}\" DROP COLUMN \"${input.columnName}\"`);\n      return { success: true };\n    }),\n\n  createTable: publicProcedure\n    .input(z.object({ tableName: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      // Create a table with a default ID column\n      await ctx.prisma.$executeRawUnsafe(`\n        CREATE TABLE \"${input.tableName}\" (\n          id text PRIMARY KEY DEFAULT gen_random_uuid()::text,\n          created_at timestamp DEFAULT now()\n        )\n      `);\n      return { success: true };\n    }),\n\n  saveQueryResults: publicProcedure\n    .input(z.object({ query: z.string(), newTableName: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      try {\n        // Clean the query - remove trailing semicolons\n        const cleanQuery = input.query.trim().replace(/;+$/, '');\n        \n        await ctx.prisma.$executeRawUnsafe(`DROP TABLE IF EXISTS \"${input.newTableName}\"`);\n        await ctx.prisma.$executeRawUnsafe(`CREATE TABLE \"${input.newTableName}\" AS (${cleanQuery})`);\n        return { success: true, newTableName: input.newTableName };\n      } catch (error: any) {\n        throw new Error(`Transformation failed: ${error.message}`);\n      }\n    }),\n\n    // Stubs for other UI calls\n    flattenRawData: publicProcedure\n    .input(z.object({ tableName: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      // 1. Find the latest RawDataLake entry\n      const latestSnapshot = await ctx.prisma.rawDataLake.findFirst({\n        orderBy: { ingestedAt: 'desc' }\n      });\n\n      if (!latestSnapshot) {\n        throw new Error(\"No raw data found to flatten.\");\n      }\n\n      const newTableName = \"refined_models_manual\";\n\n      // 2. Dynamic Extraction (Same logic as addProviderAndIngest)\n      try {\n        await ctx.prisma.$executeRawUnsafe(`DROP TABLE IF EXISTS \"${newTableName}\"`);\n\n        const keysResult = await ctx.prisma.$queryRawUnsafe<{key: string}[]>(`\n          SELECT DISTINCT jsonb_object_keys(elem) as key\n          FROM \"RawDataLake\",\n               jsonb_array_elements(\n                  CASE \n                    WHEN jsonb_typeof(\"rawData\") = 'array' THEN \"rawData\"\n                    WHEN \"rawData\" ? 'data' THEN \"rawData\"->'data'\n                    WHEN \"rawData\" ? 'models' THEN \"rawData\"->'models'\n                    WHEN \"rawData\" ? 'items' THEN \"rawData\"->'items'\n                    ELSE '[]'::jsonb \n                  END\n               ) as elem\n          WHERE \"RawDataLake\".id = '${latestSnapshot.id}'\n        `);\n\n        const keys = keysResult.map(k => k.key).filter(k => k !== 'id');\n        let columnsSql = `gen_random_uuid()::text as id, `;\n\n        // Explicitly preserve the provider's 'id' as 'model_id' if it exists\n        const hasId = keysResult.some(k => k.key === 'id');\n        if (hasId) {\n            columnsSql += `elem->>'id' as \"model_id\", `;\n        }\n        \n        if (keys.length > 0) {\n           columnsSql += keys.map(k => `elem->>'${k}' as \"${k}\"`).join(', ');\n        } else {\n           if (!hasId) columnsSql += `'unknown' as _status`; \n        }\n\n        const dynamicQuery = `\n          CREATE TABLE \"${newTableName}\" AS\n          SELECT \n            ${columnsSql}\n          FROM \"RawDataLake\",\n               jsonb_array_elements(\n                  CASE \n                    WHEN jsonb_typeof(\"rawData\") = 'array' THEN \"rawData\"\n                    WHEN \"rawData\" ? 'data' THEN \"rawData\"->'data'\n                    WHEN \"rawData\" ? 'models' THEN \"rawData\"->'models'\n                    WHEN \"rawData\" ? 'items' THEN \"rawData\"->'items'\n                    ELSE '[]'::jsonb \n                  END\n               ) as elem\n          WHERE \"RawDataLake\".id = '${latestSnapshot.id}'\n        `;\n\n        await ctx.prisma.$executeRawUnsafe(dynamicQuery);\n\n        return { success: true, tableName: newTableName };\n      } catch (error: any) {\n        console.error(\"Manual flatten failed:\", error);\n        throw new Error(\"Failed to flatten data.\");\n      }\n    }),\n\n    // Execute arbitrary SQL query and return results\n    executeQuery: publicProcedure\n      .input(z.object({ query: z.string() }))\n      .mutation(async ({ ctx, input }) => {\n        try {\n          const rows = await ctx.prisma.$queryRawUnsafe<any[]>(input.query);\n          return { success: true, rows, rowCount: rows.length };\n        } catch (error: any) {\n          // Surface DB error with the original query to aid debugging (do not expose secrets)\n          const errMsg = (error && error.message) ? String(error.message) : String(error);\n          console.error(`[Query Exec] Failed to execute query. Error: ${errMsg}\\nQuery: ${input.query}`);\n          // Provide actionable hint for missing columns\n          if (/column .* does not exist/i.test(errMsg)) {\n            throw new Error(`Query failed: ${errMsg}. Hint: check column names and quoting in your SQL. Query: ${input.query}`);\n          }\n          throw new Error(`Query failed: ${errMsg}`);\n        }\n      }),\n\n    // Cache models for C.O.R.E. - copies current table to core_models for app use\n    cacheModelsForCore: publicProcedure\n      .input(z.object({ sourceTable: z.string() }))\n      .mutation(async ({ ctx, input }) => {\n        try {\n          const targetTable = 'core_models';\n          \n          // Drop and recreate core_models with the same structure as source\n          await ctx.prisma.$executeRawUnsafe(`DROP TABLE IF EXISTS \"${targetTable}\"`);\n          await ctx.prisma.$executeRawUnsafe(`CREATE TABLE \"${targetTable}\" AS SELECT * FROM \"${input.sourceTable}\"`);\n          \n          // Count the models\n          const result = await ctx.prisma.$queryRawUnsafe<[{ count: bigint }]>(`SELECT COUNT(*) as count FROM \"${targetTable}\"`);\n          const count = Number(result[0].count);\n          \n          return { success: true, count, tableName: targetTable };\n        } catch (error: any) {\n          throw new Error(`Failed to cache models: ${error.message}`);\n        }\n      }),\n\n    // Refresh normalized Model registry from a curated table (no schema changes to source)\n    refreshModelsFromTable: publicProcedure\n      .input(z.object({\n        sourceTable: z.string().default('my_free_models'),\n        providerId: z.string().optional(),\n        // Default flags if missing on source rows\n        defaultContextWindow: z.number().int().optional().default(8192),\n        defaultHasReasoning: z.boolean().optional().default(true),\n        defaultHasCoding: z.boolean().optional().default(true),\n        defaultIsFree: z.boolean().optional().default(true),\n        defaultCostPer1k: z.number().optional().default(0),\n        providerTypeHint: z.string().optional().default('ollama'),\n      }))\n      .mutation(async ({ ctx, input }) => {\n        // 1) Resolve providerId\n        let providerId = input.providerId || null;\n        if (!providerId) {\n          const p = await ctx.prisma.providerConfig.findFirst({\n            where: { type: input.providerTypeHint, isEnabled: true },\n            orderBy: { createdAt: 'desc' },\n            select: { id: true }\n          });\n          if (!p) throw new Error(`No enabled provider found for type '${input.providerTypeHint}'.`);\n          providerId = p.id;\n        }\n\n        // 2) Dynamically detect column names in the source table\n        const columnsRaw = await ctx.prisma.$queryRawUnsafe<{ column_name: string }[]>(\n          `SELECT column_name FROM information_schema.columns \n           WHERE table_name = '${input.sourceTable}' \n           AND table_schema = 'public'`\n        );\n        const columns = columnsRaw.map(c => c.column_name);\n\n        // Find the correct column names using common conventions\n        const modelIdCol = ['model_id', 'modelId', 'id', 'model_name', 'name'].find(c => columns.includes(c));\n        const nameCol = ['name', 'model_name', 'modelName', 'model_id', 'id'].find(c => columns.includes(c));\n        const providerIdCol = ['provider_id', 'providerId', 'provider', 'data_source'].find(c => columns.includes(c));\n\n        if (!modelIdCol) {\n          throw new Error(`Could not find model ID column in table '${input.sourceTable}'. Available columns: ${columns.join(', ')}`);\n        }\n\n        // 3) Replace strategy: delete existing for provider, then insert fresh from source\n        await ctx.prisma.$executeRawUnsafe(`DELETE FROM \"Model\" WHERE \"providerId\" = '${providerId}'`);\n\n        // 4) Build dynamic SQL query\n        const providerFilter = providerIdCol \n          ? `AND m.\"${providerIdCol}\" = '${providerId}'`\n          : ''; // If no provider column, import all rows\n\n        const sql = `\n          INSERT INTO \"Model\" (\n            id, \"providerId\", \"modelId\", \"name\", \"providerData\"\n          )\n          SELECT \n            gen_random_uuid()::text as id,\n            '${providerId}' as \"providerId\",\n            m.\"${modelIdCol}\" as \"modelId\",\n            COALESCE(${nameCol ? `m.\"${nameCol}\"` : `m.\"${modelIdCol}\"`}, m.\"${modelIdCol}\") as \"name\",\n            to_jsonb(m) as \"providerData\"\n          FROM \"${input.sourceTable}\" m\n          WHERE m.\"${modelIdCol}\" IS NOT NULL\n            ${providerFilter}\n        `;\n\n        const insertedCount = await ctx.prisma.$executeRawUnsafe(sql);\n\n        // 5) Return counts for visibility\n        const [{ count }] = await ctx.prisma.$queryRawUnsafe<[{ count: bigint }]>(\n          `SELECT COUNT(*) as count FROM \"Model\" WHERE \"providerId\" = '${providerId}'`\n        );\n        return { success: true, providerId, insertedCount: Number(insertedCount), totalForProvider: Number(count) };\n      }),\n\n    promoteToApp: publicProcedure.input(z.any()).mutation(async () => ({ count: 0 })),\n\n    // --- MODEL DOCTOR ---\n    healData: protectedProcedure\n      .input(z.object({\n        modelId: z.string().optional(),\n        providerId: z.string().optional(),\n        runAll: z.boolean().optional()\n      }))\n      .mutation(async ({ ctx, input }) => {\n        // Instantiate ModelDoctor with no arguments (constructor expects none now)\n        const doctor = new ModelDoctor();\n\n        if (input.modelId) {\n          const result = await doctor.healModel(input.modelId);\n          return { success: true, results: [result] };\n        }\n\n        if (input.runAll) {\n          const stats = await doctor.healModels();\n          return { success: true, stats };\n        }\n\n        return { success: false, message: \"No target specified\" };\n      }),\n\n    // Expose a dedicated single-model endpoint if callers prefer it\n    healModel: protectedProcedure\n      .input(z.object({ modelId: z.string() }))\n      .mutation(async ({ ctx, input }) => {\n        const doctor = new ModelDoctor();\n        const result = await doctor.healModel(input.modelId);\n        return result;\n      }),\n\n  // --- REFRESH DATA (Recovery Feature) ---\n  refreshProviderData: protectedProcedure\n    .input(z.object({\n      providerId: z.string(),\n      targetTableName: z.string()\n    }))\n    .mutation(async ({ ctx, input }) => {\n      const { RawModelService } = await import('../services/RawModelService.js');\n\n      // 1. Fetch Provider Config\n      const provider = await ctx.prisma.providerConfig.findUnique({\n        where: { id: input.providerId }\n      });\n\n      if (!provider) {\n        throw new Error(`Provider with ID ${input.providerId} not found.`);\n      }\n\n      // 2. Fetch Raw JSON (The \"Blob\")\n      // We re-use the fetchAndSnapshot logic which handles the API call\n      const snapshot = await RawModelService.fetchAndSnapshot(provider.id);\n\n      // 3. FLATTEN INTO TARGET TABLE\n      const newTableName = input.targetTableName;\n\n      try {\n        // Drop old table to start fresh\n        await ctx.prisma.$executeRawUnsafe(`DROP TABLE IF EXISTS \"${newTableName}\"`);\n\n        // Dynamic Extraction Logic (Reused)\n        const keysResult = await ctx.prisma.$queryRawUnsafe<{key: string}[]>(`\n          SELECT DISTINCT jsonb_object_keys(elem) as key\n          FROM \"RawDataLake\",\n               jsonb_array_elements(\n                  CASE \n                    WHEN jsonb_typeof(\"rawData\") = 'array' THEN \"rawData\"\n                    WHEN \"rawData\" ? 'data' THEN \"rawData\"->'data'\n                    WHEN \"rawData\" ? 'models' THEN \"rawData\"->'models'\n                    WHEN \"rawData\" ? 'items' THEN \"rawData\"->'items'\n                    ELSE '[]'::jsonb \n                  END\n               ) as elem\n          WHERE \"RawDataLake\".id = '${snapshot.id}'\n        `);\n\n        const keys = keysResult.map(k => k.key).filter(k => k !== 'id');\n        \n        let columnsSql = `gen_random_uuid()::text as id, `;\n        const hasId = keysResult.some(k => k.key === 'id');\n        if (hasId) {\n            columnsSql += `elem->>'id' as \"model_id\", `;\n        }\n        \n        if (keys.length > 0) {\n           columnsSql += keys.map(k => `elem->>'${k}' as \"${k}\"`).join(', ');\n        } else {\n           if (!hasId) columnsSql += `'unknown' as _status`; \n        }\n\n        const dynamicQuery = `\n          CREATE TABLE \"${newTableName}\" AS\n          SELECT \n            ${columnsSql}\n          FROM \"RawDataLake\",\n               jsonb_array_elements(\n                  CASE \n                    WHEN jsonb_typeof(\"rawData\") = 'array' THEN \"rawData\"\n                    WHEN \"rawData\" ? 'data' THEN \"rawData\"->'data'\n                    WHEN \"rawData\" ? 'models' THEN \"rawData\"->'models'\n                    WHEN \"rawData\" ? 'items' THEN \"rawData\"->'items'\n                    ELSE '[]'::jsonb \n                  END\n               ) as elem\n          WHERE \"RawDataLake\".id = '${snapshot.id}'\n        `;\n\n        await ctx.prisma.$executeRawUnsafe(dynamicQuery);\n\n        return { success: true, tableName: newTableName, rowCount: 0 }; // TODO: Return actual count if needed\n\n      } catch (error: any) {\n        console.error(\"Refresh flatten failed:\", error);\n        throw new Error(`Failed to refresh data for table ${newTableName}: ${error.message}`);\n      }\n    }),\n\n  // --- 6. SAVED QUERIES ---\n  saveMigrationQuery: protectedProcedure\n    .input(z.object({\n      name: z.string(),\n      query: z.string(),\n      targetTable: z.string().optional()\n    }))\n    .mutation(async ({ ctx, input }) => {\n      return ctx.prisma.savedQuery.upsert({\n        where: { name: input.name },\n        update: { query: input.query, targetTable: input.targetTable },\n        create: { name: input.name, query: input.query, targetTable: input.targetTable }\n      });\n    }),\n\n  listSavedQueries: publicProcedure\n    .query(async ({ ctx }) => {\n      console.log('Fetching saved queries...');\n      const queries = await ctx.prisma.savedQuery.findMany({ orderBy: { updatedAt: 'desc' } });\n      console.log(`Found ${queries.length} saved queries.`);\n      // Return as strings to avoid SuperJSON serialization issues\n      return queries.map(q => ({\n        ...q,\n        updatedAt: q.updatedAt.toISOString()\n      }));\n    }),\n\n  executeSavedQuery: protectedProcedure\n    .input(z.object({ name: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      const saved = await ctx.prisma.savedQuery.findUnique({ where: { name: input.name } });\n      if (!saved) throw new Error(`Query \"${input.name}\" not found.`);\n      \n      // Execute the saved SQL\n      const rows = await ctx.prisma.$executeRawUnsafe(saved.query);\n      \n      return { success: true, rowsAffected: rows, queryName: saved.name };\n    }),\n\n  deleteSavedQuery: protectedProcedure\n    .input(z.object({ name: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      await ctx.prisma.savedQuery.delete({ where: { name: input.name } });\n      return { success: true };\n    }),\n\n  importJsonToTable: publicProcedure\n    .input(z.object({\n        tableName: z.string(),\n        jsonString: z.string(),\n        options: z.object({\n          allowReserved: z.boolean().optional(),\n          preserveIds: z.boolean().optional(),\n          preserveCreatedAt: z.boolean().optional(),\n          upsertOnConflict: z.boolean().optional(),\n          auditReason: z.string().optional()\n        }).optional()\n    }))\n    .mutation(async ({ ctx, input }) => {\n      return await importJsonToTableHandler(ctx, input as any);\n    }),\n\n  // Export table to JSON\n  exportTableToJson: publicProcedure\n    .input(z.object({ tableName: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      try {\n        const rows = await ctx.prisma.$queryRawUnsafe<any[]>(\n          `SELECT * FROM \"${input.tableName}\"`\n        );\n        const jsonString = JSON.stringify(rows, null, 2);\n        return { success: true, jsonString };\n      } catch (error: any) {\n        throw new Error(`Failed to export table: ${error.message}`);\n      }\n    }),\n\n  // Get table schema\n  getTableSchema: publicProcedure\n    .input(z.object({ tableName: z.string() }))\n    .query(async ({ ctx, input }) => {\n      try {\n        const columns = await ctx.prisma.$queryRawUnsafe<any[]>(\n          `SELECT column_name, data_type, is_nullable, column_default FROM information_schema.columns WHERE table_name = '${input.tableName}' AND table_schema = 'public' ORDER BY ordinal_position`\n        );\n        return { columns };\n      } catch (error: any) {\n        return { columns: [] };\n      }\n    }),\n\n  // Generate Prisma model for a table\n  generatePrismaModel: publicProcedure\n    .input(z.object({ tableName: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      try {\n        // Get table schema\n        const columns = await ctx.prisma.$queryRawUnsafe<any[]>(\n          `SELECT column_name, data_type, is_nullable, column_default, ordinal_position FROM information_schema.columns WHERE table_name = '${input.tableName}' AND table_schema = 'public' ORDER BY ordinal_position`\n        );\n\n        if (columns.length === 0) {\n          throw new Error(`Table '${input.tableName}' not found or has no columns`);\n        }\n\n        // Generate Prisma model\n        let modelDef = `model ${input.tableName} {\\n`;\n\n        for (const col of columns) {\n          const prismaType = mapSqlTypeToPrisma(col.data_type);\n          const nullable = col.is_nullable === 'YES' ? '?' : '';\n          const defaultValue = col.column_default ? ` @default(${col.column_default})` : '';\n\n          // Handle primary key (assume first column or 'id' column)\n          const isId = col.column_name === 'id' || col.ordinal_position === 1;\n          const idAnnotation = isId ? ' @id' : '';\n\n          modelDef += `  ${col.column_name} ${prismaType}${nullable}${idAnnotation}${defaultValue}\\n`;\n        }\n\n        modelDef += `}\\n`;\n\n        // Read current schema file\n        const schemaPath = path.join(process.cwd(), 'prisma', 'schema.prisma');\n        let schemaContent = fs.readFileSync(schemaPath, 'utf8');\n\n        // Create backup before making changes\n        const backupPath = `${schemaPath}.backup`;\n        fs.writeFileSync(backupPath, schemaContent);\n\n        // Check if model already exists\n        const modelRegex = new RegExp(`model ${input.tableName} \\\\{[^}]*\\\\}`, 'g');\n        const existingModel = schemaContent.match(modelRegex);\n\n        if (existingModel) {\n          // Replace existing model\n          schemaContent = schemaContent.replace(modelRegex, modelDef);\n        } else {\n          // Add new model at the end\n          schemaContent = schemaContent.trim() + '\\n\\n' + modelDef;\n        }\n\n        // Write back\n        fs.writeFileSync(schemaPath, schemaContent);\n\n        return {\n          success: true,\n          model: modelDef,\n          message: `Prisma model for '${input.tableName}' ${existingModel ? 'updated' : 'added'} to schema.prisma. Backup created at schema.prisma.backup. Run 'npx prisma generate' to update the client.`\n        };\n\n      } catch (error: any) {\n        throw new Error(`Failed to generate Prisma model: ${error.message}`);\n      }\n    }),\n\n  // Regenerate Prisma client\n  regeneratePrismaClient: publicProcedure\n    .mutation(async () => {\n      try {\n        \n        // Run prisma generate\n        execSync('npx prisma generate', { \n          cwd: process.cwd(),\n          stdio: 'pipe'\n        });\n\n        return {\n          success: true,\n          message: 'Prisma client regenerated successfully!'\n        };\n\n      } catch (error: any) {\n        throw new Error(`Failed to regenerate Prisma client: ${error.message}`);\n      }\n    }),\n\n    renameTableModel: protectedProcedure\n        .input(z.object({\n            oldTableName: z.string(),\n            newTableName: z.string(),\n            oldModelName: z.string(),\n            newModelName: z.string(),\n        }))\n        .mutation(async ({ ctx, input }) => {\n            const { oldTableName, newTableName, oldModelName, newModelName } = input;\n\n            try {\n                console.log(`[Rename] Starting rename from ${oldTableName} to ${newTableName}, model ${oldModelName} to ${newModelName}`);\n\n                // Step 1: Create backup of current schema\n                const schemaPath = path.join(process.cwd(), 'prisma', 'schema.prisma');\n                const backupPath = `${schemaPath}.backup.${Date.now()}`;\n                fs.copyFileSync(schemaPath, backupPath);\n                console.log(`[Rename] Schema backup created at ${backupPath}`);\n\n                // Step 2: Read current schema\n                const schemaContent = fs.readFileSync(schemaPath, 'utf-8');\n\n                // Step 3: Update model name in schema using regex\n                const modelRegex = new RegExp(`(model ${oldModelName}\\\\s+\\\\{)`, 'g');\n                const updatedSchema = schemaContent.replace(modelRegex, `model ${newModelName} {`);\n\n                // Step 4: Update table name references in model (@@map directive)\n                const mapRegex = new RegExp(`(@@map\\\\(\"${oldTableName}\"\\\\))`, 'g');\n                const finalSchema = updatedSchema.replace(mapRegex, `@@map(\"${newTableName}\")`);\n\n                // Step 5: Write updated schema\n                fs.writeFileSync(schemaPath, finalSchema);\n                console.log(`[Rename] Schema updated: model ${oldModelName} -> ${newModelName}, table ${oldTableName} -> ${newTableName}`);\n\n                // Step 6: Regenerate Prisma client\n                await new Promise((resolve, reject) => {\n                    const prismaGenerate = spawn('npx', ['prisma', 'generate'], {\n                        cwd: process.cwd(),\n                        stdio: 'inherit'\n                    });\n                    prismaGenerate.on('close', (code) => {\n                        if (code === 0) {\n                            console.log('[Rename] Prisma client regenerated successfully');\n                            resolve(void 0);\n                        } else {\n                            reject(new Error(`Prisma generate failed with code ${code}`));\n                        }\n                    });\n                    prismaGenerate.on('error', reject);\n                });\n\n                // Step 7: Rename the database table\n                const renameQuery = `ALTER TABLE \"${oldTableName}\" RENAME TO \"${newTableName}\";`;\n                await ctx.prisma.$executeRawUnsafe(renameQuery);\n                console.log(`[Rename] Database table renamed from ${oldTableName} to ${newTableName}`);\n\n                return {\n                    success: true,\n                    message: `Successfully renamed table from ${oldTableName} to ${newTableName} and model from ${oldModelName} to ${newModelName}`,\n                    backupPath\n                };\n\n            } catch (error: any) {\n                const errMsg = (error as Error).message || String(error);\n                console.error(`[Rename] Failed to rename table/model:`, errMsg);\n                throw new Error(`Rename operation failed: ${errMsg}`);\n            }\n        })\n\n  });\n\n\n  export async function importJsonToTableHandler(ctx: any, input: { tableName: string; jsonString: string; options?: any }) {\n    // Helper function to validate UUID\n    function isValidUUID(str: string): boolean {\n      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;\n      return uuidRegex.test(str);\n    }\n\n    // Validate and sanitize table name\n    const safeTableName = input.tableName.trim().replace(/[^a-zA-Z0-9_]/g, '_');\n    if (!safeTableName || safeTableName.match(/^\\d/)) {\n      throw new Error(\"Invalid table name. Must contain letters, numbers, or underscores and not start with a number.\");\n    }\n\n    const { jsonString } = input;\n    \n    console.log(`[Import] Starting JSON import to table: ${safeTableName}`);\n\n    // Parse and validate JSON\n    let jsonData: any[];\n    try {\n      jsonData = JSON.parse(jsonString);\n      if (!Array.isArray(jsonData)) {\n        throw new Error(\"JSON must be an array of objects\");\n      }\n      if (jsonData.length === 0) {\n        throw new Error(\"JSON array is empty\");\n      }\n      console.log(`[Import] Parsed ${jsonData.length} records from JSON`);\n    } catch (e) {\n      const errMsg = (e as Error).message || String(e);\n      throw new Error(`Invalid JSON: ${errMsg}`);\n    }\n\n    try {\n          const opts = input.options || {};\n\n          // Prevent accidental destructive imports into core schema tables unless explicitly allowed\n          // const reserved = new Set(['role','model','modelconfig','modelusage','job','_preferredmodels','provider','providerconfig']);\n          // if (reserved.has(safeTableName.toLowerCase()) && !opts.allowReserved) {\n          //   throw new Error(`Refusing to import into reserved table \"${safeTableName}\". Pass options.allowReserved=true and an auditReason to proceed.`);\n          // }\n\n          // If user is explicitly allowing reserved imports, require an audit reason to reduce accidental destructive actions\n          // if (reserved.has(safeTableName.toLowerCase()) && opts.allowReserved && !opts.auditReason) {\n          //   throw new Error(`Imports into reserved tables require an auditReason when allowReserved=true.`);\n          // }\n\n          // Create a simple audit table if it doesn't exist and record the import action\n          // if (opts.allowReserved) {\n          //   try {\n          //     await ctx.prisma.$executeRawUnsafe(`\n          //       CREATE TABLE IF NOT EXISTS \"ImportAudit\" (\n          //       id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n          //       table_name TEXT,\n          //       options JSONB,\n          //       initiated_by TEXT,\n          //       note TEXT,\n          //       created_at TIMESTAMP DEFAULT NOW()\n          //       )\n          //     `);\n\n          //     const initiatedBy = (ctx.session && (ctx.session as any).user?.email) ? (ctx.session as any).user.email : null;\n          //     await ctx.prisma.$executeRawUnsafe(`INSERT INTO \"ImportAudit\" (table_name, options, initiated_by, note) VALUES ('${safeTableName}', '${JSON.stringify(opts).replace(/'/g, \"''\")}'::jsonb, ${initiatedBy ? `'${String(initiatedBy).replace(/'/g, \"''\")}'` : 'NULL'}, '${String(opts.auditReason || 'allowed by operator').replace(/'/g, \"''\")}')`);\n          //   } catch (e) {\n          //     console.warn('[Import] Failed to record audit entry:', e);\n          //   }\n          // }\n\n            // Drop existing table\n            console.log(`[Import] Dropping table if exists: ${safeTableName}`);\n            await ctx.prisma.$executeRawUnsafe(`DROP TABLE IF EXISTS \"${safeTableName}\"`);\n\n            // Extract all unique keys from all objects\n            const keysSet = new Set<string>();\n            jsonData.forEach(obj => {\n                if (obj && typeof obj === 'object' && !Array.isArray(obj)) {\n                    Object.keys(obj).forEach(k => keysSet.add(k));\n                }\n            });\n\n            // Handle id & created_at renames based on options\n            const optsPreserveIds = Boolean(opts.preserveIds);\n            const optsPreserveCreatedAt = Boolean(opts.preserveCreatedAt);\n\n            const hasIncomingId = keysSet.has('id');\n            if (hasIncomingId) {\n              if (optsPreserveIds) {\n                // keep 'id' as-is so it becomes the table PK\n                keysSet.delete('id');  // remove from columnDefs since it's defined separately\n                console.log(`[Import] Preserving incoming 'id' as table PK`);\n              } else {\n                keysSet.delete('id');\n                keysSet.add('source_id');\n                console.log(`[Import] Renaming incoming 'id' column to 'source_id' to avoid PK collision`);\n              }\n            }\n\n            const hasIncomingCreatedAt = keysSet.has('created_at');\n            if (hasIncomingCreatedAt) {\n              if (optsPreserveCreatedAt) {\n                console.log(`[Import] Preserving incoming 'created_at' values into created_at column`);\n                keysSet.delete('created_at');  // remove from columnDefs since it's defined separately\n              } else {\n                keysSet.delete('created_at');\n                keysSet.add('source_created_at');\n                console.log(`[Import] Renaming incoming 'created_at' to 'source_created_at' to avoid collision`);\n              }\n            }\n\n            const keys = Array.from(keysSet).sort();\n            console.log(`[Import] Found columns: ${keys.join(', ')}`);\n\n            if (keys.length === 0) {\n                throw new Error(\"No keys found in JSON objects\");\n            }\n\n            // Build CREATE TABLE statement with TEXT columns\n            const columnDefs = keys.map(k => `\"${k}\" TEXT`).join(', ');\n            // Always use UUID with DEFAULT for id\n            const idColumnSql = `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`;\n            // Always use TIMESTAMP with DEFAULT NOW() for created_at\n            const createdAtSql = `created_at TIMESTAMP DEFAULT NOW()`;\n\n            const createTableSql = `\n              CREATE TABLE \"${safeTableName}\" (\n                ${idColumnSql},\n                ${columnDefs},\n                ${createdAtSql}\n              )\n            `;\n            \n            console.log(`[Import] Creating table with SQL:`, createTableSql.substring(0, 100) + '...');\n            await ctx.prisma.$executeRawUnsafe(createTableSql);\n\n            // Insert rows with proper NULL handling\n            let insertedCount = 0;\n            for (const row of jsonData) {\n                const columns = keys.map(k => `\"${k}\"`);\n                const values = keys.map(k => {\n                  let val;\n\n                  if (k === 'source_id') {\n                    val = row['id'] ?? row['source_id'];\n                  } else if (k === 'source_created_at') {\n                    val = row['created_at'] ?? row['source_created_at'];\n                  } else {\n                    val = row[k];\n                  }\n\n                  if (val == null) return 'NULL';\n                  return `'${String(val).replace(/'/g, \"''\")}'`;\n                });\n\n                if (optsPreserveIds && hasIncomingId && row.id != null && isValidUUID(String(row.id))) {\n                  columns.unshift('\"id\"');\n                  values.unshift(`'${String(row.id).replace(/'/g, \"''\")}'`);\n                }\n\n                if (optsPreserveCreatedAt && hasIncomingCreatedAt && row.created_at != null) {\n                  columns.push('\"created_at\"');\n                  values.push(`'${String(row.created_at).replace(/'/g, \"''\")}'`);\n                } else {\n                  columns.push('\"created_at\"');\n                  values.push('NOW()');\n                }\n\n                const columnsStr = columns.join(', ');\n                const valuesStr = values.join(', ');\n\n                let insertSql = `INSERT INTO \"${safeTableName}\" (${columnsStr}) VALUES (${valuesStr})`;\n\n                // Optionally perform upsert on id conflicts when preserving ids\n                if (opts.upsertOnConflict && optsPreserveIds && hasIncomingId) {\n                  // Build SET clause to update all non-id columns\n                  const nonIdCols = keys.filter(k => k !== 'id').map(k => `\"${k}\" = EXCLUDED.\"${k}\"`).join(', ');\n                  insertSql += ` ON CONFLICT (id) DO UPDATE SET ${nonIdCols}`;\n                }\n\n                await ctx.prisma.$executeRawUnsafe(insertSql);\n                insertedCount++;\n            }\n\n            console.log(`[Import] Inserted ${insertedCount} rows`);\n\n            // Get row count for verification\n            const result = await ctx.prisma.$queryRawUnsafe(`SELECT COUNT(*) as count FROM \"${safeTableName}\"`) as [{ count: bigint }];\n            const count = Number(result[0]?.count ?? BigInt(0));\n\n            console.log(`[Import] Final row count: ${count}`);\n            return { success: true, tableName: safeTableName, rowCount: count };\n\n        } catch (error: any) {\n          const errMsg = (error as Error).message || String(error);\n          console.error(`[Import] JSON import to table '${safeTableName}' failed:`, errMsg);\n          throw new Error(`Failed to import JSON: ${errMsg}`);\n        }\n    }","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/external.router.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":7,"column":5,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":7,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createTRPCRouter, publicProcedure } from '../trpc.js';\nimport axios from 'axios';\n\nexport const externalRouter = createTRPCRouter({\n  getOpenRouterRaw: publicProcedure.query(async () => {\n    const response = await axios.get('https://openrouter.ai/api/v1/models');\n    return response.data;\n  }),\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/git.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/index.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'publicProcedure' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createTRPCRouter, publicProcedure } from '../trpc.js';\nimport { gitRouter } from './git.router.js';\nimport { providerRouter } from './providers.router.js';\nimport { roleRouter } from './role.router.js';\nimport { externalRouter } from './external.router.js';\nimport { vfsRouter } from './vfs.router.js';\nimport { modelRouter } from './model.router.js';\nimport { dataRefinementRouter } from './dataRefinement.router.js';\nimport { apiExplorerRouter } from './apiExplorer.router.js';\nimport { orchestratorRouter } from './orchestrator.router.js';\nimport { orchestrationManagementRouter } from './orchestrationManagement.router.js';\nimport { usageRouter } from './usage.router.js';\nimport { browserRouter } from './browser.router.js';\nimport { projectRouter } from './project.router.js';\nimport { contextRouter } from './context.router.js';\nimport { workspaceRouter } from './workspace.router.js';\nimport { codeGraphRouter } from './codeGraph.router.js';\nimport { volcanoRouter } from './volcano.router.js';\nimport { ingestionRouter } from './ingestion.router.js';\nimport { agentRouter } from './agent.router.js';\nimport { systemHealthRouter } from './systemHealth.router.js';\n\n\nexport const appRouter = createTRPCRouter({\n  agent: agentRouter,\n  ingestion: ingestionRouter,\n  project: projectRouter,\n  codeGraph: codeGraphRouter,\n  git: gitRouter,\n  providers: providerRouter,\n  role: roleRouter,\n  external: externalRouter,\n  vfs: vfsRouter,\n  model: modelRouter,\n  dataRefinement: dataRefinementRouter,\n  apiExplorer: apiExplorerRouter,\n  context: contextRouter,\n  orchestrator: orchestratorRouter,\n  orchestrationManagement: orchestrationManagementRouter,\n  usage: usageRouter,\n  browser: browserRouter,\n  workspace: workspaceRouter,\n  volcano: volcanoRouter,\n  systemHealth: systemHealthRouter,\n});\n\nexport type AppRouter = typeof appRouter;","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/ingestion.router.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'z' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":11},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":24,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":24,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":38,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":38,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":38,"column":30,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":38,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .provider on an `any` value.","line":38,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":38,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":41,"column":20,"nodeType":"Property","messageId":"anyAssignment","endLine":41,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .provider on an `any` value.","line":48,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":48,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":49,"column":22,"nodeType":"Property","messageId":"anyAssignment","endLine":49,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":61,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":61,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .model_id on an `any` value.","line":61,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":61,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":65,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":65,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":65,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":65,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":66,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":66,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":67,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":67,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .is_free on an `any` value.","line":67,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":67,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":69,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":69,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .context_window on an `any` value.","line":69,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":69,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":70,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":70,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":70,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":70,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":75,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":75,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .model_id on an `any` value.","line":75,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":75,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":76,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":76,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":76,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":76,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":77,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":77,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":78,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":78,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .is_free on an `any` value.","line":78,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":78,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":80,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":80,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .context_window on an `any` value.","line":80,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":80,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":81,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":81,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":81,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":81,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":114,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":114,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3913,3916],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3913,3916],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access [key] on an `any` value.","line":127,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":127,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":137,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":137,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":138,"column":17,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":138,"endColumn":82},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":138,"column":25,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":138,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":138,"column":25,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":138,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":138,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":138,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .map on an `any` value.","line":138,"column":54,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":138,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":143,"column":26,"nodeType":"Property","messageId":"anyAssignment","endLine":143,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":143,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":143,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":146,"column":21,"nodeType":"Property","messageId":"anyAssignment","endLine":146,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":148,"column":33,"nodeType":"Property","messageId":"anyAssignment","endLine":148,"endColumn":69},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":148,"column":58,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":148,"endColumn":69},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":151,"column":21,"nodeType":"Property","messageId":"anyAssignment","endLine":151,"endColumn":70},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":151,"column":39,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":151,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":153,"column":21,"nodeType":"Property","messageId":"anyAssignment","endLine":153,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":154,"column":33,"nodeType":"Property","messageId":"anyAssignment","endLine":154,"endColumn":69},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":154,"column":58,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":154,"endColumn":69}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":48,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from \"zod\";\nimport { createTRPCRouter, publicProcedure } from \"../trpc.js\";\nimport { prisma } from \"../db.js\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { fileURLToPath } from \"url\";\n\n// Get current directory equivalent to __dirname\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nexport const ingestionRouter = createTRPCRouter({\n  importModels: publicProcedure.mutation(async () => {\n    try {\n      // 1. Read models.json\n      // Path relative to: apps/api/src/routers -> apps/api/latest_models/models.json\n      const modelsPath = path.resolve(__dirname, \"../../latest_models/models.json\");\n      \n      if (!fs.existsSync(modelsPath)) {\n        throw new Error(`Models file not found at ${modelsPath}`);\n      }\n\n      const fileContent = fs.readFileSync(modelsPath, \"utf-8\");\n      const models = JSON.parse(fileContent);\n\n      let count = 0;\n\n      for (const m of models) {\n        // Ensure provider exists (simple upsert or find)\n        // We assume \"provider\" field map to \"type\" or \"label\" in ProviderConfig.\n        // For now, we'll try to find a provider with that type, or create a 'system' one.\n        \n        // This is a bit tricky because ProviderConfig is usually user-managed (API Keys).\n        // WE will try to look up by 'type' (e.g. google, groq).\n        // If not found, we might skip or create a placeholder.\n        // For this task, let's upsert a placeholder provider if missing, to ensure foreign key constraints are met.\n        \n        const providerSlug = m.provider.toLowerCase();\n        \n        let provider = await prisma.providerConfig.findFirst({\n          where: { type: providerSlug }\n        });\n\n        if (!provider) {\n             // Create a placeholder provider to link models to\n             provider = await prisma.providerConfig.create({\n                 data: {\n                     label: `${m.provider} (System)`,\n                     type: providerSlug,\n                     apiKey: \"PLACEHOLDER_SYSTEM_IMPORT\",\n                     isEnabled: true\n                 }\n             });\n        }\n\n        // Upsert Model\n        await prisma.model.upsert({\n          where: {\n            providerId_modelId: {\n                providerId: provider.id,\n                modelId: m.model_id\n            }\n          },\n          update: {\n            name: m.name,\n            providerData: m,\n            isFree: m.is_free,\n            specs: {\n                contextWindow: m.context_window,\n                type: m.type\n            }\n          },\n          create: {\n            providerId: provider.id,\n            modelId: m.model_id,\n            name: m.name,\n            providerData: m,\n            isFree: m.is_free,\n            specs: {\n                contextWindow: m.context_window,\n                type: m.type\n            }\n          }\n        });\n        count++;\n      }\n\n      return { success: true, count, message: `Imported ${count} models.` };\n\n    } catch (error) {\n      console.error(\"Import Models Error:\", error);\n      throw new Error(`Failed to import models: ${(error as Error).message}`);\n    }\n  }),\n\n  importRoles: publicProcedure.mutation(async () => {\n    try {\n        // Path relative to: apps/api/src/routers -> apps/api/data/agents/en/\n        const agentsDir = path.resolve(__dirname, \"../../data/agents/en\");\n\n        if (!fs.existsSync(agentsDir)) {\n            throw new Error(`Agents directory not found at ${agentsDir}`);\n        }\n\n        const files = fs.readdirSync(agentsDir).filter(f => f.endsWith('.md'));\n        let count = 0;\n\n        for (const file of files) {\n            const content = fs.readFileSync(path.join(agentsDir, file), \"utf-8\");\n            \n            // Simple regex frontmatter parser\n            const match = content.match(/^---\\n([\\s\\S]*?)\\n---\\n([\\s\\S]*)$/);\n            \n            let frontmatter: any = {};\n            let body = content;\n\n            if (match) {\n                const fmString = match[1];\n                body = match[2].trim();\n                \n                // Parse simple key: value lines\n                fmString.split('\\n').forEach(line => {\n                    const parts = line.split(':');\n                    if (parts.length >= 2) {\n                        const key = parts[0].trim();\n                        const value = parts.slice(1).join(':').trim();\n                        frontmatter[key] = value;\n                    }\n                });\n            } else {\n                // Fallback if no frontmatter\n                frontmatter = { name: file.replace('.md', '') };\n            }\n\n            // Clean up tools if csv\n            let tools = [];\n            if (frontmatter.tools) {\n                tools = frontmatter.tools.split(',').map((t: string) => t.trim());\n            }\n\n            // Upsert Role\n            await prisma.role.upsert({\n                where: { name: frontmatter.name || file.replace('.md', '') },\n                update: {\n                    basePrompt: body,\n                    tools: tools,\n                    // If description is in frontmatter, maybe store in metadata?\n                    metadata: { description: frontmatter.description }\n                },\n                create: {\n                    name: frontmatter.name || file.replace('.md', ''),\n                    basePrompt: body,\n                    tools: tools,\n                    metadata: { description: frontmatter.description }\n                }\n            });\n            count++;\n        }\n\n        return { success: true, count, message: `Imported ${count} roles.` };\n    } catch (error) {\n        console.error(\"Import Roles Error:\", error);\n        throw new Error(`Failed to import roles: ${(error as Error).message}`);\n    }\n  })\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/llm.router.ts","messages":[{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":14,"column":26,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":22,"endColumn":2},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":25,"column":37,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":163,"endColumn":2},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":87,"column":19,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":87,"endColumn":90},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .content on an `any` value.","line":87,"column":83,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":87,"endColumn":90},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":89,"column":19,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":89,"endColumn":86},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .headers on an `any` value.","line":89,"column":74,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":89,"endColumn":81},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{}`.","line":92,"column":40,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":92,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `Record<string, string>`.","line":93,"column":88,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":93,"endColumn":95},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .length on an `any` value.","line":101,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":101,"endColumn":55},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":104,"column":13,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":111,"endColumn":16,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[3874,3874],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[3874,3874],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":121,"column":51,"nodeType":"Property","messageId":"anyAssignment","endLine":121,"endColumn":58},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4650,4653],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4650,4653],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":127,"column":63,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":127,"endColumn":70},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":128,"column":13,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":128,"endColumn":30},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":131,"column":13,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":138,"endColumn":16,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[4812,4812],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[4812,4812],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":147,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":147,"endColumn":89},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":147,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":147,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":150,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":150,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5355,5358],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5355,5358],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":160,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":160,"endColumn":82},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":160,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":160,"endColumn":29},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":166,"column":34,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":180,"endColumn":2},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":182,"column":35,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":209,"endColumn":2},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":183,"column":9,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":183,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":190,"column":34,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":190,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":192,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":192,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":192,"column":13,"nodeType":"Identifier","messageId":"unsafeCall","endLine":192,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":193,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":193,"endColumn":14},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":194,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":194,"endColumn":13},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":196,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":196,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":205,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":205,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6996,6999],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6996,6999],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":207,"column":28,"nodeType":"Property","messageId":"anyAssignment","endLine":207,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":207,"column":41,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":207,"endColumn":48},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":211,"column":41,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":220,"endColumn":2},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":217,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":217,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7389,7392],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7389,7392],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":218,"column":28,"nodeType":"Property","messageId":"anyAssignment","endLine":218,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":218,"column":41,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":218,"endColumn":48}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":87,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":87,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3084,3087],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3084,3087],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3241,3244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3241,3244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":36,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Router } from 'express';\nimport { z } from 'zod';\nimport { v4 as uuidv4 } from 'uuid';\nimport { ProviderManager } from '../services/ProviderManager.js';\nimport { db } from '../db.js';\nimport { providerConfigs } from '../db/schema.js';\nimport { encrypt } from '../utils/encryption.js';\nimport { UsageCollector } from '../services/UsageCollector.js';\nimport { eq, desc } from 'drizzle-orm';\n\nexport const llmRouter: Router = Router();\n\n// Get all aggregated models\nllmRouter.get('/models', async (req, res) => {\n  try {\n    const models = await ProviderManager.getAllModels();\n    res.json({ data: models });\n  } catch (error) {\n    console.error('Failed to fetch models:', error);\n    res.status(500).json({ error: 'Failed to fetch models' });\n  }\n});\n\n// Chat completion\nllmRouter.post('/chat/completions', async (req, res) => {\n  try {\n    // 1. Validate Input\n    const schema = z.object({\n      providerId: z.string(),\n      model: z.string(),\n      messages: z.array(z.object({\n        role: z.enum(['system', 'user', 'assistant']),\n        content: z.string()\n      })),\n      temperature: z.number().optional().default(0.7),\n      max_tokens: z.number().optional().default(1000)\n    });\n\n    const input = schema.parse(req.body);\n\n    // 2. Get all enabled models from database\n    const allModels = await ProviderManager.getAllModels();\n    \n    // Filter for the requested model or get all as candidates\n    const candidates = input.model \n      ? allModels.filter(m => m.id === input.model || m.name === input.model)\n      : allModels;\n\n    if (candidates.length === 0) {\n        return res.status(404).json({ error: 'No_Models_Found', message: 'No models available matching criteria.' });\n    }\n\n    let lastError = null;\n\n    // 3. Cascading Fallback Loop\n    for (const model of candidates) {\n        // a. Check Rate Limit (Pre-flight)\n        const allowed = await UsageCollector.checkAndIncrementRateLimit(\n            model.providerConfigId || '', \n            model.limitRequestRate || 1000, // Default to high limit if not set\n            model.limitWindow || 60\n        );\n\n        if (!allowed) {\n            console.warn(`Rate limit exceeded for ${model.name} (${model.provider}), trying next...`);\n            continue;\n        }\n\n        try {\n            const provider = ProviderManager.getProvider(model.providerConfigId || '');\n            if (!provider) {\n                console.warn(`Provider ${model.provider} not active, skipping.`);\n                continue;\n            }\n\n            const start = Date.now();\n            // b. Execute Request\n            const result = await provider.generateCompletion({\n                modelId: model.id,\n                messages: input.messages,\n                temperature: input.temperature,\n                max_tokens: input.max_tokens\n            });\n            \n            // Handle new return signature (object with headers) or legacy string\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            const content = typeof result === 'string' ? result : (result as any).content;\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\n            const headers = typeof result === 'object' ? (result as any).headers : {};\n\n            // Update Dynamic Limits (Smart Rate Limiting)\n            if (headers && Object.keys(headers).length > 0) {\n                await UsageCollector.updateDynamicLimits(model.providerConfigId || '', headers);\n            }\n\n            const duration = Date.now() - start;\n\n            // Estimate tokens (rough approximation: 4 chars = 1 token)\n            const promptText = input.messages.map(m => m.content).join(' ');\n            const tokensIn = Math.ceil(promptText.length / 4);\n            const tokensOut = Math.ceil(content.length / 4);\n\n            // c. Log Success (Post-flight)\n            UsageCollector.logRequest({\n                modelId: model.id,\n                providerConfigId: model.providerConfigId || '',\n                tokensIn,\n                tokensOut,\n                status: 'SUCCESS',\n                durationMs: duration\n            });\n\n            // d. Return Response\n            return res.json({\n                id: `chatcmpl-${crypto.randomUUID()}`,\n                object: 'chat.completion',\n                created: Math.floor(Date.now() / 1000),\n                model: model.name, // Return the ACTUAL model used\n                choices: [{\n                    index: 0,\n                    message: { role: 'assistant', content },\n                    finish_reason: 'stop'\n                }],\n            });\n\n        } catch (error: any) {\n            console.error(`Failed with ${model.name}:`, error.message);\n            lastError = error;\n            \n            // Log Failure\n            UsageCollector.logRequest({\n                modelId: model.id,\n                providerConfigId: model.providerConfigId || '',\n                tokensIn: 0,\n                tokensOut: 0,\n                status: 'FAILURE',\n                durationMs: 0\n            });\n            \n            // Continue to next candidate\n        }\n    }\n\n    // 4. All Failed\n    res.status(500).json({ \n      error: 'All_Providers_Failed', \n      message: lastError?.message || 'No available providers could fulfill the request.' \n    });\n\n  } catch (error: any) {\n    console.error('Completion Request Failed:', error);\n    \n    // Handle Zod validation errors specifically\n    if (error instanceof z.ZodError) {\n      return res.status(400).json({ error: 'Validation_Error', details: error.errors });\n    }\n\n    res.status(500).json({ \n      error: 'Internal_Server_Error', \n      message: error.message || 'An unexpected error occurred during generation.' \n    });\n  }\n});\n\n// Manage Providers (CRUD)\nllmRouter.get('/configurations', async (req, res) => {\n  try {\n    const configs = await db.select().from(providerConfigs).orderBy(desc(providerConfigs.createdAt));\n    \n    // Don't return the full API key\n    const safeConfigs = configs.map((c) => ({\n      ...c,\n      apiKey: '********' \n    }));\n    res.json(safeConfigs);\n  } catch (error) {\n    console.error('Failed to fetch configurations:', error);\n    res.status(500).json({ error: 'Failed to fetch configurations' });\n  }\n});\n\nllmRouter.post('/configurations', async (req, res) => {\n  const { label, type, apiKey, baseURL } = req.body;\n  \n  if (!label || !type || !apiKey) {\n    return res.status(400).json({ error: 'Missing required fields' });\n  }\n\n  try {\n    const encryptedKey = encrypt(apiKey);\n    const [config] = await db.insert(providerConfigs).values({\n        id: uuidv4(),\n        label,\n        type,\n        apiKey: encryptedKey,\n        baseURL,\n        isEnabled: true\n    }).returning();\n    \n    // Re-initialize ProviderManager to pick up new provider\n    await ProviderManager.initialize();\n    await ProviderManager.syncModelsToRegistry();\n    \n    res.json({ ...config, apiKey: '********' });\n  } catch (error: any) {\n    console.error('Failed to create provider config:', error);\n    res.status(500).json({ error: error.message });\n  }\n});\n\nllmRouter.delete('/configurations/:id', async (req, res) => {\n  const { id } = req.params;\n  try {\n    await db.delete(providerConfigs).where(eq(providerConfigs.id, id));\n    await ProviderManager.initialize();\n    res.json({ success: true });\n  } catch (error: any) {\n    res.status(500).json({ error: error.message });\n  }\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/model.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/orchestrationManagement.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/orchestrator.router.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":58,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2160,2163],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2160,2163],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":175,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":175,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ctx' is defined but never used. Allowed unused args must match /^_/u.","line":210,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":210,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from 'zod';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport { createTRPCRouter, publicProcedure, protectedProcedure } from '../trpc.js';\nimport { nebulaTool } from '../tools/nebulaTool.js';\nimport { createVolcanoAgent } from '../services/AgentFactory.js';\nimport { AgentRuntime } from '../services/AgentRuntime.js';\nimport { PrismaAgentConfigRepository } from '../repositories/PrismaAgentConfigRepository.js';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\nconst MONOREPO_ROOT = path.resolve(__dirname, '../../../../');\n\n\n\nexport const orchestratorRouter = createTRPCRouter({\n  getConfig: protectedProcedure.query(async ({ ctx }) => {\n    return ctx.prisma.orchestratorConfig.upsert({\n      where: { id: 'global' },\n      update: {},\n      create: { activeTableName: 'model_registry' }\n    });\n  }),\n\n  updateConfig: protectedProcedure\n    .input(z.object({ activeTableName: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      return ctx.prisma.orchestratorConfig.update({\n        where: { id: 'global' },\n        data: { activeTableName: input.activeTableName }\n      });\n    }),\n\n  setActiveRegistry: protectedProcedure\n    .input(z.object({ tableName: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      // Sanitize table name to prevent SQL injection or invalid characters\n      const sanitizedTableName = input.tableName.replace(/[^a-zA-Z0-9_]/g, '');\n      if (!sanitizedTableName) {\n        throw new Error(\"Invalid table name provided.\");\n      }\n\n      return ctx.prisma.orchestratorConfig.upsert({\n        where: { id: 'global' },\n        update: { activeTableName: sanitizedTableName },\n        create: { id: 'global', activeTableName: sanitizedTableName }\n      });\n    }),\n\n  getActiveRegistrySchema: protectedProcedure\n    .query(async ({ ctx }) => {\n      // 1. Get Active Table\n      const config = await ctx.prisma.orchestratorConfig.findUnique({ where: { id: 'global' } });\n      const tableName = config?.activeTableName || 'model_registry';\n\n      // 2. Get Columns\n      try {\n        const columns = await ctx.prisma.$queryRawUnsafe<any[]>(\n          `SELECT column_name as name, data_type as type \n           FROM information_schema.columns \n           WHERE table_name = '${tableName}' \n             AND table_schema = 'public'`\n        );\n        return { tableName, columns };\n      } catch (error) {\n        console.error(\"Failed to fetch schema:\", error);\n        return { tableName, columns: [] };\n      }\n    }),\n\n  getActiveRegistryData: protectedProcedure\n    .query(async ({ ctx }) => {\n      // Fetch models from the Prisma model_registry table\n      // This replaces the old raw SQL query approach\n      try {\n        const models = await ctx.prisma.model.findMany({\n          where: {\n            isActive: true, // Only show active models (Ghost Records pattern)\n          },\n          include: {\n            provider: {\n              select: {\n                id: true,\n                label: true,\n                type: true,\n                isEnabled: true,\n              }\n            }\n          },\n          orderBy: [\n            { isFree: 'desc' }, // Free models first\n            { lastSeenAt: 'desc' }, // Recently seen models first\n          ],\n          take: 2000 // Cap at 2000 for performance\n        });\n\n        // Transform to a format the UI expects\n        const rows = models.map(model => ({\n          id: model.id,\n          provider_id: model.providerId,\n          provider_label: model.provider.label,\n          provider_type: model.provider.type,\n          provider_enabled: model.provider.isEnabled,\n          model_id: model.modelId,\n          model_name: model.name,\n          capabilities: model.capabilityTags,\n          is_free: model.isFree,\n          cost_per_1k: model.costPer1k,\n          is_active: model.isActive,\n          source: model.source,\n          first_seen_at: model.firstSeenAt,\n          last_seen_at: model.lastSeenAt,\n          specs: model.specs,\n          provider_data: model.providerData,\n        }));\n\n        return { \n          tableName: 'model_registry', \n          rows \n        };\n      } catch (error) {\n        console.error(\"Failed to fetch models from registry:\", error);\n        return { tableName: 'model_registry', rows: [] };\n      }\n    }),\n\n  triggerProbe: protectedProcedure\n    .input(z.object({ providerId: z.string(), modelId: z.string() }))\n    .mutation(async ({ input }) => {\n      // Import dynamically to avoid circular deps if any, or just import at top\n      const { ProviderProbeService } = await import('../services/ProviderProbeService.js');\n      await ProviderProbeService.probe(input.providerId, input.modelId);\n      return { success: true };\n    }),\n\n  listTools: protectedProcedure\n    .query(async () => {\n      const { RegistryClient } = await import('../services/mcp-registry-client.js');\n      const mcpServers = await RegistryClient.listServers();\n      \n      // Add internal tools\n      const internalTools = [\n        {\n          name: 'search_codebase',\n          description: 'Semantic search over the codebase using vector embeddings. Use this to find relevant code snippets or documentation.',\n          type: 'internal'\n        },\n        {\n          name: nebulaTool.name,\n          description: nebulaTool.description,\n          type: 'internal'\n        }\n      ];\n      \n      return [...mcpServers, ...internalTools];\n    }),\n\n  getToolExamples: protectedProcedure\n    .input(z.object({ toolName: z.string() }))\n    .query(async ({ input }) => {\n      const fs = await import('fs/promises');\n      const path = await import('path');\n      \n      // Resolve path to .domoreai/tools\n      let rootDir = process.cwd();\n      if (rootDir.endsWith('apps/api')) {\n          rootDir = path.resolve(rootDir, '../../');\n      }\n      const toolsDir = path.join(rootDir, '.domoreai/tools');\n      \n      const filePath = path.join(toolsDir, `${input.toolName}_examples.md`);\n      try {\n        const content = await fs.readFile(filePath, 'utf-8');\n        return { content };\n      } catch (e) {\n        return { content: null };\n      }\n    }),\n\n  updateToolExamples: protectedProcedure\n    .input(z.object({ toolName: z.string(), content: z.string() }))\n    .mutation(async ({ input }) => {\n      const fs = await import('fs/promises');\n      const path = await import('path');\n      \n      // Resolve path to .domoreai/tools\n      let rootDir = process.cwd();\n      if (rootDir.endsWith('apps/api')) {\n          rootDir = path.resolve(rootDir, '../../');\n      }\n      const toolsDir = path.join(rootDir, '.domoreai/tools');\n      \n      const filePath = path.join(toolsDir, `${input.toolName}_examples.md`);\n      try {\n        await fs.mkdir(toolsDir, { recursive: true });\n        await fs.writeFile(filePath, input.content, 'utf-8');\n        return { success: true };\n      } catch (e) {\n        console.error(`Failed to update tool examples for ${input.toolName}:`, e);\n        throw new Error(`Failed to update tool examples: ${e instanceof Error ? e.message : String(e)}`);\n      }\n    }),\n\n  dispatch: publicProcedure\n    .input(z.object({ \n      prompt: z.string(),\n      contextId: z.string().optional(),\n      roleId: z.string().optional(),\n    }))\n    .mutation(async ({ input, ctx }) => {\n      console.log(`üöÄ [Orchestrator] Dispatching command:`, {\n        prompt: input.prompt.substring(0, 100),\n        contextId: input.contextId,\n        roleId: input.roleId,\n      });\n\n      try {\n          const roleId = input.roleId || 'general_worker';\n          const repo = new PrismaAgentConfigRepository();\n          const role = await repo.getRole(roleId);\n\n          if (!role) throw new Error(`Role ${roleId} not found`);\n\n          // 1. Initialize Runtime with Role Tools\n          console.log(`[Orchestrator] Initializing runtime for role: ${roleId} with tools: [${role.tools.join(', ')}]`);\n          const runtime = await AgentRuntime.create(MONOREPO_ROOT, role.tools);\n\n          // 2. Initialize Agent\n          const agent = await createVolcanoAgent({\n              roleId: roleId,\n              modelId: null,\n              isLocked: false,\n              temperature: 0.7,\n              maxTokens: 4096,\n              userGoal: input.prompt\n          });\n\n          // 3. Generate content WITH context (Constitution, memory, and code-mode protocol)\n          console.log(`[Orchestrator] Generating response...`);\n          const aiResponse = await runtime.generateWithContext(\n              agent, \n              role.basePrompt, \n              input.prompt, \n              roleId\n          );\n\n          console.log(`[Orchestrator] Raw AI Response:\\n${aiResponse as string}`);\n\n          // 4. Run Execution Loop (Handles tool calling if AI wrote code blocks)\n          console.log(`[Orchestrator] Running agent loop...`);\n          const { result, logs } = await runtime.runAgentLoop(\n              input.prompt,\n              aiResponse as string,\n              // Pass regeneration callback for retries\n              async (retryPrompt: string) => {\n                console.log(`[Orchestrator] Regenerating with error feedback...`);\n                return await runtime.generateWithContext(\n                  agent,\n                  role.basePrompt,\n                  retryPrompt,\n                  roleId\n                ) as string;\n              }\n          );\n\n          const finalResult = result || '';\n          const finalLogs = logs || [];\n\n          console.log(`[Orchestrator] Execution complete. Result length: ${finalResult.length}, Logs: ${finalLogs.length}`);\n\n          return {\n            success: true,\n            message: 'Command executed successfully',\n            executionId: `exec_${Date.now()}`,\n            prompt: input.prompt,\n            contextId: input.contextId,\n            output: finalResult,\n            logs: finalLogs\n          };\n\n      } catch (error) {\n          console.error('[Orchestrator] Dispatch failed:', error);\n          return {\n            success: false,\n            message: `Execution Failed: ${error instanceof Error ? error.message : String(error)}`,\n            executionId: `err_${Date.now()}`,\n            prompt: input.prompt,\n            contextId: input.contextId,\n            output: `Error: ${error instanceof Error ? error.message : String(error)}`\n          };\n      }\n    }),\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/project.router.ts","messages":[{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async arrow function has no 'await' expression.","line":104,"column":33,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":104,"endColumn":35,"suggestions":[{"messageId":"removeAsync","fix":{"range":[3235,3241],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async arrow function has no 'await' expression.","line":116,"column":33,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":116,"endColumn":35,"suggestions":[{"messageId":"removeAsync","fix":{"range":[3618,3624],"text":""},"desc":"Remove 'async'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from 'zod';\nimport { createTRPCRouter, publicProcedure } from '../trpc.js';\nimport { prisma } from '../db.js';\nimport { ProjectArchitect } from '../services/ProjectArchitect.js';\nimport { projects } from '../db/schema.js'; // Ensure proper file extension for NodeNext module resolution\n\nexport const projectRouter = createTRPCRouter({\n  /**\n   * Create a new project with its associated jobs.\n   */\n  create: publicProcedure\n    .input(\n      z.object({\n        name: z.string(),\n        description: z.string(), // Made description mandatory\n        priority: z.enum(['low', 'medium', 'high', 'critical']).default('medium'),\n        jobs: z.array(\n          z.object({\n            name: z.string(),\n            description: z.string().optional(),\n            priority: z.enum(['low', 'medium', 'high', 'critical']).default('medium'),\n            roleId: z.string().optional(),\n            dependsOn: z.number().optional(), // Index of the job it depends on in the array\n            parallelGroup: z.string().optional(),\n          })\n        ).optional(), // Made jobs optional\n      })\n    )\n    .mutation(async ({ input, ctx }) => {\n      const { name, description } = input;\n\n      const [project] = await ctx.db.insert(projects).values({\n        name,\n        description,\n        status: 'planning',\n      }).returning() as { id: string }[]; // Ensure type safety without casting to unknown\n\n      const architect: ProjectArchitect = new ProjectArchitect(); // Explicitly type the architect instance\n      if (project && typeof project.id === 'string') { // Add type guard for project.id\n        architect.draftBlueprint(project.id, description)\n          .then(() => console.log(\"Blueprint complete\"))\n          .catch(err => console.error(\"Blueprint failed\", err));\n      } else {\n        console.error(\"Project creation failed or returned invalid ID.\");\n      }\n\n      return project; // Ensure safe return of project\n    }),\n\n  /**\n   * List all projects.\n   */\n  list: publicProcedure.query(async () => {\n    return await prisma.project.findMany({\n      orderBy: {\n        createdAt: 'desc',\n      },\n      include: {\n        jobs: true, // Include jobs for a high-level overview\n      },\n    });\n  }),\n\n  /**\n   * Get a single project by its ID, including all its jobs, tasks, and errands.\n   */\n  getById: publicProcedure\n    .input(z.object({ id: z.string() }))\n    .query(async ({ input }) => {\n      return await prisma.project.findUnique({\n        where: { id: input.id },\n        include: {\n          jobs: {\n            orderBy: {\n              createdAt: 'asc',\n            },\n            include: {\n              tasks: {\n                include: {\n                  errands: true,\n                },\n              },\n              role: true, // Include the assigned role information\n            },\n          },\n        },\n      });\n    }),\n\n  /**\n   * Update a project's details.\n   * (Placeholder for future implementation)\n   */\n  update: publicProcedure\n    .input(\n      z.object({\n        id: z.string(),\n        name: z.string().optional(),\n        description: z.string().optional(),\n        status: z.string().optional(),\n        priority: z.string().optional(),\n      })\n    )\n    .mutation(async ({ input }) => {\n      // Logic to update the project will be implemented here.\n      console.log('Updating project:', input);\n      return { status: 'ok', message: 'Project update placeholder' };\n    }),\n\n  /**\n   * Delete a project by its ID.\n   * (Placeholder for future implementation)\n   */\n  delete: publicProcedure\n    .input(z.object({ id: z.string() }))\n    .mutation(async ({ input }) => {\n      // Logic to delete the project will be implemented here.\n      console.log('Deleting project:', input);\n      return { status: 'ok', message: 'Project delete placeholder' };\n    }),\n\n  /**\n   * Get Constitution settings (Code Rules and Glossary) for a workspace\n   */\n  getConstitution: publicProcedure\n    .input(z.object({ workspaceId: z.string() }))\n    .query(async ({ input }) => {\n      const workspace = await prisma.workspace.findUnique({\n        where: { id: input.workspaceId },\n        select: {\n          codeRules: true,\n          glossary: true,\n        },\n      });\n      \n      return {\n        codeRules: workspace?.codeRules || '',\n        glossary: workspace?.glossary || {},\n      };\n    }),\n\n  /**\n   * Update Constitution settings (Code Rules and Glossary) for a workspace\n   */\n  updateConstitution: publicProcedure\n    .input(\n      z.object({\n        workspaceId: z.string(),\n        codeRules: z.string().optional(),\n        glossary: z.record(z.string()).optional(),\n      })\n    )\n    .mutation(async ({ input }) => {\n      const { workspaceId, codeRules, glossary } = input;\n      \n      const updated = await prisma.workspace.update({\n        where: { id: workspaceId },\n        data: {\n          ...(codeRules !== undefined && { codeRules }),\n          ...(glossary !== undefined && { glossary }),\n          updatedAt: new Date(),\n        },\n      });\n      \n      return {\n        success: true,\n        codeRules: updated.codeRules,\n        glossary: updated.glossary,\n      };\n    }),\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/providers.router.ts","messages":[{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async arrow function has no 'await' expression.","line":49,"column":46,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":49,"endColumn":48,"suggestions":[{"messageId":"removeAsync","fix":{"range":[1466,1472],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async arrow function has no 'await' expression.","line":50,"column":88,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":50,"endColumn":90,"suggestions":[{"messageId":"removeAsync","fix":{"range":[1573,1579],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async arrow function has no 'await' expression.","line":51,"column":67,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":51,"endColumn":69,"suggestions":[{"messageId":"removeAsync","fix":{"range":[1661,1667],"text":""},"desc":"Remove 'async'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// --- providers.router.ts ---\nimport { z } from 'zod';\nimport { createTRPCRouter, publicProcedure } from '../trpc.js';\nimport { ProviderService } from '../services/provider.service.js';\n\nconst providerService = new ProviderService();\n\nexport const providerRouter = createTRPCRouter({\n  list: publicProcedure.query(async () => {\n    return providerService.listProviders();\n  }),\n\n  // [UPDATED] Changed 'add' to 'upsert' to support editing\n  upsert: publicProcedure\n    .input(z.object({\n      id: z.string().optional(),\n      name: z.string(),\n      providerType: z.string(),\n      baseURL: z.string(),\n      apiKey: z.string().optional(),\n    }))\n    .mutation(async ({ input }) => {\n      return providerService.upsertProviderConfig({\n        id: input.id,\n        label: input.name,\n        type: input.providerType,\n        baseURL: input.baseURL,\n        apiKey: input.apiKey,\n      });\n    }),\n\n  listAllAvailableModels: publicProcedure.query(async () => {\n    return providerService.listAllAvailableModels();\n  }),\n\n  delete: publicProcedure\n    .input(z.object({ id: z.string() }))\n    .mutation(async ({ input }) => {\n      return providerService.deleteProvider(input.id);\n    }),\n\n  fetchAndNormalizeModels: publicProcedure\n    .input(z.object({ providerId: z.string() }))\n    .mutation(async ({ input }) => {\n      return providerService.fetchAndNormalizeModels(input.providerId);\n    }),\n\n  // Legacy/Debug endpoints\n  getRawData: publicProcedure.query(async () => { return []; }),\n  deleteRawData: publicProcedure.input(z.object({ id: z.string() })).mutation(async () => { return null; }),\n  createRawData: publicProcedure.input(z.any()).mutation(async () => { return null; }),\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/role.router.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `Role`.","line":109,"column":68,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":109,"endColumn":79},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":109,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4327,4330],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4327,4330],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":120,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":120,"endColumn":18},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":186,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":186,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7100,7103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7100,7103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":187,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":187,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .parentId on an `any` value.","line":188,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":188,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":192,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":192,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":278,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":284,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":284,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":284,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10348,10351],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10348,10351],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":302,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":302,"endColumn":60},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":302,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":302,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10963,10966],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10963,10966],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":304,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":316,"endColumn":8},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":318,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":318,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11660,11663],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11660,11663],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":318,"column":36,"nodeType":"Property","messageId":"anyAssignment","endLine":318,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .categoryString on an `any` value.","line":319,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":319,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .categoryString on an `any` value.","line":320,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":320,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":325,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":325,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'roleId' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":371,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":371,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'context' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":371,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":371,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":19,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from \"zod\";\nimport * as path from \"path\";\nimport { fileURLToPath } from \"url\";\nimport { createTRPCRouter, publicProcedure } from \"../trpc.js\";\nimport { prisma } from \"../db.js\";\nimport { ingestAgentLibrary, onboardProject } from \"../services/RoleIngestionService.js\";\nimport { ModelSelector } from \"../services/ModelSelector.js\";\n\n// Helper function for template-based prompt generation (fallback)\nfunction generateTemplatePrompt(\n  name: string,\n  goal: string | undefined,\n  category: string | undefined,\n  capabilities?: {\n    vision?: boolean;\n    reasoning?: boolean;\n    coding?: boolean;\n    tools?: boolean;\n  }\n): string {\n  const capabilityList: string[] = [];\n  if (capabilities?.vision) capabilityList.push(\"Vision (multimodal understanding)\");\n  if (capabilities?.reasoning) capabilityList.push(\"Advanced reasoning and chain-of-thought\");\n  if (capabilities?.coding) capabilityList.push(\"Code generation and analysis\");\n  if (capabilities?.tools) capabilityList.push(\"Tool usage and function calling\");\n\n  const categoryContext = category ? `\\n\\n**Category:** ${category}` : \"\";\n  const capabilitiesContext = capabilityList.length > 0 \n    ? `\\n\\n**Required Capabilities:**\\n${capabilityList.map(c => `- ${c}`).join('\\n')}`\n    : \"\";\n  \n  return `## ROLE: ${name}${categoryContext}${capabilitiesContext}\n\n**GOAL:**\n${goal || \"Assist the user with high-quality, accurate responses tailored to this role.\"}\n\n**CORE INSTRUCTIONS:**\n- You are a specialized AI assistant with the role of \"${name}\".\n- Your primary objective is to fulfill the user's request based on your defined goal and capabilities.\n- Analyze the context provided and respond efficiently, accurately, and professionally.\n- Maintain a helpful, clear, and concise communication style.\n- Always prioritize accuracy and relevance in your responses.`;\n}\n\n\nconst createRoleSchema = z.object({\n  name: z.string().min(1, \"Name is required.\"),\n  basePrompt: z.string().min(1, \"Base prompt is required.\"),\n  category: z.string().optional().default('Uncategorized'),\n  tools: z.array(z.string()).optional().default([]),\n  \n  // Metadata fields (passed as JSON)\n  // We allow these to be passed and will store them in metadata\n  minContext: z.number().int().optional(),\n  maxContext: z.number().int().optional(),\n  needsVision: z.boolean().default(false),\n  needsReasoning: z.boolean().default(false),\n  needsCoding: z.boolean().default(false),\n  needsTools: z.boolean().default(false),\n  needsJson: z.boolean().default(false),\n  needsUncensored: z.boolean().default(false),\n  defaultMaxTokens: z.number().int().min(256).optional(),\n  defaultTopP: z.number().min(0).max(1).optional(),\n});\n\nconst updateRoleSchema = z.object({\n  id: z.string(),\n  name: z.string().min(1, \"Name is required.\").optional(),\n  basePrompt: z.string().min(1, \"Base prompt is required.\").optional(),\n  category: z.string().optional(),\n  categoryString: z.string().optional(),\n  tools: z.array(z.string()).optional(),\n  \n  // Metadata fields\n  minContext: z.number().int().optional().nullable(),\n  maxContext: z.number().int().optional().nullable(),\n  needsVision: z.boolean().optional(),\n  needsReasoning: z.boolean().optional(),\n  needsCoding: z.boolean().optional(),\n  needsTools: z.boolean().optional(),\n  needsJson: z.boolean().optional(),\n  needsUncensored: z.boolean().optional(),\n  defaultMaxTokens: z.number().int().min(256).optional(),\n  defaultTopP: z.number().min(0).max(1).optional(),\n});\n\nexport const roleRouter = createTRPCRouter({\n  list: publicProcedure.query(async () => {\n    // Fetch all roles from the database\n    const roles = await prisma.role.findMany({\n      orderBy: {\n        name: \"asc\",\n      },\n      include: {\n        category: true, // Include the category object\n      },\n    });\n\n    // Resolve Operational Intelligence (Model & Scope)\n    const modelSelector = new ModelSelector();\n\n    // We fetch model names efficiently to avoid N+1 issues where possible,\n    // but ModelSelector logic is complex so we'll do parallel resolution.\n    // In a real high-scale app, we'd cache this or store 'currentModel' in the DB periodically.\n\n    const enrichedRoles = await Promise.all(roles.map(async (role) => {\n       let currentModelName = 'Auto-Detect';\n       try {\n           const modelId = await modelSelector.resolveModelForRole(role as any);\n           // Fetch the friendly name for this model ID\n           // Note: This is an extra DB call per role.\n           // Optimization: We could fetch all models once and lookup, but model registry is large.\n           // Better: ModelSelector could return the object or name.\n           // For now, we'll do a quick lookup.\n           const model = await prisma.model.findUnique({\n               where: { id: modelId },\n               select: { name: true }\n           });\n           if (model) currentModelName = model.name;\n       } catch (e) {\n           currentModelName = 'None Available';\n       }\n\n       // Scope Extraction (Simple Heuristic)\n       let scope = 'Global';\n       const desc = (role.description || '').toLowerCase();\n       if (desc.includes('frontend') || desc.includes('react') || desc.includes('ui')) scope = 'Frontend (src/components)';\n       else if (desc.includes('backend') || desc.includes('api') || desc.includes('database')) scope = 'Backend (apps/api)';\n       else if (desc.includes('test') || desc.includes('qa')) scope = 'Tests (*.test.ts)';\n\n       return {\n           ...role,\n           currentModel: currentModelName,\n           scope: scope,\n           healthScore: 100 // Placeholder for AssessmentService score\n       };\n    }));\n\n    // Return roles, or a default role if none exist (prevents UI crash)\n    return enrichedRoles.length > 0\n      ? enrichedRoles\n      : [\n          {\n            id: \"default\",\n            name: \"General Assistant\",\n            basePrompt: \"You are a helpful AI assistant.\",\n            categoryString: null, \n            category: null,\n            tools: [],\n            metadata: {},\n            preferredModels: [],\n            currentModel: 'GPT-4o',\n            scope: 'Global',\n            healthScore: 100\n          },\n        ];\n  }),\n\n  // --- CATEGORY MANAGEMENT ---\n  \n  // --- CATEGORY MANAGEMENT ---\n  \n  listCategories: publicProcedure.query(async () => {\n    // Nested query is tricky with simple client usage.\n    // We return flat list and reconstruct tree on client, or return with children.\n    // Let's return flat for maximum flexibility in UI.\n    return prisma.roleCategory.findMany({\n      orderBy: { order: 'asc' },\n    });\n  }),\n\n  createCategory: publicProcedure\n    .input(z.object({ name: z.string().min(1), parentId: z.string().optional() }))\n    .mutation(async ({ input }) => {\n      return prisma.roleCategory.create({\n        data: { \n            name: input.name,\n            parentId: input.parentId || null\n        }\n      });\n    }),\n\n  updateCategory: publicProcedure\n    .input(z.object({ id: z.string(), name: z.string().min(1).optional(), parentId: z.string().nullable().optional() }))\n    .mutation(async ({ input }) => {\n      const data: any = {};\n      if (input.name) data.name = input.name;\n      if (input.parentId !== undefined) data.parentId = input.parentId;\n\n      return prisma.roleCategory.update({\n        where: { id: input.id },\n        data: data\n      });\n    }),\n\n  deleteCategory: publicProcedure\n    .input(z.object({ id: z.string() }))\n    .mutation(async ({ input }) => {\n      const category = await prisma.roleCategory.findUnique({\n          where: { id: input.id },\n          include: { roles: true, children: true } \n      });\n\n      if (category) {\n          // Flatten roles: set category to null (or parent?)\n          // Let's set to null ('Uncategorized') for safety\n          if (category.roles.length > 0) {\n              await prisma.role.updateMany({\n                  where: { categoryId: input.id },\n                  data: { categoryId: null, categoryString: 'Uncategorized' }\n              });\n          }\n          \n          // Flatten children: move up to root or parent?\n          // Let's set to null (root)\n          if(category.children.length > 0) {\n             await prisma.roleCategory.updateMany({\n                where: { parentId: input.id },\n                data: { parentId: category.parentId } // Move to grandparent or root\n             });\n          }\n      }\n\n      return prisma.roleCategory.delete({\n        where: { id: input.id }\n      });\n    }),\n\n  moveRoleToCategory: publicProcedure\n    .input(z.object({ roleId: z.string(), categoryId: z.string().nullable() }))\n    .mutation(async ({ input }) => {\n      let categoryName = 'Uncategorized';\n      if (input.categoryId) {\n          const cat = await prisma.roleCategory.findUnique({ where: { id: input.categoryId }});\n          if (cat) categoryName = cat.name;\n      }\n      \n      return prisma.role.update({\n        where: { id: input.roleId },\n        data: { \n            categoryId: input.categoryId,\n            categoryString: categoryName \n        }\n      });\n    }),\n\n  reorderCategories: publicProcedure\n    .input(z.array(z.object({ id: z.string(), order: z.number() })))\n    .mutation(async ({ input }) => {\n        const updates = input.map(item => \n            prisma.roleCategory.update({\n                where: { id: item.id },\n                data: { order: item.order }\n            })\n        );\n        return prisma.$transaction(updates);\n    }),\n\n  create: publicProcedure\n    .input(createRoleSchema)\n    .mutation(async ({ input }) => {\n      // Create metadata object from extra fields\n      const metadata = {\n        minContext: input.minContext,\n        maxContext: input.maxContext,\n        needsVision: input.needsVision,\n        needsReasoning: input.needsReasoning,\n        needsCoding: input.needsCoding,\n        needsTools: input.needsTools,\n        needsJson: input.needsJson,\n        needsUncensored: input.needsUncensored,\n        defaultMaxTokens: input.defaultMaxTokens,\n        defaultTopP: input.defaultTopP,\n      };\n\n      // Create a new role in the database\n      const role = await prisma.role.create({\n        data: {\n          name: input.name,\n          basePrompt: input.basePrompt,\n          categoryString: input.category, // Use category string\n          tools: input.tools,\n          metadata: metadata,\n        } as any,\n      });\n      return role;\n    }),\n\n  update: publicProcedure\n    .input(updateRoleSchema)\n    .mutation(async ({ input }) => {\n      const { id, ...dataToUpdate } = input;\n      \n      const { \n        minContext, maxContext, needsVision, needsReasoning, needsCoding, needsTools, needsJson, needsUncensored, defaultMaxTokens, defaultTopP, \n        category, categoryString,\n        ...rest \n      } = dataToUpdate;\n\n      // Fetch existing metadata to merge\n      const existing = await prisma.role.findUnique({ where: { id }, select: { metadata: true } });\n      const currentMeta = (existing?.metadata as any) || {};\n\n      const newMetadata = {\n        ...currentMeta,\n        ...(minContext !== undefined && { minContext }),\n        ...(maxContext !== undefined && { maxContext }),\n        ...(needsVision !== undefined && { needsVision }),\n        ...(needsReasoning !== undefined && { needsReasoning }),\n        ...(needsCoding !== undefined && { needsCoding }),\n        ...(needsTools !== undefined && { needsTools }),\n        ...(needsJson !== undefined && { needsJson }),\n        ...(needsUncensored !== undefined && { needsUncensored }),\n        ...(defaultMaxTokens !== undefined && { defaultMaxTokens }),\n        ...(defaultTopP !== undefined && { defaultTopP }),\n      };\n\n      const data: any = { ...rest, metadata: newMetadata };\n      if (categoryString) data.categoryString = categoryString;\n      if (category) data.categoryString = category;\n\n      // Update the role in the database\n      const role = await prisma.role.update({\n        where: { id },\n        data,\n      });\n      return role;\n    }),\n\n  delete: publicProcedure\n    .input(z.object({ id: z.string() }))\n    .mutation(async ({ input }) => {\n      // Delete the role from the database\n      await prisma.role.delete({\n        where: { id: input.id },\n      });\n      return { success: true };\n    }),\n\n  ingestLibrary: publicProcedure.mutation(async () => {\n    // Get the directory where this router is located\n    const __filename = fileURLToPath(import.meta.url);\n    const __dirname = path.dirname(__filename);\n    const agentsDir = path.join(__dirname, \"../../../data/agents/en\");\n\n    const stats = await ingestAgentLibrary(agentsDir, prisma);\n    return {\n      message: \"Agent library ingestion complete\",\n      ...stats,\n    };\n  }),\n\n  generatePrompt: publicProcedure\n    .input(\n      z.object({\n        name: z.string(),\n        goal: z.string().optional(),\n        category: z.string().optional(),\n        capabilities: z.object({\n          vision: z.boolean().optional(),\n          reasoning: z.boolean().optional(),\n          coding: z.boolean().optional(),\n          tools: z.boolean().optional(),\n        }).optional(),\n        tools: z.array(z.string()).optional(),\n        roleId: z.string().optional(), // Keep roleId optional for now\n        context: z.string().optional(),\n      }),\n    )\n    .mutation(async ({ input }) => {\n      const { roleId, context, name, goal, category, capabilities, tools } = input;\n\n      // --- NEW: Real AI-Powered Prompt Generation ---\n      console.log(`[PromptGen] üé® Generating AI prompt for role: \"${name}\"...`);\n\n      // 1. Find the Prompt Engineer role\n      const promptEngineerRole = await prisma.role.findFirst({\n        where: { name: 'Prompt Engineer' },\n      });\n\n      if (!promptEngineerRole) {\n        console.warn('[PromptGen] ‚ö†Ô∏è Prompt Engineer role not found, falling back to template');\n        // Fallback to template if role doesn't exist\n        return generateTemplatePrompt(name, goal, category, capabilities);\n      }\n\n      // 2. Build the capability list\n      const capabilityList: string[] = [];\n      if (capabilities?.vision) capabilityList.push(\"Vision (multimodal understanding)\");\n      if (capabilities?.reasoning) capabilityList.push(\"Advanced reasoning and chain-of-thought\");\n      if (capabilities?.coding) capabilityList.push(\"Code generation and analysis\");\n      if (capabilities?.tools) capabilityList.push(\"Tool usage and function calling\");\n\n      const toolsList = tools && tools.length > 0 ? tools.join(', ') : 'none';\n\n      // 3. Create the prompt engineering request\n      const request = `Generate a professional, effective system prompt for an AI assistant with the following specifications:\n\n**Role Name:** ${name}\n**Category:** ${category || 'General'}\n**Goal:** ${goal || 'Assist the user with high-quality, accurate responses tailored to this role'}\n**Required Capabilities:** ${capabilityList.length > 0 ? capabilityList.join(', ') : 'General assistance'}\n**Tools Available:** ${toolsList}\n\nPlease create a clear, structured system prompt that:\n1. Defines the role and its expertise\n2. States the primary goal/mission\n3. Provides specific, actionable instructions\n4. Uses markdown formatting for readability\n5. Is concise but comprehensive (150-400 words ideal)\n\nReturn ONLY the system prompt, no additional commentary.`;\n\n      try {\n        const { createVolcanoAgent } = await import('../services/AgentFactory.js');\n        \n        const agent = await createVolcanoAgent({\n          roleId: promptEngineerRole.id,\n          modelId: null, // CRITICAL: Setting modelId to null forces getBestModel to run.\n          isLocked: false, // Let the system dynamically choose the best model\n          temperature: 0.7,\n          maxTokens: 1500,\n        });\n\n        // 6. Generate with the Prompt Engineer's instructions\n        const fullRequest = `${promptEngineerRole.basePrompt}\\n\\n---\\n\\n${request}`;\n        \n        console.log('[PromptGen] ü§ñ Calling LLM...');\n        const generatedPrompt = await agent.generate(fullRequest);\n        console.log('[PromptGen] ‚úÖ AI-generated prompt created successfully');\n\n        return generatedPrompt;\n\n      } catch (error) {\n        console.error('[PromptGen] ‚ùå Failed to generate AI prompt:', error);\n        // Fallback to template on error\n        console.log('[PromptGen] üìã Falling back to template generation');\n        return generateTemplatePrompt(name, goal, category, capabilities);\n      }\n    }),\n\n  onboardProject: publicProcedure\n    .input(z.object({ rootPath: z.string() }))\n    .mutation(async ({ input }) => {\n      const stats = await onboardProject(input.rootPath, prisma);\n      return {\n        message: \"Project onboarding complete\",\n        ...stats,\n      };\n    }),\n\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/systemHealth.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/usage.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/vfs.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/volcano.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/routers/workspace.router.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/add-search-codebase-to-roles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/antigravity.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":24,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":24,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `Credentials`.","line":25,"column":27,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":25,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":31,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'reject' is defined but never used. Allowed unused args must match /^_/u.","line":37,"column":32,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":38},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":41,"column":38,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":55,"endColumn":6},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async function 'chatLoop' has no 'await' expression.","line":73,"column":1,"nodeType":"FunctionDeclaration","messageId":"missingAwait","endLine":73,"endColumn":24,"suggestions":[{"messageId":"removeAsync","fix":{"range":[2897,2903],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3186,3189],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3186,3189],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":84,"column":23,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":162,"endColumn":6},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":91,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3663,3666],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3663,3666],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":169,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":176,"endColumn":6,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[6576,6576],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[6576,6576],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { OAuth2Client } from 'google-auth-library';\nimport * as fs from 'fs';\nimport * as readline from 'readline';\nimport * as http from 'http';\nimport * as url from 'url';\nimport { exec } from 'child_process';\n\n// --- CONFIGURATION ---\n// In a real app, these come from your Google Cloud Console (APIs & Services > Credentials)\n// For emulation, you need an OAuth Client ID configured as a \"Desktop App\" or \"Web App\".\n// TODO: Replace these with your actual credentials\nconst CLIENT_ID = '1051593374104-hsif187melhbsmtka9m7cgi8nhekctuf.apps.googleusercontent.com';\nconst CLIENT_SECRET = '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';\nconst REDIRECT_URI = 'http://localhost:3000/oauth2callback';\nconst SCOPES = ['https://www.googleapis.com/auth/cloud-platform'];\nconst TOKEN_PATH = 'token.json';\n\n// --- 1. AUTHENTICATION (The \"Antigravity Login\" Layer) ---\nasync function getAccessToken(): Promise<string> {\n  const client = new OAuth2Client(CLIENT_ID, CLIENT_SECRET, REDIRECT_URI);\n\n  // A. Check if we already have a saved token\n  if (fs.existsSync(TOKEN_PATH)) {\n    const tokens = JSON.parse(fs.readFileSync(TOKEN_PATH, 'utf-8'));\n    client.setCredentials(tokens);\n    // Refresh if needed\n    try {\n      const { credentials } = await client.refreshAccessToken();\n      fs.writeFileSync(TOKEN_PATH, JSON.stringify(credentials));\n      return credentials.access_token!;\n    } catch (e) {\n      console.log(\"Token expired or invalid, re-authenticating...\");\n    }\n  }\n\n  // B. If not, start the \"Login with Google\" flow\n  return new Promise((resolve, reject) => {\n    const authUrl = client.generateAuthUrl({ access_type: 'offline', scope: SCOPES });\n    \n    // Create a temporary local server to catch the callback\n    const server = http.createServer(async (req, res) => {\n      if (req.url?.startsWith('/oauth2callback')) {\n        const qs = new url.URL(req.url, 'http://localhost:3000').searchParams;\n        const code = qs.get('code');\n        res.end('Login successful! You can close this tab.');\n        server.close();\n\n        if (code) {\n          const { tokens } = await client.getToken(code);\n          client.setCredentials(tokens);\n          fs.writeFileSync(TOKEN_PATH, JSON.stringify(tokens));\n          resolve(tokens.access_token!);\n        }\n      }\n    }).listen(3000);\n\n    // Open browser automatically\n    console.log('Opening browser for login...');\n    console.log(`IMPORTANT: Ensure this Redirect URI is added to your Google Cloud Console credentials: ${REDIRECT_URI}`);\n    const startCmd = process.platform == 'darwin' ? 'open' : process.platform == 'win32' ? 'start' : 'xdg-open';\n    exec(`${startCmd} \"${authUrl}\"`);\n    console.log(`If browser doesn't open, visit: ${authUrl}`);\n  });\n}\n\n// --- 2. THE API CALL (The \"Gemini 3\" Layer) ---\ninterface GeminiResponse {\n  candidates: {\n    content: { parts: { text?: string; thoughtSignature?: string }[] };\n  }[];\n}\n\nasync function chatLoop(accessToken: string) {\n  const rl = readline.createInterface({ input: process.stdin, output: process.stdout });\n  \n  // Antigravity State: We must track the signature to keep the \"Thread\" alive\n  let lastThoughtSignature: string | null = null;\n  const chatHistory: any[] = [];\n\n  console.log(\"\\n--- Antigravity Emulator Ready (Gemini 3 Pro) ---\");\n  console.log(\"Type your instruction (e.g., 'Create a plan for a snake game')\\n\");\n\n  const ask = () => {\n    rl.question('> ', async (userInput) => {\n      \n      // 1. Construct the Message\n      chatHistory.push({ role: 'user', parts: [{ text: userInput }] });\n\n      // 2. Prepare the Request Body\n      // Note: We inject the previous thoughtSignature if we have one.\n      const payload: any = {\n        contents: chatHistory,\n        generationConfig: {\n          thinkingConfig: {\n            thinkingLevel: \"high\" // <--- The \"Antigravity\" magic setting\n          }\n        }\n      };\n\n      // CRITICAL: If we have a signature from the previous turn, we MUST send it back\n      // or the model loses its \"train of thought\" and reasoning depth drops.\n      if (lastThoughtSignature) {\n        // In the REST API, this is often passed as a specific field in the previous content \n        // or a separate context field depending on the exact beta version.\n        // For emulation, we append it to the context or headers as per latest docs.\n        // (Implementation varies by exact beta version, conceptually it links the turns).\n        // Note: As of latest beta, it might be passed in 'contents' or separate field.\n        // We will try appending to the last model response in history if possible, \n        // or just rely on the session context if using the client library.\n        // Since we are using raw REST, we need to be careful.\n        // For now, we'll assume the model returns it and we just need to keep the history intact.\n        // Some versions require sending it back explicitly in a 'thought_signature' field.\n      }\n\n      // 3. The Raw Fetch Call\n      try {\n        const response = await fetch(\n          'https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent',\n          {\n            method: 'POST',\n            headers: {\n              'Content-Type': 'application/json',\n              'Authorization': `Bearer ${accessToken}`, // <--- The Google Login Token\n              'X-Goog-User-Project': 'YOUR_PROJECT_ID' // Required for OAuth calls\n            },\n            body: JSON.stringify(payload)\n          }\n        );\n\n        if (!response.ok) {\n          throw new Error(`API Error: ${response.status} ${await response.text()}`);\n        }\n\n        const data = await response.json() as GeminiResponse;\n        \n        if (!data.candidates || data.candidates.length === 0) {\n            console.log(\"No candidates returned.\");\n            ask();\n            return;\n        }\n\n        const candidate = data.candidates[0];\n        const responseText = candidate.content.parts.map(p => p.text).join('');\n        \n        // 4. Capture the Thought Signature for the next turn\n        // It acts like a \"save game\" state for the model's brain.\n        const sigPart = candidate.content.parts.find(p => p.thoughtSignature);\n        if (sigPart && sigPart.thoughtSignature) {\n           lastThoughtSignature = sigPart.thoughtSignature;\n        }\n\n        console.log(`\\nAntigravity Agent:\\n${responseText}\\n`);\n        \n        // Update history\n        chatHistory.push(candidate.content);\n        \n      } catch (e) {\n        console.error(\"Error:\", e);\n      }\n      \n      ask();\n    });\n  };\n\n  ask();\n}\n\n// --- RUN ---\n(async () => {\n  try {\n    const token = await getAccessToken();\n    await chatLoop(token);\n  } catch (err) {\n    console.error(\"Failed to start:\", err);\n  }\n})();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/backup_providers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/categorize-roles.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":110,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":110,"endColumn":19,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[4998,4998],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[4998,4998],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\n\n// Define category mappings\nconst categoryMap: Record<string, string[]> = {\n  'Executive & Leadership': [\n    'Ceo', 'chief-executive-officer', 'chief-operating-officer', 'chief-financial-officer', \n    'chief-technology-officer', 'chief-product-officer', 'chief-marketing-officer', \n    'chief-human-resources-officer', 'chief-data-officer', 'chief-information-officer',\n    'creative-director', 'communications-director', 'controller', 'financial-controller'\n  ],\n  'Engineering & Development': [\n    'architect', 'engineer', 'backend-developer', 'backend-engineer', 'frontend-developer', \n    'full-stack-developer', 'software-engineer', 'devops-engineer', 'site-reliability-engineer',\n    'cloud-architect', 'solution-architect', 'tech-lead', 'embedded-systems-engineer',\n    'game-developer', 'mobile-developer', 'blockchain-developer', 'database-administrator',\n    'network-engineer', 'security-engineer', 'qa-engineer', 'qa_specialist', 'quality-engineer',\n    'r-and-d-engineer', 'process-engineer', 'environmental-engineer', 'patent-engineer',\n    'bi-developer', 'data-engineer', 'machine-learning-engineer', 'ai-researcher'\n  ],\n  'Product & Design': [\n    'product-manager', 'product-owner', 'product-designer', 'design-lead', 'ui-designer', \n    'ux-designer', 'ux-researcher', 'interaction-designer', 'motion-designer', 'graphic-designer',\n    'instructional-designer', 'video-producer'\n  ],\n  'Data & Analytics': [\n    'data-scientist', 'data-analyst', 'business-analyst', 'business-intelligence-analyst',\n    'financial-analyst', 'marketing-analyst', 'healthcare-analyst', 'real-estate-analyst',\n    'budget-analyst', 'credit-analyst', 'investment-analyst', 'research-scientist',\n    'clinical-researcher', 'health-informatics'\n  ],\n  'Marketing & Sales': [\n    'marketing-manager', 'digital-marketing-specialist', 'digital-marketer', 'content-marketer',\n    'content-marketing-manager', 'growth-marketing-manager', 'growth-hacker', 'brand-manager',\n    'social-media-manager', 'seo-specialist', 'copywriter', 'content-creator', 'pr-manager',\n    'public-relations-manager', 'sales-manager', 'sales-engineer', 'account-manager',\n    'customer-success-manager', 'customer-service-manager', 'business-development-manager',\n    'business-developer', 'partnership-manager', 'pre-sales-consultant'\n  ],\n  'Operations & Management': [\n    'operations-manager', 'project-manager', 'program-manager', 'technical-pm', 'scrum-master',\n    'agile-coach', 'change-manager', 'change-management-specialist', 'risk-manager',\n    'compliance-manager', 'compliance-officer', 'quality-assurance-manager', 'contract-manager',\n    'procurement-manager', 'procurement-specialist', 'supply-chain-manager', 'facilities-manager',\n    'facility-manager', 'office-manager', 'executive-assistant', 'business-process-analyst',\n    'implementation-consultant', 'strategy-consultant', 'innovation-manager', 'sustainability-manager',\n    'production-manager'\n  ],\n  'HR & Admin': [\n    'hr-manager', 'talent-acquisition', 'talent-acquisition-specialist', 'learning-development',\n    'learning-development-manager', 'training-specialist', 'corporate-trainer', 'curriculum-developer',\n    'organizational-developer', 'organizational-development-manager', 'diversity-inclusion',\n    'diversity-inclusion-manager', 'compensation-benefits', 'compensation-benefits-manager',\n    'payroll-manager'\n  ],\n  'Finance & Legal': [\n    'accountant', 'accounting-manager', 'tax-manager', 'treasury-manager', 'internal-auditor',\n    'legal-counsel', 'privacy-officer', 'investor-relations', 'investor-relations-manager'\n  ],\n  'IT & Support': [\n    'it-administrator', 'help-desk-specialist', 'technical-support', 'technical-support-engineer',\n    'technical-writer', 'medical-writer'\n  ],\n  'System Agents': [\n    'role orchestrator', 'short lived agent', 'sql-query-helper'\n  ]\n};\n\nasync function categorizeRoles() {\n  console.log('Starting Role Categorization...');\n\n  try {\n    const roles = await prisma.role.findMany();\n    console.log(`Found ${roles.length} roles to process.`);\n\n    for (const role of roles) {\n      let newCategory = 'Uncategorized';\n      const normalizedName = role.name.toLowerCase().trim();\n\n      // Find matching category\n      for (const [category, keywords] of Object.entries(categoryMap)) {\n        if (keywords.some(k => normalizedName === k.toLowerCase() || normalizedName.includes(k.toLowerCase()))) {\n          newCategory = category;\n          break;\n        }\n      }\n\n      // Update Role\n      await prisma.role.update({\n        where: { id: role.id },\n        data: {\n          categoryString: newCategory,\n        }\n      });\n      \n      // console.log(`Updated ${role.name} -> ${newCategory}`);\n    }\n\n    console.log('All roles categorized and updated successfully.');\n\n  } catch (error) {\n    console.error('Error updating roles:', error);\n  } finally {\n    await prisma.$disconnect();\n  }\n}\n\ncategorizeRoles();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/check-roles.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":28,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":15},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":39,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":39,"endColumn":17,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1144,1144],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1144,1144],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\n\nasync function checkDatabase() {\n  try {\n    // 1. Check if we can query the Role table at all\n    const roleCount = await prisma.role.count();\n    console.log(`Current Role Count: ${roleCount}`);\n\n    if (roleCount > 0) {\n      const firstRole = await prisma.role.findFirst();\n      console.log('Sample Role:', firstRole);\n    } else {\n      console.log('No roles found in the database.');\n    }\n\n    // 2. Check for the 'category' column specifically using raw SQL\n    // This helps us see if the DB schema matches the Prisma schema\n    try {\n        const result = await prisma.$queryRaw`\n            SELECT column_name \n            FROM information_schema.columns \n            WHERE table_name = 'Role' AND column_name = 'category';\n        `;\n        console.log('Category column check:', result);\n    } catch (e) {\n        console.log('Could not check information_schema (might be permissions or table name casing).');\n    }\n\n  } catch (error) {\n    console.error('Error querying database:', error);\n  } finally {\n    await prisma.$disconnect();\n  }\n}\n\ncheckDatabase();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/check_duplicate_roles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/delete_old_ui_role.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/drop_view.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":19,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":19,"endColumn":8,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[378,378],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[378,378],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import postgres from 'postgres';\nimport dotenv from 'dotenv';\n\ndotenv.config({ path: '../../.env.local' });\n\nconst sql = postgres(process.env.DATABASE_URL!);\n\nasync function main() {\n  try {\n    await sql`DROP VIEW IF EXISTS unified_models CASCADE`;\n    console.log('Dropped view unified_models');\n  } catch (e) {\n    console.error(e);\n  } finally {\n    await sql.end();\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/dump_roles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/export_db_to_json.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":30,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":30,"endColumn":73},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":30,"column":26,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":30,"endColumn":71},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[685,688],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[685,688],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access [table.toLowerCase()] on an `any` value.","line":30,"column":42,"nodeType":"CallExpression","messageId":"unsafeMemberExpression","endLine":30,"endColumn":61},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":42,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":42,"endColumn":58,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1053,1053],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1053,1053],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client';\nimport fs from 'fs';\nimport path from 'path';\n\nconst prisma = new PrismaClient();\n\nasync function exportTablesToJson() {\n  const backupDir = path.join(process.cwd(), 'apps', 'api', 'db_backups');\n\n  // List of tables to export (add more as needed)\n  const tables = [\n    'Model',\n    'Role',\n    'ProviderConfig',\n    'ModelConfig',\n    'ModelFailure',\n    'ProviderFailure',\n    'ModelUsage',\n    'RawDataLake',\n    'FlattenedTable',\n    'TableMapping',\n    'Workspace',\n    'WorkOrderCard',\n    'Job'\n  ];\n\n  for (const table of tables) {\n    try {\n      // Dynamically call prisma[table].findMany()\n      const data = await (prisma as any)[table.toLowerCase()].findMany();\n      const filePath = path.join(backupDir, `${table}.json`);\n      fs.writeFileSync(filePath, JSON.stringify(data, null, 2));\n      console.log(`‚úÖ Exported ${table} to ${filePath}`);\n    } catch (error) {\n      console.warn(`‚ö†Ô∏è Failed to export ${table}:`, error);\n    }\n  }\n\n  console.log('üéâ All tables exported to JSON.');\n}\n\nexportTablesToJson().finally(() => prisma.$disconnect());","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/fix-roles.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":24,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[775,778],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[775,778],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":33,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":33,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .categoryString on an `any` value.","line":39,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":39,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":48,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":48,"endColumn":24},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":62,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":62,"endColumn":12,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1748,1748],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1748,1748],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\n\nasync function fixRoles() {\n  console.log('Starting Role Fixer...');\n\n  try {\n    // 1. Ensure 'category' column exists (Safe Schema Patch)\n    try {\n      console.log('Checking for category column...');\n      await prisma.$executeRawUnsafe(`ALTER TABLE \"Role\" ADD COLUMN IF NOT EXISTS \"category\" TEXT DEFAULT 'Uncategorized';`);\n      console.log('Ensured \"category\" column exists.');\n    } catch (e) {\n      console.warn('Could not alter table (might already exist or permissions issue):', e);\n    }\n\n    // 2. Fetch all roles\n    const roles = await prisma.role.findMany();\n    console.log(`Found ${roles.length} roles to update.`);\n\n    for (const role of roles) {\n      const updates: any = {};\n      let needsUpdate = false;\n\n      // A. Fix Context Window (Removed feature)\n      // if (!role.maxContext || role.maxContext < 36000) { ... }\n\n      // B. Fix Tools (Add research_browser)\n      const currentTools = role.tools || [];\n      if (!currentTools.includes('research_browser')) {\n        updates.tools = [...currentTools, 'research_browser'];\n        needsUpdate = true;\n      }\n\n      // C. Fix Category (for UI Grouping)\n      if (!role.categoryString) {\n        updates.categoryString = 'General';\n        needsUpdate = true;\n      }\n\n      // Apply Updates\n      if (needsUpdate) {\n        console.log(`Updating Role: ${role.name}...`);\n        await prisma.role.update({\n          where: { id: role.id },\n          data: updates,\n        });\n      }\n    }\n\n    console.log('All roles processed successfully.');\n\n  } catch (error) {\n    console.error('Critical Error in Fix Script:', error);\n  } finally {\n    await prisma.$disconnect();\n  }\n}\n\nfixRoles();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/fix_role_typos.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/import-roles.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[802,805],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[802,805],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access [key] on an `any` value.","line":39,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":39,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":48,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":48,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":49,"column":9,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":49,"endColumn":74},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":49,"column":17,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":49,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":49,"column":17,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":49,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":49,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":49,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .map on an `any` value.","line":49,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":49,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":54,"column":18,"nodeType":"Property","messageId":"anyAssignment","endLine":54,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":54,"column":36,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":54,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":58,"column":23,"nodeType":"Property","messageId":"anyAssignment","endLine":58,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":58,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":58,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":61,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":61,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":61,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":61,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":64,"column":23,"nodeType":"Property","messageId":"anyAssignment","endLine":64,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":64,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":64,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":68,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":68,"endColumn":50},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":91,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":91,"endColumn":15,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[2499,2499],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[2499,2499],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":18,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env tsx\nimport { prisma } from '../db.js';\nimport fs from 'fs';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nasync function importRoles() {\n  try {\n    const agentsDir = path.resolve(__dirname, '../../data/agents/en');\n    \n    if (!fs.existsSync(agentsDir)) {\n      throw new Error(`Agents directory not found at ${agentsDir}`);\n    }\n\n    const files = fs.readdirSync(agentsDir).filter(f => f.endsWith('.md'));\n    let count = 0;\n\n    for (const file of files) {\n      const content = fs.readFileSync(path.join(agentsDir, file), 'utf-8');\n      \n      // Parse frontmatter\n      const match = content.match(/^---\\n([\\s\\S]*?)\\n---\\n([\\s\\S]*)$/);\n      \n      let frontmatter: any = {};\n      let body = content;\n\n      if (match) {\n        const fmString = match[1];\n        body = match[2].trim();\n        \n        fmString.split('\\n').forEach(line => {\n          const parts = line.split(':');\n          if (parts.length >= 2) {\n            const key = parts[0].trim();\n            const value = parts.slice(1).join(':').trim();\n            frontmatter[key] = value;\n          }\n        });\n      } else {\n        frontmatter = { name: file.replace('.md', '') };\n      }\n\n      // Parse tools\n      let tools: string[] = [];\n      if (frontmatter.tools) {\n        tools = frontmatter.tools.split(',').map((t: string) => t.trim());\n      }\n\n      // Upsert Role\n      await prisma.role.upsert({\n        where: { name: frontmatter.name || file.replace('.md', '') },\n        update: {\n          basePrompt: body,\n          tools: tools,\n          metadata: { description: frontmatter.description }\n        },\n        create: {\n          name: frontmatter.name || file.replace('.md', ''),\n          basePrompt: body,\n          tools: tools,\n          metadata: { description: frontmatter.description }\n        }\n      });\n      \n      console.log(`‚úÖ Imported: ${frontmatter.name || file}`);\n      count++;\n    }\n\n    console.log(`\\nüéâ Successfully imported ${count} roles!`);\n    \n    // Show all roles\n    const allRoles = await prisma.role.findMany({\n      select: { name: true, tools: true }\n    });\n    \n    console.log('\\nRoles in database:');\n    allRoles.forEach(role => {\n      console.log(`  - ${role.name}: [${role.tools.join(', ')}]`);\n    });\n    \n    process.exit(0);\n  } catch (error) {\n    console.error('‚ùå Import failed:', error);\n    process.exit(1);\n  }\n}\n\nimportRoles();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/ingest-agents.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/ingest-codebase.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'path' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":12},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":17,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":17,"endColumn":8,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[441,441],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[441,441],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { ingestionAgent } from '../services/IngestionAgent.js';\nimport path from 'path';\n\nasync function main() {\n  const rootDir = process.argv[2] || '/home/guy/mono/apps/api'; // Default to api app\n  console.log(`Starting ingestion for directory: ${rootDir}`);\n  \n  try {\n    await ingestionAgent.ingestRepository(rootDir);\n    console.log('Ingestion complete.');\n  } catch (error) {\n    console.error('Ingestion failed:', error);\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/ingest_models_robust.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/inventory_roles.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | ArrayBufferView<ArrayBufferLike>`.","line":23,"column":51,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":23,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stack on an `any` value.","line":23,"column":53,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":23,"endColumn":58}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { PrismaClient } from '@prisma/client';\nimport fs from 'fs';\n\nconst prisma = new PrismaClient();\n\nasync function main() {\n  const roles = await prisma.role.findMany({\n    select: {\n      id: true,\n      name: true,\n      categoryString: true\n    }\n  });\n  \n  const output = roles.map(r => `ID: ${r.id}, Name: ${r.name}, Category: ${r.categoryString}`).join('\\n');\n  fs.writeFileSync('roles_inventory.txt', output);\n  console.log('Roles inventory written to roles_inventory.txt');\n}\n\nmain()\n  .catch(e => {\n    fs.writeFileSync('roles_inventory_error.txt', e.stack);\n    process.exit(1);\n  })\n  .finally(async () => {\n    await prisma.$disconnect();\n  });\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/list_roles.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/manage_providers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/migrate_gm.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[310,313],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[310,313],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":18,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":18,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":19,"column":11,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":19,"endColumn":104},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":19,"column":19,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":19,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":19,"column":19,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":19,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":19,"column":19,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":19,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":19,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":19,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .map on an `any` value.","line":19,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":19,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .filter on an `any` value.","line":19,"column":69,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":19,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":20,"column":36,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":20,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":21,"column":11,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":21,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":21,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":21,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":25,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":25,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":25,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":25,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":25,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":25,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":26,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":26,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .basePrompt on an `any` value.","line":26,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":26,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .prompt on an `any` value.","line":26,"column":43,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":26,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":27,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":27,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .category on an `any` value.","line":27,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":27,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":28,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":28,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":28,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":28,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .needsVision on an `any` value.","line":29,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":29,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .needsVision on an `any` value.","line":29,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":29,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .needsReasoning on an `any` value.","line":30,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":30,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .needsReasoning on an `any` value.","line":30,"column":62,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":30,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .needsCoding on an `any` value.","line":31,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":31,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .needsCoding on an `any` value.","line":31,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":31,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":35,"column":64,"nodeType":"Property","messageId":"anyAssignment","endLine":35,"endColumn":83},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1627,1630],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1627,1630],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":51,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":51,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1822,1825],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1822,1825],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":57,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":57,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .model_id on an `any` value.","line":57,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":57,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":57,"column":38,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":57,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":58,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":58,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .provider_id on an `any` value.","line":58,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":58,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .provider on an `any` value.","line":58,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":58,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":59,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":59,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .model_name on an `any` value.","line":59,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":59,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":59,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":59,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":60,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":60,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerData on an `any` value.","line":60,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":60,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":62,"column":42,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":62,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .context_window on an `any` value.","line":62,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":62,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .is_free on an `any` value.","line":63,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":63,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .is_free on an `any` value.","line":63,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":63,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":68,"column":40,"nodeType":"Property","messageId":"anyAssignment","endLine":68,"endColumn":72},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":68,"column":74,"nodeType":"Property","messageId":"anyAssignment","endLine":68,"endColumn":100},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":81,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":81,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2988,2991],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2988,2991],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":82,"column":9,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":82,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":82,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":82,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":51,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { PrismaClient } from \"@prisma/client\";\n\nconst prisma = new PrismaClient();\n\nasync function main() {\n  console.log(\"Starting Emergency Migration: g -> Role, m -> Model\");\n\n  // --- MIGRATE 'g' (Roles) ---\n  try {\n    console.log(\"Checking table 'g'...\");\n    const rowsG = await prisma.$queryRawUnsafe<any[]>(`SELECT * FROM \"g\"`);\n    console.log(`Found ${rowsG.length} rows in 'g'. Migrating to Role...`);\n\n    let roleCount = 0;\n    for (const row of rowsG) {\n      let tools: string[] = [];\n      if (typeof row.tools === 'string') {\n          tools = row.tools.split(',').map((t: string) => t.trim()).filter((t: string) => t.length > 0);\n      } else if (Array.isArray(row.tools)) {\n          tools = row.tools;\n      }\n\n      const roleData = {\n        name: row.name || row.role || `Imported Role ${Date.now()}`,\n        basePrompt: row.basePrompt || row.prompt || \"\",\n        category: row.category || 'Migrated From g',\n        description: row.description || \"\",\n        needsVision: row.needsVision === 'true' || row.needsVision === true,\n        needsReasoning: row.needsReasoning === 'true' || row.needsReasoning === true,\n        needsCoding: row.needsCoding === 'true' || row.needsCoding === true,\n        tools: tools,\n      };\n\n      const existing = await prisma.role.findUnique({ where: { name: roleData.name } });\n      if (existing) {\n        await prisma.role.update({ where: { id: existing.id }, data: roleData });\n      } else {\n        await prisma.role.create({ data: roleData });\n      }\n      roleCount++;\n    }\n    console.log(`Successfully migrated ${roleCount} roles.`);\n  } catch (error: any) {\n    console.error(\"Failed to migrate 'g':\", error);\n  }\n\n  // --- MIGRATE 'm' (Models) ---\n  try {\n    console.log(\"Checking table 'm'...\");\n    const rowsM = await prisma.$queryRawUnsafe<any[]>(`SELECT * FROM \"m\"`);\n    console.log(`Found ${rowsM.length} rows in 'm'. Migrating to Model...`);\n\n    let modelCount = 0;\n    for (const row of rowsM) {\n      const modelData = {\n        modelId: row.model_id || row.id || `migrated-${Date.now()}`,\n        providerId: row.provider_id || row.provider || \"unknown\",\n        name: row.model_name || row.name || \"Unnamed Model\",\n        providerData: row.providerData || {},\n        aiData: {},\n        specs: { contextWindow: parseInt(row.context_window || '0') },\n        isFree: row.is_free === 'true' || row.is_free === true,\n        costPer1k: 0,\n      };\n\n      const existing = await prisma.model.findUnique({ \n        where: { providerId_modelId: { providerId: modelData.providerId, modelId: modelData.modelId } } \n      });\n      \n      if (existing) {\n          await prisma.model.update({ where: { id: existing.id }, data: modelData });\n      } else {\n          try {\n             await prisma.model.create({ data: modelData });\n          } catch(e) { console.warn(\"Skipping.\", e); }\n      }\n      modelCount++;\n    }\n    console.log(`Successfully migrated ${modelCount} models.`);\n  } catch (error: any) {\n    if (error.message.includes('does not exist')) {\n        console.log(\"Table 'm' does not exist. Skipping Model migration.\");\n    } else {\n        console.error(\"Failed to migrate 'm':\", error);\n    }\n  }\n\n  console.log(\"Migration Complete.\");\n}\n\nmain()\n  .catch(e => {\n    console.error(e);\n    process.exit(1);\n  })\n  .finally(async () => {\n    await prisma.$disconnect();\n  });\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/restore_raw_table.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":36,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":36,"endColumn":8,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[967,967],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[967,967],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\n\nasync function main() {\n  try {\n    console.log(\"Safely creating RawDataLake table...\");\n    await prisma.$executeRawUnsafe(`\n      CREATE TABLE IF NOT EXISTS \"RawDataLake\" (\n          \"id\" TEXT NOT NULL,\n          \"provider\" TEXT NOT NULL,\n          \"rawData\" JSONB NOT NULL,\n          \"ingestedAt\" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      \n          CONSTRAINT \"RawDataLake_pk\" PRIMARY KEY (\"id\")\n      );\n    `);\n    console.log(\"‚úÖ RawDataLake table created (if it didn't exist).\");\n    \n    // Verify it exists\n    const result = await prisma.$queryRawUnsafe(`\n        SELECT table_name \n        FROM information_schema.tables \n        WHERE table_schema = 'public' AND table_name = 'RawDataLake'\n    `);\n    console.log(\"Verification:\", result);\n\n  } catch (e) {\n    console.error(\"Error creating table:\", e);\n  } finally {\n    await prisma.$disconnect();\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/seed-ghost-records.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/seed_datacenter_helper.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":43,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":43,"endColumn":44,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[2192,2192],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[2192,2192],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client';\nconst prisma = new PrismaClient();\n\nasync function main() {\n  await prisma.role.upsert({\n    where: { name: 'Datacenter Helper' },\n    update: {\n      basePrompt: `You are a Datacenter Helper AI. You are an expert database administrator and system integrator with full access to manage database schemas, run migrations, backup data, and perform complex data operations. You have tools to execute SQL queries, manage database tables, search codebases, and access file systems for comprehensive data center management.\n\nYour capabilities include:\n- Database schema management and migrations\n- SQL query execution and optimization\n- Data backup and restoration\n- Table creation, modification, and deletion\n- Codebase analysis for database-related changes\n- File system operations for data management\n- Automated backup procedures before schema changes\n\nAlways prioritize data safety - create backups before making destructive changes, validate queries before execution, and ensure data integrity.`,\n      categoryString: 'Infrastructure & Operations',\n    },\n    create: {\n      name: 'Datacenter Helper',\n      basePrompt: `You are a Datacenter Helper AI. You are an expert database administrator and system integrator with full access to manage database schemas, run migrations, backup data, and perform complex data operations. You have tools to execute SQL queries, manage database tables, search codebases, and access file systems for comprehensive data center management.\n\nYour capabilities include:\n- Database schema management and migrations\n- SQL query execution and optimization\n- Data backup and restoration\n- Table creation, modification, and deletion\n- Codebase analysis for database-related changes\n- File system operations for data management\n- Automated backup procedures before schema changes\n\nAlways prioritize data safety - create backups before making destructive changes, validate queries before execution, and ensure data integrity.`,\n      tools: ['postgres', 'filesystem', 'search_codebase'],\n      categoryString: 'Infrastructure & Operations',\n    }\n  });\n  console.log('‚úÖ Datacenter Helper role created or updated.');\n}\n\nmain().finally(() => prisma.$disconnect());","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/seed_orchestrations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/seed_org_chart.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":42,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":42,"endColumn":8,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1334,1334],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1334,1334],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client';\nconst prisma = new PrismaClient();\n\nconst ORG_CHART = [\n  {\n    name: 'architect',\n    basePrompt: `You are a Senior Software Architect. You do NOT write code. You PLAN systems. \n    You think in systems, dependencies, and data structures. You are precise and authoritative.`,\n    needsReasoning: true,\n    tools: ['research_browser'] // Give access to docs\n  },\n  {\n    name: 'engineer',\n    basePrompt: `You are a Senior Full-Stack Developer. You execute orders precisely. \n    You write clean, documented, robust TypeScript code. You prefer small, testable functions.`,\n    needsCoding: true,\n    tools: ['file_system', 'terminal', 'git'] // The \"Hands\"\n  },\n  {\n    name: 'qa_specialist',\n    basePrompt: `You are a QA Lead. You are skeptical, pedantic, and annoying. \n    Your job is to find flaws. If a job claims to be done, you verify it physically. \n    If it fails, you REJECT it.`,\n    needsReasoning: true,\n    tools: ['file_system', 'terminal', 'browser_test']\n  }\n];\n\nasync function main() {\n  console.log('üè¢ Staffing the Corporation...');\n\n  for (const employee of ORG_CHART) {\n    await prisma.role.upsert({\n      where: { name: employee.name },\n      update: { ...employee },\n      create: { ...employee }\n    });\n    console.log(` -> Hired: ${employee.name}`);\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/seed_prompt_engineer.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":33,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":33,"endColumn":44,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1488,1488],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1488,1488],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client';\nimport * as dotenv from 'dotenv';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n// ../../.. -> src/scripts -> src -> api -> apps -> root\nconst envPath = path.resolve(__dirname, '../../../../.env.local');\nconsole.log(`Loading env from: ${envPath}`);\ndotenv.config({ path: envPath });\n\nconst prisma = new PrismaClient();\n\nasync function main() {\n  await prisma.role.upsert({\n    where: { name: 'Prompt Engineer' },\n    update: {\n      basePrompt: `You are a Prompt Engineer. You specialize in crafting, refining, and optimizing prompts for AI models. You understand model capabilities, limitations, and how to elicit the best responses. Your goal is to generate clear, effective, and safe prompts for any use case.`,\n      tools: ['research_browser', 'search_codebase'],\n      categoryString: 'Specialized Workers',\n    },\n    create: {\n      name: 'Prompt Engineer',\n      basePrompt: `You are a Prompt Engineer. You specialize in crafting, refining, and optimizing prompts for AI models. You understand model capabilities, limitations, and how to elicit the best responses. Your goal is to generate clear, effective, and safe prompts for any use case.`,\n      tools: ['research_browser', 'search_codebase'],\n      categoryString: 'Specialized Workers',\n    }\n  });\n  console.log('‚úÖ Prompt Engineer role created or updated.');\n}\n\nmain().finally(() => prisma.$disconnect());\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/seed_ui_designer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/setup-vector-db.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":44,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":44,"endColumn":8,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[1351,1351],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[1351,1351],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { prisma } from '../db.js';\n\nasync function main() {\n  try {\n    console.log('Creating VectorEmbedding table if not exists...');\n    await prisma.$executeRawUnsafe(`\n      CREATE TABLE IF NOT EXISTS \"VectorEmbedding\" (\n        \"id\" TEXT NOT NULL,\n        \"vector\" TEXT,\n        \"content\" TEXT NOT NULL,\n        \"filePath\" TEXT NOT NULL,\n        \"metadata\" JSONB,\n        \"createdAt\" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,\n        CONSTRAINT \"VectorEmbedding_pkey\" PRIMARY KEY (\"id\")\n      );\n    `);\n    console.log('Table created (vector stored as TEXT/JSON for now).');\n    \n    console.log('Creating index...');\n    await prisma.$executeRawUnsafe(`\n      CREATE INDEX IF NOT EXISTS \"VectorEmbedding_filePath_idx\" ON \"VectorEmbedding\"(\"filePath\");\n    `);\n    console.log('Index created.');\n\n    console.log('Creating FileIndex table if not exists...');\n    await prisma.$executeRawUnsafe(`\n      CREATE TABLE IF NOT EXISTS \"FileIndex\" (\n        \"filePath\" TEXT NOT NULL,\n        \"contentHash\" TEXT NOT NULL,\n        \"updatedAt\" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,\n        CONSTRAINT \"FileIndex_pkey\" PRIMARY KEY (\"filePath\")\n      );\n    `);\n    console.log('FileIndex table created.');\n\n  } catch (error) {\n    console.error('Failed to setup vector DB:', error);\n  } finally {\n    await prisma.$disconnect();\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/scripts/verify_normalization.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":37,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":37,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1237,1240],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1237,1240],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":41,"column":50,"nodeType":"MemberExpression","messageId":"unsafeReturn","endLine":41,"endColumn":63},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .column_name on an `any` value.","line":41,"column":52,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":41,"endColumn":63}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nimport { PrismaClient } from \"@prisma/client\";\n\nconst prisma = new PrismaClient();\n\nasync function main() {\n  console.log(\"Starting Normalization Verification...\");\n\n  // 1. Create a mock source table with raw data\n  const rawTableName = `raw_import_${Date.now()}`;\n  console.log(`Creating mock raw table: ${rawTableName}`);\n  \n  await prisma.$executeRawUnsafe(`\n    CREATE TABLE \"${rawTableName}\" (\n      id TEXT,\n      provider_id TEXT,\n      model_name TEXT,\n      context_length INTEGER,\n      pricing JSONB\n    )\n  `);\n\n  await prisma.$executeRawUnsafe(`\n    INSERT INTO \"${rawTableName}\" VALUES \n    ('gpt-4-turbo', 'openai', 'GPT-4 Turbo', 128000, '{\"prompt\": 0.01, \"completion\": 0.03}'),\n    ('claude-3-opus', 'anthropic', 'Claude 3 Opus', 200000, '{\"prompt\": 0.015, \"completion\": 0.075}')\n  `);\n\n  // 2. Call the normalize mutation logic (simulated call or direct DB interaction)\n  // Since we can't easily invoke the TRPC router directly from here without context mocking,\n  // we will manually test the LOGIC that `normalizeToRegistry` uses:\n  // - Dynamic inspection\n  // - Column mapping\n  // - Insertion into model_registry\n\n  console.log(\"Inspecting raw table columns...\");\n  const columns = await prisma.$queryRawUnsafe<any[]>(`\n    SELECT column_name FROM information_schema.columns \n    WHERE table_name = '${rawTableName}'\n  `);\n  console.log(\"Columns found:\", columns.map(c => c.column_name));\n\n  // 3. Clean up\n  await prisma.$executeRawUnsafe(`DROP TABLE \"${rawTableName}\"`);\n  console.log(\"Verification Clean. Logic seems accessible.\");\n}\n\nmain()\n  .catch(e => {\n    console.error(e);\n    process.exit(1);\n  })\n  .finally(async () => {\n    await prisma.$disconnect();\n  });\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ActionHandler.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":24,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":24,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":25,"column":48,"nodeType":"Property","messageId":"anyAssignment","endLine":25,"endColumn":54},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1481,1484],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1481,1484],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":44,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":44,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":44,"column":16,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":44,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from 'fs/promises';\nimport path from 'path';\nimport { exec } from 'child_process';\nimport util from 'util';\n\nconst execAsync = util.promisify(exec);\n\nexport class ActionHandler {\n  async executeActionsFromText(text: string, workspaceRoot: string) {\n    const actions = [];\n\n    const fileRegex = /```write:(.*?)[\\n\\r]+([\\s\\S]*?)```/g;\n    let match;\n    while ((match = fileRegex.exec(text)) !== null) {\n      const relativePath = match[1].trim();\n      const content = match[2];\n      await this.writeFile(workspaceRoot, relativePath, content);\n      actions.push({ type: 'write', path: relativePath });\n    }\n\n    const cmdRegex = /```bash:(.*?)[\\n\\r]+([\\s\\S]*?)```/g;\n    while ((match = cmdRegex.exec(text)) !== null) {\n      const command = match[2].trim();\n      const output = await this.runCommand(workspaceRoot, command);\n      actions.push({ type: 'command', command, output });\n    }\n\n    return actions;\n  }\n\n  private async writeFile(root: string, relPath: string, content: string) {\n    const fullPath = path.join(root, relPath);\n    await fs.mkdir(path.dirname(fullPath), { recursive: true });\n    await fs.writeFile(fullPath, content);\n    console.log(`[ActionHandler] üìù Wrote file: ${relPath}`);\n  }\n\n  private async runCommand(root: string, command: string) {\n    try {\n      console.log(`[ActionHandler] üíª Running: ${command}`);\n      const { stdout, stderr } = await execAsync(command, { cwd: root });\n      return stdout || stderr;\n    } catch (e: any) {\n      return e.message;\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/AgentFactory.test.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[419,422],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[419,422],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[448,451],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[448,451],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":14,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[480,483],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[480,483],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":15,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[507,510],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[507,510],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1004,1007],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1004,1007],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":95,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":98,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1014,1017],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1014,1017],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async arrow function has no 'await' expression.","line":39,"column":100,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":39,"endColumn":102,"suggestions":[{"messageId":"removeAsync","fix":{"range":[987,993],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":40,"column":9,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":40,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":40,"column":16,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":40,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .generateCompletion on an `any` value.","line":40,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":40,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":46,"column":5,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":46,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .generateCompletion on an `any` value.","line":46,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":46,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":49,"column":5,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":49,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .generateCompletion on an `any` value.","line":49,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":49,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":52,"column":5,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":52,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .getProvider on an `any` value.","line":52,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":52,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":53,"column":32,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":53,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":54,"column":32,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":54,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `ModelSelectionResult | null`.","line":59,"column":60,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":65,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":65,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":65,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1982,1985],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1982,1985],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `BaseLLMProvider`.","line":68,"column":7,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":68,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `IProviderManager`.","line":72,"column":7,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":72,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `IAgentConfigRepository`.","line":73,"column":7,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":73,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .generateCompletion on an `any` value.","line":87,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":87,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .generateCompletion on an `any` value.","line":89,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":89,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":95,"column":5,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":95,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .generateCompletion on an `any` value.","line":95,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":95,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":97,"column":5,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":97,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .getProvider on an `any` value.","line":97,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":97,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `ModelSelectionResult | null`.","line":100,"column":60,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":106,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3396,3399],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3396,3399],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `BaseLLMProvider`.","line":109,"column":7,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":109,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `IProviderManager`.","line":113,"column":7,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":113,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `IAgentConfigRepository`.","line":114,"column":7,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":114,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":34,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi, beforeEach } from 'vitest';\nimport { VolcanoAgent } from './AgentFactory.js';\nimport * as modelManager from '../services/modelManager.service.js';\nimport * as rateLimiter from '../rateLimiter.js';\n\n// Mock dependencies\nvi.mock('./ProviderManager.js');\nvi.mock('../services/modelManager.service.js');\nvi.mock('../rateLimiter.js');\n\ndescribe('VolcanoAgent', () => {\n  let mockProvider: any;\n  let mockNextProvider: any;\n  let mockProviderManager: any;\n  let mockConfigRepo: any;\n\n  beforeEach(() => {\n    vi.clearAllMocks();\n\n    mockProvider = {\n      id: 'provider-1',\n      generateCompletion: vi.fn(),\n    };\n\n    mockNextProvider = {\n      id: 'provider-2',\n      generateCompletion: vi.fn(),\n    };\n\n    mockProviderManager = {\n        getProvider: vi.fn(),\n    };\n\n    mockConfigRepo = {\n        getRole: vi.fn(),\n    };\n\n    // Mock rate limiter to just pass through to provider\n    vi.mocked(rateLimiter.executeWithRateLimit).mockImplementation(async (provider: any, req: any) => {\n        return provider.generateCompletion(req);\n    });\n  });\n\n  it('should fallback to the next best model when the first provider fails', async () => {\n    // Setup initial failure\n    mockProvider.generateCompletion.mockRejectedValue({ status: 500, message: 'Server Error' });\n    \n    // Setup successful recovery\n    mockNextProvider.generateCompletion.mockResolvedValue('Success after failover');\n\n    // Mock ProviderManager to return providers\n    mockProviderManager.getProvider.mockImplementation((id: string) => {\n      if (id === 'provider-1') return mockProvider;\n      if (id === 'provider-2') return mockNextProvider;\n      return undefined;\n    });\n\n    // Mock getBestModel to return the next model\n    vi.mocked(modelManager.getBestModel).mockResolvedValue({\n      modelId: 'gpt-4-backup',\n      providerId: 'provider-2',\n      temperature: 0.7,\n      maxTokens: 100,\n      model: { id: 'gpt-4-backup', providerId: 'provider-2' }\n    } as any);\n\n    const agent = new VolcanoAgent(\n      mockProvider,\n      'System Prompt',\n      { apiModelId: 'gpt-4-primary', temperature: 0.7, maxTokens: 100 },\n      'role-1',\n      mockProviderManager,\n      mockConfigRepo\n    );\n\n    // Override wait time to 0 for test speed\n    vi.useFakeTimers();\n\n    const generatePromise = agent.generate('User Goal');\n    \n    // Fast-forward time to skip the backoff\n    await vi.runAllTimersAsync();\n    \n    const result = await generatePromise;\n\n    expect(result).toBe('Success after failover');\n    expect(mockProvider.generateCompletion).toHaveBeenCalledTimes(1);\n    expect(modelManager.getBestModel).toHaveBeenCalledWith('role-1', ['gpt-4-primary']);\n    expect(mockNextProvider.generateCompletion).toHaveBeenCalledTimes(1);\n    \n    vi.useRealTimers();\n  });\n\n  it('should throw an error if the orchestrator returns a failed model', async () => {\n    mockProvider.generateCompletion.mockRejectedValue({ status: 500, message: 'Server Error' });\n\n    mockProviderManager.getProvider.mockReturnValue(mockProvider);\n\n    // Orchestrator returns the SAME provider that just failed (simulating a bug or exhaustion)\n    vi.mocked(modelManager.getBestModel).mockResolvedValue({\n      modelId: 'gpt-4-primary',\n      providerId: 'provider-1', // SAME ID\n      temperature: 0.7,\n      maxTokens: 100,\n      model: { id: 'gpt-4-primary', providerId: 'provider-1' }\n    } as any);\n\n    const agent = new VolcanoAgent(\n      mockProvider,\n      'System Prompt',\n      { apiModelId: 'gpt-4-primary', temperature: 0.7, maxTokens: 100 },\n      'role-1',\n      mockProviderManager,\n      mockConfigRepo\n    );\n\n    vi.useFakeTimers();\n    const generatePromise = agent.generate('User Goal');\n    await vi.runAllTimersAsync();\n\n    await expect(generatePromise).rejects.toThrow(/Orchestrator returned failed model/);\n    \n    vi.useRealTimers();\n  });\n});\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/AgentFactory.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1276,1279],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1276,1279],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":29,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":29,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1316,1319],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1316,1319],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1465,1468],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1465,1468],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":129,"column":17,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":129,"endColumn":96},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":129,"column":30,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":129,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .get on an `any` value.","line":129,"column":43,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":129,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":130,"column":49,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":130,"endColumn":59},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":190,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":190,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8232,8235],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8232,8235],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":261,"column":28,"nodeType":"Property","messageId":"anyAssignment","endLine":261,"endColumn":69},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":261,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":261,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10533,10536],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10533,10536],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":261,"column":55,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":261,"endColumn":63},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":262,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":262,"endColumn":76},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":262,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":262,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10634,10637],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10634,10637],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .template on an `any` value.","line":262,"column":68,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":262,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":264,"column":10,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":264,"endColumn":86},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":264,"column":41,"nodeType":"Property","messageId":"anyAssignment","endLine":264,"endColumn":84},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":272,"column":28,"nodeType":"Property","messageId":"anyAssignment","endLine":272,"endColumn":67},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":272,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":272,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11031,11034],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11031,11034],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":272,"column":53,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":272,"endColumn":61},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":284,"column":13,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":284,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":288,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":288,"endColumn":68},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":288,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":288,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11646,11649],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11646,11649],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":288,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":288,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":293,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":293,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":293,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":293,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":294,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":294,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":294,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":294,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":295,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":295,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .category on an `any` value.","line":295,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":295,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":296,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":296,"endColumn":81},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .basePrompt on an `any` value.","line":296,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":296,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":297,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":297,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":297,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":297,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":299,"column":34,"nodeType":"Property","messageId":"anyAssignment","endLine":299,"endColumn":75},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":299,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":299,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12102,12105],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12102,12105],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":299,"column":61,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":299,"endColumn":69},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":315,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":315,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12757,12760],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12757,12760],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `ModelDef`.","line":346,"column":57,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":346,"endColumn":72},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":346,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":346,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14109,14112],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14109,14112],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":354,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":354,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":354,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":354,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ id: string; providerId: string; modelId: string; name: string; providerData: JsonValue; aiData: JsonValue; specs: JsonValue; capabilityTags: string[]; isFree: boolean; ... 5 more ...; updatedAt: Date; }`.","line":361,"column":74,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":361,"endColumn":79},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":364,"column":55,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":364,"endColumn":71},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerId on an `any` value.","line":364,"column":61,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":364,"endColumn":71},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerId on an `any` value.","line":366,"column":57,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":366,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":385,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":385,"endColumn":89},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":385,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":385,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15546,15549],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15546,15549],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .memoryConfig on an `any` value.","line":385,"column":77,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":385,"endColumn":89},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ useProjectMemory: boolean; } | undefined`.","line":391,"column":11,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":391,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":401,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":401,"endColumn":108},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":401,"column":83,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":401,"endColumn":86,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16127,16130],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16127,16130],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestrationConfig on an `any` value.","line":401,"column":89,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":401,"endColumn":108},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ requiresCheck: boolean; judgeRoleId?: string | undefined; minPassScore: number; } | undefined`.","line":414,"column":7,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":414,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":53,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AssessmentService } from \"./AssessmentService.js\";\nimport { PromptFactory, loadRolePrompt } from \"./PromptFactory.js\";\nimport { PrismaLessonProvider } from \"./PrismaLessonProvider.js\";\nimport { Role } from \"@prisma/client\";\n\nimport { ProviderManager } from \"./ProviderManager.js\";\nimport { getBestModel } from \"../services/modelManager.service.js\";\nimport { type BaseLLMProvider } from \"../utils/BaseLLMProvider.js\";\nimport { ModelConfigurator } from \"./ModelConfigurator.js\";\nimport { ProviderError, CardAgentState } from \"../types.js\";\nimport { executeWithRateLimit } from '../rateLimiter.js';\n\nimport { IAgentFactory } from \"../interfaces/IAgentFactory.js\";\nimport { IAgent } from \"../interfaces/IAgent.js\";\nimport { IProviderManager } from \"../interfaces/IProviderManager.js\";\nimport { IAgentConfigRepository } from \"../interfaces/IAgentConfigRepository.js\";\nimport { PrismaAgentConfigRepository } from \"../repositories/PrismaAgentConfigRepository.js\";\n\n// Configuration Constants\nconst DEFAULT_RETRY_SECONDS = 2;\nconst MAX_RETRY_WAIT = 5;\nconst JUDGE_MAX_TOKENS = 500;\nconst AGENT_MAX_ATTEMPTS = 5; // Prevent infinite loops\n\n// Type extension for Role to include metadata fields\ninterface ExtendedRole extends Role {\n  metadata: {\n    template?: Record<string, any>;\n    memoryConfig?: Record<string, any>;\n    orchestrationConfig?: { \n      requiresCheck: boolean; \n      judgeRoleId?: string; \n      minPassScore: number \n    };\n    [key: string]: any;\n  } | null;\n}\n\n// A simple wrapper ensuring the Agent has a standard .generate() interface\nexport class VolcanoAgent implements IAgent {\n  private failedModels: string[] = []; // Track failed models, not providers\n\n  constructor(\n    private provider: BaseLLMProvider,\n    private systemPrompt: string,\n    private config: { apiModelId: string; temperature: number; maxTokens: number },\n    private roleId: string,\n    private providerManager: IProviderManager,\n    private configRepo: IAgentConfigRepository,\n    private orchestrationConfig?: { requiresCheck: boolean; judgeRoleId?: string; minPassScore: number }\n  ) {}\n\n  /**\n   * Generates a response using the configured provider and model.\n   * This utilizes the SDK's standardized BaseLLMProvider interface.\n   * NOW WITH EXHAUSTIVE FALLBACK and LOOP PROTECTION!\n   */\n  async generate(userGoal: string): Promise<string> {\n    for (let attempt = 1; attempt <= AGENT_MAX_ATTEMPTS; attempt++) {\n      try {\n        console.log(`[VolcanoAgent] Generating with model: \"${this.config.apiModelId}\" on provider ${this.provider.id} (Attempt ${attempt}/${AGENT_MAX_ATTEMPTS})`);\n\n        const response = await executeWithRateLimit(this.provider, {\n            modelId: this.config.apiModelId,\n            messages: [\n              { role: 'system', content: this.systemPrompt },\n              { role: 'user', content: userGoal }\n            ],\n            temperature: this.config.temperature,\n            max_tokens: this.config.maxTokens,\n          });\n\n          // --- JUDGE VERIFICATION ---\n          if (this.orchestrationConfig?.requiresCheck && this.orchestrationConfig.judgeRoleId) {\n            console.log(`[VolcanoAgent] Judge verification required (Judge Role: ${this.orchestrationConfig.judgeRoleId})`);\n            \n            try {\n               const judgeRole = await this.configRepo.getRole(this.orchestrationConfig.judgeRoleId);\n               if (judgeRole) {\n                 const verificationPrompt = `\n                 ${judgeRole.basePrompt}\n                 \n                 TASK: Verify the following output against the user goal.\n                 \n                 USER GOAL: ${userGoal}\n                 \n                 OUTPUT TO VERIFY:\n                 ${response}\n                 \n                 Respond with \"PASS\" if it meets the criteria, or \"FAIL: <reason>\" if it does not.\n                 `;\n                 \n                 // Use a new provider for judge, maybe a specific one\n                 const judgeProvider = this.providerManager.getProvider(this.provider.id) ?? this.provider;\n\n                 const verification = await executeWithRateLimit(judgeProvider, {\n                   modelId: this.config.apiModelId, // Use same model for now, or find a smart one\n                   messages: [{ role: 'user', content: verificationPrompt }],\n                   temperature: 0.0,\n                   max_tokens: JUDGE_MAX_TOKENS\n                 });\n                 \n                 if (!verification.includes(\"PASS\")) {\n                   console.warn(`[VolcanoAgent] Judge Failed: ${verification}`);\n                   await AssessmentService.recordFailure(this.roleId, this.systemPrompt, verification);\n                   return `[‚ö†Ô∏è JUDGE FAILED: ${verification}]\\n\\n${response}`;\n                 } else {\n                   console.log(`[VolcanoAgent] Judge Passed.`);\n                 }\n               }\n            } catch (judgeError) {\n              console.error(\"[VolcanoAgent] Judge execution failed:\", judgeError);\n            }\n          }\n\n          return response;\n\n      } catch (error) {\n        const err = error as ProviderError;\n        console.warn(`[VolcanoAgent] Generation failed with provider ${this.provider.id || 'unknown'}:`, err);\n        \n        // Track failed model\n        const modelId = this.config.apiModelId;\n        if (modelId) this.failedModels.push(modelId);\n\n        // Add backoff for rate limits and server errors\n        const status = err.status;\n        if (status === 429 || status === 500) {\n          const retryAfter = err.headers?.get?.('retry-after') || String(DEFAULT_RETRY_SECONDS);\n          const waitSeconds = Math.min(parseInt(retryAfter, 10) || DEFAULT_RETRY_SECONDS, MAX_RETRY_WAIT);\n          console.log(`[VolcanoAgent] Encountered ${status} error. Waiting ${waitSeconds}s before failover.`);\n          await new Promise(resolve => setTimeout(resolve, waitSeconds * 1000));\n        }\n\n        // If we reached max attempts, stop trying\n        if (attempt === AGENT_MAX_ATTEMPTS) {\n           throw new Error(`Agent Execution Failed: Max attempts (${AGENT_MAX_ATTEMPTS}) reached. Last Error: ${err.message}`);\n        }\n\n        // ATTEMPT RECOVERY\n        try {\n          console.log(`[VolcanoAgent] Attempting failover... Excluded models: [${this.failedModels.join(', ')}]`);\n          \n          // 1. Get Next Best Model (excluding failed models)\n          const nextModel = await getBestModel(this.roleId, this.failedModels);\n          \n          if (!nextModel) {\n             throw new Error(\"Orchestrator returned no model available.\");\n          }\n          \n          // 2. Reconfigure Agent\n          if (this.failedModels.includes(nextModel.modelId)) {\n             throw new Error(`Orchestrator returned failed model ${nextModel.modelId} despite exclusion list.`);\n          }\n\n          this.config.apiModelId = nextModel.modelId;\n          this.config.temperature = nextModel.temperature || this.config.temperature;\n          this.config.maxTokens = nextModel.maxTokens || this.config.maxTokens;\n          \n          // 3. Get New Provider\n          const newProvider = this.providerManager.getProvider(nextModel.providerId);\n          if (!newProvider) throw new Error(`Provider ${nextModel.providerId} not initialized.`);\n          \n          this.provider = newProvider;\n          console.log(`[VolcanoAgent] Failover successful. Switched to: ${nextModel.providerId} / ${nextModel.modelId}`);\n          \n          // Loop continues...\n        } catch (retryError) {\n          console.error(\"[VolcanoAgent] Exhaustive fallback failed:\", retryError);\n          throw new Error(`Agent Execution Failed (Exhausted all options). Final Error: ${retryError instanceof Error ? retryError.message : String(retryError)}`);\n        }\n      }\n    }\n\n    throw new Error(\"Agent execution loop terminated unexpectedly.\");\n  }\n\n  public getConfig() {\n      return {\n          modelId: this.config.apiModelId,\n          providerId: this.provider.id,\n          temperature: this.config.temperature,\n          maxTokens: this.config.maxTokens\n      };\n  }\n}\n\nexport class AgentFactoryService implements IAgentFactory {\n  // Static cache to prevent disk spamming\n  private static cachedRoles: any[] | null = null;\n\n  constructor(\n    private providerManager: IProviderManager,\n    private configRepo: IAgentConfigRepository\n  ) {}\n\n  /**\n   * Create an agent with a specific corporate tier\n   */\n  async createVolcanoAgentWithTier(\n    cardConfig: CardAgentState,\n    tier: 'Executive' | 'Manager' | 'Worker' = 'Worker'\n  ): Promise<VolcanoAgent> {\n    const tierConfig = { ...cardConfig, isLocked: false };\n    const bestModel = await this.getModelForTier(cardConfig.roleId, tier);\n    \n    if (bestModel) {\n      tierConfig.modelId = bestModel.modelId;\n      tierConfig.temperature = bestModel.temperature;\n      tierConfig.maxTokens = bestModel.maxTokens;\n      tierConfig.isLocked = true;\n    }\n    \n    return this.createVolcanoAgent(tierConfig);\n  }\n\n  private async getModelForTier(\n    roleId: string,\n    tier: 'Executive' | 'Manager' | 'Worker'\n  ): Promise<{ modelId: string; providerId: string; temperature: number; maxTokens: number } | null> {\n    const { prisma } = await import('../db.js');\n    const tierThresholds = {\n      Executive: { min: 0.01, max: 1.0 },\n      Manager: { min: 0.001, max: 0.01 },\n      Worker: { min: 0, max: 0.001 }\n    };\n    \n    const threshold = tierThresholds[tier];\n    \n    try {\n      const model = await prisma.model.findFirst({\n        where: {\n          isActive: true,\n          costPer1k: { gte: threshold.min, lte: threshold.max },\n          capabilityTags: { has: 'text' }\n        },\n        orderBy: [{ costPer1k: tier === 'Executive' ? 'desc' : 'asc' }],\n        include: { provider: true }\n      });\n      \n      if (!model) return null;\n      \n      return {\n        modelId: model.id,\n        providerId: model.providerId,\n        temperature: tier === 'Executive' ? 0.3 : tier === 'Manager' ? 0.5 : 0.7,\n        maxTokens: tier === 'Executive' ? 4096 : tier === 'Manager' ? 2048 : 1024\n      };\n    } catch (error) {\n      console.error(`[AgentFactory] Error selecting model for tier ${tier}:`, error);\n      return null;\n    }\n  }\n\n  async createVolcanoAgent(cardConfig: CardAgentState): Promise<VolcanoAgent> {\n    // 1. Load Role Configuration\n    const rawRole = await this.configRepo.getRole(cardConfig.roleId);\n    let role: ExtendedRole | null = null;\n    \n    if (rawRole) {\n      role = { ...rawRole, metadata: (rawRole as any).metadata || {} } as ExtendedRole;\n      const template = role.metadata?.template || (rawRole as any).template;\n      if (template) {\n         role = { ...role, ...template, metadata: { ...role.metadata, ...template } };\n      }\n    }\n\n    // Fallback logic with CACHING to avoid repetitive Disk I/O\n    if (!role && cardConfig.roleId !== 'general_worker') {\n      const rawGw = await this.configRepo.getRole('general_worker');\n      if (rawGw) {\n        role = { ...rawGw, metadata: (rawGw as any).metadata || {} } as ExtendedRole;\n        cardConfig.roleId = 'general_worker';\n      }\n    }\n\n    if (!role) {\n      try {\n        if (!AgentFactoryService.cachedRoles) {\n            const fs = await import('node:fs/promises');\n            const path = await import('node:path');\n            const rolesPath = path.join(process.cwd(), 'packages', 'coc', 'agents', 'roles.json');\n            const raw = await fs.readFile(rolesPath, 'utf-8');\n            AgentFactoryService.cachedRoles = JSON.parse(raw);\n        }\n\n        const list = AgentFactoryService.cachedRoles || [];\n        const gw = list.find((r: any) => r.id === 'general_worker');\n\n        if (gw) {\n          try {\n            const created = await this.configRepo.createRole({\n                id: gw.id,\n                name: gw.name || 'General Worker',\n                category: gw.category || 'Utility',\n                basePrompt: gw.basePrompt || 'You are a versatile AI assistant.',\n                tools: gw.tools || [],\n            });\n            role = { ...created, metadata: (created as any).metadata || {} } as ExtendedRole;\n            cardConfig.roleId = 'general_worker';\n            console.log('[AgentFactory] Seeded general_worker role from roles.json');\n          } catch (createErr) {\n            console.warn('[AgentFactory] Failed to seed general_worker role (might exist):', createErr);\n          }\n        }\n      } catch (readErr) {\n        console.warn('[AgentFactory] Could not read roles.json to seed default role:', readErr instanceof Error ? readErr.message : String(readErr));\n      }\n    }\n\n    if (!role) {\n      throw new Error(`Agent creation failed: Role ID ${cardConfig.roleId} not found.`);\n    }\n\n      let model: any;\n      let effectiveConfig: { modelId: string; temperature?: number; maxTokens?: number } = { modelId: '' };\n\n    // 2. Model Resolution Strategy\n    if (!cardConfig.isLocked || !cardConfig.modelId) {\n      const bestModel = await getBestModel(cardConfig.roleId);\n      if (!bestModel) throw new Error(\"Orchestrator failed to select a model for this agent.\");\n\n      model = bestModel.model;\n      effectiveConfig = {\n          modelId: bestModel.modelId,\n          temperature: bestModel.temperature,\n          maxTokens: bestModel.maxTokens\n      };\n    } else {\n      const allModels = await this.providerManager.getAllModels();\n      const modelDef = allModels.find(m => m.id === cardConfig.modelId);\n      const requestedModelId = modelDef?.id || cardConfig.modelId;\n      const requestedProviderId = modelDef?.providerId;\n\n      if (requestedProviderId && requestedModelId) {\n         model = await this.configRepo.getModel(requestedProviderId, requestedModelId);\n      }\n\n      if (!modelDef && !model) {\n        throw new Error(`Configuration Error: Model '${cardConfig.modelId}' is not available.`);\n      }\n\n      if (modelDef && !model) {\n          console.log(`[AgentFactory] JIT Creation: Model '${cardConfig.modelId}' not found in DB. Creating...`);\n          try {\n              model = await this.configRepo.createModel(modelDef as any);\n          } catch (createError) {\n               console.error(`[AgentFactory] JIT Creation failed:`, createError);\n               throw new Error(`Model '${cardConfig.modelId}' not found in database and JIT creation failed.`);\n          }\n      }\n      \n      effectiveConfig = {\n          modelId: model.id,\n          temperature: cardConfig.temperature,\n          maxTokens: cardConfig.maxTokens\n      };\n    }\n\n    // 3. Configure & Validate Parameters\n    const [safeParams, _adjustments] = await ModelConfigurator.configure(model, role, effectiveConfig);\n\n    // 4. Initialize Provider\n    const provider = this.providerManager.getProvider(model.providerId);\n    if (!provider) {\n      throw new Error(`Runtime Error: Provider '${model.providerId}' is not initialized.`);\n    }\n\n    // 5. Return the Configured Agent\n    let basePrompt: string;\n    \n    try {\n      const { prisma } = await import('../db.js');\n      const workspace = await prisma.workspace.findFirst({\n        select: { codeRules: true, glossary: true },\n      });\n      \n      const constitution = workspace ? {\n        codeRules: workspace.codeRules || undefined,\n        glossary: (workspace.glossary as Record<string, string>) || undefined,\n      } : undefined;\n\n      const lessonProvider = new PrismaLessonProvider();\n      const promptFactory = new PromptFactory(lessonProvider);\n      const memoryConfig = role.metadata?.memoryConfig || (rawRole as any)?.memoryConfig;\n\n      const tools = cardConfig.tools || role.tools;\n      basePrompt = await promptFactory.build(\n          role.name,\n          cardConfig.userGoal || '',\n          memoryConfig,\n          tools,\n          cardConfig.projectPrompt,\n          constitution\n      );\n    } catch (error) {\n      console.warn(`[AgentFactory] PromptFactory failed for role \"${role.name}\". Falling back to simple role prompt load.`, error);\n      basePrompt = await loadRolePrompt(role.name);\n    }\n\n    const orchestrationConfig = role.metadata?.orchestrationConfig || (rawRole as any)?.orchestrationConfig;\n\n    return new VolcanoAgent(\n      provider,\n      basePrompt,\n      {\n        apiModelId: effectiveConfig.modelId,\n        temperature: safeParams.temperature ?? 0.7,\n        maxTokens: safeParams.max_tokens ?? 2048\n      },\n      role.id,\n      this.providerManager,\n      this.configRepo,\n      orchestrationConfig\n    );\n  }\n}\n\n// LAZY INITIALIZATION FACADE\n// Prevents top-level execution of ProviderManager.getInstance()\n// which can cause circular dependency crashes at module load time.\nlet defaultFactory: AgentFactoryService | null = null;\n\nexport async function createVolcanoAgent(cardConfig: CardAgentState): Promise<VolcanoAgent> {\n  if (!defaultFactory) {\n    defaultFactory = new AgentFactoryService(\n      ProviderManager.getInstance(),\n      new PrismaAgentConfigRepository()\n    );\n  }\n  return defaultFactory.createVolcanoAgent(cardConfig);\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/AgentRuntime.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":165,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":165,"endColumn":38},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":165,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5528,5531],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5528,5531],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":309,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":309,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10720,10723],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10720,10723],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":356,"column":19,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":359,"endColumn":14},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `Record<string, any>`.","line":358,"column":15,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":358,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { CodeModeUtcpClient } from \"@utcp/code-mode\";\nimport { CallTemplateSerializer, CommunicationProtocol } from \"@utcp/sdk\";\nimport { createFsTools } from \"../tools/filesystem.js\";\nimport { mcpOrchestrator } from \"./McpOrchestrator.js\";\nimport { metaTools } from \"../tools/meta.js\";\nimport { contextManager } from \"./ContextManager.js\";\nimport {\n  LocalCommunicationProtocol,\n  LocalCallTemplateSerializer,\n  ToolDefinition,\n} from \"./protocols/LocalProtocol.js\";\nimport { getNativeTools } from \"./tools/NativeToolsRegistry.js\";\nimport { loadToolDocs } from \"./tools/ToolDocumentationLoader.js\";\n\n// Register the protocol globally (idempotent)\nCallTemplateSerializer.registerCallTemplate(\n  \"local\",\n  new LocalCallTemplateSerializer()\n);\n\ninterface IClientWithProtocolRegistry {\n  _registeredCommProtocols: Map<string, CommunicationProtocol>;\n}\n\nexport class AgentRuntime {\n  private client!: CodeModeUtcpClient;\n  private fsTools: ReturnType<typeof createFsTools>;\n  private rootPath: string;\n  private contextManager = contextManager;\n  private toolDocs: string = \"\";\n\n  constructor(rootPath: string = process.cwd()) {\n    this.rootPath = rootPath;\n    this.fsTools = createFsTools(rootPath);\n    // use the shared contextManager singleton\n    this.contextManager = contextManager;\n  }\n\n  static async create(\n    rootPath?: string,\n    tools: string[] = []\n  ): Promise<AgentRuntime> {\n    const runtime = new AgentRuntime(rootPath);\n    await runtime.init(tools);\n    return runtime;\n  }\n\n  private async init(requestedTools: string[], _roleId?: string) {\n    try {\n      this.client = await CodeModeUtcpClient.create();\n    } catch (error) {\n      console.warn(\"[AgentRuntime] Failed to create UTCP client:\", error);\n      console.log(\n        \"[AgentRuntime] Proceeding without tool support (simple chat mode)\"\n      );\n      return;\n    }\n\n    // ONLY setup tools if explicitly requested\n    if (requestedTools.length === 0) {\n      console.log(\n        \"[AgentRuntime] No tools requested - running in simple chat mode\"\n      );\n      return;\n    }\n\n    // INJECT LOCAL PROTOCOL INSTANCE INTO THIS CLIENT\n    const localProtocol = new LocalCommunicationProtocol();\n    // Use an interface cast to bypass access restriction on private property in a typesafe manner\n    (\n      this.client as unknown as IClientWithProtocolRegistry\n    )._registeredCommProtocols.set(\"local\", localProtocol);\n\n    // 1. Initialize Orchestrator & Load Servers\n    // We assume requestedTools contains server names like 'git', 'postgres'\n    // Filter out native tools and 'meta' from this list before passing to orchestrator\n    const nativeToolNames = [\n      \"read_file\",\n      \"write_file\",\n      \"list_files\",\n      \"browse\",\n      \"research.web_scrape\",\n      \"analysis.complexity\",\n      \"terminal_execute\",\n      \"search_codebase\",\n      \"list_files_tree\",\n      \"scan_ui_components\",\n      \"nebula\",\n    ];\n    const serverNames = requestedTools.filter(\n      (t) => !nativeToolNames.includes(t) && t !== \"meta\"\n    );\n\n    let mcpTools: ToolDefinition[] = [];\n\n    if (serverNames.length > 0) {\n      try {\n        await mcpOrchestrator.prepareEnvironment(serverNames);\n        // 2. Get Dynamic Tools from MCP servers\n        const tools = await mcpOrchestrator.getToolsForSandbox();\n        // Convert to ToolDefinition compatible format\n        mcpTools = tools as unknown as ToolDefinition[];\n      } catch (mcpError) {\n        console.warn(\"[AgentRuntime] MCP connection failed:\", mcpError);\n        console.log(\"[AgentRuntime] Proceeding with native tools only\");\n        // Continue without MCP tools - don't crash the entire agent\n      }\n    }\n\n    // 3. Register \"system\" namespace with Native, MCP, and optionally Meta tools\n    const nativeTools = getNativeTools(this.rootPath, this.fsTools).filter(\n      (t) => requestedTools.includes(t.name)\n    );\n\n    // 4. Wrap tools with logging\n    const toolsToRegister: ToolDefinition[] = [...nativeTools, ...mcpTools].map(\n      (tool) => ({\n        ...tool,\n        handler: tool.handler\n          ? async (args: unknown) => {\n              console.log(\n                `Calling tool 'system.${tool.name}' via protocol 'local'.`\n              );\n              try {\n                const result = await tool.handler!(args);\n                console.log(JSON.stringify(result));\n                return result;\n              } catch (error) {\n                console.error(`Tool 'system.${tool.name}' failed:`, error);\n                throw error;\n              }\n            }\n          : undefined,\n      })\n    );\n\n    if (requestedTools.includes(\"meta\")) {\n      const wrappedMetaTools = (metaTools as unknown as ToolDefinition[]).map(\n        (tool) => ({\n          ...tool,\n          handler: tool.handler\n            ? async (args: unknown) => {\n                console.log(\n                  `Calling tool 'system.${tool.name}' via protocol 'local'.`\n                );\n                try {\n                  const result = await tool.handler!(args);\n                  console.log(JSON.stringify(result));\n                  return result;\n                } catch (error) {\n                  console.error(`Tool 'system.${tool.name}' failed:`, error);\n                  throw error;\n                }\n              }\n            : undefined,\n        })\n      );\n      toolsToRegister.push(...wrappedMetaTools);\n    }\n\n    try {\n      await this.client.registerManual({\n        name: \"system\",\n        call_template_type: \"local\",\n        tools: toolsToRegister as any,\n      });\n\n      // 5. Load Tool Documentation\n      this.toolDocs = await loadToolDocs(\n        requestedTools,\n        getNativeTools(this.rootPath, this.fsTools)\n      );\n\n      console.log(\n        `[AgentRuntime] Registered ${toolsToRegister.length} tools: ${\n          nativeTools.length\n        } native, ${mcpTools.length} MCP${\n          requestedTools.includes(\"meta\")\n            ? \", \" + metaTools.length + \" meta\"\n            : \"\"\n        }`\n      );\n    } catch (registerError) {\n      console.warn(\"[AgentRuntime] Failed to register tools:\", registerError);\n      console.log(\"[AgentRuntime] Agent will run without tool support\");\n    }\n  }\n\n  async runAgentLoop(\n    userGoal: string,\n    initialResponse: string,\n    regenerateCallback: (retryPrompt: string) => Promise<string>\n  ): Promise<{ result: string; logs: string[] }> {\n    const MAX_RETRIES = 2;\n    let attempt = 0;\n    let lastError: string | null = null;\n    let currentResponse = initialResponse;\n\n    while (attempt <= MAX_RETRIES) {\n      attempt++;\n\n      // If this is a retry, regenerate with error feedback\n      if (lastError && attempt > 1) {\n        const retryPrompt = `Your previous code failed with this error:\\n\\n${lastError}\\n\\nHere is the full response that caused the error:\\n\\n${currentResponse}\\n\\nPlease fix the code and try again. Original request: ${userGoal}`;\n        process.stdout.write(\n          `[AgentRuntime] Retry attempt ${attempt}/${\n            MAX_RETRIES + 1\n          } - Calling LLM with error feedback\\n`\n        );\n        currentResponse = await regenerateCallback(retryPrompt);\n        process.stdout.write(`[AgentRuntime] Received new response from LLM\\n`);\n      }\n\n      // Convert response to string if it's an object (some providers return objects)\n      const responseStr =\n        typeof currentResponse === \"string\"\n          ? currentResponse\n          : JSON.stringify(currentResponse);\n\n      // Simpler, more robust code extraction logic\n      const codeBlockRegex = /```(?:[a-zA-Z0-9]+)?\\s*\\n?([\\s\\S]*?)```/g;\n      let match;\n      const blocks: string[] = [];\n\n      while ((match = codeBlockRegex.exec(responseStr)) !== null) {\n        const block = match[1].trim();\n        if (block) {\n          blocks.push(block);\n        }\n      }\n\n      let codeToExecute: string | null = null;\n\n      if (blocks.length > 0) {\n        codeToExecute = blocks.join(\"\\n\\n\");\n      } else {\n        // Fallback for no code blocks at all: check if the whole response is code\n        const isMarkdown = /\\*\\*|__/.test(responseStr);\n        const hasCodeKeywords =\n          /^(?:import|const|let|var|function|class|await|system\\.|nebula\\.)/m.test(\n            responseStr.trim()\n          );\n\n        if (!isMarkdown && hasCodeKeywords) {\n          codeToExecute = responseStr;\n        }\n      }\n\n      // SANITIZE: Remove thinking protocol lines that AI might have included in code block\n      if (codeToExecute) {\n        const lines = codeToExecute.split(\"\\n\");\n        const sanitizedLines = lines.filter((line) => {\n          const trimmed = line.trim();\n          // Remove lines that are part of the thinking protocol\n          if (\n            trimmed.startsWith(\"LOCATE:\") ||\n            trimmed.startsWith(\"DEFINE:\") ||\n            trimmed.startsWith(\"EXECUTE:\") ||\n            /^\\d+\\.\\s+(LOCATE|DEFINE|EXECUTE):/.test(trimmed)\n          ) {\n            return false;\n          }\n          return true;\n        });\n        codeToExecute = sanitizedLines.join(\"\\n\");\n      }\n\n      // Check if response contains nebula operations even without proper code blocks\n      const hasNebulaOps =\n        responseStr.includes(\"nebula.addNode\") ||\n        responseStr.includes(\"nebula.\") ||\n        responseStr.includes(\"LOCATE:\");\n\n      if (!codeToExecute || codeToExecute.trim().length === 0) {\n        if (hasNebulaOps) {\n          // Force execution if we detect nebula operations\n          codeToExecute = responseStr;\n          console.log(\n            \"[AgentRuntime] Forcing execution despite no code blocks due to nebula operations\"\n          );\n        } else {\n          // Treat as conversational response - DO NOT EXECUTE\n          process.stdout.write(\n            \"[AgentRuntime] No code found or text looks conversational. Skipping execution.\\n\"\n          );\n          return { result: responseStr, logs: [] };\n        }\n      }\n\n      console.log(\"[AgentRuntime] Executing code in sandbox:\\n\", codeToExecute);\n\n      // 2. Check if we should use the specialized TypeScript interpreter for Nebula Code Mode\n      const useSpecializedInterpreter =\n        codeToExecute.includes(\"nebula.\") || codeToExecute.includes(\"ast.\");\n\n      let result = \"\";\n      let logs: string[] = [];\n\n      if (useSpecializedInterpreter) {\n        process.stdout.write(\n          \"[AgentRuntime] Using specialized Nebula Code Mode interpreter...\\n\"\n        );\n        const { typescriptInterpreterTool } = await import(\n          \"../tools/typescriptInterpreter.js\"\n        );\n        const interpreterResponse = await (\n          typescriptInterpreterTool.handler as (args: {\n            code: string;\n          }) => Promise<{ text: string; meta?: { nebula_actions?: any[] } }[]>\n        )({ code: codeToExecute });\n\n        // The interpreter tool returns an array of message objects\n        const firstMessage = interpreterResponse[0];\n        const responseText = firstMessage?.text || \"\";\n        const actions = firstMessage?.meta?.nebula_actions || [];\n\n        // Check if execution failed\n        if (\n          responseText.includes(\"‚ùå Execution Error:\") ||\n          responseText.includes(\"ERROR:\")\n        ) {\n          lastError = responseText;\n          process.stdout.write(\n            `[AgentRuntime] Execution failed on attempt ${attempt}/${\n              MAX_RETRIES + 1\n            }\\n`\n          );\n          process.stdout.write(`[AgentRuntime] Error message:\\n${lastError}\\n`);\n\n          // If we have retries left, continue the loop\n          if (attempt <= MAX_RETRIES) {\n            continue;\n          } else {\n            // Out of retries, return the error\n            return {\n              result: JSON.stringify([\n                {\n                  type: \"text\",\n                  content: `Failed after ${\n                    MAX_RETRIES + 1\n                  } attempts. Last error:\\n${lastError}`,\n                },\n              ]),\n              logs: [responseText],\n            };\n          }\n        }\n\n        const toolResults: unknown[] = [];\n        // If we have actions, we need to execute them via the nebula tool\n        if (actions.length > 0) {\n          process.stdout.write(\n            `[AgentRuntime] Executing ${actions.length} captured Nebula actions...\\n`\n          );\n          for (const action of actions) {\n            const toolOutput = await this.client.callTool(\n              \"system.nebula\",\n              action\n            );\n            toolResults.push(toolOutput);\n          }\n        }\n\n        // Parse result and logs from the response text\n        const outputMatch = responseText.match(\n          /Output:\\n([\\s\\S]*?)(?:\\nWarnings\\/Errors:|$)/\n        );\n        const parsedResult = outputMatch ? outputMatch[1].trim() : responseText;\n\n        // Return both the text output and the captured tool results\n        // We wrap the text in an object that the frontend will ignore (fails ui_action check)\n        // but can still be displayed as the primary output.\n        const combinedResult: unknown = [\n          { type: \"text\", content: parsedResult },\n          ...toolResults,\n        ];\n\n        result = JSON.stringify(combinedResult);\n        logs = [responseText];\n\n        // Success! Break out of retry loop\n        return { result, logs };\n      } else {\n        // Standard Sandbox Execution\n        const sandboxResponse = (await this.client.callToolChain(\n          codeToExecute\n        )) as { result: string; logs: string[] };\n        result = sandboxResponse?.result || \"\";\n        logs = sandboxResponse?.logs || [];\n\n        // Success! Break out of retry loop\n        return { result, logs };\n      }\n    }\n\n    // This should never be reached, but TypeScript needs it\n    return { result: \"\", logs: [] };\n  }\n\n  /**\n   * Wrap a provider/agent generate call and enhance the system prompt\n   * using the ContextManager state for the given roleId.\n   */\n  async generateWithContext(\n    agent: { generate: (prompt: string) => Promise<unknown> },\n    baseSystemPrompt: string,\n    prompt: string,\n    roleId?: string\n  ) {\n    const roleContext = roleId\n      ? await this.contextManager.getContext(roleId)\n      : { tone: \"\", style: \"\", memory: {} };\n    const memoryStr = Object.entries(roleContext.memory || {})\n      .map(([k, v]) => `${k}: ${v}`)\n      .join(\"\\n\");\n\n    let enhancedSystemPrompt = `${baseSystemPrompt || \"\"}\\n\\n${\n      roleContext.tone || \"\"\n    }\\n\\n${memoryStr}`.trim();\n\n    // Inject Tool Documentation\n    if (this.toolDocs) {\n      if (enhancedSystemPrompt.includes(\"{{tool_definitions}}\")) {\n        enhancedSystemPrompt = enhancedSystemPrompt.replace(\n          \"{{tool_definitions}}\",\n          this.toolDocs\n        );\n      } else {\n        // Auto-append Protocol + Docs if tag is missing\n        const CODE_MODE_PROTOCOL = `\nüß† System Instruction: Nebula Code Mode v2.0\nRole: You are the Nebula Engine Pilot. You do not write code to describe a UI; you write code to construct it using the live nebula runtime instance.\n\nThe Prime Directive: NEVER write code without first verifying the current state.\n\nYour Runtime Environment:\n- Global Object: nebula (Instance of NebulaOps)\n- Global Helper: ast (Instance of AstTransformer)\n- Context: tree (Read-only access to current NebulaTree state)\n\n## üõ†Ô∏è TOOL USAGE PROTOCOL\nYou are operating in **CODE MODE**. Your primary objective is to fulfill the user's request by calling available tools. \n\n### üö® CRITICAL RULES:\n1. **NO CONVERSATIONAL FILLER.** Do not say \"Sure, I can help with that.\" \n2. **USE CODE BLOCKS.** You MUST wrap your logic in a \\` \\` \\`typescript block.\n3. **USE THE NEBULA OBJECT.** Call nebula methods directly: \\`const id = nebula.addNode(...)\\`.\n4. **CAPTURE RETURNS.** The addNode function returns an ID. YOU MUST CAPTURE IT.\n   - ‚úÖ Good: \\`const cardId = nebula.addNode(...)\\`\n   - ‚ùå Bad: \\`nebula.addNode(...)\\` (ID is lost, cannot add children).\n5. **ATOMIC OPERATIONS.** Group related changes into a single execution block.\n6. **NEVER HALLUCINATE IDs.** Do not update node_123 unless you created it or confirmed it exists in the tree.\n\n### Phase 1: The \"Thinking\" Protocol (Mandatory)\nBefore writing code, you must output a plan:\n- LOCATE: Which node ID am I attaching to? (Check existence).\n- DEFINE: What specific tokens (Tailwind) and Layouts (flex/grid) will I use?\n- EXECUTE: Write the script.\n\n### Component Registry (Use these as \"type\" for addNode)\n- **Box**: Layout container (div). Default.\n- **Text**: Props: { content: string, type: 'h1'|'h2'|'h3'|'p' }.\n- **Button**: Props: { children: string, variant: 'default'|'outline'|'ghost' }.\n- **Input / Textarea**: Form inputs.\n- **Badge**: Tiny pill label.\n- **Label**: Form labels.\n- **Slider**: Range input.\n- **Icon**: Props: { name: string } (Lucide names like 'User', 'Settings').\n- **Card**: Composite (CardHeader, CardTitle, CardDescription, CardContent, CardFooter).\n- **Tabs**: Composite (TabsList, TabsTrigger [prop value], TabsContent [prop value]).\n- **AiButton / SuperAiButton**: AI trigger buttons.\n- **Image**: Props: { src: string, alt: string }.\n\n### Phase 2: API Reference (Cheat Sheet)\n\\`\\`\\`typescript\n// 1. ADDING NODES (Recursive)\nconst parentId = \"root\"; // Or some captured ID\nconst btnId = nebula.addNode(parentId, {\n  type: \"Button\",\n  props: { children: \"Click Me\", variant: \"default\" },\n  style: { background: \"bg-primary\", padding: \"p-4\" },\n  layout: { mode: \"flex\" }\n});\n\n// 2. BUILDING COCHLEATED STRUCTURES (Cards)\nconst cardId = nebula.addNode(\"root\", { type: \"Card\", style: { width: \"w-80\" } });\nconst headerId = nebula.addNode(cardId, { type: \"CardHeader\" });\nnebula.addNode(headerId, { type: \"CardTitle\", props: { children: \"User Profile\" } });\nconst contentId = nebula.addNode(cardId, { type: \"CardContent\" });\nnebula.addNode(contentId, { type: \"Text\", props: { children: \"Managing your account settings level here.\" } });\n\n// 3. UPDATING NODES\nnebula.updateNode(btnId, { style: { background: \"bg-red-500\" } });\n\n// 3. MOVING NODES\nnebula.moveNode(btnId, \"new-parent-id\", 0); // Index 0\n\n// 4. INGESTION (Raw Code -> Nodes)\nconst rawJSX = \\`<div className=\"p-4\">...</div>\\`;\nconst fragment = ast.parse(rawJSX);\nnebula.addNode(parentId, fragment);\n\\`\\`\\`\n\n### Example Pattern: The \"Iterator\" (Building Lists)\n\\`\\`\\`typescript\nconst listId = nebula.addNode(parentId, { type: 'Box', layout: { mode: 'flex', direction: 'column' }});\nconst items = ['Pricing', 'Features', 'About'];\n\nitems.forEach(item => {\n  nebula.addNode(listId, { \n    type: 'Button', \n    props: { children: item, variant: 'ghost' },\n    style: { width: 'w-full', align: 'start' }\n  });\n});\n\\`\\`\\`\n\n### Available Tools:\n\\${this.toolDocs}\n`;\n        enhancedSystemPrompt += CODE_MODE_PROTOCOL;\n      }\n    }\n\n    const finalPrompt = `${enhancedSystemPrompt}\\n\\n${prompt}`.trim();\n    // Delegate to the provided agent/provider\n    return agent.generate(finalPrompt);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/AssessmentService.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":10,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":17,"endColumn":7},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":10,"column":30,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":10,"endColumn":65},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[381,384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[381,384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .promptRefinement on an `any` value.","line":10,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":10,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":20,"column":25,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":20,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":20,"column":36,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":20,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":21,"column":79,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":21,"endColumn":81},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":24,"column":5,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":24,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":28,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":31,"endColumn":7},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":28,"column":30,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":28,"endColumn":69},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[882,885],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[882,885],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .promptRefinement on an `any` value.","line":28,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":28,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":36,"column":85,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":36,"endColumn":89},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .originalPrompt on an `any` value.","line":39,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":39,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .critique on an `any` value.","line":42,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":42,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":79,"column":11,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":79,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2668,2671],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2668,2671],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .promptRefinement on an `any` value.","line":79,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":79,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":84,"column":72,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":84,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":186,"column":11,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":186,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":188,"column":11,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":188,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'parseError' is defined but never used.","line":190,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":190,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .score on an `any` value.","line":202,"column":70,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":202,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .passed on an `any` value.","line":202,"column":99,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":202,"endColumn":105},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":205,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":205,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .score on an `any` value.","line":205,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":205,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":206,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":206,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .feedback on an `any` value.","line":206,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":206,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .passed on an `any` value.","line":207,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":207,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":208,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":208,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .strengths on an `any` value.","line":208,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":208,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":209,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":209,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .weaknesses on an `any` value.","line":209,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":209,"endColumn":42},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":212,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":212,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6748,6751],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6748,6751],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":216,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":216,"endColumn":53},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":227,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":227,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7127,7130],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7127,7130],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestration on an `any` value.","line":230,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":230,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestration on an `any` value.","line":231,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":231,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .input on an `any` value.","line":234,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":234,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":237,"column":3,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":239,"endColumn":7},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":237,"column":3,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":237,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stepLogs on an `any` value.","line":237,"column":13,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":237,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":237,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":237,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7403,7406],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7403,7406],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stepName on an `any` value.","line":238,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":238,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .status on an `any` value.","line":238,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":238,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .duration on an `any` value.","line":238,"column":71,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":238,"endColumn":79},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .error on an `any` value.","line":238,"column":88,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":238,"endColumn":93},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .error on an `any` value.","line":238,"column":112,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":238,"endColumn":117},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .join on an `any` value.","line":239,"column":3,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":239,"endColumn":7},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .output on an `any` value.","line":242,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":242,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .completedAt on an `any` value.","line":244,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":244,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | number | Date`.","line":245,"column":12,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":245,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .completedAt on an `any` value.","line":245,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":245,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | number | Date`.","line":245,"column":56,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":245,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .startedAt on an `any` value.","line":245,"column":66,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":245,"endColumn":75},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Static async method 'getAverageQuality' has no 'await' expression.","line":250,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":250,"endColumn":33,"suggestions":[{"messageId":"removeAsync","fix":{"range":[7880,7937],"text":"getAverageQuality(modelId: string): number"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'modelId' is defined but never used. Allowed unused args must match /^_/u.","line":250,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":250,"endColumn":41}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":57,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from \"../db.js\";\nimport { prisma } from \"../db.js\";\nimport { ProviderManager } from \"./ProviderManager.js\";\nimport { createVolcanoAgent } from \"./AgentFactory.js\";\n\nexport class AssessmentService {\n  \n  static async recordFailure(roleId: string, originalPrompt: string, critique: string) {\n    // 1. Save to PromptRefinement table\n    const refinement = await (db as any).promptRefinement.create({\n      data: {\n        roleId,\n        originalPrompt,\n        critique,\n        refinedPrompt: '', // To be filled by optimization job\n      }\n    });\n\n    // 2. Trigger Optimization (Fire and Forget)\n    this.optimizePrompt(refinement.id).catch(err => \n      console.error(`[AssessmentService] Optimization failed for ${refinement.id}:`, err)\n    );\n\n    return refinement;\n  }\n\n  static async optimizePrompt(refinementId: string) {\n    const refinement = await (db as any).promptRefinement.findUnique({\n      where: { id: refinementId },\n      include: { role: true }\n    });\n\n    if (!refinement) return;\n\n    const metaPrompt = `\n    You are an expert Prompt Engineer. A previous prompt for the role \"${refinement.role.name}\" failed.\n    \n    ORIGINAL PROMPT:\n    ${refinement.originalPrompt}\n    \n    CRITIQUE (Why it failed):\n    ${refinement.critique}\n    \n    TASK:\n    Rewrite the prompt to address the critique and improve performance.\n    Return ONLY the new prompt text.\n    `;\n\n    // Use a smart model - Dynamic Selection\n    const models = await ProviderManager.getAllModels();\n    \n    // [NEW] Dynamic Resilience\n    // 1. Look for models explicitly tagged with 'reasoning' or 'smart' (future-proofing)\n    // 2. Fallback to models that are NOT free (assuming paid = smarter)\n    // 3. Fallback to the largest context window\n    const smartModel = models.find(m => m.capabilities?.includes('reasoning')) \n      || models.find(m => (m.costPer1k || 0) > 0) // Heuristic: Paid models are usually \"smarter\"\n      || models.sort((a, b) => ((b.specs?.contextWindow || 0) - (a.specs?.contextWindow || 0)))[0] // Fallback: Biggest brain\n      || models[0];\n\n    if (!smartModel) {\n      console.error('[AssessmentService] No capable models found for assessment.');\n      return;\n    }\n\n    console.log(`üß† Assessment Service selected: ${smartModel.id} (Cost: $${smartModel.costPer1k || 0}/1k)`);\n\n    const provider = ProviderManager.getProvider(smartModel.providerId || '');\n    if (!provider) return;\n\n    const newPrompt = await provider.generateCompletion({\n      modelId: smartModel.id,\n      messages: [{ role: 'user', content: metaPrompt }],\n      temperature: 0.7,\n      max_tokens: 4000\n    });\n\n    // Update the record\n    await (db as any).promptRefinement.update({\n      where: { id: refinementId },\n      data: { refinedPrompt: newPrompt }\n    });\n    \n    console.log(`[AssessmentService] Prompt optimized for ${refinement.role.name}`);\n  }\n\n  /**\n   * Evaluate an orchestration execution using a Judge role\n   * @param executionId - The execution to evaluate\n   * @returns Quality score (0-1) and detailed feedback\n   */\n  static async evaluateExecution(executionId: string): Promise<{\n    score: number;\n    feedback: string;\n    passed: boolean;\n    strengths: string[];\n    weaknesses: string[];\n  }> {\n    console.log(`[Judge] ‚öñÔ∏è  Evaluating execution: ${executionId}`);\n\n    // 1. Load the execution\n    const execution = await prisma.orchestrationExecution.findUnique({\n      where: { id: executionId },\n      include: {\n        orchestration: {\n          include: {\n            steps: true\n          }\n        }\n      }\n    });\n\n    if (!execution) {\n      throw new Error(`Execution ${executionId} not found`);\n    }\n\n    if (execution.status !== 'completed') {\n      console.warn(`[Judge] Cannot evaluate incomplete execution: ${execution.status}`);\n      return {\n        score: 0,\n        feedback: 'Execution did not complete successfully',\n        passed: false,\n        strengths: [],\n        weaknesses: ['Execution failed or is still running']\n      };\n    }\n\n    // 2. Find or create a Judge role\n    let judgeRole = await prisma.role.findFirst({\n      where: { name: 'Judge' }\n    });\n\n    if (!judgeRole) {\n      console.log('[Judge] Creating default Judge role...');\n      judgeRole = await prisma.role.create({\n        data: {\n          name: 'Judge',\n          basePrompt: `You are an expert Quality Assurance Judge for AI orchestrations.\n\nYour job is to evaluate the quality of orchestration executions by analyzing:\n1. Whether the output matches the input requirements\n2. The efficiency of the workflow (step duration, retries)\n3. The completeness and correctness of the result\n4. Any errors or issues in the execution logs\n\nReturn your assessment as a JSON object with this structure:\n{\n  \"score\": 0.85,  // 0-1 scale\n  \"passed\": true,  // true if score >= 0.7\n  \"strengths\": [\"Clear output\", \"Efficient execution\"],\n  \"weaknesses\": [\"Minor formatting issue\"],\n  \"feedback\": \"Overall good execution with room for improvement...\"\n}`,\n          tools: [],\n          metadata: {\n            defaultTemperature: 0.3,  // Low temperature for consistent grading\n            defaultMaxTokens: 2048,\n            defaultResponseFormat: 'json_object'\n          }\n        }\n      });\n    }\n\n    // 3. Create the evaluation prompt\n    const evaluationPrompt = this.createEvaluationPrompt(execution);\n\n    // 4. Create Judge agent\n    const judgeAgent = await createVolcanoAgent({\n      roleId: judgeRole.id,\n      modelId: null,  // Let orchestrator pick best model\n      isLocked: false,\n      temperature: 0.3,\n      maxTokens: 2048\n    });\n\n    // 5. Get Judge's assessment\n    try {\n      const response = await judgeAgent.generate(evaluationPrompt);\n      \n      // Parse JSON response\n      let assessment;\n      try {\n        // Try to extract JSON from the response\n        const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\n        if (jsonMatch) {\n          assessment = JSON.parse(jsonMatch[0]);\n        } else {\n          assessment = JSON.parse(response);\n        }\n      } catch (parseError) {\n        console.error('[Judge] Failed to parse JSON response:', response);\n        // Fallback assessment\n        assessment = {\n          score: 0.5,\n          passed: false,\n          strengths: [],\n          weaknesses: ['Failed to parse judge response'],\n          feedback: response\n        };\n      }\n\n      console.log(`[Judge] ‚úÖ Evaluation complete: Score ${assessment.score}, Passed: ${assessment.passed}`);\n      \n      return {\n        score: assessment.score || 0,\n        feedback: assessment.feedback || '',\n        passed: assessment.passed !== false,\n        strengths: assessment.strengths || [],\n        weaknesses: assessment.weaknesses || []\n      };\n\n    } catch (error: any) {\n      console.error('[Judge] Evaluation failed:', error);\n      return {\n        score: 0,\n        feedback: `Evaluation error: ${error.message}`,\n        passed: false,\n        strengths: [],\n        weaknesses: ['Judge evaluation failed']\n      };\n    }\n  }\n\n  /**\n   * Create the evaluation prompt for the Judge\n   */\n  private static createEvaluationPrompt(execution: any): string {\n    return `Evaluate this orchestration execution:\n\nORCHESTRATION: ${execution.orchestration.name}\nDESCRIPTION: ${execution.orchestration.description || 'N/A'}\n\nINPUT:\n${JSON.stringify(execution.input, null, 2)}\n\nWORKFLOW STEPS:\n${execution.stepLogs?.map((log: any, i: number) => \n  `${i + 1}. ${log.stepName} - Status: ${log.status}, Duration: ${log.duration}ms${log.error ? `, Error: ${log.error}` : ''}`\n).join('\\n') || 'No step logs available'}\n\nOUTPUT:\n${JSON.stringify(execution.output, null, 2)}\n\nEXECUTION TIME: ${execution.completedAt ? \n  new Date(execution.completedAt).getTime() - new Date(execution.startedAt).getTime() : 'N/A'}ms\n\nPlease evaluate this execution and provide your assessment as a JSON object.`;\n  }\n\n  static async getAverageQuality(modelId: string): Promise<number> {\n    // Placeholder: In the future, this will query the 'assessments' table\n    // to find the average pass rate for this model.\n    // For now, we assume neutral quality (0.7)\n    return 0.7;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/BackupService.ts","messages":[{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":56,"column":33,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":59,"endColumn":6},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'stdout' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":101,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":101,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":134,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":134,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3706,3709],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3706,3709],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":135,"column":63,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":135,"endColumn":70},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":136,"column":32,"nodeType":"Property","messageId":"anyAssignment","endLine":136,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":136,"column":45,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":136,"endColumn":52},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":174,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":174,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4988,4991],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4988,4991],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":175,"column":64,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":175,"endColumn":71},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":176,"column":32,"nodeType":"Property","messageId":"anyAssignment","endLine":176,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":176,"column":45,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":176,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { exec } from 'child_process';\nimport { promisify } from 'util';\nimport fs from 'fs/promises';\nimport path from 'path';\n\nconst execAsync = promisify(exec);\n\n/**\n * AUTOMATIC DATABASE BACKUP SERVICE\n * \n * Ensures data safety by creating regular snapshots of the database.\n * Runs automatically on a schedule and before critical operations.\n * \n * Strategy:\n * - Hourly snapshots (keep last 24)\n * - Daily snapshots (keep last 7)\n * - Weekly snapshots (keep last 4)\n * - Manual snapshots (keep forever)\n */\n\nexport interface BackupMetadata {\n  timestamp: string;\n  type: 'hourly' | 'daily' | 'weekly' | 'manual' | 'pre-operation';\n  size: number;\n  tables: string[];\n  reason?: string;\n}\n\nexport class BackupService {\n  private backupDir: string;\n  private isRunning = false;\n  private interval: NodeJS.Timeout | null = null;\n\n  constructor(backupDir?: string) {\n    this.backupDir = backupDir || path.join(process.cwd(), 'backups');\n  }\n\n  /**\n   * Start the automatic backup scheduler\n   */\n  async start() {\n    if (this.isRunning) {\n      console.log('[BackupService] Already running');\n      return;\n    }\n\n    console.log('[BackupService] üöÄ Starting automatic backup service...');\n    \n    // Ensure backup directory exists\n    await fs.mkdir(this.backupDir, { recursive: true });\n\n    // Run initial backup\n    await this.createBackup('hourly');\n\n    // Schedule hourly backups\n    this.interval = setInterval(async () => {\n      await this.createBackup('hourly');\n      await this.cleanup();\n    }, 60 * 60 * 1000); // Every hour\n\n    this.isRunning = true;\n    console.log('[BackupService] ‚úÖ Backup service started (hourly schedule)');\n  }\n\n  /**\n   * Stop the automatic backup scheduler\n   */\n  stop() {\n    if (this.interval) {\n      clearInterval(this.interval);\n      this.interval = null;\n    }\n    this.isRunning = false;\n    console.log('[BackupService] ‚èπÔ∏è Backup service stopped');\n  }\n\n  /**\n   * Create a database backup\n   */\n  async createBackup(\n    type: BackupMetadata['type'] = 'manual',\n    reason?: string\n  ): Promise<{ success: boolean; filePath?: string; error?: string }> {\n    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');\n    const fileName = `core_db_${type}_${timestamp}.sql`;\n    const filePath = path.join(this.backupDir, fileName);\n\n    try {\n      console.log(`[BackupService] üíæ Creating ${type} backup: ${fileName}...`);\n\n      // Get database URL from environment\n      const dbUrl = process.env.DATABASE_URL;\n      if (!dbUrl) {\n        throw new Error('DATABASE_URL not found in environment');\n      }\n\n      // Use pg_dump to create backup\n      // -O: no owner (better for restoring on different machines)\n      // -x: no privileges\n      // --clean: include DROP statements\n      const { stdout, stderr } = await execAsync(\n        `pg_dump \"${dbUrl}\" -O -x --clean > \"${filePath}\"`,\n        { maxBuffer: 50 * 1024 * 1024 } // 50MB buffer for large DBs\n      );\n\n      if (stderr && !stderr.includes('WARNING')) {\n        console.warn(`[BackupService] pg_dump warnings: ${stderr}`);\n      }\n\n      // Get file size\n      const stats = await fs.stat(filePath);\n      const sizeMB = (stats.size / 1024 / 1024).toFixed(2);\n\n      // Get list of tables\n      const tables = await this.getTableList();\n\n      // Save metadata\n      const metadata: BackupMetadata = {\n        timestamp: new Date().toISOString(),\n        type,\n        size: stats.size,\n        tables,\n        reason\n      };\n\n      await fs.writeFile(\n        `${filePath}.meta.json`,\n        JSON.stringify(metadata, null, 2)\n      );\n\n      console.log(`[BackupService] ‚úÖ Backup complete: ${sizeMB} MB`);\n      return { success: true, filePath };\n\n    } catch (error: any) {\n      console.error('[BackupService] ‚ùå Backup failed:', error.message);\n      return { success: false, error: error.message };\n    }\n  }\n\n  /**\n   * Create a backup before a critical operation\n   */\n  async backupBeforeOperation(operationName: string): Promise<boolean> {\n    console.log(`[BackupService] üõ°Ô∏è Creating safety backup before: ${operationName}`);\n    const result = await this.createBackup('pre-operation', operationName);\n    return result.success;\n  }\n\n  /**\n   * Restore from a backup file\n   */\n  async restore(backupFilePath: string): Promise<{ success: boolean; error?: string }> {\n    try {\n      console.log(`[BackupService] üîÑ Restoring from: ${backupFilePath}...`);\n\n      // Verify file exists\n      await fs.access(backupFilePath);\n\n      // Get database URL\n      const dbUrl = process.env.DATABASE_URL;\n      if (!dbUrl) {\n        throw new Error('DATABASE_URL not found in environment');\n      }\n\n      // Create a safety backup before restoring\n      await this.createBackup('pre-operation', `restore from ${path.basename(backupFilePath)}`);\n\n      // Restore using psql\n      await execAsync(`psql \"${dbUrl}\" < \"${backupFilePath}\"`);\n\n      console.log('[BackupService] ‚úÖ Restore complete');\n      return { success: true };\n\n    } catch (error: any) {\n      console.error('[BackupService] ‚ùå Restore failed:', error.message);\n      return { success: false, error: error.message };\n    }\n  }\n\n  /**\n   * List all available backups\n   */\n  async listBackups(): Promise<Array<BackupMetadata & { filePath: string }>> {\n    try {\n      const files = await fs.readdir(this.backupDir);\n      const sqlFiles = files.filter(f => f.endsWith('.sql'));\n\n      const backups = await Promise.all(\n        sqlFiles.map(async (file) => {\n          const filePath = path.join(this.backupDir, file);\n          const metaPath = `${filePath}.meta.json`;\n\n          try {\n            const metaContent = await fs.readFile(metaPath, 'utf-8');\n            const metadata = JSON.parse(metaContent) as BackupMetadata;\n            return { ...metadata, filePath };\n          } catch {\n            // No metadata file, create basic info from file stats\n            const stats = await fs.stat(filePath);\n            return {\n              timestamp: stats.mtime.toISOString(),\n              type: 'manual' as const,\n              size: stats.size,\n              tables: [],\n              filePath\n            };\n          }\n        })\n      );\n\n      // Sort by timestamp (newest first)\n      return backups.sort((a, b) => \n        new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()\n      );\n\n    } catch (error) {\n      console.error('[BackupService] Failed to list backups:', error);\n      return [];\n    }\n  }\n\n  /**\n   * Cleanup old backups according to retention policy\n   */\n  private async cleanup() {\n    try {\n      const backups = await this.listBackups();\n\n      // Group by type\n      const hourly = backups.filter(b => b.type === 'hourly');\n      const daily = backups.filter(b => b.type === 'daily');\n      const weekly = backups.filter(b => b.type === 'weekly');\n\n      // Keep last 24 hourly\n      const toDelete = [\n        ...hourly.slice(24),\n        ...daily.slice(7),\n        ...weekly.slice(4)\n      ];\n\n      for (const backup of toDelete) {\n        await fs.unlink(backup.filePath);\n        await fs.unlink(`${backup.filePath}.meta.json`).catch(() => {});\n        console.log(`[BackupService] üóëÔ∏è Deleted old backup: ${path.basename(backup.filePath)}`);\n      }\n\n    } catch (error) {\n      console.error('[BackupService] Cleanup failed:', error);\n    }\n  }\n\n  /**\n   * Get list of tables in the database\n   */\n  private async getTableList(): Promise<string[]> {\n    try {\n      const { prisma } = await import('../db.js');\n      const result = await prisma.$queryRaw<Array<{ tablename: string }>>`\n        SELECT tablename FROM pg_tables \n        WHERE schemaname = 'public'\n        ORDER BY tablename\n      `;\n      return result.map(r => r.tablename);\n    } catch {\n      return [];\n    }\n  }\n}\n\n// Singleton instance\nexport const backupService = new BackupService();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/CodeGraphService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ComplexityRouter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ConfidenceAgent.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":124,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":124,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4475,4478],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4475,4478],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":128,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":128,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":131,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":131,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":220,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":220,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":223,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":223,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .output on an `any` value.","line":223,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":223,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":224,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":224,"endColumn":84},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .confidence on an `any` value.","line":224,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":224,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .confidence on an `any` value.","line":224,"column":68,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":224,"endColumn":78},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":225,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":225,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .reasoning on an `any` value.","line":225,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":225,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AgentFactoryService } from './AgentFactory.js';\nimport { ProviderManager } from \"./ProviderManager.js\";\nimport { PrismaAgentConfigRepository } from '../repositories/PrismaAgentConfigRepository.js';\nimport type { CardAgentState } from '../types.js';\n\n/**\n * ConfidenceAgent: Wraps agent execution with confidence scoring and self-correction\n * \n * Purpose: Stop hallucinations before they spread by requiring agents to self-assess\n * their confidence in their outputs. If confidence is below threshold, triggers\n * a self-correction loop.\n * \n * This implements the \"Quality Control\" layer of the Intelligence System.\n */\n\nexport interface ConfidenceResult {\n  output: string;\n  confidence: number;\n  correctionAttempts: number;\n  reasoning?: string;\n}\n\nexport interface ConfidenceConfig {\n  minConfidence?: number; // Default 0.8\n  maxCorrectionAttempts?: number; // Default 3\n  requireReasoning?: boolean; // Default true\n}\n\nexport class ConfidenceAgent {\n  private agentFactory: AgentFactoryService;\n  \n  constructor() {\n    this.agentFactory = new AgentFactoryService(\n      ProviderManager.getInstance(),\n      new PrismaAgentConfigRepository()\n    );\n  }\n\n  /**\n   * Execute a task with confidence scoring and self-correction\n   * \n   * @param cardConfig - The agent configuration\n   * @param userGoal - The task to execute\n   * @param config - Confidence configuration\n   * @returns Result with output, confidence score, and correction attempts\n   */\n  async executeWithConfidence(\n    cardConfig: CardAgentState,\n    userGoal: string,\n    config: ConfidenceConfig = {}\n  ): Promise<ConfidenceResult> {\n    const minConfidence = config.minConfidence ?? 0.8;\n    const maxAttempts = config.maxCorrectionAttempts ?? 3;\n    const requireReasoning = config.requireReasoning ?? true;\n\n    let correctionAttempts = 0;\n    let lastOutput = '';\n    let lastConfidence = 0;\n    let lastReasoning = '';\n\n    // Create the base agent\n    const agent = await this.agentFactory.createVolcanoAgent(cardConfig);\n\n    // Augment the prompt to request confidence scoring\n    const confidencePrompt = this.buildConfidencePrompt(userGoal, requireReasoning);\n\n    while (correctionAttempts < maxAttempts) {\n      try {\n        // Generate response with confidence scoring\n        const rawResponse = await agent.generate(confidencePrompt);\n        \n        // Parse the response to extract confidence and output\n        const parsed = this.parseConfidenceResponse(rawResponse);\n        \n        lastOutput = parsed.output;\n        lastConfidence = parsed.confidence;\n        lastReasoning = parsed.reasoning || '';\n\n        // Check if confidence meets threshold\n        if (lastConfidence >= minConfidence) {\n          console.log(`[ConfidenceAgent] ‚úì Confidence ${lastConfidence.toFixed(2)} meets threshold ${minConfidence}`);\n          return {\n            output: lastOutput,\n            confidence: lastConfidence,\n            correctionAttempts,\n            reasoning: lastReasoning\n          };\n        }\n\n        // Confidence too low, trigger self-correction\n        console.warn(`[ConfidenceAgent] ‚ö† Confidence ${lastConfidence.toFixed(2)} below threshold ${minConfidence}. Attempting correction ${correctionAttempts + 1}/${maxAttempts}`);\n        \n        correctionAttempts++;\n        \n        // If we have more attempts, modify the prompt for self-correction\n        if (correctionAttempts < maxAttempts) {\n          const correctionPrompt = this.buildCorrectionPrompt(\n            userGoal,\n            lastOutput,\n            lastConfidence,\n            lastReasoning,\n            requireReasoning\n          );\n          \n          // Use the correction prompt for next iteration\n          const correctedResponse = await agent.generate(correctionPrompt);\n          const correctedParsed = this.parseConfidenceResponse(correctedResponse);\n          \n          lastOutput = correctedParsed.output;\n          lastConfidence = correctedParsed.confidence;\n          lastReasoning = correctedParsed.reasoning || '';\n          \n          // Check again after correction\n          if (lastConfidence >= minConfidence) {\n            console.log(`[ConfidenceAgent] ‚úì After correction: Confidence ${lastConfidence.toFixed(2)} meets threshold`);\n            return {\n              output: lastOutput,\n              confidence: lastConfidence,\n              correctionAttempts,\n              reasoning: lastReasoning\n            };\n          }\n        }\n      } catch (error: any) {\n        console.error(`[ConfidenceAgent] Error during execution:`, error);\n        // Return what we have with low confidence\n        return {\n          output: lastOutput || `Error: ${error.message}`,\n          confidence: 0,\n          correctionAttempts,\n          reasoning: `Execution failed: ${error.message}`\n        };\n      }\n    }\n\n    // Max attempts reached, return best effort\n    console.warn(`[ConfidenceAgent] ‚ö† Max correction attempts reached. Final confidence: ${lastConfidence.toFixed(2)}`);\n    return {\n      output: lastOutput,\n      confidence: lastConfidence,\n      correctionAttempts,\n      reasoning: lastReasoning\n    };\n  }\n\n  /**\n   * Build a prompt that requests confidence scoring\n   */\n  private buildConfidencePrompt(userGoal: string, requireReasoning: boolean): string {\n    return `${userGoal}\n\nIMPORTANT: You must respond with a JSON object in the following format:\n{\n  \"output\": \"your actual response to the task\",\n  \"confidence\": 0.95,${requireReasoning ? '\\n  \"reasoning\": \"brief explanation of your confidence level\",' : ''}\n}\n\nThe confidence score should be between 0.0 and 1.0, where:\n- 0.9-1.0: Very confident, well-established facts or straightforward tasks\n- 0.7-0.9: Moderately confident, some assumptions or complexity\n- 0.5-0.7: Low confidence, significant uncertainty or speculation\n- 0.0-0.5: Very uncertain, mostly guessing\n\nBe honest about your confidence level. It's better to admit uncertainty than to hallucinate.`;\n  }\n\n  /**\n   * Build a prompt for self-correction\n   */\n  private buildCorrectionPrompt(\n    originalGoal: string,\n    previousOutput: string,\n    previousConfidence: number,\n    previousReasoning: string,\n    requireReasoning: boolean\n  ): string {\n    return `You previously attempted this task but your confidence was too low (${previousConfidence.toFixed(2)}).\n\nORIGINAL TASK:\n${originalGoal}\n\nYOUR PREVIOUS RESPONSE:\n${previousOutput}\n\nYOUR PREVIOUS REASONING:\n${previousReasoning}\n\nPlease try again with more careful analysis. Consider:\n1. What assumptions did you make that might be wrong?\n2. What information are you uncertain about?\n3. How can you provide a more accurate or complete response?\n\nRespond with a JSON object in the following format:\n{\n  \"output\": \"your improved response\",\n  \"confidence\": 0.95,${requireReasoning ? '\\n  \"reasoning\": \"explanation of what you improved and why you\\'re more confident\",' : ''}\n}`;\n  }\n\n  /**\n   * Parse the agent's response to extract confidence and output\n   */\n  private parseConfidenceResponse(rawResponse: string): {\n    output: string;\n    confidence: number;\n    reasoning?: string;\n  } {\n    try {\n      // Try to extract JSON from the response\n      const jsonMatch = rawResponse.match(/\\{[\\s\\S]*\\}/);\n      if (!jsonMatch) {\n        // No JSON found, treat entire response as output with low confidence\n        return {\n          output: rawResponse,\n          confidence: 0.5,\n          reasoning: 'No confidence score provided'\n        };\n      }\n\n      const parsed = JSON.parse(jsonMatch[0]);\n      \n      return {\n        output: parsed.output || rawResponse,\n        confidence: typeof parsed.confidence === 'number' ? parsed.confidence : 0.5,\n        reasoning: parsed.reasoning\n      };\n    } catch (error) {\n      // Parsing failed, return raw response with low confidence\n      console.warn('[ConfidenceAgent] Failed to parse confidence response:', error);\n      return {\n        output: rawResponse,\n        confidence: 0.5,\n        reasoning: 'Failed to parse confidence score'\n      };\n    }\n  }\n}\n\n// Singleton instance\nexport const confidenceAgent = new ConfidenceAgent();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ContextManager.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":36,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":36,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{}`.","line":37,"column":39,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":37,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `ContextState`.","line":38,"column":31,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":38,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access [key] on an `any` value.","line":38,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":38,"endColumn":38},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'getContext' has no 'await' expression.","line":58,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":58,"endColumn":19,"suggestions":[{"messageId":"removeAsync","fix":{"range":[1636,1691],"text":"getContext(roleId: string): ContextState"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'setContext' has no 'await' expression.","line":68,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":68,"endColumn":19,"suggestions":[{"messageId":"removeAsync","fix":{"range":[1982,2059],"text":"setContext(roleId: string, state: Partial<ContextState>): void"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'updateTone' has no 'await' expression.","line":80,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":80,"endColumn":19,"suggestions":[{"messageId":"removeAsync","fix":{"range":[2435,2496],"text":"updateTone(roleId: string, tone: string): void"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'updateStyle' has no 'await' expression.","line":87,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":87,"endColumn":20,"suggestions":[{"messageId":"removeAsync","fix":{"range":[2677,2740],"text":"updateStyle(roleId: string, style: string): void"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'setMemoryKey' has no 'await' expression.","line":94,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":94,"endColumn":21,"suggestions":[{"messageId":"removeAsync","fix":{"range":[2923,3000],"text":"setMemoryKey(roleId: string, key: string, value: string): void"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'removeMemoryKey' has no 'await' expression.","line":101,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":101,"endColumn":24,"suggestions":[{"messageId":"removeAsync","fix":{"range":[3223,3288],"text":"removeMemoryKey(roleId: string, key: string): void"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'clearContext' has no 'await' expression.","line":113,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":113,"endColumn":21,"suggestions":[{"messageId":"removeAsync","fix":{"range":[3591,3640],"text":"clearContext(roleId: string): void"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'countTokensFromFiles' has no 'await' expression.","line":203,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":203,"endColumn":37,"suggestions":[{"messageId":"removeAsync","fix":{"range":[6181,6245],"text":"countTokensFromFiles(filePaths: string[]): number"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'countTokens' has no 'await' expression.","line":227,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":227,"endColumn":20,"suggestions":[{"messageId":"removeAsync","fix":{"range":[6927,6975],"text":"countTokens(text: string): number"},"desc":"Remove 'async'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":13,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from 'fs';\nimport path from 'path';\n\nexport type ContextState = {\n  tone?: string;\n  style?: string;\n  memory: Record<string, string>;\n};\n\n/**\n * ContextManager\n * - In-memory Map backed by a JSON file for optional persistence\n * - Safe, simple persistence (no DB migrations required)\n */\nexport class ContextManager {\n  private store: Map<string, ContextState>;\n  private persistFile: string | null;\n\n  constructor(persistFile?: string | null) {\n    this.store = new Map();\n    this.persistFile = persistFile || path.join(process.cwd(), 'data', 'context_store.json');\n    this.loadFromDisk();\n  }\n\n  private ensureDataDir() {\n    if (!this.persistFile) return;\n    const dir = path.dirname(this.persistFile);\n    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });\n  }\n\n  private loadFromDisk() {\n    try {\n      if (!this.persistFile) return;\n      if (fs.existsSync(this.persistFile)) {\n        const raw = fs.readFileSync(this.persistFile, 'utf8');\n        const obj = JSON.parse(raw || '{}');\n        for (const key of Object.keys(obj)) {\n          this.store.set(key, obj[key]);\n        }\n      }\n    } catch (err) {\n      console.warn('[ContextManager] Failed to load context store:', err);\n    }\n  }\n\n  private saveToDisk() {\n    try {\n      if (!this.persistFile) return;\n      this.ensureDataDir();\n      const obj: Record<string, ContextState> = {};\n      for (const [k, v] of this.store.entries()) obj[k] = v;\n      fs.writeFileSync(this.persistFile, JSON.stringify(obj, null, 2), 'utf8');\n    } catch (err) {\n      console.warn('[ContextManager] Failed to persist context store:', err);\n    }\n  }\n\n  async getContext(roleId: string): Promise<ContextState> {\n    if (!roleId) return { tone: '', style: '', memory: {} };\n    let ctx = this.store.get(roleId);\n    if (!ctx) {\n      ctx = { tone: '', style: '', memory: {} };\n      this.store.set(roleId, ctx);\n    }\n    return { tone: ctx.tone, style: ctx.style, memory: { ...ctx.memory } };\n  }\n\n  async setContext(roleId: string, state: Partial<ContextState>): Promise<void> {\n    if (!roleId) return;\n    const existing = this.store.get(roleId) || { tone: '', style: '', memory: {} };\n    const merged: ContextState = {\n      tone: state.tone ?? existing.tone,\n      style: state.style ?? existing.style,\n      memory: { ...(existing.memory || {}), ...(state.memory || {}) },\n    };\n    this.store.set(roleId, merged);\n    this.saveToDisk();\n  }\n\n  async updateTone(roleId: string, tone: string): Promise<void> {\n    const existing = this.store.get(roleId) || { tone: '', style: '', memory: {} };\n    existing.tone = tone;\n    this.store.set(roleId, existing);\n    this.saveToDisk();\n  }\n\n  async updateStyle(roleId: string, style: string): Promise<void> {\n    const existing = this.store.get(roleId) || { tone: '', style: '', memory: {} };\n    existing.style = style;\n    this.store.set(roleId, existing);\n    this.saveToDisk();\n  }\n\n  async setMemoryKey(roleId: string, key: string, value: string): Promise<void> {\n    const existing = this.store.get(roleId) || { tone: '', style: '', memory: {} };\n    existing.memory = { ...(existing.memory || {}), [key]: value };\n    this.store.set(roleId, existing);\n    this.saveToDisk();\n  }\n\n  async removeMemoryKey(roleId: string, key: string): Promise<void> {\n    const existing = this.store.get(roleId);\n    if (!existing) return;\n    if (existing.memory && key in existing.memory) {\n      const copy = { ...existing.memory };\n      delete copy[key];\n      existing.memory = copy;\n      this.store.set(roleId, existing);\n      this.saveToDisk();\n    }\n  }\n\n  async clearContext(roleId: string): Promise<void> {\n    this.store.delete(roleId);\n    this.saveToDisk();\n  }\n\n  /**\n   * Cell Division: Validates if model can fit the context from given files\n   * Returns validation result with action suggestions\n   */\n  async validateContextFit(\n    modelId: string, \n    filePaths: string[]\n  ): Promise<{\n    fit: boolean;\n    action?: string;\n    reason?: string;\n    usage?: {\n      totalTokens: number;\n      limit: number;\n      utilizationPercent: number;\n    };\n  }> {\n    try {\n      const { PrismaClient } = await import('@prisma/client');\n      const prisma = new PrismaClient();\n\n      // 1. Fetch Model Specs\n      const model = await prisma.model.findUnique({ \n        where: { id: modelId },\n        select: { specs: true, name: true }\n      });\n\n      if (!model) {\n        return {\n          fit: false,\n          action: 'SELECT_DIFFERENT_MODEL',\n          reason: `Model ${modelId} not found in registry`\n        };\n      }\n\n      const specs = model.specs as { contextWindow?: number };\n      const limit = specs?.contextWindow || 8192; // Default if unknown\n\n      // 2. Calculate \"Weight\" - count tokens from files\n      const totalTokens = await this.countTokensFromFiles(filePaths);\n\n      const utilizationPercent = (totalTokens / limit) * 100;\n\n      console.log(`‚öñÔ∏è Context Check for ${model.name}: ${totalTokens} / ${limit} (${utilizationPercent.toFixed(1)}%)`);\n\n      // 3. Determine if context fits\n      const SAFE_THRESHOLD = 0.85; // Use 85% of context window to leave room for output\n\n      if (totalTokens > limit * SAFE_THRESHOLD) {\n        // TRIGGER CELL DIVISION\n        return {\n          fit: false,\n          action: 'SPLIT_JOB',\n          reason: `Context overflow (${totalTokens} tokens > ${(limit * SAFE_THRESHOLD).toFixed(0)} safe limit). ` +\n                  `Suggest breaking ${filePaths.length > 1 ? 'files' : filePaths[0]} into sub-tasks.`,\n          usage: {\n            totalTokens,\n            limit,\n            utilizationPercent\n          }\n        };\n      }\n\n      return { \n        fit: true,\n        usage: {\n          totalTokens,\n          limit,\n          utilizationPercent\n        }\n      };\n    } catch (error) {\n      console.error('[ContextManager] Context validation failed:', error);\n      return {\n        fit: false,\n        action: 'ERROR',\n        reason: `Validation error: ${error instanceof Error ? error.message : 'Unknown error'}`\n      };\n    }\n  }\n\n  /**\n   * Counts approximate tokens from file paths\n   * Uses a simple heuristic: 1 token ‚âà 4 characters\n   */\n  private async countTokensFromFiles(filePaths: string[]): Promise<number> {\n    let totalChars = 0;\n\n    for (const filePath of filePaths) {\n      try {\n        if (fs.existsSync(filePath)) {\n          const content = fs.readFileSync(filePath, 'utf8');\n          totalChars += content.length;\n        } else {\n          console.warn(`[ContextManager] File not found: ${filePath}`);\n        }\n      } catch (error) {\n        console.warn(`[ContextManager] Failed to read ${filePath}:`, error);\n      }\n    }\n\n    // Simple heuristic: ~4 chars per token\n    return Math.ceil(totalChars / 4);\n  }\n\n  /**\n   * Advanced tokenization using a proper tokenizer (TODO: integrate tiktoken or similar)\n   * For now, uses the simple character-based heuristic\n   */\n  async countTokens(text: string): Promise<number> {\n    // TODO: Integrate proper tokenizer (tiktoken for GPT models, etc.)\n    // For now, use simple heuristic\n    return Math.ceil(text.length / 4);\n  }\n}\n\n\n// Export a singleton for app-wide usage (AgentRuntime will use this)\nexport const contextManager = new ContextManager();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/CorporateOrchestrator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/CreditGuard.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":9,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":9,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .data on an `any` value.","line":9,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":9,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import axios from 'axios';\n\nexport class CreditGuard {\n  static async checkOpenRouterBalance(apiKey: string): Promise<number | null> {\n    try {\n      const response = await axios.get('https://openrouter.ai/api/v1/credits', {\n        headers: { Authorization: `Bearer ${apiKey}` }\n      });\n      return response.data?.data?.total_credits || 0;\n    } catch (error) {\n      console.error('[Guard] Failed to check credits:', error);\n      return null;\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/DynamicModelAdapter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/FileWatcherService.ts","messages":[{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":51,"column":28,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":51,"endColumn":90},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":52,"column":31,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":52,"endColumn":95},{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":55,"column":31,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":55,"endColumn":84},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":57,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":57,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1948,1951],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1948,1951],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":68,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":68,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":105,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":105,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":141,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":141,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":189,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":189,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5261,5264],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5261,5264],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .length on an `any` value.","line":194,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":194,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access [0] on an `any` value.","line":194,"column":55,"nodeType":"Literal","messageId":"unsafeMemberExpression","endLine":194,"endColumn":56},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":253,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":253,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as chokidar from 'chokidar';\nimport * as path from 'path';\nimport fs from 'fs/promises';\nimport crypto from 'crypto';\nimport { prisma } from '../db.js';\nimport { vectorStore, chunkText, createEmbedding } from './vector.service.js';\nimport { getWebSocketService } from './websocket.singleton.js';\n\n/**\n * FileWatcherService\n * \n * Watches the filesystem for changes and automatically re-indexes modified files.\n * Uses content hashing to avoid re-indexing unchanged files.\n */\nclass FileWatcherService {\n  private watcher: chokidar.FSWatcher | null = null;\n  private readonly textExtensions = ['.ts', '.js', '.tsx', '.jsx', '.md', '.json', '.css', '.html', '.txt', '.yaml', '.yml', '.sql', '.prisma'];\n  private isIndexing = false;\n  private indexQueue: Set<string> = new Set();\n\n  /**\n   * Start watching a directory for file changes\n   */\n  async startWatching(rootPath: string) {\n    if (this.watcher) {\n      console.log('[FileWatcher] Already watching. Stopping previous watcher...');\n      await this.stopWatching();\n    }\n\n    console.log(`[FileWatcher] üëÅÔ∏è  Starting file watcher for: ${rootPath}`);\n\n    this.watcher = chokidar.watch(rootPath, {\n      ignored: [\n        '**/node_modules/**',\n        '**/.git/**',\n        '**/dist/**',\n        '**/.turbo/**',\n        '**/.next/**',\n        '**/build/**',\n        '**/.domoreai/shadow/**', // Don't watch shadow files\n      ],\n      persistent: true,\n      ignoreInitial: true, // Don't trigger on initial scan\n      awaitWriteFinish: {\n        stabilityThreshold: 500,\n        pollInterval: 100\n      }\n    });\n\n    // File added or changed\n    this.watcher.on('add', (filePath: string) => this.handleFileChange(filePath, 'added'));\n    this.watcher.on('change', (filePath: string) => this.handleFileChange(filePath, 'changed'));\n    \n    // File deleted\n    this.watcher.on('unlink', (filePath: string) => this.handleFileDelete(filePath));\n\n    this.watcher.on('error', (error: any) => {\n      console.error('[FileWatcher] ‚ùå Error:', error);\n    });\n\n    this.watcher.on('ready', () => {\n      console.log('[FileWatcher] ‚úÖ Ready and watching for changes');\n      try {\n        getWebSocketService()?.broadcast({ \n          type: 'filewatcher.ready', \n          path: rootPath \n        });\n      } catch (e) {\n        // Ignore WS errors\n      }\n    });\n  }\n\n  /**\n   * Stop watching\n   */\n  async stopWatching() {\n    if (this.watcher) {\n      await this.watcher.close();\n      this.watcher = null;\n      console.log('[FileWatcher] üõë Stopped watching');\n    }\n  }\n\n  /**\n   * Handle file change (add or modify)\n   */\n  private async handleFileChange(filePath: string, changeType: 'added' | 'changed') {\n    const ext = path.extname(filePath).toLowerCase();\n    \n    // Only process text files\n    if (!this.textExtensions.includes(ext)) {\n      return;\n    }\n\n    console.log(`[FileWatcher] üìù File ${changeType}: ${path.basename(filePath)}`);\n    \n    try {\n      getWebSocketService()?.broadcast({ \n        type: 'filewatcher.change', \n        file: path.basename(filePath),\n        filePath,\n        changeType \n      });\n    } catch (e) {\n      // Ignore WS errors\n    }\n\n    // Add to queue and process\n    this.indexQueue.add(filePath);\n    await this.processQueue();\n  }\n\n  /**\n   * Handle file deletion\n   */\n  private async handleFileDelete(filePath: string) {\n    console.log(`[FileWatcher] üóëÔ∏è  File deleted: ${path.basename(filePath)}`);\n    \n    try {\n      // Remove from FileIndex\n      await prisma.$executeRawUnsafe(\n        `DELETE FROM \"FileIndex\" WHERE \"filePath\" = $1`,\n        filePath\n      );\n\n      // Remove from VectorEmbedding\n      await prisma.$executeRawUnsafe(\n        `DELETE FROM \"VectorEmbedding\" WHERE \"filePath\" = $1`,\n        filePath\n      );\n\n      console.log(`[FileWatcher] ‚úÖ Removed ${filePath} from index`);\n      \n      try {\n        getWebSocketService()?.broadcast({ \n          type: 'filewatcher.delete', \n          file: path.basename(filePath),\n          filePath \n        });\n      } catch (e) {\n        // Ignore WS errors\n      }\n    } catch (error) {\n      console.error(`[FileWatcher] ‚ùå Error removing ${filePath} from index:`, error);\n    }\n  }\n\n  /**\n   * Process the index queue\n   */\n  private async processQueue() {\n    if (this.isIndexing || this.indexQueue.size === 0) {\n      return;\n    }\n\n    this.isIndexing = true;\n\n    try {\n      const filesToProcess = Array.from(this.indexQueue);\n      this.indexQueue.clear();\n\n      for (const filePath of filesToProcess) {\n        try {\n          const content = await fs.readFile(filePath, 'utf-8');\n          await this.indexFile(filePath, content);\n        } catch (error) {\n          console.error(`[FileWatcher] ‚ùå Error indexing ${filePath}:`, error);\n        }\n      }\n    } finally {\n      this.isIndexing = false;\n\n      // Process any files that were added while we were indexing\n      if (this.indexQueue.size > 0) {\n        await this.processQueue();\n      }\n    }\n  }\n\n  /**\n   * Index a single file (same logic as IngestionAgent)\n   */\n  private async indexFile(filePath: string, content: string) {\n    // Compute content hash to detect unchanged files\n    const hash = crypto.createHash('sha256').update(content, 'utf8').digest('hex');\n\n    try {\n      const existing: any = await prisma.$queryRawUnsafe(\n        `SELECT \"contentHash\" FROM \"FileIndex\" WHERE \"filePath\" = $1 LIMIT 1`,\n        filePath\n      );\n\n      if (existing && existing.length > 0 && existing[0].contentHash === hash) {\n        console.log(`[FileWatcher] ‚è≠Ô∏è  Skipping ${path.basename(filePath)} ‚Äî content unchanged`);\n        return;\n      }\n    } catch (err) {\n      console.warn(`[FileWatcher] Could not check FileIndex for ${filePath}:`, err);\n      // fall through to re-embed\n    }\n\n    console.log(`[FileWatcher] üîÑ Re-indexing ${path.basename(filePath)}...`);\n\n    const chunks = chunkText(content);\n    console.log(`[FileWatcher] üì¶ Created ${chunks.length} chunks`);\n    \n    const vectors = await Promise.all(chunks.map(async (chunk, i) => {\n      const embedding = await createEmbedding(chunk);\n      return {\n        id: `${filePath}#${i}`,\n        vector: embedding,\n        metadata: {\n          filePath,\n          chunk,\n          contentHash: hash,\n        },\n      };\n    }));\n\n    // Delete old vectors for this file\n    try {\n      await prisma.$executeRawUnsafe(\n        `DELETE FROM \"VectorEmbedding\" WHERE \"filePath\" = $1`,\n        filePath\n      );\n    } catch (err) {\n      console.warn(`[FileWatcher] Could not delete old vectors for ${filePath}:`, err);\n    }\n\n    // Add new vectors\n    await vectorStore.add(vectors);\n    console.log(`[FileWatcher] üíæ Stored ${vectors.length} vectors for ${path.basename(filePath)}`);\n\n    // Update FileIndex\n    try {\n      await prisma.$executeRawUnsafe(\n        `INSERT INTO \"FileIndex\" (\"filePath\", \"contentHash\", \"updatedAt\") VALUES ($1, $2, CURRENT_TIMESTAMP)\n         ON CONFLICT (\"filePath\") DO UPDATE SET \"contentHash\" = EXCLUDED.\"contentHash\", \"updatedAt\" = CURRENT_TIMESTAMP`,\n        filePath,\n        hash\n      );\n      console.log(`[FileWatcher] üîñ Updated FileIndex for ${path.basename(filePath)}`);\n      \n      try {\n        getWebSocketService()?.broadcast({ \n          type: 'filewatcher.indexed', \n          file: path.basename(filePath),\n          filePath,\n          chunks: vectors.length,\n          hash \n        });\n      } catch (e) {\n        // Ignore WS errors\n      }\n    } catch (err) {\n      console.warn(`[FileWatcher] Failed to update FileIndex for ${filePath}:`, err);\n    }\n  }\n\n  /**\n   * Get watcher status\n   */\n  getStatus() {\n    return {\n      isWatching: this.watcher !== null,\n      isIndexing: this.isIndexing,\n      queueSize: this.indexQueue.size,\n    };\n  }\n}\n\nexport const fileWatcherService = new FileWatcherService();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/IngestionAgent.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":12,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[441,444],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[441,444],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[470,473],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[470,473],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":56,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":56,"endColumn":72,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[2373,2373],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[2373,2373],"text":"await "},"desc":"Add await operator."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .ignores on an `any` value.","line":66,"column":58,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":66,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":66,"column":85,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":66,"endColumn":110},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .ignores on an `any` value.","line":66,"column":103,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":66,"endColumn":110},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .ignores on an `any` value.","line":69,"column":66,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":69,"endColumn":73},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .ignores on an `any` value.","line":81,"column":61,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":81,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":81,"column":88,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":81,"endColumn":113},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .ignores on an `any` value.","line":81,"column":106,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":81,"endColumn":113},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .ignores on an `any` value.","line":83,"column":67,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":83,"endColumn":74},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":96,"column":120,"nodeType":null,"messageId":"unusedVar","endLine":96,"endColumn":121},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .ignores on an `any` value.","line":112,"column":67,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":112,"endColumn":74},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":112,"column":93,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":112,"endColumn":118},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .ignores on an `any` value.","line":112,"column":111,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":112,"endColumn":118},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":123,"column":134,"nodeType":null,"messageId":"unusedVar","endLine":123,"endColumn":135},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":129,"column":165,"nodeType":null,"messageId":"unusedVar","endLine":129,"endColumn":166},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":134,"column":153,"nodeType":null,"messageId":"unusedVar","endLine":134,"endColumn":154},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":145,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7096,7099],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7096,7099],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .length on an `any` value.","line":150,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":150,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access [0] on an `any` value.","line":150,"column":55,"nodeType":"Literal","messageId":"unsafeMemberExpression","endLine":150,"endColumn":56},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":152,"column":138,"nodeType":null,"messageId":"unusedVar","endLine":152,"endColumn":139},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":177,"column":151,"nodeType":null,"messageId":"unusedVar","endLine":177,"endColumn":152},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":187,"column":136,"nodeType":null,"messageId":"unusedVar","endLine":187,"endColumn":137},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":211,"column":17,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":211,"endColumn":55},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":211,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10016,10019],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10016,10019],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":212,"column":11,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":212,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .default on an `any` value.","line":212,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":212,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":214,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":214,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":214,"column":28,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":214,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":215,"column":9,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":215,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .text on an `any` value.","line":215,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":215,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":32,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { onFileWrite } from './vfs/events.js';\nimport * as path from 'path';\nimport fs from 'fs/promises';\nimport { IVfsProvider } from './vfs/IVfsProvider.js';\nimport { vectorStore, chunkText, createEmbedding } from './vector.service.js';\nimport { prisma } from '../db.js';\nimport crypto from 'crypto';\nimport ignore from 'ignore';\nimport { getWebSocketService } from './websocket.singleton.js';\n\nclass IngestionAgent {\n  private pdfParse: any;\n  private ignoreFilter: any;\n  private readonly repoRoot = '/home/guy/mono';\n  private readonly textExtensions = ['.ts', '.js', '.tsx', '.jsx', '.md', '.json', '.css', '.html', '.txt', '.yaml', '.yml', '.sql'];\n  private readonly binaryExtensions = ['.pdf', '.docx', '.png'];\n\n  constructor() {\n    this.subscribeToVfsEvents();\n    // Initialize ignoreFilter synchronously with a placeholder\n    // Will be properly initialized when needed\n    this.ignoreFilter = ignore();\n    this.initializeIgnoreFilter()\n      .then(() => {\n        // Start a full repository ingest on initialization so the project root stays indexed across restarts\n        // this.ingestRepository(this.repoRoot).catch(err => {\n        //   console.error('[IngestionAgent] Failed to ingest repository on startup:', err);\n        // });\n      })\n      .catch(err => {\n        console.warn('Failed to initialize ignore filter:', err);\n        this.ignoreFilter = ignore(); // fallback to empty ignore\n        // Still attempt to ingest even if ignore couldn't be read\n        // this.ingestRepository(this.repoRoot).catch(e => console.error('[IngestionAgent] Failed to ingest repository on startup (fallback):', e));\n      });\n  }\n\n  private async initializeIgnoreFilter(): Promise<void> {\n    try {\n      const gitignoreContent = await this.readGitIgnore();\n      this.ignoreFilter = ignore().add(gitignoreContent);\n    } catch (error) {\n      console.warn('Failed to read .gitignore. Indexing all files.', error);\n      this.ignoreFilter = ignore(); // Allow all files if .gitignore can't be read\n    }\n  }\n\n  private async readGitIgnore(): Promise<string> {\n    const rootPath = '/home/guy/mono'; // Hardcoded root path for now.  Ideally, this would be passed in.\n    const gitignorePath = path.join(rootPath, '.gitignore');\n    return await fs.readFile(gitignorePath, 'utf-8');\n  }\n\n  private subscribeToVfsEvents() {\n    onFileWrite((data) => {\n      this.handleFileWrite(data.provider, data.filePath, data.content);\n    });\n  }\n\n  private async handleFileWrite(provider: IVfsProvider, filePath: string, content: Buffer) {\n    const fileExtension = path.extname(filePath).toLowerCase();\n\n    if (this.textExtensions.includes(fileExtension)) {\n       // Check if the file should be ignored\n       const relPath = path.relative(this.repoRoot, filePath);\n       if (this.ignoreFilter && typeof this.ignoreFilter.ignores === 'function' && !this.ignoreFilter.ignores(relPath)) {\n          const text = content.toString('utf-8');\n          await this.indexFile(filePath, text);\n       } else if (!this.ignoreFilter || typeof this.ignoreFilter.ignores !== 'function') {\n          // If ignoreFilter not ready, index anyway\n          const text = content.toString('utf-8');\n          await this.indexFile(filePath, text);\n       }\n    } else if (this.binaryExtensions.includes(fileExtension)) {\n      try {\n        const markdownContent = await this.parseFile(fileExtension, content);\n        const shadowFilePath = await this.generateShadowFile(provider, filePath, markdownContent);\n\n        // Check if the file should be ignored\n          const relShadowPath = path.relative(this.repoRoot, shadowFilePath);\n          if (this.ignoreFilter && typeof this.ignoreFilter.ignores === 'function' && !this.ignoreFilter.ignores(relShadowPath)) {\n          await this.indexFile(shadowFilePath, markdownContent);\n        } else if (!this.ignoreFilter || typeof this.ignoreFilter.ignores !== 'function') {\n          // If ignoreFilter not ready, index anyway\n          await this.indexFile(shadowFilePath, markdownContent);\n        }\n\n      } catch (error) {\n        console.error(`Error processing file ${filePath}:`, error);\n      }\n    }\n  }\n\n  public async ingestRepository(dir: string) {\n      console.log(`[IngestionAgent] üöÄ Scanning directory: ${dir}`);\n      try { if (dir === this.repoRoot) getWebSocketService()?.broadcast({ type: 'ingest.start', path: dir }); } catch (e) {}\n      let totalFiles = 0;\n      let processedFiles = 0;\n      try {\n        const entries = await fs.readdir(dir, { withFileTypes: true });\n        for (const entry of entries) {\n            const fullPath = path.join(dir, entry.name);\n            if (entry.isDirectory()) {\n                if (entry.name === '.git' || entry.name === 'node_modules' || entry.name === '.domoreai' || entry.name === 'dist' || entry.name === '.turbo') {\n                  console.log(`[IngestionAgent] ‚è≠Ô∏è  Skipping: ${fullPath}`);\n                  continue;\n                }\n                await this.ingestRepository(fullPath);\n            } else {\n                // Check ignore with proper type check\n                const rel = path.relative(this.repoRoot, fullPath);\n                if (this.ignoreFilter && typeof this.ignoreFilter.ignores === 'function' && this.ignoreFilter.ignores(rel)) {\n              const displayName = path.basename(fullPath);\n              console.log(`[IngestionAgent] üö´ Ignored: ${displayName}`);\n                  continue;\n                }\n                \n                const ext = path.extname(fullPath).toLowerCase();\n                if (this.textExtensions.includes(ext)) {\n                     totalFiles++;\n              const displayName = path.basename(fullPath);\n              console.log(`[IngestionAgent] üìÑ Processing file ${totalFiles}: ${displayName}`);\n              try { getWebSocketService()?.broadcast({ type: 'ingest.file.start', file: displayName, filePath: fullPath }); } catch (e) {}\n                     const content = await fs.readFile(fullPath);\n                     const text = content.toString('utf-8');\n                     await this.indexFile(fullPath, text);\n                     processedFiles++;\n              console.log(`[IngestionAgent] ‚úÖ Indexed file ${processedFiles}/${totalFiles}: ${displayName}`);\n              try { getWebSocketService()?.broadcast({ type: 'ingest.file.complete', file: displayName, filePath: fullPath, processedFiles, totalFiles }); } catch (e) {}\n                }\n            }\n        }\n        console.log(`[IngestionAgent] üèÅ Completed: ${processedFiles}/${totalFiles} files indexed from ${dir}`);\n        try { if (dir === this.repoRoot) getWebSocketService()?.broadcast({ type: 'ingest.complete', path: dir, processedFiles, totalFiles }); } catch (e) {}\n      } catch (err) {\n          console.error(`[IngestionAgent] ‚ùå Error scanning directory ${dir}:`, err);\n      }\n  }\n\n  private async indexFile(filePath: string, content: string) {\n    // Compute content hash to detect unchanged files\n    const hash = crypto.createHash('sha256').update(content, 'utf8').digest('hex');\n\n    try {\n      const existing: any = await prisma.$queryRawUnsafe(\n        `SELECT \"contentHash\" FROM \"FileIndex\" WHERE \"filePath\" = $1 LIMIT 1`,\n        filePath\n      );\n\n      if (existing && existing.length > 0 && existing[0].contentHash === hash) {\n        console.log(`[IngestionAgent] ‚ö†Ô∏è Skipping ${filePath} ‚Äî content unchanged (hash ${hash})`);\n        try { getWebSocketService()?.broadcast({ type: 'ingest.file.skipped', file: path.basename(filePath), filePath, hash }); } catch (e) {}\n        return;\n      }\n    } catch (err) {\n      console.warn(`[IngestionAgent] Could not check FileIndex for ${filePath}:`, err);\n      // fall through to re-embed\n    }\n\n    const chunks = chunkText(content);\n    console.log(`[IngestionAgent] üì¶ Created ${chunks.length} chunks from ${filePath}`);\n    const vectors = await Promise.all(chunks.map(async (chunk, i) => {\n      const embedding = await createEmbedding(chunk);\n      return {\n        id: `${filePath}#${i}`,\n        vector: embedding,\n        metadata: {\n          filePath,\n          chunk,\n          contentHash: hash,\n        },\n      };\n    }));\n\n    await vectorStore.add(vectors);\n    console.log(`[IngestionAgent] üíæ Stored ${vectors.length} vectors for ${filePath}`);\n    try { getWebSocketService()?.broadcast({ type: 'ingest.file.stored', file: path.basename(filePath), filePath, chunks: vectors.length }); } catch (e) {}\n    // Upsert file hash into FileIndex so future ingests can skip unchanged files\n    try {\n      await prisma.$executeRawUnsafe(\n        `INSERT INTO \"FileIndex\" (\"filePath\", \"contentHash\", \"updatedAt\") VALUES ($1, $2, CURRENT_TIMESTAMP)\n         ON CONFLICT (\"filePath\") DO UPDATE SET \"contentHash\" = EXCLUDED.\"contentHash\", \"updatedAt\" = CURRENT_TIMESTAMP`,\n        filePath,\n        hash\n      );\n      console.log(`[IngestionAgent] üîñ Updated FileIndex for ${filePath} (hash ${hash})`);\n      try { getWebSocketService()?.broadcast({ type: 'ingest.file.indexed', file: path.basename(filePath), filePath, hash }); } catch (e) {}\n    } catch (err) {\n      console.warn(`[IngestionAgent] Failed to update FileIndex for ${filePath}:`, err);\n    }\n  }\n\n  private async generateShadowFile(provider: IVfsProvider, originalPath: string, markdownContent: string): Promise<string> {\n    const originalPathInfo = path.parse(originalPath);\n    const shadowFileName = `${originalPathInfo.name}.md`;\n    const shadowFilePath = path.join(originalPathInfo.dir, '.domoreai', 'shadow', shadowFileName);\n\n    await provider.write(shadowFilePath, markdownContent);\n    console.log(`Shadow file created: ${shadowFilePath}`);\n    return shadowFilePath;\n  }\n\n  private async parseFile(fileExtension: string, content: Buffer): Promise<string> {\n    if (this.textExtensions.includes(fileExtension)) {\n      return content.toString('utf-8');\n    }\n\n    switch (fileExtension) {\n      case '.pdf':\n        if (!this.pdfParse) {\n          const mod = await import('pdf-parse') as any;\n          this.pdfParse = mod.default || mod;\n        }\n        const data = await this.pdfParse(content);\n        return data.text;\n      case '.docx':\n        // TODO: Implement DOCX parsing, potentially using a library like 'mammoth'\n        console.log('DOCX parsing not yet implemented.');\n        return 'DOCX content placeholder';\n      case '.png':\n        // TODO: Implement PNG parsing using a multimodal LLM\n        console.log('PNG parsing not yet implemented.');\n        return 'PNG content placeholder';\n      default:\n        throw new Error(`Unsupported file type for parsing: ${fileExtension}`);\n    }\n  }\n}\n\nexport const ingestionAgent = new IngestionAgent();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/IngestionService.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":61,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":61,"endColumn":41},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":83,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":83,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3043,3046],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3043,3046],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":116,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4153,4156],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4153,4156],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from 'fs';\nimport path from 'path';\n\n// Node.js 20+ feature check - safe fallback if needed, though package.json says ^20.12.12\nconst { openAsBlob, existsSync, mkdirSync, writeFileSync, readFileSync } = fs;\n\nconst MAX_RETRIES = 3;\nconst BASE_DELAY_MS = 1000;\n\nexport class IngestionService {\n  private static SHADOW_DIR = path.join(process.cwd(), '.domoreai/shadow');\n  private static UNSTRUCTURED_API_URL = process.env.UNSTRUCTURED_API_URL || 'https://api.unstructured.io/general/v0/general';\n  private static UNSTRUCTURED_API_KEY = process.env.UNSTRUCTURED_API_KEY;\n\n  constructor() {\n    this.ensureShadowDir();\n  }\n\n  private ensureShadowDir() {\n    if (!existsSync(IngestionService.SHADOW_DIR)) {\n      mkdirSync(IngestionService.SHADOW_DIR, { recursive: true });\n    }\n  }\n\n  /**\n   * Ingests a file: sends it to Unstructured API and saves the result as a shadow file.\n   * Uses streaming (via openAsBlob) to prevent memory crashes on large files.\n   * @param filePath Absolute path to the file to ingest.\n   * @returns The path to the created shadow file.\n   */\n  async ingestFile(filePath: string): Promise<string> {\n    if (!existsSync(filePath)) {\n      throw new Error(`File not found: ${filePath}`);\n    }\n\n    try {\n      console.log(`[IngestionService] Ingesting file: ${filePath}`);\n\n      // 1. Prepare form data using efficient Node.js Blob (Node 20+)\n      // This prevents loading the entire file into V8 heap memory.\n      // If fs.openAsBlob is missing (older Node), fallback would be needed,\n      // but package.json requires Node 20+.\n      const blob = await openAsBlob(filePath);\n      const fileName = path.basename(filePath);\n      const formData = new FormData();\n      formData.append('files', blob, fileName);\n\n      const headers: Record<string, string> = {};\n      if (IngestionService.UNSTRUCTURED_API_KEY) {\n        headers['unstructured-api-key'] = IngestionService.UNSTRUCTURED_API_KEY;\n      }\n\n      console.log(`[IngestionService] Sending to ${IngestionService.UNSTRUCTURED_API_URL}...`);\n      \n      const response = await this.fetchWithRetry(IngestionService.UNSTRUCTURED_API_URL, {\n        method: 'POST',\n        headers: headers,\n        body: formData,\n      });\n\n      const data = await response.json();\n      console.log(`[IngestionService] Received ${Array.isArray(data) ? data.length : 0} elements.`);\n\n      // 2. Save as Shadow File\n      const shadowFileName = `${fileName}.json`;\n      const shadowFilePath = path.join(IngestionService.SHADOW_DIR, shadowFileName);\n      \n      writeFileSync(shadowFilePath, JSON.stringify(data, null, 2));\n      console.log(`[IngestionService] Shadow file saved: ${shadowFilePath}`);\n\n      return shadowFilePath;\n\n    } catch (error) {\n      console.error('[IngestionService] Error ingesting file:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Helper to perform fetch with exponential backoff retries.\n   */\n  private async fetchWithRetry(url: string, options: RequestInit, retries = MAX_RETRIES): Promise<Response> {\n    let lastError: any;\n\n    for (let attempt = 0; attempt <= retries; attempt++) {\n      try {\n        const response = await fetch(url, options);\n\n        if (!response.ok) {\n          // Don't retry client errors (4xx), except maybe 429\n          if (response.status >= 400 && response.status < 500 && response.status !== 429) {\n            const errorText = await response.text();\n            throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorText}`);\n          }\n          throw new Error(`API Server Error: ${response.status} ${response.statusText}`);\n        }\n\n        return response;\n      } catch (error) {\n        lastError = error;\n        console.warn(`[IngestionService] Attempt ${attempt + 1}/${retries + 1} failed: ${error instanceof Error ? error.message : String(error)}`);\n\n        if (attempt < retries) {\n          const delay = BASE_DELAY_MS * Math.pow(2, attempt);\n          await new Promise(resolve => setTimeout(resolve, delay));\n        }\n      }\n    }\n\n    throw lastError;\n  }\n\n  /**\n   * Retrieves the content of a shadow file.\n   */\n  getShadowFile(fileName: string): any {\n    const shadowFilePath = path.join(IngestionService.SHADOW_DIR, fileName);\n    if (!existsSync(shadowFilePath)) {\n      return null;\n    }\n    return JSON.parse(readFileSync(shadowFilePath, 'utf-8'));\n  }\n}\n\nexport const ingestionService = new IngestionService();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/JobScheduler.ts","messages":[{"ruleId":"@typescript-eslint/no-misused-promises","severity":1,"message":"Promise returned in function argument where a void return was expected.","line":14,"column":33,"nodeType":"ArrowFunctionExpression","messageId":"voidReturnArgument","endLine":14,"endColumn":51},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1254,1257],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1254,1257],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .code on an `any` value.","line":46,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":46,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":46,"column":38,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":46,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":46,"column":45,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":46,"endColumn":52},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1627,1630],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1627,1630],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | SQLWrapper`.","line":58,"column":26,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":58,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":58,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":58,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":62,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":62,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .roleId on an `any` value.","line":62,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":62,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":67,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":67,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":67,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":67,"endColumn":34},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'result' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":70,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":70,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":70,"column":43,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":70,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":70,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":70,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | SQLWrapper`.","line":75,"column":28,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":75,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":75,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":75,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":77,"column":58,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":77,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":80,"column":57,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":80,"endColumn":61},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | SQLWrapper`.","line":84,"column":28,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":84,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":84,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":84,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":21,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../db.js';\nimport { jobs } from '../db/schema.js';\nimport { eq } from 'drizzle-orm';\nimport { createVolcanoAgent } from './AgentFactory.js';\n\nexport class JobScheduler {\n  private isRunning = false;\n  private interval: NodeJS.Timeout | null = null;\n\n  start(intervalMs: number = 5000) {\n    if (this.isRunning) return;\n    console.log('[CEO] Starting Corporate Heartbeat...');\n    this.isRunning = true;\n    this.interval = setInterval(() => this.cycle(), intervalMs);\n  }\n\n  stop() {\n    if (this.interval) clearInterval(this.interval);\n    this.isRunning = false;\n  }\n\n  private async cycle() {\n    try {\n      const pendingJobs = await db.query.jobs.findMany({\n        where: eq(jobs.status, 'not_started'),\n        limit: 5\n      });\n\n      for (const job of pendingJobs) {\n        // Check if job has a dependency\n        if (job.dependsOnJobId) {\n          const dependency = await db.query.jobs.findFirst({\n            where: eq(jobs.id, job.dependsOnJobId)\n          });\n          if (dependency && dependency.status !== 'completed') {\n            continue;\n          }\n        }\n\n        console.log(`[JobScheduler] üü¢ Starting Job: ${job.name} (${job.id})`);\n        await this.executeJob(job);\n      }\n\n    } catch (error: any) {\n      // Silently handle \"relation does not exist\" errors (table not yet created)\n      if (error?.code === '42P01' || error?.message?.includes('does not exist')) {\n        // Table doesn't exist yet - scheduler will retry on next cycle\n        return;\n      }\n      console.error('[JobScheduler] üî¥ Cycle Error:', error);\n    }\n  }\n\n  private async executeJob(job: any) {\n    await db.update(jobs).set({\n        status: 'in_progress',\n        startedAt: new Date()\n    }).where(eq(jobs.id, job.id));\n\n    try {\n      const agent = await createVolcanoAgent({\n        roleId: job.roleId || 'general_worker',\n        modelId: null,\n        isLocked: false,\n        temperature: 0.7,\n        maxTokens: 4096,\n        userGoal: job.description\n      });\n\n      const result = await agent.generate(job.description);\n\n      await db.update(jobs).set({\n        status: 'completed',\n        completedAt: new Date()\n      }).where(eq(jobs.id, job.id));\n\n      console.log(`[JobScheduler] ‚úÖ Job Completed: ${job.name}`);\n\n    } catch (error) {\n      console.error(`[JobScheduler] ‚ùå Job Failed: ${job.name}`, error);\n      await db.update(jobs).set({\n        status: 'failed',\n        completedAt: new Date()\n      }).where(eq(jobs.id, job.id));\n    }\n  }\n}\n\nexport const scheduler = new JobScheduler();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/LibrarianService.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'chunkText' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":32},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":90,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2927,2930],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2927,2930],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":101,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3336,3339],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3336,3339],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":101,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":101,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":102,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3397,3400],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3397,3400],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":103,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":103,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":103,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":103,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":104,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":104,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":104,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":104,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":105,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":105,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":105,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":105,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":106,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":106,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":106,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":106,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":107,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":107,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":107,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":107,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":108,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":108,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":108,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":108,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":109,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":109,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":109,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":109,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":110,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":110,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":110,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":110,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":111,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":111,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .similarity on an `any` value.","line":111,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":111,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":112,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":112,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":112,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":112,"endColumn":30},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4205,4208],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4205,4208],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":127,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":127,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4225,4228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4225,4228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":128,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4251,4254],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4251,4254],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":136,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":136,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestrationName on an `any` value.","line":136,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":136,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":137,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":137,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .qualityScore on an `any` value.","line":137,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":137,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":138,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":138,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .similarity on an `any` value.","line":138,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":138,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":139,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":139,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .summary on an `any` value.","line":139,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":139,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":141,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":145,"endColumn":12},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":141,"column":29,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":141,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stepLogs on an `any` value.","line":141,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":141,"endColumn":39},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":141,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":141,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4688,4691],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4688,4691],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":142,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":142,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stepName on an `any` value.","line":142,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":142,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":143,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":143,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .status on an `any` value.","line":143,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":143,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":144,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":144,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .duration on an `any` value.","line":144,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":144,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":147,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":147,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .output on an `any` value.","line":147,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":147,"endColumn":32},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":160,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":160,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5178,5181],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5178,5181],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestration on an `any` value.","line":164,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":164,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestration on an `any` value.","line":165,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":165,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestration on an `any` value.","line":166,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":166,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .input on an `any` value.","line":170,"column":51,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":170,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":173,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":173,"endColumn":95},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":173,"column":23,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":173,"endColumn":79},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":173,"column":23,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":173,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stepLogs on an `any` value.","line":173,"column":33,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":173,"endColumn":41},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":173,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":173,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5636,5639],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5636,5639],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":173,"column":61,"nodeType":"MemberExpression","messageId":"unsafeReturn","endLine":173,"endColumn":73},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stepName on an `any` value.","line":173,"column":65,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":173,"endColumn":73},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .join on an `any` value.","line":173,"column":75,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":173,"endColumn":79},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .output on an `any` value.","line":177,"column":52,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":177,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestration on an `any` value.","line":180,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":180,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":181,"column":27,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":181,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestration on an `any` value.","line":181,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":181,"endColumn":50},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":190,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":190,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6100,6103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6100,6103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":193,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":193,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestrationName on an `any` value.","line":196,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":196,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .qualityScore on an `any` value.","line":197,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":197,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .similarity on an `any` value.","line":198,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":198,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":199,"column":14,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":199,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .summary on an `any` value.","line":199,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":199,"endColumn":31},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Static async method 'cleanup' has no 'await' expression.","line":209,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":209,"endColumn":23,"suggestions":[{"messageId":"removeAsync","fix":{"range":[6764,6839],"text":"cleanup(maxAge: number = 90, minQuality: number = 0.7): void"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Static async method 'getStats' has no 'await' expression.","line":219,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":219,"endColumn":24,"suggestions":[{"messageId":"removeAsync","fix":{"range":[7211,7360],"text":"getStats(): {\n    totalRecords: number;\n    averageQuality: number;\n    topOrchestrations: Array<{ name: string; count: number }>;\n  }"},"desc":"Remove 'async'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":74,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { prisma } from '../db.js';\nimport { vectorStore, chunkText, createEmbedding } from './vector.service.js';\nimport crypto from 'crypto';\n\n/**\n * LibrarianService - The Memory Keeper\n * \n * Purpose: Prevent \"Context Rot\" by saving only proven, high-quality execution results\n * as \"Golden Records\" that can be recalled for future tasks.\n * \n * Difference from IngestionAgent:\n * - IngestionAgent: Indexes raw documentation and source code\n * - LibrarianService: Stores proven execution logs and successful patterns\n */\nexport class LibrarianService {\n  \n  /**\n   * Store a successful execution as a \"Golden Record\"\n   * @param executionId - The orchestration execution that succeeded\n   * @param qualityScore - Quality score from the Judge (0-1)\n   * @param tags - Searchable tags for this record\n   */\n  static async storeGoldenRecord(\n    executionId: string,\n    qualityScore: number,\n    tags: string[] = []\n  ): Promise<void> {\n    const execution = await prisma.orchestrationExecution.findUnique({\n      where: { id: executionId },\n      include: {\n        orchestration: {\n          include: {\n            steps: true\n          }\n        }\n      }\n    });\n\n    if (!execution || execution.status !== 'completed') {\n      console.warn(`[Librarian] Cannot store incomplete execution: ${executionId}`);\n      return;\n    }\n\n    // Only store high-quality executions (threshold: 0.7)\n    if (qualityScore < 0.7) {\n      console.log(`[Librarian] Skipping low-quality execution (score: ${qualityScore})`);\n      return;\n    }\n\n    // Create a searchable summary of the execution\n    const summary = this.createExecutionSummary(execution);\n    \n    // Generate embedding for semantic search\n    const embedding = await createEmbedding(summary);\n\n    // Create a unique ID for this golden record\n    const recordId = `golden_${executionId}_${Date.now()}`;\n    const contentHash = crypto.createHash('sha256').update(summary).digest('hex');\n\n    // Store in vector database\n    await vectorStore.add([{\n      id: recordId,\n      vector: embedding,\n      metadata: {\n        type: 'golden_record',\n        executionId,\n        orchestrationId: execution.orchestrationId,\n        orchestrationName: execution.orchestration.name,\n        qualityScore,\n        tags,\n        summary,\n        input: execution.input,\n        output: execution.output,\n        stepLogs: execution.stepLogs,\n        context: execution.context,\n        contentHash,\n        createdAt: new Date().toISOString()\n      }\n    }]);\n\n    console.log(`[Librarian] ‚úÖ Stored Golden Record: ${recordId} (score: ${qualityScore})`);\n  }\n\n  /**\n   * Recall relevant past executions for a new task\n   * @param query - Natural language description of the current task\n   * @param limit - Maximum number of records to return\n   * @returns Array of relevant golden records with similarity scores\n   */\n  static async recall(query: string, limit: number = 5): Promise<any[]> {\n    console.log(`[Librarian] üîç Recalling memories for: \"${query.substring(0, 100)}...\"`);\n\n    // Generate embedding for the query\n    const queryEmbedding = await createEmbedding(query);\n\n    // Search vector store for similar executions\n    const results = await vectorStore.search(queryEmbedding, limit);\n\n    // Filter for golden records only\n    const goldenRecords = results\n      .filter((r: any) => r.metadata?.type === 'golden_record')\n      .map((r: any) => ({\n        executionId: r.metadata.executionId,\n        orchestrationName: r.metadata.orchestrationName,\n        qualityScore: r.metadata.qualityScore,\n        summary: r.metadata.summary,\n        input: r.metadata.input,\n        output: r.metadata.output,\n        stepLogs: r.metadata.stepLogs,\n        tags: r.metadata.tags,\n        similarity: r.similarity || 0,\n        createdAt: r.metadata.createdAt\n      }));\n\n    console.log(`[Librarian] üìö Found ${goldenRecords.length} relevant memories`);\n    \n    return goldenRecords;\n  }\n\n  /**\n   * Inject recalled context into an orchestration's initial context\n   * @param orchestrationContext - The current orchestration context\n   * @param memories - Recalled golden records\n   */\n  static injectMemories(\n    orchestrationContext: Record<string, any>,\n    memories: any[]\n  ): Record<string, any> {\n    if (memories.length === 0) {\n      return orchestrationContext;\n    }\n\n    // Add memories to context under a special key\n    orchestrationContext.librarian = {\n      memories: memories.map(m => ({\n        orchestration: m.orchestrationName,\n        quality: m.qualityScore,\n        similarity: m.similarity,\n        summary: m.summary,\n        // Include successful patterns\n        successfulApproach: m.stepLogs?.map((log: any) => ({\n          step: log.stepName,\n          status: log.status,\n          duration: log.duration\n        })),\n        // Include example output\n        exampleOutput: m.output\n      })),\n      guidance: this.generateGuidance(memories)\n    };\n\n    console.log(`[Librarian] üí° Injected ${memories.length} memories into context`);\n    \n    return orchestrationContext;\n  }\n\n  /**\n   * Create a searchable summary of an execution\n   */\n  private static createExecutionSummary(execution: any): string {\n    const parts: string[] = [];\n\n    // Orchestration name and description\n    parts.push(`Orchestration: ${execution.orchestration.name}`);\n    if (execution.orchestration.description) {\n      parts.push(`Description: ${execution.orchestration.description}`);\n    }\n\n    // Input summary\n    parts.push(`Input: ${JSON.stringify(execution.input).substring(0, 500)}`);\n\n    // Steps executed\n    const stepNames = execution.stepLogs?.map((log: any) => log.stepName).join(' ‚Üí ') || 'N/A';\n    parts.push(`Workflow: ${stepNames}`);\n\n    // Output summary\n    parts.push(`Output: ${JSON.stringify(execution.output).substring(0, 500)}`);\n\n    // Tags\n    if (execution.orchestration.tags?.length > 0) {\n      parts.push(`Tags: ${execution.orchestration.tags.join(', ')}`);\n    }\n\n    return parts.join('\\n');\n  }\n\n  /**\n   * Generate guidance text from memories\n   */\n  private static generateGuidance(memories: any[]): string {\n    if (memories.length === 0) return '';\n\n    const topMemory = memories[0]; // Highest similarity\n    \n    return `Based on ${memories.length} similar past execution(s), the most relevant approach was:\n- Orchestration: ${topMemory.orchestrationName}\n- Quality Score: ${(topMemory.qualityScore * 100).toFixed(0)}%\n- Similarity: ${(topMemory.similarity * 100).toFixed(0)}%\n- Summary: ${topMemory.summary.substring(0, 200)}...\n\nConsider following a similar pattern for best results.`;\n  }\n\n  /**\n   * Clean up old or low-quality records\n   * @param maxAge - Maximum age in days\n   * @param minQuality - Minimum quality score to keep\n   */\n  static async cleanup(maxAge: number = 90, minQuality: number = 0.7): Promise<void> {\n    // This would require implementing a cleanup mechanism in vector.service.ts\n    // For now, we log the intent\n    console.log(`[Librarian] üßπ Cleanup requested: maxAge=${maxAge} days, minQuality=${minQuality}`);\n    console.log(`[Librarian] ‚ö†Ô∏è Cleanup not yet implemented in vector store`);\n  }\n\n  /**\n   * Get statistics about stored golden records\n   */\n  static async getStats(): Promise<{\n    totalRecords: number;\n    averageQuality: number;\n    topOrchestrations: Array<{ name: string; count: number }>;\n  }> {\n    // This would require querying the vector store for metadata\n    // For now, return placeholder stats\n    return {\n      totalRecords: 0,\n      averageQuality: 0,\n      topOrchestrations: []\n    };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/McpOrchestrator.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3135,3138],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3135,3138],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .error on an `any` value.","line":79,"column":90,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":79,"endColumn":95},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":85,"column":125,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":85,"endColumn":129},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":86,"column":13,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":86,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .text on an `any` value.","line":86,"column":38,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":86,"endColumn":42},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":91,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3671,3674],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3671,3674],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":93,"column":67,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":93,"endColumn":74},{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":137,"column":7,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":141,"endColumn":10,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[5034,5034],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[5034,5034],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Client } from '@modelcontextprotocol/sdk/client/index.js';\nimport { StdioClientTransport } from '@modelcontextprotocol/sdk/client/stdio.js';\nimport { RegistryClient } from './mcp-registry-client.js';\nimport { SandboxTool } from '../types.js';\nimport { searchCodebaseTool } from '../tools/search.js';\nimport { IMcpOrchestrator } from '../interfaces/IMcpOrchestrator.js';\nimport { IRegistryClient } from '../interfaces/IRegistryClient.js';\n\ninterface ActiveServer {\n  client: Client;\n  transport: StdioClientTransport;\n  lastUsed: number;\n}\n\nexport class McpOrchestrator implements IMcpOrchestrator {\n  private activeServers = new Map<string, ActiveServer>();\n  private CLEANUP_INTERVAL_MS = 60_000;\n  private SHUTDOWN_TIMEOUT = 1000 * 60 * 5; // 5 minutes\n  private registryClient: IRegistryClient;\n\n  constructor(registryClient?: IRegistryClient) {\n    this.registryClient = registryClient || new RegistryClient();\n\n    // Start cleanup interval\n    setInterval(() => { void this.cleanupIdleServers(); }, this.CLEANUP_INTERVAL_MS);\n  }\n\n  /**\n   * Prepares the environment by ensuring specific MCP servers are running.\n   * @param serverNames List of server names (e.g., 'git', 'postgres') to start.\n   */\n  async prepareEnvironment(serverNames: string[]) {\n    await Promise.all(serverNames.map(name => this.ensureServerRunning(name)));\n  }\n\n  /**\n   * Returns a list of tools formatted for the AgentRuntime/CodeMode sandbox.\n   * Each tool includes a 'handler' that proxies the call to the actual MCP server.\n   */\n  async getToolsForSandbox(): Promise<SandboxTool[]> {\n    const promises = Array.from(this.activeServers.entries()).map(async ([serverName, server]) => {\n      try {\n        const { tools } = await server.client.listTools();\n        return tools.map((tool) => this.formatToolForSandbox(serverName, server, tool));\n      } catch (error) {\n        console.warn(`[Orchestrator] Failed to fetch tools from ${serverName}:`, error);\n        return [];\n      }\n    });\n\n    const results = await Promise.all(promises);\n    const mcpTools = results.flat();\n\n    // Inject Internal Tools\n    return [\n      ...mcpTools, \n      searchCodebaseTool\n    ];\n  }\n\n\n  private formatToolForSandbox(serverName: string, server: ActiveServer, tool: { name: string; description?: string; inputSchema: Record<string, unknown> }): SandboxTool {\n    const safeName = `${serverName}_${tool.name}`.replace(/-/g, '_');\n\n    return {\n      name: safeName,\n      description: `\\n      [MCP Server: ${serverName}] ${tool.description}\\n      @example\\n      // Call the tool from code-mode:\\n      await ${safeName}({ /* tool arguments here */ });\\n      `,\n      inputSchema: tool.inputSchema,\n      handler: async (args: Record<string, unknown>) => {\n        server.lastUsed = Date.now();\n\n        try {\n          const result = await server.client.callTool({\n            name: tool.name,\n            arguments: args,\n          });\n\n          // If the MCP protocol returned an application-level error, THROW so generated code's try/catch can handle it\n          if (result && typeof result === 'object' && (result.isError || (result as any).error)) {\n            console.warn(`[MCP] Tool Logic Error from ${serverName}:${tool.name}:`, result);\n            throw new Error(`MCP Tool Error: ${JSON.stringify(result.content ?? result)}`);\n          }\n\n          // Unwrap single text content for convenience\n          if (result && result.content && Array.isArray(result.content) && result.content.length === 1 && result.content[0].type === 'text') {\n            return result.content[0].text;\n          }\n\n          return result.content ?? result;\n\n        } catch (error: any) {\n          console.error(`[MCP] Protocol Error calling ${serverName}:${tool.name}:`, error);\n          throw new Error(`Failed to execute ${safeName}: ${error.message || String(error)}`);\n        }\n      }\n    };\n  }\n\n  private async ensureServerRunning(serverName: string) {\n    if (this.activeServers.has(serverName)) {\n      this.activeServers.get(serverName)!.lastUsed = Date.now();\n      return;\n    }\n\n    console.log(`[Orchestrator] Starting MCP Server: ${serverName}...`);\n\n    try {\n      // 1. Get Config\n      const config = await this.registryClient.getServerConfig(serverName);\n\n      // 2. Initialize Transport (Stdio)\n      const transport = new StdioClientTransport({\n        command: config.command,\n        args: config.args,\n        env: { ...process.env, ...(config.env || {}) } as Record<string, string>,\n      });\n\n      // 3. Initialize Client\n      const client = new Client(\n        { name: \"domoreai-orchestrator\", version: \"1.0.0\" },\n        { capabilities: {} }\n      );\n\n      // 4. Connect\n      await client.connect(transport);\n      \n      this.activeServers.set(serverName, { \n        client, \n        transport, \n        lastUsed: Date.now() \n      });\n      \n      console.log(`[Orchestrator] Connected to ${serverName}`);\n\n      // Document the server\n      // We run this in background so it doesn't block startup\n      import('./ToolDocumenter.js').then(({ ToolDocumenter }) => {\n        void ToolDocumenter.documentServer(serverName, client).catch(err => {\n          console.error(`[Orchestrator] Failed to document ${serverName}:`, err);\n        });\n      });\n    } catch (error) {\n      console.error(`[Orchestrator] Failed to start server ${serverName}:`, error);\n      throw error;\n    }\n  }\n\n  private async cleanupIdleServers() {\n    const now = Date.now();\n    for (const [name, server] of this.activeServers.entries()) {\n      if (now - server.lastUsed > this.SHUTDOWN_TIMEOUT) {\n        console.log(`[Orchestrator] Shutting down idle server: ${name}`);\n        try {\n          await server.client.close();\n        } catch (e) {\n          console.error(`[Orchestrator] Error closing client ${name}:`, e);\n        } finally {\n          this.activeServers.delete(name);\n        }\n      }\n    }\n  }\n}\n\nexport const mcpOrchestrator = new McpOrchestrator();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/MetaRouter.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":125,"column":11,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":125,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":127,"column":11,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":127,"endColumn":42},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'parseError' is defined but never used.","line":129,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":129,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestrationName on an `any` value.","line":145,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":145,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .fallbackToSingleAgent on an `any` value.","line":145,"column":51,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":145,"endColumn":72},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":147,"column":41,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":147,"endColumn":79},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestrationName on an `any` value.","line":147,"column":50,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":147,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestrationName on an `any` value.","line":152,"column":64,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":152,"endColumn":81},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .fallbackToSingleAgent on an `any` value.","line":153,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":153,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":158,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":158,"endColumn":66},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestrationName on an `any` value.","line":158,"column":41,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":158,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":160,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":160,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .confidence on an `any` value.","line":160,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":160,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":161,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":161,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .reasoning on an `any` value.","line":161,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":161,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .fallbackToSingleAgent on an `any` value.","line":162,"column":41,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":162,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":163,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":163,"endColumn":70},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .recommendedRole on an `any` value.","line":163,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":163,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":164,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":164,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .estimatedDuration on an `any` value.","line":164,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":164,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":165,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":165,"endColumn":72},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .requiredCapabilities on an `any` value.","line":165,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":165,"endColumn":60},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":172,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":172,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6554,6557],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6554,6557],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":177,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":177,"endColumn":51}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":24,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { prisma } from '../db.js';\nimport { createVolcanoAgent } from './AgentFactory.js';\n\n/**\n * MetaRouter - The Traffic Controller\n * \n * Purpose: Intelligently route tasks to the right orchestration template using LLM-based analysis\n * \n * Difference from ComplexityRouter:\n * - ComplexityRouter: Simple keyword matching for complexity scoring\n * - MetaRouter: LLM-powered classification that selects specific orchestration templates\n */\n\nexport interface RoutingDecision {\n  orchestrationTemplate: string | null;  // Name of the orchestration to use\n  orchestrationId?: string;              // ID if found in database\n  confidence: number;                    // 0-1 confidence score\n  reasoning: string;                     // Why this orchestration was chosen\n  fallbackToSingleAgent: boolean;        // If true, use single agent instead\n  recommendedRole?: string;              // Role to use if single agent\n  estimatedDuration: number;             // Estimated minutes\n  requiredCapabilities: string[];        // Capabilities needed\n}\n\nexport class MetaRouter {\n  \n  /**\n   * Route a task to the appropriate orchestration template\n   * @param taskDescription - Natural language description of the task\n   * @param availableOrchestrations - Optional list of available orchestrations (fetched if not provided)\n   * @returns Routing decision with orchestration selection\n   */\n  static async routeTask(\n    taskDescription: string,\n    availableOrchestrations?: Array<{ id: string; name: string; description?: string | null; tags: string[] }>\n  ): Promise<RoutingDecision> {\n    console.log(`[MetaRouter] üö¶ Routing task: \"${taskDescription.substring(0, 100)}...\"`);\n\n    // 1. Load available orchestrations if not provided\n    const orchestrations = availableOrchestrations || await prisma.orchestration.findMany({\n      where: { isActive: true },\n      select: {\n        id: true,\n        name: true,\n        description: true,\n        tags: true\n      }\n    });\n\n    // 2. If no orchestrations available, fallback to single agent\n    if (orchestrations.length === 0) {\n      console.log('[MetaRouter] No orchestrations available, falling back to single agent');\n      return {\n        orchestrationTemplate: null,\n        confidence: 1.0,\n        reasoning: 'No orchestrations available in the system',\n        fallbackToSingleAgent: true,\n        recommendedRole: 'general_worker',\n        estimatedDuration: 30,\n        requiredCapabilities: ['text']\n      };\n    }\n\n    // 3. Find or create a MetaRouter role for classification\n    let routerRole = await prisma.role.findFirst({\n      where: { name: 'MetaRouter' }\n    });\n\n    if (!routerRole) {\n      console.log('[MetaRouter] Creating MetaRouter role...');\n      routerRole = await prisma.role.create({\n        data: {\n          name: 'MetaRouter',\n          basePrompt: `You are an expert Task Router for AI orchestration systems.\n\nYour job is to analyze a task description and select the most appropriate orchestration template from the available options.\n\nConsider:\n1. Task complexity and requirements\n2. Orchestration capabilities and steps\n3. Tags and descriptions\n4. Whether a multi-step workflow is needed or a single agent would suffice\n\nReturn your decision as a JSON object with this structure:\n{\n  \"orchestrationName\": \"Code Review Pipeline\",  // Name of the orchestration, or null\n  \"confidence\": 0.9,  // 0-1 confidence score\n  \"reasoning\": \"This task requires code analysis which matches the Code Review Pipeline\",\n  \"fallbackToSingleAgent\": false,  // true if single agent is better\n  \"recommendedRole\": \"Code Reviewer\",  // If single agent, which role\n  \"estimatedDuration\": 45,  // Estimated minutes\n  \"requiredCapabilities\": [\"coding\", \"tools\"]  // Capabilities needed\n}`,\n          tools: [],\n          metadata: {\n            defaultTemperature: 0.2,  // Low temperature for consistent routing\n            defaultMaxTokens: 1024,\n            defaultResponseFormat: 'json_object'\n          }\n        }\n      });\n    }\n\n    // 4. Create the routing prompt\n    const routingPrompt = this.createRoutingPrompt(taskDescription, orchestrations);\n\n    // 5. Create router agent\n    const routerAgent = await createVolcanoAgent({\n      roleId: routerRole.id,\n      modelId: null,  // Let orchestrator pick best model\n      isLocked: false,\n      temperature: 0.2,\n      maxTokens: 1024\n    });\n\n    // 6. Get routing decision\n    try {\n      const response = await routerAgent.generate(routingPrompt);\n      \n      // Parse JSON response\n      let decision;\n      try {\n        const jsonMatch = response.match(/\\{[\\s\\S]*\\}/);\n        if (jsonMatch) {\n          decision = JSON.parse(jsonMatch[0]);\n        } else {\n          decision = JSON.parse(response);\n        }\n      } catch (parseError) {\n        console.error('[MetaRouter] Failed to parse JSON response:', response);\n        // Fallback to single agent\n        return {\n          orchestrationTemplate: null,\n          confidence: 0.5,\n          reasoning: 'Failed to parse router response, using single agent fallback',\n          fallbackToSingleAgent: true,\n          recommendedRole: 'general_worker',\n          estimatedDuration: 30,\n          requiredCapabilities: ['text']\n        };\n      }\n\n      // 7. Find the orchestration ID if a template was selected\n      let orchestrationId: string | undefined;\n      if (decision.orchestrationName && !decision.fallbackToSingleAgent) {\n        const orchestration = orchestrations.find(\n          o => o.name.toLowerCase() === decision.orchestrationName.toLowerCase()\n        );\n        orchestrationId = orchestration?.id;\n\n        if (!orchestrationId) {\n          console.warn(`[MetaRouter] Orchestration \"${decision.orchestrationName}\" not found, falling back to single agent`);\n          decision.fallbackToSingleAgent = true;\n        }\n      }\n\n      const result: RoutingDecision = {\n        orchestrationTemplate: decision.orchestrationName || null,\n        orchestrationId,\n        confidence: decision.confidence || 0.5,\n        reasoning: decision.reasoning || 'No reasoning provided',\n        fallbackToSingleAgent: decision.fallbackToSingleAgent !== false,\n        recommendedRole: decision.recommendedRole || 'general_worker',\n        estimatedDuration: decision.estimatedDuration || 30,\n        requiredCapabilities: decision.requiredCapabilities || ['text']\n      };\n\n      console.log(`[MetaRouter] ‚úÖ Routed to: ${result.orchestrationTemplate || 'Single Agent'} (confidence: ${result.confidence})`);\n      \n      return result;\n\n    } catch (error: any) {\n      console.error('[MetaRouter] Routing failed:', error);\n      return {\n        orchestrationTemplate: null,\n        confidence: 0,\n        reasoning: `Routing error: ${error.message}`,\n        fallbackToSingleAgent: true,\n        recommendedRole: 'general_worker',\n        estimatedDuration: 30,\n        requiredCapabilities: ['text']\n      };\n    }\n  }\n\n  /**\n   * Create the routing prompt for the MetaRouter agent\n   */\n  private static createRoutingPrompt(\n    taskDescription: string,\n    orchestrations: Array<{ id: string; name: string; description?: string | null; tags: string[] }>\n  ): string {\n    const orchestrationList = orchestrations.map((o, i) => \n      `${i + 1}. ${o.name}\n   Description: ${o.description || 'No description'}\n   Tags: ${o.tags.join(', ') || 'None'}`\n    ).join('\\n\\n');\n\n    return `Analyze this task and select the best orchestration template:\n\nTASK:\n${taskDescription}\n\nAVAILABLE ORCHESTRATIONS:\n${orchestrationList}\n\nIf none of these orchestrations are a good fit, set \"fallbackToSingleAgent\" to true and recommend an appropriate role.\n\nProvide your routing decision as a JSON object.`;\n  }\n\n  /**\n   * Quick complexity check (lightweight, no LLM)\n   * Useful for determining if MetaRouter should even be called\n   */\n  static quickComplexityCheck(taskDescription: string): 'simple' | 'moderate' | 'complex' {\n    const lower = taskDescription.toLowerCase();\n    \n    const simpleKeywords = ['list', 'show', 'display', 'get', 'read', 'status'];\n    const complexKeywords = ['orchestrate', 'workflow', 'multi-step', 'pipeline', 'coordinate', 'architect'];\n    \n    const hasSimple = simpleKeywords.some(k => lower.includes(k));\n    const hasComplex = complexKeywords.some(k => lower.includes(k));\n    const isLong = taskDescription.length > 300;\n    \n    if (hasComplex || isLong) return 'complex';\n    if (hasSimple && !isLong) return 'simple';\n    return 'moderate';\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ModelConfigurator.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'prisma' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Prisma' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":23,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[180,183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[180,183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Static async method 'configure' has no 'await' expression.","line":15,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":15,"endColumn":25,"suggestions":[{"messageId":"removeAsync","fix":{"range":[385,560],"text":"configure(\n    model: Model,\n    role: Role,\n    config: { temperature?: number | null; maxTokens?: number | null }\n  ): [CompletionParams, Record<string, any>]"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":19,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":19,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[554,557],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[554,557],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":22,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":22,"endColumn":45},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":22,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[667,670],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[667,670],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .specs on an `any` value.","line":22,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":22,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .supportedParameters on an `any` value.","line":23,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":23,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":24,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":24,"endColumn":78},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .contextWindow on an `any` value.","line":24,"column":33,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":24,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .context_window on an `any` value.","line":24,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":24,"endColumn":70},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":26,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[894,897],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[894,897],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":30,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":30,"endColumn":54},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1078,1081],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1078,1081],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":31,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1114,1117],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1114,1117],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":32,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":32,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultTemperature on an `any` value.","line":32,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":32,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":33,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":33,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultMaxTokens on an `any` value.","line":33,"column":38,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":33,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":37,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":37,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultTemperature on an `any` value.","line":37,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":37,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":38,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":38,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultMaxTokens on an `any` value.","line":38,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":38,"endColumn":50},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1521,1524],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1521,1524],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":56,"column":13,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":56,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":59,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":59,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":65,"column":17,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":65,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":71,"column":18,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":71,"endColumn":70}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":29,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { prisma } from '../db.js';\nimport { Model, Role, Prisma } from '@prisma/client';\n\ntype CompletionParams = {\n  temperature?: number;\n  max_tokens?: number;\n  [key: string]: any;\n};\n\nexport class ModelConfigurator {\n  /**\n   * Safely merges parameters, suppressing unsupported values and logging adjustments.\n   * @returns A tuple of [safe_params, adjustment_log]\n   */\n  static async configure(\n    model: Model,\n    role: Role,\n    config: { temperature?: number | null; maxTokens?: number | null }\n  ): Promise<[CompletionParams, Record<string, any>]> {\n    \n    // Read JSON specs layer for capabilities and supported parameters\n    const specs = (model as any).specs || {};\n    const supported: string[] = (specs.supportedParameters as string[]) || [];\n    const contextWindow = specs.contextWindow ?? specs.context_window ?? 4096;\n\n    const adjustments: Record<string, { original: any, reason: string }> = {};\n\n    // 1. Start with Role Defaults\n    // Role fields were removed from schema. Use metadata or hard defaults.\n    const roleMetadata = (role.metadata as any) || {};\n    const roleDefaults: any = {\n      defaultTemperature: roleMetadata.defaultTemperature, \n      defaultMaxTokens: roleMetadata.defaultMaxTokens\n    };\n\n    const finalParams: CompletionParams = {\n        temperature: roleDefaults.defaultTemperature ?? 0.7,\n        max_tokens: roleDefaults.defaultMaxTokens ?? contextWindow, \n    };\n\n    // 2. Overrides from Config (manual or dynamic choice)\n    const overrides: Record<string, any> = {\n        temperature: config.temperature,\n        maxTokens: config.maxTokens,\n    };\n\n    // 3. Merge and Validate\n    for (const [key, value] of Object.entries(overrides)) {\n        if (value === undefined || value === null) continue;\n\n        // Convert TS style (maxTokens) to API style (max_tokens)\n        const apiParam = key.replace(/([A-Z])/g, (g) => `_${g[0].toLowerCase()}`); \n\n        // Be permissive if supported list is empty (migration safety)\n        if (supported.includes(apiParam) || supported.length === 0) {\n            finalParams[apiParam] = value;\n        } else {\n            adjustments[key] = {\n                original: value,\n                reason: `Parameter '${key}' is not supported by model ${model.modelId || 'unknown'}. Value ignored.`\n            };\n\n            // AUTO-CORRECTION: If max_tokens is too high, cap it to contextWindow\n            if (key === 'maxTokens' && contextWindow && value > contextWindow) {\n                finalParams['max_tokens'] = contextWindow;\n                adjustments[key].reason = `Max tokens reduced from ${value} to model's context window (${contextWindow}).`;\n            }\n            \n            // Ensure temperature has a safe default\n            if (key === 'temperature') {\n                 finalParams[apiParam] = finalParams[apiParam] ?? 0.7;\n            }\n        }\n    }\n    \n    // 4. (Removed) Save adjustments back to ModelConfig\n\n    return [finalParams, adjustments];\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ModelDiscoveryService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ModelDoctor.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'webScraperTool' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":25,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":25,"endColumn":86},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":31,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":34,"endColumn":18},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":83,"column":15,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":83,"endColumn":47},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'inferSpecs' has no 'await' expression.","line":93,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":93,"endColumn":26,"suggestions":[{"messageId":"removeAsync","fix":{"range":[3349,3355],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":93,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3373,3376],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3373,3376],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":93,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3404,3407],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3404,3407],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":106,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":106,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":107,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":107,"endColumn":79},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .context_window on an `any` value.","line":107,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":107,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .context_length on an `any` value.","line":107,"column":41,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":107,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .max_context_length on an `any` value.","line":107,"column":61,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":107,"endColumn":79},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":108,"column":35,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":108,"endColumn":36},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":128,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4691,4694],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4691,4694],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":128,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":128,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4702,4705],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4702,4705],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'source' is defined but never used. Allowed unused args must match /^_/u.","line":128,"column":53,"nodeType":null,"messageId":"unusedVar","endLine":128,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .modelName on an `any` value.","line":129,"column":67,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":129,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":134,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":134,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":134,"column":13,"nodeType":"Identifier","messageId":"unsafeCall","endLine":134,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":135,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":135,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":135,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":135,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":136,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":136,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .contextWindow on an `any` value.","line":136,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":136,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":137,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":137,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .maxOutput on an `any` value.","line":137,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":137,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .hasVision on an `any` value.","line":138,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":138,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .hasAudioInput on an `any` value.","line":139,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":139,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .hasReasoning on an `any` value.","line":140,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":140,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":146,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":146,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .contextWindow on an `any` value.","line":146,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":146,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":147,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":147,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .maxOutput on an `any` value.","line":147,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":147,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .hasVision on an `any` value.","line":148,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":148,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .hasAudioInput on an `any` value.","line":149,"column":33,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":149,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .hasReasoning on an `any` value.","line":150,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":150,"endColumn":44},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'heal' has no 'await' expression.","line":157,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":157,"endColumn":23,"suggestions":[{"messageId":"removeAsync","fix":{"range":[5623,5746],"text":"heal<T>(data: Record<string, unknown>, schema: z.ZodSchema<T>, modelId: string): T | Record<string, unknown>"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'modelId' is defined but never used. Allowed unused args must match /^_/u.","line":157,"column":79,"nodeType":null,"messageId":"unusedVar","endLine":157,"endColumn":86},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'forceResearch' is assigned a value but never used. Allowed unused args must match /^_/u.","line":162,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":162,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":38,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { db } from '../db.js';\nimport { modelRegistry, modelCapabilities } from '../db/schema.js';\nimport { eq } from 'drizzle-orm';\nimport { v4 as uuidv4 } from 'uuid';\nimport { z } from 'zod';\nimport { createVolcanoAgent } from './AgentFactory.js';\nimport { webScraperTool } from '../tools/webScraper.js';\n\nexport class ModelDoctor {\n\n  // 1. The Public Entry Point\n  async healModel(modelId: string) {\n    const model = await db.query.modelRegistry.findFirst({\n      where: eq(modelRegistry.modelId, modelId)\n    });\n    if (!model) return;\n\n    // Phase 1: Fast Heuristics (Fallback)\n    let diagnosis = await this.inferSpecs(null, model.modelId, model.providerData);\n\n    // Phase 2: AI Research (The \"Internet\" Check)\n    // We only research if we lack high-confidence data\n    try {\n        console.log(`[ModelDoctor] ü©∫ Initiating AI Research for ${model.modelName}...`);\n        const researchData = await this.researchModel(model.modelName, model.modelId);\n        if (researchData) {\n            console.log(`[ModelDoctor] ‚úÖ Research successful for ${model.modelName}`, researchData);\n            // Merge research data with heuristics\n            diagnosis = {\n                confidence: 'high',\n                data: {\n                    ...diagnosis.data,\n                    ...researchData\n                }\n            };\n        }\n    } catch (e) {\n        console.warn(`[ModelDoctor] ‚ö†Ô∏è Research failed for ${model.modelName}, using heuristics.`, e);\n    }\n\n    // Save to DB\n    await this.saveKnowledge(model, diagnosis.data, 'doctor_heal');\n  }\n\n  // 2. The Research Agent\n  private async researchModel(name: string, id: string) {\n      try {\n          // Create a temporary researcher agent\n          // We use a cheap, fast model for the agent itself if possible, or default to system\n          const agent = await createVolcanoAgent({\n              roleId: 'researcher', // ensure this role exists or fallback\n              modelId: null,\n              isLocked: false,\n              temperature: 0,\n              maxTokens: 1000,\n              // Inject the web scraper tool directly\n              tools: ['research.web_scrape'] \n          });\n\n          const prompt = `You are a Model Researcher. Find the technical specifications for the LLM \"${name}\" (ID: ${id}).\n          \n          I specifically need:\n          1. Context Window (in tokens, e.g., 128000, 200000, 8192)\n          2. Capabilities: Does it support Vision? Audio? Function Calling?\n          3. Max Output Tokens.\n\n          Use the web_scrape tool to find this information from official documentation (OpenAI, Anthropic, Google, HuggingFace, etc).\n          \n          Return JSON ONLY:\n          {\n            \"contextWindow\": number,\n            \"maxOutput\": number,\n            \"hasVision\": boolean,\n            \"hasAudioInput\": boolean,\n            \"hasReasoning\": boolean\n          }`;\n\n          const result = await agent.generate(prompt);\n          \n          // Attempt to parse JSON from the response\n          const jsonMatch = result.match(/\\{[\\s\\S]*\\}/);\n          if (jsonMatch) {\n              return JSON.parse(jsonMatch[0]);\n          }\n          return null;\n      } catch (error) {\n          console.error(\"[ModelDoctor] Research Agent Error:\", error);\n          return null;\n      }\n  }\n\n  // 3. The Brain (Heuristics)\n  public async inferSpecs(agent: any, modelId: string, rawData: any) {\n    const lower = modelId.toLowerCase();\n    const rawString = JSON.stringify(rawData).toLowerCase();\n\n    // Context Window Logic\n    let context = 4096; // Fallback\n    if (lower.includes('128k')) context = 128000;\n    else if (lower.includes('200k')) context = 200000;\n    else if (lower.includes('32k')) context = 32000;\n    else if (lower.includes('16k')) context = 16000;\n    else if (lower.includes('8k')) context = 8192;\n    // Attempt to grab from raw data if available\n    else if (rawData && typeof rawData === 'object') {\n        const r = rawData;\n        const c = r.context_window || r.context_length || r.max_context_length;\n        if (c) context = parseInt(c);\n    }\n\n    // Capability Flags\n    const hasVision = lower.includes('vision') || lower.includes('vl') || rawString.includes('vision');\n    const hasAudio = lower.includes('audio') || lower.includes('whisper') || lower.includes('speech');\n    const hasReasoning = lower.includes('reasoning') || lower.includes('thinking') || lower.startsWith('o1-');\n\n    return {\n      confidence: 'medium',\n      data: {\n        contextWindow: context,\n        hasVision,\n        hasAudioInput: hasAudio,\n        hasReasoning\n      }\n    };\n  }\n\n  // 4. The Hands (Database Write)\n  public async saveKnowledge(model: any, data: any, source: string) {\n    console.log(`[ModelDoctor] üíæ Saving Capabilities for ${model.modelName}...`);\n\n    // Update the main capabilities table\n    await db.insert(modelCapabilities)\n      .values({\n        id: uuidv4(),\n        modelId: model.id,\n        contextWindow: data.contextWindow || 4096,\n        maxOutput: data.maxOutput || 4096,\n        hasVision: !!data.hasVision,\n        hasAudioInput: !!data.hasAudioInput,\n        hasReasoning: !!data.hasReasoning,\n        updatedAt: new Date()\n      })\n      .onConflictDoUpdate({\n        target: modelCapabilities.modelId,\n        set: {\n          contextWindow: data.contextWindow,\n          maxOutput: data.maxOutput,\n          hasVision: !!data.hasVision,\n          hasAudioInput: !!data.hasAudioInput,\n          hasReasoning: !!data.hasReasoning,\n          updatedAt: new Date()\n        }\n      });\n  }\n\n  // --- Preserved Compatibility Methods ---\n  public async heal<T>(data: Record<string, unknown>, schema: z.ZodSchema<T>, modelId: string): Promise<T | Record<string, unknown>> {\n    const validation = schema.safeParse(data);\n    return validation.success ? validation.data : data;\n  }\n\n  async healModels(forceResearch = false) {\n     const allModels = await db.query.modelRegistry.findMany({\n         where: eq(modelRegistry.isActive, true)\n     });\n     let healed = 0;\n     for (const model of allModels) {\n        await this.healModel(model.modelId);\n        healed++;\n     }\n     return { inferred: healed, researched: 0, failed: 0, skipped: 0 };\n  }\n\n  async healCapabilities() {\n    return this.healModels();\n  }\n}","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ModelSelector.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/PersistentModelDoctor.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/PrismaLessonProvider.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ProjectArchitect.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'projects' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'eq' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":12},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":52,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":52,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .length on an `any` value.","line":53,"column":54,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":53,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .dependsOnJobIndex on an `any` value.","line":61,"column":45,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":61,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Computed name [jobSpec.dependsOnJobIndex] resolves to an `any` value.","line":61,"column":94,"nodeType":"MemberExpression","messageId":"unsafeComputedMemberAccess","endLine":61,"endColumn":119},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .dependsOnJobIndex on an `any` value.","line":61,"column":102,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":61,"endColumn":119},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Computed name [jobSpec.dependsOnJobIndex] resolves to an `any` value.","line":62,"column":35,"nodeType":"MemberExpression","messageId":"unsafeComputedMemberAccess","endLine":62,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .dependsOnJobIndex on an `any` value.","line":62,"column":43,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":62,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":67,"column":19,"nodeType":"Property","messageId":"anyAssignment","endLine":67,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":67,"column":33,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":67,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":68,"column":19,"nodeType":"Property","messageId":"anyAssignment","endLine":68,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":68,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":68,"endColumn":51},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":69,"column":19,"nodeType":"Property","messageId":"anyAssignment","endLine":69,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .priority on an `any` value.","line":69,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":69,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":70,"column":19,"nodeType":"Property","messageId":"anyAssignment","endLine":70,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .parallelGroup on an `any` value.","line":70,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":70,"endColumn":55},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":79,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2897,2900],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2897,2900],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .code on an `any` value.","line":81,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":81,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":81,"column":44,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":81,"endColumn":70},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":81,"column":53,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":81,"endColumn":60}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":21,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createVolcanoAgent } from './AgentFactory.js';\nimport { db } from '../db.js';\nimport { jobs, projects } from '../db/schema.js';\nimport { eq } from 'drizzle-orm';\n\nexport class ProjectArchitect {\n\n  /**\n   * Hires an AI Architect to break down a vague goal into an actionable plan.\n   */\n  async draftBlueprint(projectId: string, goal: string) {\n    console.log(`[Architect] üèóÔ∏è Drafting blueprint for project: \"${goal}\"...`);\n\n    // 1. Hire the Architect Agent\n    // We request a high-reasoning model (Chain of Command: Officer Level)\n    const architect = await createVolcanoAgent({\n        roleId: 'architect', // We will seed this role next\n        modelId: null,       // Let orchestrator find the smartest model\n        isLocked: false,\n        temperature: 0.7,\n        maxTokens: 4000\n    });\n\n    // 2. The Planning Prompt\n    const prompt = `\n      You are the Chief Architect of a software development firm.\n      PROJECT GOAL: \"${goal}\"\n\n      Your task is to break this project down into a series of sequential or parallel JOBS.\n      \n      RULES:\n      1. Start with setup/scaffolding.\n      2. Break complex features into separate jobs.\n      3. End with a QA/Testing job.\n      4. Return ONLY a JSON array.\n      \n      Format:\n      [\n        { \"name\": \"Init Repo\", \"description\": \"Initialize git and npm...\", \"priority\": \"high\", \"parallelGroup\": \"setup\" },\n        { \"name\": \"Build UI\", \"description\": \"Create React components...\", \"dependsOnJobIndex\": 0 }\n      ]\n    `;\n\n    // 3. Generate the Plan\n    const planText = await architect.generate(prompt);\n\n    // 4. Parse and Enforce the Plan\n    try {\n        const jsonMatch = planText.match(/\\[[\\s\\S]*\\]/);\n        if (!jsonMatch) throw new Error(\"Architect failed to produce valid JSON plan.\");\n\n        const plan = JSON.parse(jsonMatch[0]);\n        console.log(`[Architect] üìã Generated ${plan.length} jobs.`);\n\n        // 5. Commit to Corporate Database\n        // We need to map the relative indices to actual DB IDs\n        const createdJobIds: string[] = [];\n\n        try {\n          for (const jobSpec of plan) {\n              const dependencyId = (jobSpec.dependsOnJobIndex !== undefined && createdJobIds[jobSpec.dependsOnJobIndex])\n                  ? createdJobIds[jobSpec.dependsOnJobIndex]\n                  : undefined;\n\n              const [job] = await db.insert(jobs).values({\n                  projectId: projectId,\n                  name: jobSpec.name,\n                  description: jobSpec.description,\n                  priority: jobSpec.priority || 'medium',\n                  parallelGroup: jobSpec.parallelGroup,\n                  dependsOnJobId: dependencyId,\n                  status: 'not_started'\n              }).returning();\n\n              createdJobIds.push(job.id);\n          }\n\n          console.log(`[Architect] ‚úÖ Blueprint active. Workers notified.`);\n        } catch (dbError: any) {\n          // Silently handle if jobs table doesn't exist yet\n          if (dbError?.code === '42P01' || dbError?.message?.includes('does not exist')) {\n            console.log(`[Architect] ‚ö†Ô∏è Jobs table not yet created. Plan generated but not persisted. Run migrations when ready.`);\n            return;\n          }\n          throw dbError;\n        }\n\n    } catch (e) {\n        console.error(\"[Architect] üí• Planning meeting failed:\", e);\n    }\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/PromptFactory.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":34,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as fs from 'fs/promises';\nimport * as path from 'path';\n\nexport interface AgentLesson {\n  rule: string;\n  confidence: number;\n}\n\nexport interface LessonProvider {\n  getLessons(keywords: string[]): Promise<AgentLesson[]>;\n}\n\n/**\n * Loads a role's base prompt from the markdown files in apps/api/data/agents/en/\n */\nexport async function loadRolePrompt(roleName: string): Promise<string> {\n  const agentsDir = path.join(process.cwd(), 'data', 'agents', 'en');\n  \n  // Try to find the markdown file for this role\n  // Role names in DB might be like \"Backend Developer\" but files are \"backend-developer.md\"\n  const normalizedName = roleName.toLowerCase().replace(/\\s+/g, '-');\n  const filePath = path.join(agentsDir, `${normalizedName}.md`);\n  \n  try {\n    const content = await fs.readFile(filePath, 'utf-8');\n    \n    // Extract the body (after frontmatter)\n    const frontmatterMatch = content.match(/^---\\n([\\s\\S]*?)\\n---/);\n    if (frontmatterMatch) {\n      return content.substring(frontmatterMatch[0].length).trim();\n    }\n    \n    return content;\n  } catch (error) {\n    // If file doesn't exist, return a default prompt\n    console.warn(`[PromptFactory] Role prompt not found for \"${roleName}\", using default`);\n    return `You are a helpful ${roleName}. Assist the user with their request.`;\n  }\n}\n\nexport class PromptFactory {\n  constructor(private lessonProvider: LessonProvider) {}\n\n  async build(\n    role: string, \n    userQuery: string, \n    memoryConfig?: { useProjectMemory: boolean },\n    tools?: string[],\n    projectPrompt?: string,\n    constitution?: { codeRules?: string; glossary?: Record<string, string> }\n  ): Promise<string> {\n    // 0. Constitution Layer (Global Rules - Highest Priority)\n    let constitutionSection = '';\n    if (constitution) {\n      if (constitution.codeRules) {\n        constitutionSection += `\\n## ‚öñÔ∏è CONSTITUTION - CODE RULES (MUST FOLLOW)\\n${constitution.codeRules}\\n`;\n      }\n      if (constitution.glossary && Object.keys(constitution.glossary).length > 0) {\n        const glossaryEntries = Object.entries(constitution.glossary)\n          .map(([key, value]) => `- **${key}**: ${value}`)\n          .join('\\n');\n        constitutionSection += `\\n## üìñ GLOSSARY - PROJECT TERMINOLOGY\\n${glossaryEntries}\\n`;\n      }\n    }\n\n    // 1. Load the role's base prompt from markdown\n    const rolePrompt = await loadRolePrompt(role);\n\n    // 2. Load Dynamic Layer (The \"Learning\" Integration)\n    let lessons: AgentLesson[] = [];\n    \n    if (memoryConfig?.useProjectMemory) {\n      const keywords = this.extractKeywords(userQuery); \n      lessons = await this.lessonProvider.getLessons(keywords);\n    }\n\n    const memoryBlock = lessons.length > 0 \n      ? `\\n## üß† PREVIOUS LESSONS\\n${lessons.map(l => `- ${l.rule}`).join('\\n')}`\n      : '';\n\n    // 3. Load Tool Definitions & Examples\n    let toolSection = '';\n    try {\n      // Resolve path to .domoreai/tools\n      let rootDir = process.cwd();\n      if (rootDir.endsWith('apps/api')) {\n          rootDir = path.resolve(rootDir, '../../');\n      }\n      \n      const toolsDir = path.join(rootDir, '.domoreai/tools');\n      \n      const files = await fs.readdir(toolsDir).catch(() => []);\n      \n      let toolDefs = '';\n      let toolExamples = '';\n\n      for (const file of files) {\n          // If tools list is provided, only include files that start with one of the tool names\n          let shouldInclude = true;\n          if (tools && tools.length > 0) {\n             const serverName = file.split('.')[0].split('_')[0];\n             if (!tools.includes(serverName)) {\n                 shouldInclude = false;\n             }\n          }\n\n          if (shouldInclude) {\n              if (file.endsWith('.d.ts')) {\n                  const content = await fs.readFile(path.join(toolsDir, file), 'utf-8');\n                  toolDefs += content + '\\n';\n              }\n              if (file.endsWith('_examples.md')) {\n                  const content = await fs.readFile(path.join(toolsDir, file), 'utf-8');\n                  toolExamples += content + '\\n';\n              }\n          }\n      }\n\n      if (toolDefs) {\n        toolSection = `\n## üõ†Ô∏è AVAILABLE TOOLS (TYPE DEFINITIONS)\n\\`\\`\\`typescript\n${toolDefs}\n\\`\\`\\`\n\n## üí° USAGE EXAMPLES\n${toolExamples}\n`;\n      }\n    } catch {\n      // Ignore errors if tools directory doesn't exist or can't be read\n    }\n\n    // 4. Project Specific Prompt\n    const projectSection = projectPrompt ? `\\n## üèóÔ∏è PROJECT CONTEXT & GUIDELINES\\n${projectPrompt}\\n` : '';\n\n    // Constitution comes FIRST to ensure it's always visible and enforced\n    return `${constitutionSection}${rolePrompt}\\n${projectSection}\\n${memoryBlock}${toolSection}`;\n  }\n\n  private extractKeywords(query: string): string[] {\n    // Simple logic: split by space, filter common words\n    return query.toLowerCase().split(' ').filter(w => w.length > 3);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ProviderManager.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Computed name [config.type] resolves to an `any` value.","line":71,"column":38,"nodeType":"MemberExpression","messageId":"unsafeComputedMemberAccess","endLine":71,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":71,"column":45,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":71,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":73,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":73,"endColumn":26},{"ruleId":"@typescript-eslint/no-unnecessary-type-assertion","severity":2,"message":"This assertion is unnecessary since it does not change the type of the expression.","line":78,"column":22,"nodeType":"TSAsExpression","messageId":"unnecessaryAssertion","endLine":78,"endColumn":51,"fix":{"range":[3138,3148],"text":""}},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .label on an `any` value.","line":79,"column":90,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":79,"endColumn":95},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":82,"column":30,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":82,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .apiKey on an `any` value.","line":82,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":82,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":85,"column":59,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":85,"endColumn":70},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":85,"column":66,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":85,"endColumn":70},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":86,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":86,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":86,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":86,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":88,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":88,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .baseURL on an `any` value.","line":88,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":88,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":90,"column":30,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":90,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":90,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":90,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":93,"column":37,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":93,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":93,"column":44,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":93,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":93,"column":50,"nodeType":"Property","messageId":"anyAssignment","endLine":93,"endColumn":69},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .label on an `any` value.","line":93,"column":64,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":93,"endColumn":69},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":93,"column":71,"nodeType":"Property","messageId":"anyAssignment","endLine":93,"endColumn":88},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":93,"column":84,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":93,"endColumn":88},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .label on an `any` value.","line":95,"column":61,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":95,"endColumn":66},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":95,"column":78,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":95,"endColumn":82},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .label on an `any` value.","line":97,"column":70,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":97,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":121,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":121,"endColumn":84},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":166,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":166,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":323,"column":19,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":323,"endColumn":86},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":343,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":343,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":27,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { decrypt, encrypt } from '../utils/encryption.js';\nimport { ProviderFactory } from '../utils/ProviderFactory.js';\nimport { type BaseLLMProvider, type LLMModel } from '../utils/BaseLLMProvider.js';\nimport { IProviderManager } from '../interfaces/IProviderManager.js';\nimport { IProviderRepository } from '../interfaces/IProviderRepository.js';\nimport { ProviderRepository } from '../repositories/ProviderRepository.js';\nimport { OLLAMA_DEFAULT_HOST, OLLAMA_PROVIDER_ID, OPENROUTER_API_URL, GROQ_API_URL, DEFAULT_FETCH_TIMEOUT_MS } from '../config/constants.js';\n\nconst MS_PER_SECOND = 1000;\n\n\ninterface RawSnapshotData extends LLMModel {\n    [key: string]: unknown;\n}\n\nexport class ProviderManager implements IProviderManager {\n  private providers: Map<string, BaseLLMProvider> = new Map();\n  private unhealthyProviders: Map<string, number> = new Map(); // providerId -> cooldownEndTime\n  // NEW: Store metadata for logging and filtering\n  private providerMetadata: Map<string, { label: string; type: string }> = new Map();\n\n  private repository: IProviderRepository;\n\n  constructor(repository?: IProviderRepository) {\n      this.repository = repository || new ProviderRepository();\n  }\n\n  public markUnhealthy(providerId: string, cooldownSeconds: number) {\n    this.unhealthyProviders.set(providerId, Date.now() + cooldownSeconds * MS_PER_SECOND);\n    console.warn(`[ProviderManager] Marked ${providerId} as unhealthy. Cooldown for ${cooldownSeconds}s.`);\n  }\n\n  public isHealthy(providerId: string): boolean {\n      const cooldownEndTime = this.unhealthyProviders.get(providerId);\n      if (!cooldownEndTime) {\n          return true;\n      }\n      if (Date.now() > cooldownEndTime) {\n          this.unhealthyProviders.delete(providerId);\n          console.log(`[ProviderManager] ${providerId} is healthy again.`);\n          return true;\n      }\n      return false;\n  }\n\n  async initialize() {\n    // 1. AUTO-BOOTSTRAP FROM ENV (The \"Free Labor\" Fix)\n    // This checks your .env file and inserts them into the DB if missing\n    await this.bootstrapFromEnv();\n\n    // 2. Load from DB\n    try {\n      const configs = await this.repository.getEnabledProviderConfigs();\n      \n      this.providers.clear();\n      this.providerMetadata.clear(); // Clear metadata\n\n      // Environment variable mappings for direct access\n      const envMappings: Record<string, string> = {\n        'google': 'GOOGLE_GENERATIVE_AI_API_KEY',\n        'mistral': 'MISTRAL_API_KEY',\n        'openrouter': 'OPENROUTER_API_KEY',\n        'groq': 'GROQ_API_KEY',\n        'ollama': 'OLLAMA_API_KEY' // Usually empty for local Ollama\n      };\n\n      for (const config of configs) {\n        try {\n          // Try to use environment variable first (avoids decryption issues)\n          let apiKey = '';\n          const envVar = envMappings[config.type];\n          \n          if (config.type === 'ollama') {\n            // Ollama is local and doesn't need an API key\n            apiKey = process.env.OLLAMA_API_KEY || '';\n          } else if (envVar && process.env[envVar]) {\n            // Use environment variable directly\n            apiKey = process.env[envVar] as string;\n            console.log(`[ProviderManager] Using ${envVar} from environment for ${config.label}`);\n          } else {\n            // Fall back to decrypting from database\n            apiKey = decrypt(config.apiKey);\n          }\n          \n          const provider = ProviderFactory.createProvider(config.type, {\n            id: config.id,\n            apiKey,\n            baseURL: config.baseURL || undefined,\n          });\n          this.providers.set(config.id, provider);\n          \n          // STORE METADATA HERE\n          this.providerMetadata.set(config.id, { label: config.label, type: config.type });\n          \n          console.log(`[ProviderManager] ‚úÖ Online: ${config.label} (${config.type})`);\n        } catch (error) {\n          console.error(`[ProviderManager] ‚ùå Failed to init ${config.label}:`, error);\n        }\n      }\n      \n      // 3. Auto-detect Ollama (Local)\n      await this.detectLocalOllama();\n\n    } catch (error) {\n      console.error('[ProviderManager] Critical Error loading providers:', error);\n    }\n  }\n\n  private async bootstrapFromEnv() {\n    const mappings = [\n      { env: 'GOOGLE_GENERATIVE_AI_API_KEY', type: 'google', label: 'Google AI Studio (Env)' },\n      { env: 'MISTRAL_API_KEY', type: 'mistral', label: 'Mistral API (Env)' },\n      { env: 'OPENROUTER_API_KEY', type: 'openrouter', label: 'OpenRouter (Env)', url: OPENROUTER_API_URL },\n      { env: 'GROQ_API_KEY', type: 'groq', label: 'Groq (Env)', url: GROQ_API_URL }\n    ];\n\n    for (const map of mappings) {\n      const key = process.env[map.env];\n      if (key) {\n        // Check if already exists to avoid duplicates\n        const existing = await this.repository.findProviderConfigByLabel(map.label);\n\n        if (!existing) {\n           console.log(`[ProviderManager] üöÄ Bootstrapping ${map.label} from .env...`);\n           // Create a stable, human-readable ID instead of a random UUID.\n           // e.g., \"OpenRouter (Env)\" -> \"openrouter-env\"\n           const stableId = `${map.type}-${map.label.split(' ')[1].toLowerCase().replace(/[^a-z0-9]/g, '')}`;\n\n           const now = new Date();\n           await this.repository.createProviderConfig({\n             id: stableId,\n             label: map.label,\n             type: map.type,\n             apiKey: encrypt(key),\n             baseURL: map.url || '',\n             isEnabled: true,\n             createdAt: now,\n             updatedAt: now\n           });\n        }\n      }\n    }\n  }\n\n  getProvider(id: string): BaseLLMProvider | undefined {\n    // Allow lookup by \"type\" as well if ID fails (e.g. \"google\")\n    if (this.providers.has(id)) return this.providers.get(id);\n    \n    // Fallback: Find first provider of this type\n    for (const [_, p] of this.providers) {\n        if (p.id === id || p.id.includes(id)) return p;\n    }\n    return undefined;\n  }\n  \n  hasProvider(partialId: string): boolean {\n      return Array.from(this.providers.keys()).some(k => k.includes(partialId));\n  }\n\n  async getAllModels(): Promise<LLMModel[]> {\n    const allModels: LLMModel[] = [];\n    for (const provider of this.providers.values()) {\n      try {\n        const models = await provider.getModels();\n        allModels.push(...models);\n      } catch (error) {\n        console.error(`Failed to fetch models from provider ${provider.id}`);\n      }\n    }\n    return allModels;\n  }\n\n  /**\n   * Syncs all discovered models to the Drizzle tables.\n   * Splits data between Registry (lookup) and Provider Tables (details).\n   */\n  async syncModelsToRegistry() {\n    console.log('[ProviderManager] Starting Registry Sync (Unified)...');\n\n    for (const [providerId] of this.providers.entries()) {\n      try {\n        // 1. Get readable name for logs\n        const meta = this.providerMetadata.get(providerId);\n        const providerLabel = meta?.label || providerId;\n        const providerType = meta?.type || 'unknown';\n\n        // --- UNIFIED FETCH LOGIC ---\n        // We will now use RawModelService to handle all fetching,\n        // ensuring pagination and correct endpoints are always used.\n        console.log(`[ProviderManager] Fetching models for ${providerLabel} via RawModelService...`);\n        const { RawModelService } = await import('./RawModelService.js');\n        const snapshot = await RawModelService.fetchAndSnapshot(providerId);\n        \n        if (!snapshot || !Array.isArray(snapshot.rawData)) {\n          console.error(`[ProviderManager] Failed to get a valid snapshot for ${providerLabel}.`);\n          continue;\n        }\n        // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion\n        const models = snapshot.rawData as LLMModel[];\n        console.log(`[ProviderManager] Got ${models.length} models from ${providerLabel}.`);\n\n        // The snapshot is already created by RawModelService. We just need to flatten.\n        // We pass the snapshot ID to ensure we use the exact data that was saved.\n        await this.flattenSnapshot(snapshot.id, providerType, models);\n\n        if (models.length === 0) {\n          console.warn(`[ProviderManager] No models to sync for ${providerLabel} after filtering`);\n          continue;\n        }\n\n        const uniqueModels = new Map<string, RawSnapshotData>();\n        models.forEach(m => uniqueModels.set(m.id, m as RawSnapshotData));\n\n        // 3. Log with readable name\n        console.log(`[Registry Sync] Upserting ${uniqueModels.size} models for ${providerLabel}...`);\n\n        for (const m of uniqueModels.values()) {\n          // Defensive: Extract model ID from various possible fields\n          const modelId = (m.id || m.model || m.name) as string;\n          if (!modelId) {\n            console.warn(`[Registry Sync] Skipping model with no ID:`, m);\n            continue;\n          }\n\n          const cost = m.costPer1k;\n          const isFree = m.isFree === true || (typeof cost === 'number' && cost === 0);\n\n          const specs = {\n            contextWindow: m.contextWindow,\n            hasVision: m.hasVision,\n            hasReasoning: m.hasReasoning || false,\n            hasCoding: m.hasCoding || false\n          };\n\n          await this.repository.upsertModel({\n            where: {\n              providerId_modelId: {\n                providerId: providerId,\n                modelId: modelId\n              }\n            },\n            create: {\n              providerId: providerId,\n              modelId: modelId,\n              name: (m.name as string) || modelId,\n              isFree: isFree,\n              costPer1k: cost || 0,\n              providerData: m, // Store full raw model object\n              specs: specs as unknown as Record<string, unknown>,\n              aiData: {}\n            },\n            update: {\n              name: (m.name as string) || modelId,\n              isFree: isFree,\n              costPer1k: cost || 0,\n              providerData: m, // Store full raw model object\n              specs: specs as unknown as Record<string, unknown>\n            }\n          });\n        }\n\n      } catch (error) {\n        const meta = this.providerMetadata.get(providerId);\n        const providerLabel = meta?.label || providerId;\n        const err = error as Error & { cause?: { code: string } };\n        if (err.cause?.code === 'ETIMEDOUT') {\n          console.error(`[Registry Sync] Failed for provider ${providerLabel}: Connection timed out.`);\n          console.error(`If you are behind a firewall, please ensure the HTTPS_PROXY environment variable is correctly configured.`);\n        } else {\n          console.error(`[Registry Sync] Failed for provider ${providerLabel}:`, error);\n        }\n      }\n    }\n\n    console.log('[ProviderManager] Registry Sync Completed.');\n  }\n\n  /**\n   * Helper to flatten provider data from a snapshot into a dynamic table.\n   * The snapshotting part is now handled by RawModelService.\n   */\n  private async flattenSnapshot(snapshotId: string, providerType: string, models: RawSnapshotData[]) {\n    // Flatten into a dynamic table. This is the critical step.\n    // Table name convention: \"{providerType}_models\" (e.g. google_models)\n    try {\n      const tableName = `${providerType}_models`;\n      \n      const { flattenRawData } = await import('./dataRefinement.service.js');\n      \n      console.log(`[ProviderManager] üî® Flattening data into table: ${tableName}...`);\n      // Pass both snapshotId and the in-memory rawData.\n      // flattenRawData is smart enough to use the rawData if the snapshotId lookup fails for any reason.\n      const result = await flattenRawData({ snapshotId, tableName, rawData: models });\n      console.log(`[ProviderManager] ‚úÖ Created dynamic table ${result.tableName} with ${result.rowCount} rows.`);\n      \n    } catch (error) {\n      console.error(`[ProviderManager] ‚ùå Failed to snapshot/flatten data for ${providerType}:`, error);\n    }\n  }\n\n  /**\n   * Auto-detects a local Ollama instance and registers it as a provider.\n   * This allows \"zero-config\" usage of local models.\n   */\n  private async detectLocalOllama() {\n    const ollamaHost = process.env.OLLAMA_HOST || OLLAMA_DEFAULT_HOST;\n    const providerId = OLLAMA_PROVIDER_ID;\n\n    // If already configured in DB, skip auto-detection to respect user config\n    if (this.providers.has(providerId)) return;\n\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), DEFAULT_FETCH_TIMEOUT_MS);\n    try {\n        // A simple fetch to the root endpoint is enough to see if Ollama is running.\n        const response = await fetch(ollamaHost, { signal: controller.signal });\n        const text = await response.text();\n\n        if (response.ok && text.includes('Ollama is running')) {\n            console.log(`[ProviderManager] ‚úÖ Auto-detected local Ollama at ${ollamaHost}.`);\n\n            // Ensure the provider config exists in the database.\n            const existing = await this.repository.findProviderConfigById(providerId);\n            if (!existing) {\n              const now = new Date();\n              await this.repository.createProviderConfig({\n                id: providerId,\n                label: 'Ollama (Local)',\n                type: 'ollama',\n                apiKey: encrypt(''),\n                baseURL: ollamaHost,\n                isEnabled: true,\n                createdAt: now,\n                updatedAt: now\n              });\n              console.log('[ProviderManager] Registered local Ollama provider in DB.');\n            }\n\n            // Add the provider to the active list. The main sync loop will handle fetching its models.\n            const provider = ProviderFactory.createProvider('ollama', { id: providerId, baseURL: ollamaHost });\n            this.providers.set(providerId, provider);\n        }\n    } catch (e) {\n        // Silent failure - Ollama just isn't running\n        // console.debug(`[ProviderManager] Local Ollama not detected at ${ollamaHost}`);\n    } finally {\n        clearTimeout(timeoutId);\n    }\n  }\n\n  // --- STATIC FACADE ---\n  // Uses the default repository implementation for backward compatibility\n  private static instance = new ProviderManager();\n\n  public static getInstance() {\n      return this.instance;\n  }\n\n  public static markUnhealthy(providerId: string, cooldownSeconds: number) {\n      this.instance.markUnhealthy(providerId, cooldownSeconds);\n  }\n\n  public static isHealthy(providerId: string): boolean {\n      return this.instance.isHealthy(providerId);\n  }\n\n  static async initialize() {\n      await this.instance.initialize();\n  }\n\n  static getProvider(id: string) {\n      return this.instance.getProvider(id);\n  }\n\n  static hasProvider(partialId: string) {\n      return this.instance.hasProvider(partialId);\n  }\n\n  static async getAllModels(): Promise<LLMModel[]> {\n      return this.instance.getAllModels();\n  }\n\n  static async syncModelsToRegistry() {\n      await this.instance.syncModelsToRegistry();\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ProviderProbeService.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UsageCollector' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":24},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Static async method 'probe' has no 'await' expression.","line":4,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":4,"endColumn":21,"suggestions":[{"messageId":"removeAsync","fix":{"range":[100,106],"text":""},"desc":"Remove 'async'."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { UsageCollector } from './UsageCollector.js';\n\nexport class ProviderProbeService {\n  static async probe(providerId: string, modelId: string) {\n    console.log(`[Probe] Probing ${providerId} ${modelId}`);\n    // Logic to invoke provider with max_tokens=1 would go here\n    // For now, we just log\n    return true;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/RawJsonLoader.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":31,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":31,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{}`.","line":46,"column":25,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":46,"endColumn":28},{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"'v' will use Object's default stringification format ('[object Object]') when stringified.","line":90,"column":26,"nodeType":"Identifier","messageId":"baseToString","endLine":90,"endColumn":27}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { readdir, readFile } from 'fs/promises';\nimport { join } from 'path';\nimport { prisma } from '../db.js';\n\n/**\n * Scans for raw JSON files saved by ProviderManager\n * and creates/populates tables from the JSON data\n */\nexport async function autoLoadRawJsonFiles() {\n  try {\n    const rootDir = process.cwd();\n    const latestModelsDir = join(rootDir, 'latest_models');\n    console.log(`[JsonLoader] üîç Scanning ${latestModelsDir} for provider JSON files...`);\n\n    const files = await readdir(latestModelsDir);\n    const jsonFiles = files.filter(f =>\n      f.match(/^(google|mistral|openrouter|groq|ollama)_models_.*\\.json$/)\n    );\n\n    if (jsonFiles.length === 0) {\n      console.log('[JsonLoader] ‚ÑπÔ∏è No provider JSON files found in', latestModelsDir);\n      return;\n    }\n\n    console.log(`[JsonLoader] ‚úì Found ${jsonFiles.length} latest model files: ${jsonFiles.join(', ')}`);\n\n    for (const file of jsonFiles) {\n      try {\n        const filepath = join(latestModelsDir, file);\n        const content = await readFile(filepath, 'utf-8');\n        const jsonData = JSON.parse(content);\n\n        const match = file.match(/^(\\w+)_models_/);\n        if (!match) continue;\n\n        const providerType = match[1];\n        const tableName = `raw_${providerType}_models`;\n        const rows = Array.isArray(jsonData) ? jsonData : [jsonData];\n\n        console.log(`[JsonLoader] üìä Creating table ${tableName} with ${rows.length} rows...`);\n\n        // Extract all unique keys\n        const keysSet = new Set<string>();\n        rows.forEach(obj => {\n          if (obj && typeof obj === 'object') {\n            Object.keys(obj).forEach(k => keysSet.add(k));\n          }\n        });\n\n        const keys = Array.from(keysSet).sort();\n        if (keys.length === 0) {\n          console.warn(`[JsonLoader] ‚ö†Ô∏è No keys in ${file}`);\n          continue;\n        }\n\n        // Drop existing table\n        await prisma.$executeRawUnsafe(`DROP TABLE IF EXISTS \"${tableName}\"`);\n\n        // FIX: Handle 'id' collision - rename 'id' to 'model_id' to avoid conflict with PK\n        const columnDefs = keys.map(k => {\n          if (k === 'id') return `\"model_id\" TEXT`;\n          return `\"${k}\" TEXT`;\n        }).join(', ');\n\n        const createSql = `CREATE TABLE \"${tableName}\" (\n          id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n          _loaded_at TIMESTAMP DEFAULT NOW(),\n          ${columnDefs}\n        )`;\n\n        await prisma.$executeRawUnsafe(createSql);\n        console.log(`[JsonLoader] ‚úÖ Created table ${tableName}`);\n\n        // Insert all rows\n        let inserted = 0;\n        for (const row of rows) {\n          // FIX: Map column names, renaming 'id' to 'model_id'\n          const cols = keys.map(k => {\n            if (k === 'id') return `\"model_id\"`;\n            return `\"${k}\"`;\n          }).join(', ');\n\n          const vals = keys.map(k => {\n            const v = (row as Record<string, unknown>)[k];\n            if (v === null || v === undefined) return 'NULL';\n            let s: string;\n            if (typeof v === 'object') {\n              s = JSON.stringify(v).replace(/'/g, \"''\");\n            } else {\n              s = String(v).replace(/'/g, \"''\");\n            }\n            return `'${s}'`;\n          }).join(', ');\n\n          await prisma.$executeRawUnsafe(`INSERT INTO \"${tableName}\" (${cols}) VALUES (${vals})`);\n          inserted++;\n        }\n\n        console.log(`[JsonLoader] ‚úÖ Inserted ${inserted} rows into ${tableName}`);\n      } catch (err) {\n        console.error(`[JsonLoader] ‚úó Failed to load ${file}:`, (err as Error).message);\n      }\n    }\n\n    console.log('[JsonLoader] ‚úÖ Raw JSON load complete');\n  } catch (err) {\n    console.error('[JsonLoader] ‚ùå Error:', (err as Error).message);\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/RawModelService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":50,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2084,2087],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2084,2087],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":70,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2800,2803],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2800,2803],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .ok on an `any` value.","line":75,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":75,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":76,"column":19,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":76,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":76,"column":31,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":76,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .text on an `any` value.","line":76,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":76,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .status on an `any` value.","line":77,"column":61,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":77,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":80,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":80,"endColumn":52},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3093,3096],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3093,3096],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":80,"column":37,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":80,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .json on an `any` value.","line":80,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":80,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":83,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":83,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .models on an `any` value.","line":83,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":83,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe spread of an `any` type.","line":84,"column":24,"nodeType":"SpreadElement","messageId":"unsafeSpread","endLine":84,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .nextPageToken on an `any` value.","line":87,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":87,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .nextPageToken on an `any` value.","line":90,"column":67,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":90,"endColumn":80},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":110,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":110,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4245,4248],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4245,4248],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":113,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":113,"endColumn":63}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":18,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { prisma } from '../db.js';\nimport { decrypt } from '../utils/encryption.js';\n\nexport class RawModelService {\n  \n  static async fetchAndSnapshot(providerConfigId: string) {\n    // 1. Get Config\n    const config = await prisma.providerConfig.findUnique({ \n      where: { id: providerConfigId } \n    });\n    \n    if (!config) throw new Error(`Provider Config ${providerConfigId} not found`);\n\n    // 2. Prepare URL with provider-aware defaults and normalization\n    let url = config.baseURL;\n    if (!url) {\n        if (config.type === 'openai') url = 'https://api.openai.com/v1';\n        else if (config.type === 'openrouter') url = 'https://openrouter.ai/api/v1';\n        else if (config.type === 'mistral') url = 'https://api.mistral.ai/v1';\n        else if (config.type === 'groq') url = 'https://api.groq.com/openai/v1';\n        else if (config.type === 'anthropic') url = 'https://api.anthropic.com/v1';\n        else if (config.type === 'ollama') url = 'http://localhost:11434';\n        else if (config.type === 'google') url = 'https://generativelanguage.googleapis.com/v1beta';\n    }\n\n    // Normalize Ollama URL (strip trailing /v1 if present)\n    const looksLikeOllama = config.type === 'ollama' || /:11434(\\/|$)/.test(url || '');\n    if (looksLikeOllama && url) {\n      url = url.replace(/\\/?v1\\/?$/, '');\n    }\n\n    // Remove trailing slash and add endpoint\n    url = url?.replace(/\\/$/, '') || '';\n    \n    let fetchUrl = '';\n    if (looksLikeOllama) {\n        fetchUrl = url.endsWith('/api/tags') ? url : `${url}/api/tags`;\n    } else if (config.type === 'google') {\n        // CORRECTED: Use the v1 endpoint which provides the full model catalog,\n        // not the v1beta endpoint which only lists a small subset.\n        fetchUrl = 'https://generativelanguage.googleapis.com/v1/models?pageSize=100';\n    } else {\n        // OpenAI Compatible\n        fetchUrl = url.endsWith('/models') ? url : `${url}/models`;\n    }\n\n    console.log(`[RawModelService] Attempting to fetch models from provider endpoint: ${fetchUrl}`);\n\n    // 3. Fetch (Raw)\n    const allModels: any[] = [];\n    let nextUrl: string | undefined = fetchUrl;\n    const apiKey = decrypt(config.apiKey);\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout\n\n    try {\n      const headers: Record<string, string> = { 'Content-Type': 'application/json' };\n      \n      if (apiKey) {\n          if (config.type === 'google') {\n              headers['x-goog-api-key'] = apiKey;\n          } else if (!looksLikeOllama) {\n              headers.Authorization = `Bearer ${apiKey}`;\n          }\n      }\n\n      // --- PAGINATION LOOP ---\n      while (nextUrl) {\n        console.log(`[RawModelService] Fetching page: ${nextUrl}`);\n        const response: any = await fetch(nextUrl, {\n          headers,\n          signal: controller.signal\n        });\n\n        if (!response.ok) {\n            const txt = await response.text();\n            throw new Error(`Provider API Error: ${response.status} ${txt}`);\n        }\n        \n        const pageJson: any = await response.json();\n        \n        // Extract models from the current page\n        const pageModels = pageJson.models || [];\n        allModels.push(...pageModels);\n\n        // Check for the next page token\n        if (pageJson.nextPageToken) {\n          // Construct the URL for the next page\n          const baseUrl = fetchUrl.split('?')[0];\n          nextUrl = `${baseUrl}?pageSize=100&pageToken=${pageJson.nextPageToken}`;\n        } else {\n          nextUrl = undefined; // No more pages, exit loop\n        }\n      }\n\n      // 5. Save to DB (Exact dump)\n      // NOTE: RawDataLake table has been replaced by provider-specific tables\n      // (raw_google_models, raw_groq_models, etc.) which are created by RawJsonLoader\n      // from the JSON files in latest_models/ directory.\n      console.log(`[RawModelService] Successfully fetched ${allModels.length} models from ${config.type}`);\n      \n      // Return a mock snapshot object for backward compatibility\n      return {\n        id: `${config.type}-${Date.now()}`,\n        provider: config.type,\n        rawData: allModels,\n        ingestedAt: new Date()\n      };\n\n    } catch (error: any) {\n      clearTimeout(timeoutId);\n      console.error(`[RawModelService] Fetch failed for ${fetchUrl}:`, error);\n      throw new Error(`Failed to fetch models: ${error.message}`);\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/RoleIngestionService.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":191,"column":15,"nodeType":"Property","messageId":"anyAssignment","endLine":199,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":199,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":199,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5809,5812],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5809,5812],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":206,"column":14,"nodeType":"Property","messageId":"anyAssignment","endLine":217,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":217,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":217,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6410,6413],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6410,6413],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":291,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":291,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":362,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":362,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":455,"column":29,"nodeType":"Property","messageId":"anyAssignment","endLine":462,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":462,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":462,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14967,14970],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14967,14970],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":467,"column":29,"nodeType":"Property","messageId":"anyAssignment","endLine":475,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":475,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":475,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15637,15640],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15637,15640],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as fs from 'fs/promises';\nimport * as path from 'path';\nimport { PrismaClient } from '@prisma/client';\nimport { ProviderManager } from './ProviderManager.js';\n\ninterface AgentData {\n  name: string;\n  description: string;\n  tools: string[];\n  category?: string;\n  systemPrompt: string;\n}\n\n/**\n * Parses frontmatter and body from markdown agent files\n */\nfunction parseMarkdownAgent(content: string): AgentData {\n  // Extract frontmatter (between --- markers)\n  const frontmatterMatch = content.match(/^---\\n([\\s\\S]*?)\\n---/);\n  if (!frontmatterMatch) {\n    throw new Error('Invalid markdown: missing frontmatter');\n  }\n\n  const frontmatter = frontmatterMatch[1];\n  const body = content.substring(frontmatterMatch[0].length).trim();\n\n  // Parse YAML-like frontmatter\n  const parseFrontmatterField = (key: string): string | string[] => {\n    const regex = new RegExp(`^${key}:\\\\s*(.*)$`, 'm');\n    const match = frontmatter.match(regex);\n    if (!match) return key === 'tools' ? [] : '';\n\n    const value = match[1].trim();\n    if (key === 'tools') {\n      // Split comma-separated tools\n      return value\n        .split(',')\n        .map((t) => t.trim())\n        .filter((t) => t.length > 0);\n    }\n    return value;\n  };\n\n  const name = parseFrontmatterField('name') as string;\n  const description = parseFrontmatterField('description') as string;\n  const category = parseFrontmatterField('category') as string;\n  const tools = parseFrontmatterField('tools') as string[];\n\n  return {\n    name,\n    description,\n    tools,\n    category: category || 'Uncategorized',\n    systemPrompt: body,\n  };\n}\n\n/**\n * Tool name mapping from agent definitions to actual system tools\n */\nconst TOOL_MAPPING: Record<string, string[]> = {\n  // File system operations\n  'read': ['filesystem'],\n  'write': ['filesystem'],\n  'edit': ['filesystem'],\n  'multiEdit': ['filesystem'],\n  'grep': ['filesystem'],\n  \n  // Terminal/shell operations\n  'bash': ['terminal'],\n  'shell': ['terminal'],\n  'command': ['terminal'],\n  \n  // Web/browser operations\n  'browser': ['browser'],\n  'http': ['browser'],\n  'web': ['browser'],\n  \n  // Meta/system operations\n  'git': ['meta'],\n  'system': ['meta'],\n  'meta': ['meta'],\n};\n\n/**\n * Get available system tools\n */\nconst AVAILABLE_TOOLS = new Set(['filesystem', 'terminal', 'browser', 'meta']);\n\n/**\n * Filter tools to only include those that exist in the system\n * Maps agent tool names (Read, Write, Bash, etc.) to repo tools (filesystem, terminal, browser, meta)\n */\nfunction filterAvailableTools(tools: string[]): string[] {\n  const mapped = new Set<string>();\n  \n  for (const tool of tools) {\n    const normalized = tool.toLowerCase();\n    const mappedTools = TOOL_MAPPING[normalized];\n    \n    if (mappedTools) {\n      // Add all mapped tools that exist in the system\n      mappedTools.forEach((t) => {\n        if (AVAILABLE_TOOLS.has(t)) {\n          mapped.add(t);\n        }\n      });\n    } else {\n      // If no mapping found, try direct match (in case tool is already a system tool)\n      if (AVAILABLE_TOOLS.has(normalized)) {\n        mapped.add(normalized);\n      }\n    }\n  }\n  \n  return Array.from(mapped);\n}\n\n/**\n * Determines if an agent should have reasoning enabled based on description/tools\n */\nfunction shouldNeedReasoning(description: string, systemPrompt: string): boolean {\n  const reasoningKeywords = [\n    'analysis',\n    'complex',\n    'reasoning',\n    'planning',\n    'strategy',\n    'research',\n    'architect',\n  ];\n  const combined = `${description} ${systemPrompt}`.toLowerCase();\n  return reasoningKeywords.some((keyword) => combined.includes(keyword));\n}\n\n/**\n * Ingest agent markdown files from a directory into the Role table\n */\nexport async function ingestAgentLibrary(\n  agentsDir: string,\n  prisma: PrismaClient\n): Promise<{ created: number; updated: number; failed: number; errors: string[] }> {\n  const stats = { created: 0, updated: 0, failed: 0, errors: [] as string[] };\n  const createdNames = new Set<string>();\n\n  try {\n    // Read all .md files from the agents directory\n    const files = await fs.readdir(agentsDir);\n    const mdFiles = files.filter((f) => f.endsWith('.md'));\n\n    console.log(`Found ${mdFiles.length} agent files in ${agentsDir}`);\n\n    for (const file of mdFiles) {\n      try {\n        const filePath = path.join(agentsDir, file);\n        const content = await fs.readFile(filePath, 'utf-8');\n\n        const agentData = parseMarkdownAgent(content);\n\n        // Validate required fields\n        if (!agentData.name || !agentData.systemPrompt) {\n          stats.failed++;\n          stats.errors.push(`${file}: missing name or system prompt`);\n          continue;\n        }\n\n        const filteredTools = filterAvailableTools(agentData.tools);\n        const needsReasoning = shouldNeedReasoning(\n          agentData.description,\n          agentData.systemPrompt\n        );\n\n        // Manage RoleCategory\n        const categoryName = agentData.category || 'Uncategorized';\n        // Upsert permissionless, assuming name is unique\n        const category = await prisma.roleCategory.upsert({\n            where: { name: categoryName },\n            update: {},\n            create: { name: categoryName }\n        });\n\n        // Check if role already exists\n        const existing = await prisma.role.findUnique({\n          where: { name: agentData.name },\n        });\n\n        if (existing) {\n          // Update existing role\n          await prisma.role.update({\n            where: { name: agentData.name },\n              data: {\n                basePrompt: agentData.systemPrompt,\n                tools: filteredTools,\n                categoryId: category.id,\n                categoryString: categoryName,\n                metadata: {\n                  needsReasoning: needsReasoning,\n                },\n              } as any,\n          });\n          stats.updated++;\n          createdNames.add(agentData.name);\n        } else {\n           // Create new role\n           await prisma.role.create({\n             data: {\n                name: agentData.name,\n                basePrompt: agentData.systemPrompt,\n                tools: filteredTools,\n                categoryId: category.id,\n                categoryString: categoryName,\n                metadata: {\n                  needsReasoning: needsReasoning,\n                  minContext: 4096,\n                  maxContext: 128000,\n                },\n              } as any,\n           });\n           stats.created++;\n           createdNames.add(agentData.name);\n        }\n\n        console.log(`‚úì Ingested role: ${agentData.name}`);\n      } catch (error) {\n        stats.failed++;\n        const errorMsg = error instanceof Error ? error.message : String(error);\n        stats.errors.push(`${file}: ${errorMsg}`);\n        console.error(`‚úó Failed to ingest ${file}:`, errorMsg);\n      }\n    }\n  } catch (error) {\n    const errorMsg = error instanceof Error ? error.message : String(error);\n    stats.errors.push(`Directory read error: ${errorMsg}`);\n    console.error('Fatal error reading agents directory:', errorMsg);\n  }\n\n  return stats;\n}\n\n/**\n * Department detection based on package.json dependencies\n */\ninterface GeneratedRole {\n  name: string;\n  description: string;\n  tools: string[];\n  isManager: boolean;\n}\n\n/**\n * Recursively find all package.json files in a directory tree\n */\nasync function findPackageJsonFiles(rootPath: string): Promise<string[]> {\n  const packageJsonFiles: string[] = [];\n  \n  async function scan(dirPath: string): Promise<void> {\n    try {\n      const entries = await fs.readdir(dirPath, { withFileTypes: true });\n      \n      for (const entry of entries) {\n        const fullPath = path.join(dirPath, entry.name);\n        \n        // Skip node_modules and hidden directories\n        if (entry.name === 'node_modules' || entry.name.startsWith('.')) {\n          continue;\n        }\n        \n        if (entry.isDirectory()) {\n          await scan(fullPath);\n        } else if (entry.name === 'package.json') {\n          packageJsonFiles.push(fullPath);\n        }\n      }\n    } catch (error) {\n      // Skip directories we can't read\n      console.warn(`Could not read directory ${dirPath}:`, error);\n    }\n  }\n  \n  await scan(rootPath);\n  return packageJsonFiles;\n}\n\nasync function getTopFiles(dirPath: string, limit: number = 20): Promise<string[]> {\n    try {\n        const entries = await fs.readdir(dirPath, { withFileTypes: true });\n        const files = entries\n            .filter(e => e.isFile() && !e.name.startsWith('.'))\n            .map(e => e.name);\n        return files.slice(0, limit);\n    } catch (error) {\n        return [];\n    }\n}\n\n/**\n * Identify roles using AI\n */\nasync function identifyRolesWithAI(\n  dependencies: Record<string, string>,\n  fileList: string[],\n  pkgName: string\n): Promise<GeneratedRole[]> {\n  const providerManager = ProviderManager.getInstance();\n  \n  // Try to get gpt-4o-mini, or fallback to any model\n  // We'll search for a model with 'gpt-4o-mini' in ID or name, or just use first available\n  const allModels = await providerManager.getAllModels();\n  let modelId = allModels.find(m => m.id.includes('gpt-4o-mini'))?.id;\n  \n  if (!modelId && allModels.length > 0) {\n      modelId = allModels[0].id;\n  }\n  \n  if (!modelId) {\n      throw new Error(\"No AI models available for Role Ingestion\");\n  }\n  \n  // Find provider for this model\n  // Simplified lookup: we need the provider instance.\n  // We can iterate providers to find who owns this model.\n  // ProviderManager doesn't expose `getProviderForModel` directly efficiently,\n  // but we can guess or use `getProvider` if we know the provider ID.\n  // Actually, LLMModel interface has providerId.\n  const model = allModels.find(m => m.id === modelId);\n  const providerId = model?.providerId || model?.provider;\n\n  if (!providerId) {\n       throw new Error(`Provider not found for model ${modelId}`);\n  }\n  \n  const provider = providerManager.getProvider(providerId);\n  if (!provider) {\n      throw new Error(`Provider instance not found for ID ${providerId}`);\n  }\n\n  const prompt = `\n  You are a Corporate Recruiter for a software company.\n  Analyze the following project to determine the necessary team roles.\n\n  Project Name: ${pkgName}\n  Top Files: ${fileList.join(', ')}\n  Dependencies: ${JSON.stringify(dependencies, null, 2)}\n\n  Rule: If the directory/dependency list suggests a large or complex project (e.g. many frameworks, many files), create specialized 'Worker' roles (e.g., 'TailwindCSS Tweaker', 'API Schema Validator') and ONE 'Manager' role (e.g., 'Frontend Lead').\n  If simple, just one Manager role might suffice.\n\n  Output strictly a JSON array with this schema:\n  [{ \"name\": \"string\", \"description\": \"string\", \"tools\": [\"string\"], \"isManager\": boolean }]\n\n  Allowed tools: 'filesystem', 'terminal', 'browser'.\n  `;\n\n  try {\n      const response = await provider.generateCompletion({\n          modelId: modelId,\n          messages: [{ role: 'user', content: prompt }]\n      });\n\n      // Clean markdown code blocks if present\n      const jsonStr = response.replace(/```json\\n?|\\n?```/g, '').trim();\n      return JSON.parse(jsonStr);\n  } catch (error) {\n      console.error(\"AI Role Generation failed:\", error);\n      return [];\n  }\n}\n\n/**\n * Corporate Recruiter: Automatically staff the organization based on detected tech stacks\n * \n * This function scans a project directory for package.json files, identifies departments\n * based on dependencies, and creates specialized roles with tech-stack-specific prompts.\n */\nexport async function onboardProject(\n  rootPath: string,\n  prisma: PrismaClient\n): Promise<{ \n  scanned: number; \n  departments: number; \n  rolesCreated: number; \n  rolesUpdated: number;\n  errors: string[];\n}> {\n  const stats = {\n    scanned: 0,\n    departments: 0,\n    rolesCreated: 0,\n    rolesUpdated: 0,\n    errors: [] as string[],\n  };\n\n  console.log(`\\nüè¢ [Corporate Recruiter] Starting project onboarding...`);\n  console.log(`üìÇ Root Path: ${rootPath}\\n`);\n\n  try {\n    // Step 1: Find all package.json files\n    const packageJsonFiles = await findPackageJsonFiles(rootPath);\n    stats.scanned = packageJsonFiles.length;\n    \n    console.log(`üì¶ Found ${packageJsonFiles.length} package.json files`);\n\n    // Step 2: Analyze each package.json and identify roles via AI\n    // We will now iterate and process immediately instead of buffering \"departments\"\n    \n    for (const pkgPath of packageJsonFiles) {\n      try {\n        const dirPath = path.dirname(pkgPath);\n        const content = await fs.readFile(pkgPath, 'utf-8');\n        const pkg = JSON.parse(content) as { name?: string; dependencies?: Record<string, string>; devDependencies?: Record<string, string> };\n        \n        const allDeps: Record<string, string> = {\n          ...(pkg.dependencies || {}),\n          ...(pkg.devDependencies || {}),\n        };\n        \n        const fileList = await getTopFiles(dirPath);\n        \n        console.log(`  ü§ñ Asking AI to staff ${pkg.name || 'project'} in ${path.relative(rootPath, dirPath)}...`);\n        \n        // Call AI\n        const generatedRoles = await identifyRolesWithAI(allDeps, fileList, pkg.name || 'Unnamed Project');\n        \n        if (generatedRoles.length > 0) {\n            console.log(`  ‚úì AI suggested ${generatedRoles.length} roles.`);\n\n            // Step 3: Save to DB\n            for (const roleData of generatedRoles) {\n                 try {\n                    // Determine category (Generic \"AI Recruited\" for now, or derive from isManager)\n                    const categoryName = roleData.isManager ? 'Management' : 'Engineering';\n\n                    const category = await prisma.roleCategory.upsert({\n                        where: { name: categoryName },\n                        update: {},\n                        create: { name: categoryName },\n                    });\n\n                    const existing = await prisma.role.findUnique({\n                        where: { name: roleData.name },\n                    });\n\n                    const metadata = {\n                        needsReasoning: roleData.isManager, // Managers get reasoning\n                        needsCoding: true,\n                        minContext: 8192,\n                        maxContext: 128000,\n                        generatedBy: 'AI Recruiter',\n                        sourcePackage: pkgPath\n                    };\n\n                    if (existing) {\n                        await prisma.role.update({\n                            where: { name: roleData.name },\n                            data: {\n                                description: roleData.description,\n                                basePrompt: `You are ${roleData.name}. ${roleData.description}`,\n                                tools: roleData.tools,\n                                categoryId: category.id,\n                                categoryString: categoryName,\n                                metadata: metadata,\n                            } as any\n                        });\n                        stats.rolesUpdated++;\n                    } else {\n                        await prisma.role.create({\n                            data: {\n                                name: roleData.name,\n                                description: roleData.description,\n                                basePrompt: `You are ${roleData.name}. ${roleData.description}`,\n                                tools: roleData.tools,\n                                categoryId: category.id,\n                                categoryString: categoryName,\n                                metadata: metadata,\n                            } as any\n                        });\n                        stats.rolesCreated++;\n                    }\n                    console.log(`    - Processed Role: ${roleData.name} (${roleData.isManager ? 'Manager' : 'Worker'})`);\n\n                 } catch (err) {\n                     console.error(`    ‚úó Failed to save role ${roleData.name}:`, err);\n                 }\n            }\n        } else {\n            console.log(`  ? AI returned no roles for ${pkgPath}`);\n        }\n\n      } catch (error) {\n        const errorMsg = error instanceof Error ? error.message : String(error);\n        stats.errors.push(`Failed to process ${pkgPath}: ${errorMsg}`);\n        console.error(`  ‚úó Error processing ${pkgPath}:`, errorMsg);\n      }\n    }\n\n    console.log(`\\n‚úÖ [Corporate Recruiter] Onboarding complete!`);\n    console.log(`   üìä Stats:`);\n    console.log(`      - Package.json files scanned: ${stats.scanned}`);\n    console.log(`      - Departments identified: ${stats.departments}`);\n    console.log(`      - Roles created: ${stats.rolesCreated}`);\n    console.log(`      - Roles updated: ${stats.rolesUpdated}`);\n    if (stats.errors.length > 0) {\n      console.log(`      - Errors: ${stats.errors.length}`);\n    }\n\n  } catch (error) {\n    const errorMsg = error instanceof Error ? error.message : String(error);\n    stats.errors.push(`Fatal error: ${errorMsg}`);\n    console.error('‚ùå [Corporate Recruiter] Fatal error:', errorMsg);\n  }\n\n  return stats;\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/SelfImprovementService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":16,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":16,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[646,649],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[646,649],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":77,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":77,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2708,2711],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2708,2711],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":78,"column":62,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":78,"endColumn":69}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from 'fs/promises';\nimport path from 'path';\nimport { UnifiedIngestionService } from './UnifiedIngestionService.js';\n\nexport class SelfImprovementService {\n  private readonly ROOT_PATH = process.cwd(); // Targets the execution root (usually ./ in docker or project root)\n\n  // Configuration for the \"Ouroboros\" scope\n  private readonly TARGET_EXTENSIONS = ['.ts', '.js', '.json', '.md'];\n  private readonly IGNORED_DIRS = ['node_modules', 'dist', '.git', 'coverage', 'apps/api/dist'];\n\n  /**\n   * The Entry Point: Orchestrates the self-improvement cycle.\n   * Currently scoped to Step 1: Ingestion.\n   */\n  async autoImprove(): Promise<any> {\n    console.log('üêç Ouroboros Loop Initiated: Beginning Self-Ingestion.');\n\n    try {\n      // Step 1: Index the current codebase to update the Vector Store context\n      const fileCount = await this.indexCodebase();\n\n      console.log(`‚úÖ Self-Ingestion Complete. Indexed ${fileCount} files.`);\n\n      // Placeholder for Steps 2 & 3 (Assessment & Rewrite)\n      // await this.assessCodeQuality();\n      // await this.applyRefinements();\n\n      return { status: 'success', indexedFiles: fileCount };\n\n    } catch (error) {\n      console.error('‚ùå Ouroboros Loop Failed:', error);\n      // In the future, this triggers the Rollback mechanism\n      throw error;\n    }\n  }\n\n  /**\n   * Recursively crawls the file system and feeds data to the Ingestion Service.\n   */\n  private async indexCodebase(dir: string = this.ROOT_PATH): Promise<number> {\n    let processedCount = 0;\n    const entries = await fs.readdir(dir, { withFileTypes: true });\n\n    for (const entry of entries) {\n      const fullPath = path.join(dir, entry.name);\n\n      // Guardrails: Skip ignored directories\n      if (entry.isDirectory()) {\n        if (this.IGNORED_DIRS.includes(entry.name)) continue;\n        // Skip hidden directories (starting with .)\n        if (entry.name.startsWith('.')) continue;\n\n        processedCount += await this.indexCodebase(fullPath);\n        continue;\n      }\n\n      // Filter: Only ingest relevant source code and documentation\n      if (this.isValidFileType(entry.name)) {\n        await this.ingestFile(fullPath);\n        processedCount++;\n      }\n    }\n\n    return processedCount;\n  }\n\n  /**\n   * Reads the file and pushes it to UnifiedIngestionService.\n   * Wraps the ingestion to ensure the system doesn't crash on a single bad file.\n   */\n  private async ingestFile(filePath: string): Promise<void> {\n    try {\n      // We assume UnifiedIngestionService handles the logic of chunking and embedding\n      // We pass metadata 'isSystemSelfReflection: true' to distinguish these embeddings\n      await this.ingestFileContent(filePath);\n    } catch (err: any) {\n      console.warn(`Failed to ingest file: ${filePath}`, err.message);\n    }\n  }\n\n  /**\n   * Helper to bridge fs to the ingestion service.\n   * Assumes UnifiedIngestionService has a generic 'processContent' or similar.\n   */\n  private async ingestFileContent(filePath: string) {\n    const content = await fs.readFile(filePath, 'utf-8');\n    const relativePath = path.relative(this.ROOT_PATH, filePath);\n\n    // Call the existing service.\n    await UnifiedIngestionService.processContent({\n      source: relativePath,\n      content: content,\n      type: 'codebase',\n      metadata: {\n        isSelfReflection: true,\n        absolutePath: filePath,\n        extension: path.extname(filePath)\n      }\n    });\n  }\n\n  private isValidFileType(filename: string): boolean {\n    const ext = path.extname(filename);\n    return this.TARGET_EXTENSIONS.includes(ext);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/Surveyor.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":304,"column":22,"nodeType":"Property","messageId":"anyAssignment","endLine":304,"endColumn":41},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":304,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":304,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7604,7607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7604,7607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":314,"column":34,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":314,"endColumn":62},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":314,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":314,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7795,7798],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7795,7798],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .provider on an `any` value.","line":314,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":314,"endColumn":57}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * SURVEYOR SERVICE\n * \n * The \"Map of Florida\" - Uses regex patterns to instantly identify model capabilities\n * without burning tokens or making API calls. This is the FAST PATH for data collection.\n * \n * Strategy: Pattern matching on model names to infer specs\n * - 90% of models follow naming conventions (gemini-1.5-pro, gpt-4o, etc.)\n * - We can instantly map these to known capabilities\n * - Only unknown models need the slower \"Cartographer\" agent\n */\n\nexport interface ModelSpecs {\n  contextWindow?: number;\n  maxOutput?: number;\n  capabilities: string[]; // e.g. [\"text\", \"vision\", \"audio_in\", \"image_gen\", \"embedding\"]\n  costPer1k?: number;\n  rateLimit?: {\n    rpm?: number; // Requests per minute\n    tpm?: number; // Tokens per minute\n    rpd?: number; // Requests per day\n  };\n}\n\ninterface ProviderPattern {\n  pattern: RegExp;\n  specs: ModelSpecs;\n}\n\n/**\n * THE ZONING MAP\n * Each provider has \"zones\" - model families with shared characteristics\n */\nconst PROVIDER_PATTERNS: Record<string, ProviderPattern[]> = {\n  // ===== GOOGLE =====\n  google: [\n    {\n      pattern: /gemini-2\\.0-flash-exp/i,\n      specs: {\n        contextWindow: 1000000,\n        maxOutput: 8192,\n        capabilities: [\"text\", \"vision\", \"audio_in\", \"video_in\", \"tool_use\"],\n        costPer1k: 0, // Free tier\n        rateLimit: { rpm: 10, tpm: 4000000, rpd: 1500 }\n      }\n    },\n    {\n      pattern: /gemini-1\\.5-pro/i,\n      specs: {\n        contextWindow: 2000000,\n        maxOutput: 8192,\n        capabilities: [\"text\", \"vision\", \"audio_in\", \"video_in\", \"tool_use\"],\n        costPer1k: 1.25, // $1.25 per 1M input tokens\n        rateLimit: { rpm: 360, tpm: 4000000 }\n      }\n    },\n    {\n      pattern: /gemini-1\\.5-flash/i,\n      specs: {\n        contextWindow: 1000000,\n        maxOutput: 8192,\n        capabilities: [\"text\", \"vision\", \"audio_in\", \"tool_use\"],\n        costPer1k: 0.075, // $0.075 per 1M input tokens\n        rateLimit: { rpm: 1000, tpm: 4000000 }\n      }\n    },\n    {\n      pattern: /gemini-pro-vision/i,\n      specs: {\n        contextWindow: 16384,\n        capabilities: [\"text\", \"vision\"],\n        costPer1k: 0.25\n      }\n    },\n    {\n      pattern: /text-embedding/i,\n      specs: {\n        contextWindow: 2048,\n        capabilities: [\"embedding\"],\n        costPer1k: 0.00001 // Very cheap\n      }\n    }\n  ],\n\n  // ===== OPENAI =====\n  openai: [\n    {\n      pattern: /gpt-4o/i,\n      specs: {\n        contextWindow: 128000,\n        maxOutput: 16384,\n        capabilities: [\"text\", \"vision\", \"tool_use\"],\n        costPer1k: 2.50,\n        rateLimit: { rpm: 10000, tpm: 30000000 }\n      }\n    },\n    {\n      pattern: /gpt-4-turbo/i,\n      specs: {\n        contextWindow: 128000,\n        maxOutput: 4096,\n        capabilities: [\"text\", \"vision\", \"tool_use\"],\n        costPer1k: 10.00\n      }\n    },\n    {\n      pattern: /gpt-3\\.5-turbo/i,\n      specs: {\n        contextWindow: 16385,\n        maxOutput: 4096,\n        capabilities: [\"text\", \"tool_use\"],\n        costPer1k: 0.50\n      }\n    },\n    {\n      pattern: /dall-e/i,\n      specs: {\n        capabilities: [\"image_gen\"],\n        costPer1k: 20.00 // Per image, not per token\n      }\n    },\n    {\n      pattern: /tts/i,\n      specs: {\n        capabilities: [\"text_to_speech\"],\n        costPer1k: 15.00 // Per 1M characters\n      }\n    },\n    {\n      pattern: /whisper/i,\n      specs: {\n        capabilities: [\"speech_to_text\"],\n        costPer1k: 6.00 // Per minute\n      }\n    },\n    {\n      pattern: /text-embedding/i,\n      specs: {\n        contextWindow: 8191,\n        capabilities: [\"embedding\"],\n        costPer1k: 0.02\n      }\n    }\n  ],\n\n  // ===== ANTHROPIC =====\n  anthropic: [\n    {\n      pattern: /claude-3\\.5-sonnet/i,\n      specs: {\n        contextWindow: 200000,\n        maxOutput: 8192,\n        capabilities: [\"text\", \"vision\", \"tool_use\"],\n        costPer1k: 3.00,\n        rateLimit: { rpm: 50, tpm: 40000 }\n      }\n    },\n    {\n      pattern: /claude-3-opus/i,\n      specs: {\n        contextWindow: 200000,\n        maxOutput: 4096,\n        capabilities: [\"text\", \"vision\", \"tool_use\"],\n        costPer1k: 15.00\n      }\n    },\n    {\n      pattern: /claude-3-haiku/i,\n      specs: {\n        contextWindow: 200000,\n        maxOutput: 4096,\n        capabilities: [\"text\", \"vision\", \"tool_use\"],\n        costPer1k: 0.25\n      }\n    }\n  ],\n\n  // ===== MISTRAL =====\n  mistral: [\n    {\n      pattern: /mistral-large/i,\n      specs: {\n        contextWindow: 128000,\n        maxOutput: 4096,\n        capabilities: [\"text\", \"tool_use\"],\n        costPer1k: 2.00\n      }\n    },\n    {\n      pattern: /mistral-medium/i,\n      specs: {\n        contextWindow: 32000,\n        capabilities: [\"text\"],\n        costPer1k: 0.70\n      }\n    },\n    {\n      pattern: /mistral-small/i,\n      specs: {\n        contextWindow: 32000,\n        capabilities: [\"text\"],\n        costPer1k: 0.20\n      }\n    },\n    {\n      pattern: /codestral/i,\n      specs: {\n        contextWindow: 32000,\n        capabilities: [\"text\", \"code\"],\n        costPer1k: 0.30\n      }\n    }\n  ],\n\n  // ===== GROQ =====\n  groq: [\n    {\n      pattern: /llama.*70b/i,\n      specs: {\n        contextWindow: 8192,\n        capabilities: [\"text\"],\n        costPer1k: 0, // Free tier\n        rateLimit: { rpm: 30, tpm: 6000, rpd: 14400 }\n      }\n    },\n    {\n      pattern: /llama.*8b/i,\n      specs: {\n        contextWindow: 8192,\n        capabilities: [\"text\"],\n        costPer1k: 0,\n        rateLimit: { rpm: 30, tpm: 7000, rpd: 14400 }\n      }\n    },\n    {\n      pattern: /mixtral/i,\n      specs: {\n        contextWindow: 32768,\n        capabilities: [\"text\"],\n        costPer1k: 0,\n        rateLimit: { rpm: 30, tpm: 5000, rpd: 14400 }\n      }\n    }\n  ],\n\n  // ===== OLLAMA (Local) =====\n  ollama: [\n    {\n      pattern: /.*/i, // Catch-all for local models\n      specs: {\n        contextWindow: 4096, // Conservative default\n        capabilities: [\"text\"],\n        costPer1k: 0, // Local = free\n        rateLimit: { rpm: 1000, tpm: 1000000 } // No real limits for local\n      }\n    }\n  ]\n};\n\nexport class Surveyor {\n  /**\n   * Inspect a model and return its specs if we can identify it via patterns\n   * @returns ModelSpecs if identified, null if unknown (needs Cartographer)\n   */\n  static inspect(provider: string, modelName: string): ModelSpecs | null {\n    const providerKey = provider.toLowerCase();\n    const rules = PROVIDER_PATTERNS[providerKey] || [];\n    \n    // Try each pattern for this provider\n    for (const rule of rules) {\n      if (rule.pattern.test(modelName)) {\n        console.log(`[Surveyor] ‚úÖ Identified ${provider}/${modelName} via pattern`);\n        return rule.specs;\n      }\n    }\n    \n    // Special case: Extract context window from model name (e.g., \"model-128k\")\n    const contextMatch = modelName.match(/(\\d+)k/i);\n    if (contextMatch) {\n      const contextK = parseInt(contextMatch[1]);\n      console.log(`[Surveyor] üîç Inferred ${contextK}k context from model name`);\n      return {\n        contextWindow: contextK * 1024,\n        capabilities: [\"text\"]\n      };\n    }\n    \n    console.log(`[Surveyor] ‚ùì Unknown model: ${provider}/${modelName} - needs Cartographer`);\n    return null;\n  }\n\n  /**\n   * Bulk survey: Apply patterns to all models in the registry\n   * @returns Count of models successfully surveyed\n   */\n  static async surveyAll(): Promise<{ surveyed: number; unknown: number }> {\n    const { prisma } = await import('../db.js');\n    \n    // Find all models with missing specs\n    const models = await prisma.model.findMany({\n      where: {\n        OR: [\n          { specs: { equals: {} } },\n          { specs: { equals: null as any } }\n        ]\n      },\n      include: { provider: true }\n    });\n\n    let surveyed = 0;\n    let unknown = 0;\n\n    for (const model of models) {\n      const specs = this.inspect((model as any).provider.type, model.modelId);\n      \n      if (specs) {\n        // Update the model with surveyed specs\n        await prisma.model.update({\n          where: { id: model.id },\n          data: {\n            specs: {\n              ...specs,\n              source: 'surveyor',\n              surveyedAt: new Date().toISOString()\n            },\n            capabilityTags: specs.capabilities\n          }\n        });\n        surveyed++;\n      } else {\n        unknown++;\n      }\n    }\n\n    console.log(`[Surveyor] üìä Survey complete: ${surveyed} identified, ${unknown} unknown`);\n    return { surveyed, unknown };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/ToolDocumenter.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":11,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[306,309],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[306,309],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":80,"column":47,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":80,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":80,"column":55,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":80,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":81,"column":43,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":81,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":156,"column":18,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":156,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":157,"column":46,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":157,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":157,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":157,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":159,"column":18,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":159,"endColumn":66},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":159,"column":25,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":159,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":159,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":159,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .replace on an `any` value.","line":159,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":159,"endColumn":54}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from 'fs/promises';\nimport path from 'path';\nimport { Client } from '@modelcontextprotocol/sdk/client/index.js';\nimport { ProviderManager } from './ProviderManager.js';\n\ninterface Tool {\n  name: string;\n  description?: string;\n  inputSchema?: {\n    type?: string;\n    properties?: Record<string, any>;\n    required?: string[];\n  };\n}\n\nexport class ToolDocumenter {\n  // We'll try to resolve to the project root.\n  private static get STORAGE_PATH() {\n    let root = process.cwd();\n    if (root.endsWith('apps/api')) {\n        root = path.resolve(root, '../../');\n    }\n    const p = path.resolve(root, '.domoreai/tools');\n    console.log('[ToolDocumenter] Storage Path:', p);\n    return p;\n  }\n\n  static async documentServer(serverName: string, client: Client) {\n    try {\n      const result = await client.listTools();\n      const tools = result.tools as Tool[];\n      await this.documentTools(serverName, tools);\n    } catch (error) {\n      console.error(`[ToolDocumenter] Failed to document server ${serverName}:`, error);\n    }\n  }\n\n  static async documentTools(sourceName: string, tools: Tool[]) {\n    try {\n      // Ensure directory exists\n      await fs.mkdir(this.STORAGE_PATH, { recursive: true });\n      \n      if (!tools || tools.length === 0) return;\n\n      // 1. Generate Type Definitions\n      const typeDefs = this.generateTypeDefinitions(sourceName, tools);\n      await fs.writeFile(path.join(this.STORAGE_PATH, `${sourceName}.d.ts`), typeDefs);\n\n      // 2. Generate Comprehensive Documentation\n      const documentation = await this.generateDocumentation(sourceName, tools);\n      await fs.writeFile(path.join(this.STORAGE_PATH, `${sourceName}_examples.md`), documentation);\n      \n      console.log(`[ToolDocumenter] Generated documentation for ${sourceName}`);\n    } catch (error) {\n      console.error(`[ToolDocumenter] Failed to document tools for ${sourceName}:`, error);\n    }\n  }\n\n  private static generateTypeDefinitions(serverName: string, tools: Tool[]): string {\n    const lines: string[] = [];\n    \n    lines.push(`// Type definitions for ${serverName}`);\n    lines.push(`// Generated by ToolDocumenter`);\n    lines.push('');\n    lines.push('declare namespace system {');\n\n    for (const tool of tools) {\n      const toolName = `${serverName}_${tool.name}`;\n      const interfaceName = `${this.capitalize(serverName)}${this.capitalize(tool.name)}Args`;\n      \n      // Generate Interface from JSON Schema\n      const schema = tool.inputSchema;\n      const props: string[] = [];\n      \n      if (schema && schema.properties) {\n        for (const [key, value] of Object.entries(schema.properties)) {\n          // Cast value to any or check type\n          if (typeof value === 'object' && value !== null && 'type' in (value)) {\n            const isOptional = !schema.required?.includes(key);\n            const type = this.mapJsonTypeToTs((value).type);\n            props.push(`    /** ${(value).description || ''} */`);\n            props.push(`    ${key}${isOptional ? '?' : ''}: ${type};`);\n          }\n        }\n      }\n\n      lines.push(`  interface ${interfaceName} {`);\n      lines.push(props.join('\\n'));\n      lines.push(`  }`);\n      lines.push('');\n      lines.push(`  /**`);\n      lines.push(`   * ${tool.description || 'No description provided.'}`);\n      lines.push(`   */`);\n      lines.push(`  function ${toolName}(args: ${interfaceName}): Promise<any>;`);\n      lines.push('');\n    }\n\n    lines.push('}');\n    return lines.join('\\n');\n  }\n\n  private static async generateDocumentation(serverName: string, tools: Tool[]): Promise<string> {\n    const docs: string[] = [];\n\n    // [NEW] Strategic Selection\n    // Documentation is a \"Heavy Context\" task. We need big windows.\n    let model = null;\n    try {\n        const allModels = await ProviderManager.getAllModels();\n        \n        // 1. Filter for models with > 32k context\n        // 2. Sort by Cost (Free first) -> Then by Context Size (Descending)\n        const capableModels = allModels\n            .filter(m => ((m.specs?.contextWindow || 0) >= 32000))\n            .sort((a, b) => {\n                // Primary Sort: Cost (Ascending) - prioritize Free\n                if ((a.costPer1k || 0) !== (b.costPer1k || 0)) return (a.costPer1k || 0) - (b.costPer1k || 0);\n                // Secondary Sort: Context (Descending) - get the biggest window available for that price\n                return ((b.specs?.contextWindow || 0) - (a.specs?.contextWindow || 0));\n            });\n\n        model = capableModels[0] || allModels[0];\n\n        if (model) {\n            console.log(`üìö Tool Documenter using: ${model.id} (Context: ${model.specs?.contextWindow || 'unknown'})`);\n        } else {\n            console.warn(\"‚ö†Ô∏è No suitable model found for Tool Documentation. Defaulting to system fallback.\");\n        }\n    } catch (e) {\n        console.warn('[ToolDocumenter] Failed to load models for smart documentation:', e);\n    }\n\n    for (const tool of tools) {\n      const toolName = serverName === 'system' ? tool.name : `${serverName}_${tool.name}`;\n      const interfaceName = `${this.capitalize(serverName)}${this.capitalize(tool.name)}Args`;\n      \n      docs.push(`### Tool: \\`system.${toolName}\\``);\n      docs.push(`**Description:** ${tool.description || 'No description provided.'}`);\n      docs.push('');\n      \n      // Signature\n      docs.push('**Signature:**');\n      docs.push('```typescript');\n      docs.push(`await system.${toolName}(args: ${interfaceName})`);\n      docs.push('```');\n      docs.push('');\n\n      // Arguments Table\n      docs.push('**Arguments:**');\n      docs.push('| Name | Type | Required | Description |');\n      docs.push('|------|------|----------|-------------|');\n      \n      const schema = tool.inputSchema;\n      if (schema && schema.properties) {\n        for (const [key, value] of Object.entries(schema.properties)) {\n           const v = value;\n           const type = this.mapJsonTypeToTs(v.type);\n           const required = schema.required?.includes(key) ? 'Yes' : 'No';\n           const desc = (v.description || '').replace(/\\n/g, ' ');\n           docs.push(`| \\`${key}\\` | \\`${type}\\` | ${required} | ${desc} |`);\n        }\n      } else {\n        docs.push('| - | - | - | No arguments |');\n      }\n      docs.push('');\n\n      // Usage Example\n      docs.push('**Usage Example:**');\n      docs.push('```typescript');\n      \n      let exampleCode = `// Call ${toolName}\\nawait system.${toolName}({ /* args */ });`;\n\n      if (model) {\n        try {\n            const provider = ProviderManager.getProvider(model.providerId || '');\n            if (provider) {\n                const prompt = `\n                You are an expert TypeScript developer.\n                I have a tool named \"system.${toolName}\".\n                Description: ${tool.description}\n                Input Schema: ${JSON.stringify(tool.inputSchema)}\n\n                Write a realistic, executable TypeScript code block showing how to use this tool in a \"Code Mode\" environment.\n                - Use top-level await or an async function.\n                - Include comments explaining the step.\n                - Do NOT wrap in markdown code blocks (I will add them).\n                - Keep it concise (3-5 lines).\n                `;\n\n                const response = await provider.generateCompletion({\n                    modelId: model.id,\n                    messages: [{ role: 'user', content: prompt }],\n                    temperature: 0.2,\n                    max_tokens: 200\n                });\n                \n                exampleCode = response.trim().replace(/^```typescript\\n|^```ts\\n|^```/g, '').replace(/```$/g, '');\n            }\n        } catch (e) {\n            console.warn(`[ToolDocumenter] Failed to generate smart example for ${toolName}`, e);\n        }\n      }\n\n      docs.push(exampleCode);\n      docs.push('```');\n      docs.push('');\n      docs.push('---');\n      docs.push('');\n    }\n\n    return docs.join('\\n');\n  }\n\n  private static capitalize(s: string): string {\n    return s.charAt(0).toUpperCase() + s.slice(1);\n  }\n\n  private static mapJsonTypeToTs(type: string): string {\n    switch (type) {\n      case 'string': return 'string';\n      case 'integer': return 'number';\n      case 'number': return 'number';\n      case 'boolean': return 'boolean';\n      case 'array': return 'any[]';\n      case 'object': return 'any';\n      default: return 'any';\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/UnifiedIngestionService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[971,974],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[971,974],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":31,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":31,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":31,"column":13,"nodeType":"Identifier","messageId":"unsafeCall","endLine":31,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":33,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":38,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient, Prisma } from '@prisma/client';\nimport fs from 'fs/promises';\nimport path from 'path';\nimport { chunkText, createEmbedding, vectorStore } from './vector.service.js';\nimport { v4 as uuidv4 } from 'uuid';\n\nconst prisma = new PrismaClient();\n\nconst MAPPINGS: Record<string, { contextPath: string; namePath: string; idPath: string; pricingPath?: string }> = {\n  google: { contextPath: 'inputTokenLimit', namePath: 'displayName', idPath: 'name' },\n  openrouter: { contextPath: 'context_length', namePath: 'name', idPath: 'id', pricingPath: 'pricing' },\n  groq: { contextPath: 'context_window', namePath: 'id', idPath: 'id' },\n  ollama: { contextPath: 'details.context_length', namePath: 'name', idPath: 'name' },\n  mistral: { contextPath: 'max_context_length', namePath: 'name', idPath: 'id' }\n};\n\nexport class UnifiedIngestionService {\n\n  static async processContent(payload: {\n    source: string;\n    content: string;\n    type: string;\n    metadata?: any\n  }): Promise<void> {\n    const chunks = chunkText(payload.content);\n    const vectors = [];\n\n    for (const chunk of chunks) {\n      const embedding = await createEmbedding(chunk);\n      vectors.push({\n        id: uuidv4(),\n        vector: embedding,\n        metadata: {\n          ...payload.metadata,\n          source: payload.source,\n          type: payload.type,\n          chunk: chunk // duplicating content in metadata as per vector.service example\n        }\n      });\n    }\n\n    await vectorStore.add(vectors);\n  }\n  \n  static async ingestAllModels(modelsDir?: string): Promise<void> {\n    const targetDir = modelsDir || path.join(process.cwd(), 'latest_models');\n    let files: string[] = [];\n    try { files = await fs.readdir(targetDir); } catch { return; }\n\n    console.log(`üöÄ Starting Unified Ingestion...`);\n\n    // PHASE 1: Raw Data Lake (Anti-Corruption)\n    // We save the file content FIRST. If the app crashes later, we still have this.\n    const rawRecords = [];\n    for (const file of files) {\n      if (!file.endsWith('.json')) continue;\n      const providerMatch = file.match(/^(google|openrouter|groq|ollama|mistral)/);\n      if (!providerMatch) continue;\n      \n      const providerName = providerMatch[1];\n      const content = await fs.readFile(path.join(targetDir, file), 'utf-8');\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const rawData = JSON.parse(content) as Record<string, unknown> | Record<string, unknown>[]; // Parsing only to validate JSON validity\n\n      // Insert into RawDataLake\n      const record = await prisma.rawDataLake.create({\n        data: {\n          provider: providerName,\n          fileName: file,\n          rawData: rawData as Prisma.JsonObject, // <--- THE SOURCE OF TRUTH\n          processed: false\n        }\n      });\n      rawRecords.push({ id: record.id, provider: providerName, rawData });\n    }\n\n    // PHASE 2: Application Processing (Gatekeeper)\n    let totalIngested = 0;\n    \n    for (const { id, provider, rawData } of rawRecords) {\n        const mapping = MAPPINGS[provider] || MAPPINGS['openrouter'];\n        const castRaw = rawData; \n        const modelList = Array.isArray(castRaw) ? castRaw : ((castRaw.data || castRaw.models || []) as Record<string, unknown>[]);\n        \n        const providerConfig = await this.ensureProviderConfig(provider);\n\n        for (const raw of modelList) {\n            const modelIdRaw = this.resolvePath(raw, mapping.idPath);\n            if (typeof modelIdRaw !== 'string' && typeof modelIdRaw !== 'number') continue;\n            const modelId = String(modelIdRaw); // Force string\n\n            // --- CRITICAL: PRICING & FILTERING LOGIC ---\n            // 1. Is it a \"Fail-Open\" Provider? (Groq, Google, Ollama, Mistral) -> ALWAYS FREE\n            // 2. Is it OpenRouter? -> CHECK PRICING OBJECT\n            const isFree = this.checkIsFree(provider, raw);\n\n            // cspell:ignore Gatekeeping\n            // Gatekeeping: If OpenRouter AND Paid, SKIP IT.\n            if (provider === 'openrouter' && !isFree) {\n                continue; \n            }\n\n            // Normalization\n            const contextWindow = (this.resolvePath(raw, mapping.contextPath) as number) || 4096;\n            const nameRaw = this.resolvePath(raw, mapping.namePath);\n            const name = (typeof nameRaw === 'string' || typeof nameRaw === 'number') ? String(nameRaw) : modelId;\n            const isMultimodal = JSON.stringify(raw).toLowerCase().includes('vision');\n\n            // 3. CAPABILITY EXTRACTION\n            const modelIdLower = modelId.toLowerCase();\n            const rawStr = JSON.stringify(raw).toLowerCase();\n            const capsData = {\n                contextWindow,\n                maxOutput: 4096,\n                hasVision: isMultimodal || modelIdLower.includes('vision') || modelIdLower.includes('vl'),\n                hasAudioInput: modelIdLower.includes('audio') || modelIdLower.includes('whisper'),\n                hasAudioOutput: modelIdLower.includes('tts') || rawStr.includes('text-to-speech'),\n                hasTTS: modelIdLower.includes('tts'),\n                hasImageGen: modelIdLower.includes('dall-e') || modelIdLower.includes('imagen'),\n                isMultimodal,\n                supportsFunctionCalling: rawStr.includes('function') || rawStr.includes('tool'),\n                supportsJsonMode: rawStr.includes('json_mode') || rawStr.includes('json')\n            };\n\n            // 4. UPSERT WITH CAPABILITIES (The Missing Link)\n            await prisma.model.upsert({\n                where: { providerId_modelId: { providerId: providerConfig.id, modelId } },\n                create: {\n                    providerId: providerConfig.id,\n                    modelId,\n                    name,\n                    isFree: true, // It passed the gate, so it's free/allowed\n                    isActive: true,\n                    providerData: raw as Prisma.JsonObject, // Store copy here for fast access\n                    specs: { contextWindow, isMultimodal }, // Deprecated but populated for safety\n                    source: 'INDEX',\n                    // [UPDATED] Create the relation immediately\n                    capabilities: {\n                        create: capsData\n                    }\n                },\n                update: {\n                    isActive: true,\n                    isFree: true,\n                    providerData: raw as Prisma.JsonObject,\n                    lastSeenAt: new Date(),\n                    // [UPDATED] Update the relation\n                    capabilities: {\n                        upsert: {\n                            create: capsData,\n                            update: capsData\n                        }\n                    }\n                }\n            });\n            totalIngested++;\n        }\n        // Mark Raw Record Processed\n        await prisma.rawDataLake.update({ where: { id }, data: { processed: true } });\n    }\n    console.log(`‚úÖ Ingestion Complete. Available Models: ${totalIngested}`);\n  }\n\n  // The Logic you specifically asked for\n  private static checkIsFree(provider: string, raw: Record<string, unknown>): boolean {\n      // Whitelist\n      if (['groq', 'ollama', 'mistral', 'google'].includes(provider)) return true;\n\n      // Strict OpenRouter Check\n      if (provider === 'openrouter') {\n          // If pricing is missing, assume paid.\n          const pricing = raw.pricing as Record<string, unknown> | undefined;\n          if (!pricing) return false;\n          \n          // Cast values to ensure we aren't fooled by strings\n          const prompt = Number(pricing.prompt);\n          const completion = Number(pricing.completion);\n          \n          // EXACT ZERO CHECK\n          return prompt === 0 && completion === 0;\n      }\n      return false;\n  }\n\n  // Helpers\n  private static resolvePath(obj: Record<string, unknown>, path: string): unknown {\n      return path.split('.').reduce((o: unknown, k) => {\n          if (o && typeof o === 'object' && k in o) {\n             return (o as Record<string, unknown>)[k];\n          }\n          return undefined;\n      }, obj);\n  }\n\n  private static async ensureProviderConfig(type: string) {\n      const existing = await prisma.providerConfig.findFirst({ where: { type } });\n      if (existing) return existing;\n      return await prisma.providerConfig.create({\n          data: { label: type, type, baseURL: '', apiKey: 'PLACEHOLDER', isEnabled: true }\n      });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/UsageCollector.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/agent.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'IAgent' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'VolcanoAgent' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":82,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":82,"endColumn":66},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":82,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2888,2891],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2888,2891],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":83,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":83,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":83,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":83,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":83,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":83,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string[]`.","line":86,"column":60,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":86,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":91,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":91,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .basePrompt on an `any` value.","line":91,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":91,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":94,"column":11,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":94,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":114,"column":13,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":114,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .basePrompt on an `any` value.","line":114,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":114,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":155,"column":9,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":155,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":155,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":155,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5208,5211],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5208,5211],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":168,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5617,5620],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5617,5620],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .column_name on an `any` value.","line":173,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":173,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .data_type on an `any` value.","line":173,"column":50,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":173,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":178,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":180,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":178,"column":25,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":180,"endColumn":15},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":178,"column":25,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":179,"endColumn":15},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .basePrompt on an `any` value.","line":178,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":178,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .replace on an `any` value.","line":179,"column":8,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":179,"endColumn":15},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .replace on an `any` value.","line":180,"column":8,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":180,"endColumn":15},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | undefined`.","line":185,"column":42,"nodeType":"ChainExpression","messageId":"unsafeArgument","endLine":185,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":185,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":185,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":207,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":207,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultTemperature on an `any` value.","line":207,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":207,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":208,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":208,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultMaxTokens on an `any` value.","line":208,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":208,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":229,"column":52,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":229,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerId on an `any` value.","line":229,"column":66,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":229,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerId on an `any` value.","line":232,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":232,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":237,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":237,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .modelId on an `any` value.","line":237,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":237,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":238,"column":38,"nodeType":"Property","messageId":"anyAssignment","endLine":238,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":239,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":239,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .temperature on an `any` value.","line":239,"column":38,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":239,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":240,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":240,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .maxTokens on an `any` value.","line":240,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":240,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":255,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":255,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8487,8490],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8487,8490],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":256,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":256,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":256,"column":56,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":256,"endColumn":63},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .modelId on an `any` value.","line":258,"column":71,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":258,"endColumn":78},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerId on an `any` value.","line":258,"column":97,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":258,"endColumn":107},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":266,"column":15,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":266,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerId on an `any` value.","line":266,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":266,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":267,"column":15,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":267,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .modelId on an `any` value.","line":267,"column":29,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":267,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | undefined`.","line":268,"column":15,"nodeType":"ChainExpression","messageId":"unsafeArgument","endLine":268,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":268,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":268,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":270,"column":41,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":270,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerId on an `any` value.","line":270,"column":55,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":270,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | undefined`.","line":270,"column":67,"nodeType":"ChainExpression","messageId":"unsafeArgument","endLine":270,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":270,"column":73,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":270,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":279,"column":41,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":279,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerId on an `any` value.","line":279,"column":55,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":279,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":280,"column":34,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":280,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerId on an `any` value.","line":280,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":280,"endColumn":58},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":283,"column":38,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":283,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .modelId on an `any` value.","line":283,"column":52,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":283,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":284,"column":31,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":284,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .modelId on an `any` value.","line":284,"column":45,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":284,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | undefined`.","line":289,"column":15,"nodeType":"ChainExpression","messageId":"unsafeArgument","endLine":289,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":289,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":289,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | undefined`.","line":310,"column":17,"nodeType":"ChainExpression","messageId":"unsafeArgument","endLine":310,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":310,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":310,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":315,"column":15,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":315,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":315,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":315,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10766,10769],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10766,10769],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .modelId on an `any` value.","line":317,"column":73,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":317,"endColumn":80},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .providerId on an `any` value.","line":317,"column":99,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":317,"endColumn":109}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":71,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from \"zod\";\nimport { AgentRuntime } from \"./AgentRuntime.js\";\nimport { type IAgent } from \"../interfaces/IAgent.js\";\nimport { type CardAgentState } from \"../types.js\";\nimport { createVolcanoAgent, VolcanoAgent } from \"./AgentFactory.js\";\nimport { ProviderManager } from \"./ProviderManager.js\";\nimport { prisma } from \"../db.js\";\nimport {\n  getBestModel,\n  recordModelFailure,\n  recordProviderFailure,\n} from \"./modelManager.service.js\";\n\nexport const startSessionSchema = z.object({\n  roleId: z.string(),\n  modelConfig: z.object({\n    providerId: z.string().optional(),\n    modelId: z.string().optional(),\n    temperature: z.number().min(0).max(2).default(0.7),\n    maxTokens: z.number().int().min(256).max(32000).default(2048),\n  }),\n  userGoal: z.string().min(1, \"User goal/prompt is required\"),\n  cardId: z.string(),\n  context: z\n    .object({\n      targetDir: z.string().optional(),\n    })\n    .optional(),\n});\n\nexport type StartSessionInput = z.infer<typeof startSessionSchema>;\n\nconst BASE_PROMPT_SQL_HELPER = `\nYou are an expert PostgreSQL Query Generator. Your task is to translate the user's natural language request into a single, clean SQL query that can be executed against the available database tables.\n\nThe user is querying the following table schemas:\n[TABLE_SCHEMAS_CONTEXT]\n\nUser Request: [USER_PROMPT]\n\nConstraints:\n1. Only output the raw SQL query text. Do NOT include any markdown, commentary, or explanation (e.g., do not use \\`\\`\\`sql ... \\`\\`\\`).\n2. Only use SELECT statements. Do not use INSERT, DELETE, DROP, or ALTER.\n`;\n\nexport class AgentService {\n  async startSession(input: StartSessionInput) {\n    const { roleId, modelConfig, userGoal, cardId, context } = input;\n\n    try {\n      // 1.5 Fetch Workspace Prompt\n      const card = await prisma.workOrderCard.findUnique({\n        where: { id: cardId },\n        include: { workspace: true },\n      });\n      const projectPrompt = card?.systemPrompt || undefined;\n\n      // Prepend context if available\n      let finalUserGoal = userGoal;\n      if (context?.targetDir) {\n        finalUserGoal = `Context: Target Directory: ${context.targetDir}\\n\\n${userGoal}`;\n      }\n\n      // 1. Create the agent configuration\n      const agentConfig: CardAgentState = {\n        roleId,\n        modelId: modelConfig.modelId || null,\n        isLocked: !!modelConfig.modelId, // Lock if model is explicitly provided\n        temperature: modelConfig.temperature,\n        maxTokens: modelConfig.maxTokens,\n        userGoal: finalUserGoal, // Pass user goal for memory injection\n        projectPrompt,\n      };\n\n      // 2. Create the Volcano agent\n      const agent = await createVolcanoAgent(agentConfig);\n\n      // 2.5 Fetch Role to get Tools and other defaults\n      const roleRecord = await prisma.role.findUnique({\n        where: { id: roleId },\n      });\n      const role = roleRecord ? ({ ...roleRecord } as any) : null;\n      const tools = role && role.tools ? role.tools : [];\n\n      // 3. Create the agent runtime with selected tools\n      const runtime = await AgentRuntime.create(undefined, tools);\n\n      // 4. Define the LLM callback that uses our Volcano agent and enriches\n      //    the system prompt with role context from the runtime's ContextManager.\n      const llmCallback = async (prompt: string): Promise<string> => {\n        const basePrompt = role?.basePrompt || \"\";\n        return (await runtime.generateWithContext(\n          agent,\n          basePrompt,\n          prompt,\n          roleId\n        )) as string;\n      };\n\n      // 5. Start the agent loop (Synchronous for now to ensure UI update)\n      const sessionId = `session-${cardId}-${Date.now()}`;\n\n      // Get initial response first\n      const initialResponse = await llmCallback(userGoal);\n\n      // Execute the agent loop and wait for result\n      const { result, logs } = await runtime.runAgentLoop(\n        userGoal,\n        initialResponse,\n        async (retryPrompt: string) => {\n          // Regenerate with the retry prompt\n          const retryResponse = await runtime.generateWithContext(\n            agent,\n            role?.basePrompt || \"\",\n            retryPrompt,\n            roleId\n          );\n          return retryResponse as string;\n        }\n      );\n\n      console.log(`[AgentService] Session ${sessionId} Completed.`);\n\n      // Get the actual model used\n      const usedConfig = agent.getConfig();\n\n      // 6. Return session info and result immediately\n      return {\n        sessionId,\n        status: \"completed\" as const,\n        cardId,\n        result,\n        logs,\n        modelId: usedConfig.modelId,\n        providerId: usedConfig.providerId,\n      };\n    } catch (error) {\n      console.error(\"[AgentService] Failed to start session:\", error);\n      throw new Error(\n        error instanceof Error\n          ? `Failed to start agent session: ${error.message}`\n          : \"Failed to start agent session\"\n      );\n    }\n  }\n\n  async generateQuery(input: {\n    userPrompt: string;\n    targetTable?: string;\n    roleName?: string;\n  }) {\n    const { userPrompt, targetTable, roleName = \"sql-query-helper\" } = input;\n\n    // 1. Try to find an optional role; fall back to base prompt if none\n    let role = null as any;\n    if (roleName) {\n      role = await prisma.role.findFirst({ where: { name: roleName } });\n      if (!role) {\n        console.warn(\n          `[AgentService] Role \"${roleName}\" not found; proceeding without role-specific settings.`\n        );\n      }\n    }\n\n    // 2. Build schema context (lightweight)\n    let schemaContext = \"\";\n    if (targetTable) {\n      const rows = await prisma.$queryRawUnsafe<any[]>(\n        `SELECT column_name, data_type FROM information_schema.columns WHERE table_name = '${targetTable}'`\n      );\n      schemaContext = rows.length\n        ? `The primary table is \"${targetTable}\" with columns: ` +\n          rows.map((r) => `${r.column_name} (${r.data_type})`).join(\", \")\n        : \"\";\n    }\n\n    // 3. Final prompt\n    const finalPrompt = ((role && role.basePrompt) || BASE_PROMPT_SQL_HELPER)\n      .replace(\"[TABLE_SCHEMAS_CONTEXT]\", schemaContext)\n      .replace(\"[USER_PROMPT]\", userPrompt);\n\n    // 4. Select Model using Dynamic Role Criteria\n    let selectedModel;\n    try {\n      selectedModel = await getBestModel(role?.id, [], []);\n    } catch (e) {\n      console.warn(\n        `[AgentService] Dynamic model selection failed for role ${roleName}:`,\n        e\n      );\n    }\n\n    // Fallback if dynamic selection fails\n    if (!selectedModel) {\n      console.log(\n        `[AgentService] Falling back to any enabled model for ${roleName}`\n      );\n      const fallback = await prisma.model.findFirst({\n        where: { provider: { isEnabled: true } },\n        include: { provider: true },\n      });\n\n      if (fallback) {\n        selectedModel = {\n          modelId: fallback.modelId,\n          providerId: fallback.providerId,\n          temperature: role?.defaultTemperature ?? 0.1,\n          maxTokens: role?.defaultMaxTokens ?? 1024,\n        };\n      }\n    }\n\n    if (!selectedModel)\n      throw new Error(\"No suitable models available for SQL generation.\");\n\n    console.log(\n      `[AgentService] Generating SQL using model: ${selectedModel.modelId} (${selectedModel.providerId})`\n    );\n\n    // Attempt generation with retries and model fallbacks on invalid-model errors\n    const maxAttempts = 3;\n    const failedModels: string[] = [];\n    const failedProviders: string[] = [];\n    let attempt = 0;\n    let queryText = \"\";\n\n    while (attempt < maxAttempts) {\n      attempt++;\n      const provider = ProviderManager.getProvider(selectedModel.providerId);\n      if (!provider)\n        throw new Error(\n          `Selected provider ${selectedModel.providerId} is not initialized.`\n        );\n\n      try {\n        const text = await provider.generateCompletion({\n          modelId: selectedModel.modelId,\n          messages: [{ role: \"user\", content: finalPrompt }],\n          temperature: selectedModel.temperature ?? 0.1,\n          max_tokens: selectedModel.maxTokens ?? 1024,\n        });\n\n        // Strip markdown code blocks if present\n        queryText = (text || \"\").trim();\n        if (queryText.startsWith(\"```sql\")) {\n          queryText = queryText\n            .replace(/^```sql\\s*/, \"\")\n            .replace(/\\s*```$/, \"\");\n        } else if (queryText.startsWith(\"```\")) {\n          queryText = queryText.replace(/^```\\s*/, \"\").replace(/\\s*```$/, \"\");\n        }\n\n        // Success\n        break;\n      } catch (err: any) {\n        const errMsg = err && err.message ? String(err.message) : String(err);\n        console.warn(\n          `[AgentService] Model generation failed for ${selectedModel.modelId} (${selectedModel.providerId}): ${errMsg}`\n        );\n\n        // If provider says invalid model, blacklist this model and try again\n        if (/invalid model|not found|invalid model id/i.test(errMsg)) {\n          // Persist the failure\n          try {\n            await recordModelFailure(\n              selectedModel.providerId,\n              selectedModel.modelId,\n              role?.id\n            );\n            await recordProviderFailure(selectedModel.providerId, role?.id);\n          } catch (recErr) {\n            console.warn(\n              \"[AgentService] Failed to persist model/provider failure:\",\n              recErr\n            );\n          }\n\n          // Add provider-level fallback\n          if (!failedProviders.includes(selectedModel.providerId))\n            failedProviders.push(selectedModel.providerId);\n\n          // Also track the failed model id\n          if (!failedModels.includes(selectedModel.modelId))\n            failedModels.push(selectedModel.modelId);\n\n          // Select a new model avoiding the failed ones\n          try {\n            selectedModel = await getBestModel(\n              role?.id,\n              failedModels,\n              failedProviders\n            );\n            if (!selectedModel) {\n              console.warn(\n                \"[AgentService] No alternative model available after failure\"\n              );\n              throw new Error(\"No alternative models available\");\n            }\n            console.log(\n              `[AgentService] Retrying with new model: ${selectedModel.modelId} (${selectedModel.providerId})`\n            );\n          } catch (selectErr) {\n            console.warn(\n              \"[AgentService] Failed to select alternative model:\",\n              selectErr\n            );\n            // Try fallback selection\n            try {\n              const fallback = await getBestModel(\n                role?.id,\n                failedModels,\n                failedProviders\n              );\n              if (!fallback) throw new Error(\"No fallback model available\");\n              selectedModel = fallback as any;\n              console.log(\n                `[AgentService] Retrying with fallback: ${selectedModel.modelId} (${selectedModel.providerId})`\n              );\n              continue;\n            } catch (fallbackErr) {\n              console.warn(\n                \"[AgentService] Fallback selection failed:\",\n                fallbackErr\n              );\n            }\n          }\n        } else {\n          throw err;\n        }\n      }\n    }\n\n    if (!queryText)\n      throw new Error(\"Failed to generate query after multiple attempts.\");\n\n    return { queryText };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/browser.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/dataRefinement.service.ts","messages":[{"ruleId":"@typescript-eslint/no-base-to-string","severity":2,"message":"'val' will use Object's default stringification format ('[object Object]') when stringified.","line":87,"column":20,"nodeType":"Identifier","messageId":"baseToString","endLine":87,"endColumn":23}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { prisma } from '../db.js';\n\n/**\n * Sanitizes a string to be used as a table or column name.\n * Replaces non-alphanumeric characters with underscores.\n */\nfunction sanitizeName(name: string): string {\n  return name.replace(/[^a-zA-Z0-9_]/g, '_');\n}\n\ninterface FlattenOptions {\n  snapshotId?: string;\n  tableName: string;\n  rawData?: Record<string, unknown>[];\n}\n\n/**\n * Flattens a raw JSON array from the RawDataLake into a new, structured SQL table.\n * This function is idempotent and will replace the table on each run.\n *\n * @param options - The options for flattening data.\n * @param options.snapshotId - The ID of the record in RawDataLake. If provided, rawData will be fetched from here.\n * @param options.tableName - The desired name for the new, flattened table.\n * @param options.rawData - A fallback array of raw data to use if snapshotId is not provided or fails.\n */\nexport async function flattenRawData(options: FlattenOptions) {\n  const { tableName: rawTableName, rawData } = options;\n  \n  // We will ONLY use the rawData passed directly from the provider fetch.\n  // This removes the dependency on any intermediate snapshot table.\n  if (!rawData || !Array.isArray(rawData) || rawData.length === 0) {\n    console.warn(`[Refinement] No data provided to flatten for table ${rawTableName}.`);\n    return { tableName: rawTableName, rowCount: 0 };\n  }\n\n  const dataToProcess = rawData;\n\n  const tableName = sanitizeName(rawTableName);\n\n  // 3. Introspect the data to determine columns\n  const columnSet = new Set<string>();\n  dataToProcess.forEach((row: Record<string, unknown>) => {\n    if (row && typeof row === 'object') {\n      Object.keys(row).forEach(key => columnSet.add(key));\n    }\n  });\n\n  const columns = Array.from(columnSet).map(sanitizeName);\n  if (columns.length === 0) {\n    throw new Error('Cannot create a table with no columns.');\n  }\n\n  // 4. Build and execute the CREATE TABLE statement\n  await prisma.$executeRawUnsafe(`DROP TABLE IF EXISTS \"${tableName}\"`);\n\n  const columnDefs = columns.map(col => `\"${col}\" TEXT`).join(', ');\n  const createSql = `CREATE TABLE \"${tableName}\" (\n    _id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    _loaded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),\n    ${columnDefs}\n  )`;\n  await prisma.$executeRawUnsafe(createSql);\n\n  // 5. Batch Insert the data for performance\n  const rowsToInsert = dataToProcess.filter(row => row && typeof row === 'object');\n  if (rowsToInsert.length === 0) {\n    return { tableName, rowCount: 0 };\n  }\n\n  // All rows will be inserted against the full list of columns derived earlier\n  const insertCols = columns.map(c => `\"${c}\"`).join(', ');\n\n  const valueStrings = rowsToInsert.map(row => {\n    const vals = columns.map(col => {\n      // Find the original key before sanitization to look up the value\n      const originalKey = Array.from(columnSet).find(k => sanitizeName(k) === col);\n      const val = originalKey ? (row)[originalKey] : undefined;\n\n      if (val === null || val === undefined) return 'NULL';\n      let s: string;\n      if (typeof val === 'object') {\n        // If it's an object (including arrays), stringify it as JSON\n        s = JSON.stringify(val).replace(/'/g, \"''\");\n        return `'${s}'::jsonb`; // Store as JSONB\n      } else {\n        // Otherwise, it's a primitive, so convert to string\n        s = String(val).replace(/'/g, \"''\");\n        return `'${s}'`;\n      }\n    });\n    return `(${vals.join(', ')})`;\n  });\n\n  if (valueStrings.length > 0) {\n    const insertSql = `INSERT INTO \"${tableName}\" (${insertCols}) VALUES ${valueStrings.join(', ')}`;\n    try {\n      await prisma.$executeRawUnsafe(insertSql);\n    } catch (e) {\n      console.error(`[Refinement] Batch insert failed for ${tableName}. Error:`, e);\n      throw e;\n    }\n  }\n\n  return { tableName, rowCount: rowsToInsert.length };\n}","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/git.service.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":36,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1571,1574],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1571,1574],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":39,"column":43,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":39,"endColumn":50},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":52,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":52,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2033,2036],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2033,2036],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":55,"column":53,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":55,"endColumn":60},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":72,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2603,2606],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2603,2606],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":75,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":75,"endColumn":53},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":93,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":93,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3218,3221],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3218,3221],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":96,"column":55,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":96,"endColumn":62},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3606,3609],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3606,3609],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":109,"column":51,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":109,"endColumn":58},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":139,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":139,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4484,4487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4484,4487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":142,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":142,"endColumn":56},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":161,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5073,5076],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5073,5076],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":164,"column":48,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":164,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { simpleGit, type SimpleGit } from 'simple-git';\nimport { TRPCError } from '@trpc/server';\n// import { getVfsForWorkspace, type FsPromises } from './vfsService.js'; // Commented out as unused\n// import path from 'path'; // Commented out as unused\n\n// Define a safe base directory for all workspaces\n// const WORKSPACE_BASE_DIR = path.resolve(process.cwd(), 'workspaces'); // Commented out as unused\n\nexport class GitService {\n  // constructor(private _getVfs: (workspaceId: string) => FsPromises) {} // Commented out as unused\n\n  private getGit(_vfsToken: string): { git: SimpleGit; systemPath: string } {\n    // const payload = this.vfsSession.validateToken(vfsToken);\n    // if (!payload) {\n    //   throw new TRPCError({ code: 'UNAUTHORIZED', message: 'Invalid VFS token' });\n    // }\n\n    // // This is the FIX: Construct the path, don't read it from the adapter.\n    // // It prevents any path traversal attacks.\n    // const systemPath = path.join(WORKSPACE_BASE_DIR, payload.vfsRootPath);\n\n    // Security Check: Ensure the path is *inside* the allowed workspace\n    // if (!path.resolve(systemPath).startsWith(WORKSPACE_BASE_DIR)) {\n    //    throw new TRPCError({ code: 'FORBIDDEN', message: 'Filesystem access denied' });\n    // }\n    \n    // return { git: simpleGit(systemPath), systemPath };\n    return { git: simpleGit(), systemPath: '' };\n  }\n\n  async gitLog(vfsToken: string, count: number = 10) {\n    try {\n      const { git } = this.getGit(vfsToken);\n      const log = await git.log({ maxCount: count });\n      return log.all;\n    } catch (error: any) {\n      throw new TRPCError({\n        code: 'INTERNAL_SERVER_ERROR',\n        message: `Git Log failed: ${error.message}`,\n      });\n    }\n  }\n\n  async checkoutAndPull(vfsToken: string, branchName: string) {\n    try {\n      const { git } = this.getGit(vfsToken);\n      // Ensure we have latest refs\n      await git.fetch();\n      await git.checkout(branchName);\n      await git.pull();\n      return { success: true, branch: branchName };\n    } catch (error: any) {\n      throw new TRPCError({\n        code: 'INTERNAL_SERVER_ERROR',\n        message: `Checkout and Pull failed: ${error.message}`,\n      });\n    }\n  }\n\n  async gitCommit(vfsToken: string, message: string) {\n    try {\n      const { git } = this.getGit(vfsToken);\n      const status = await git.status();\n      \n      if (status.files.length === 0) {\n        throw new Error('No changes to commit');\n      }\n\n      await git.add('.');\n      const commit = await git.commit(message);\n      return { hash: commit.commit, summary: commit.summary };\n    } catch (error: any) {\n      throw new TRPCError({\n        code: 'INTERNAL_SERVER_ERROR',\n        message: `Git Commit failed: ${error.message}`,\n      });\n    }\n  }\n  \n  async createGhostBranch(vfsToken: string, taskId: string, customName?: string) {\n    try {\n      const { git } = this.getGit(vfsToken);\n      const branchName = customName || `volcano/task-${taskId}`;\n      \n      // Ensure we are on main and up to date\n      await git.checkout('main');\n      await git.pull();\n      \n      // Create and checkout new branch\n      await git.checkoutLocalBranch(branchName);\n      \n      return branchName;\n    } catch (error: any) {\n      throw new TRPCError({\n        code: 'INTERNAL_SERVER_ERROR',\n        message: `Create Ghost Branch failed: ${error.message}`,\n      });\n    }\n  }\n\n  async checkoutBranch(vfsToken: string, branchName: string) {\n    try {\n      const { git } = this.getGit(vfsToken);\n      await git.checkout(branchName);\n      return { success: true, branch: branchName };\n    } catch (error: any) {\n       throw new TRPCError({\n        code: 'INTERNAL_SERVER_ERROR',\n        message: `Checkout Branch failed: ${error.message}`,\n      });\n    }\n  }\n\n  async ratifyBranch(vfsToken: string, branchName: string) {\n    try {\n      const { git } = this.getGit(vfsToken);\n      \n      // Validate branch name\n      if (!branchName.startsWith('volcano/')) {\n        throw new Error('Can only ratify volcano/* branches');\n      }\n\n      await git.checkout('main');\n      await git.pull();\n      \n      // Squash merge\n      await git.merge([branchName, '--squash']);\n      \n      // Commit the squash\n      await git.commit(`Ratified: ${branchName}`);\n      \n      // Push changes\n      await git.push('origin', 'main');\n      \n      // Delete local branch\n      await git.deleteLocalBranch(branchName);\n\n      return { success: true, ratified: branchName };\n    } catch (error: any) {\n      throw new TRPCError({\n        code: 'INTERNAL_SERVER_ERROR',\n        message: `Ratify Branch failed: ${error.message}`,\n      });\n    }\n  }\n\n  async getBranches(vfsToken: string) {\n    try {\n      const { git } = this.getGit(vfsToken);\n      const branchSummary = await git.branch();\n      \n      // Filter for volcano branches + main\n      const interestingBranches = branchSummary.all.filter(b => \n        b === 'main' || b.startsWith('volcano/')\n      );\n\n      return {\n        all: interestingBranches,\n        current: branchSummary.current\n      };\n    } catch (error: any) {\n      throw new TRPCError({\n        code: 'INTERNAL_SERVER_ERROR',\n        message: `Get Branches failed: ${error.message}`,\n      });\n    }\n  }\n}","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/languageServer.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `BufferLike`.","line":21,"column":17,"nodeType":"CallExpression","messageId":"unsafeArgument","endLine":21,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":21,"column":17,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":21,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .toString on an `any` value.","line":21,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":21,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { WebSocketServer, WebSocket } from 'ws';\nimport { Server } from 'http';\nimport { spawn } from 'child_process';\n\nexport class LanguageServerService {\n  private wss: WebSocketServer | null = null;\n\n  constructor(server: Server) {\n    this.initialize(server);\n  }\n\n  private initialize(server: Server) {\n    this.wss = new WebSocketServer({ server, path: '/language-server' });\n\n    this.wss.on('connection', (ws: WebSocket) => {\n      console.log('Language server client connected');\n\n      const ls = spawn('typescript-language-server', ['--stdio']);\n\n      ls.stdout.on('data', (data) => {\n        ws.send(data.toString());\n      });\n\n      ws.on('message', (message: string) => {\n        ls.stdin.write(message);\n      });\n\n      ws.on('close', () => {\n        console.log('Language server client disconnected');\n        ls.kill();\n      });\n    });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/mcp-registry-client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/model.service.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":138,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":138,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3964,3967],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3964,3967],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":169,"column":70,"nodeType":"Property","messageId":"anyAssignment","endLine":169,"endColumn":96},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":211,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7057,7060],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7057,7060],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .meta on an `any` value.","line":212,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":212,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .code on an `any` value.","line":212,"column":51,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":212,"endColumn":55}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":124,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":124,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3400,3403],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3400,3403],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { prisma } from '../db.js';\nimport { z } from 'zod';\nimport { modelInputSchema } from '@repo/api-contract';\nimport type { Prisma } from '@prisma/client';\nimport { ModelDoctor } from './ModelDoctor.js';\n\ntype ModelInput = z.infer<typeof modelInputSchema>;\n\ninterface FreeModelRow {\n  id?: string;\n  model_id?: string;\n  name?: string;\n  model_name?: string;\n  context_length?: number;\n  context_window?: number;\n  contextWindow?: number;\n  provider?: string;\n}\n\ninterface UnifiedModelRow {\n  id: string;\n  name: string;\n  context_length: number;\n  provider: string;\n  source: string;\n}\n\nexport class ModelService {\n  async saveNormalizedModel(input: ModelInput) {\n    const { providerId, modelId, name, isFree, contextWindow, hasVision, hasReasoning, hasCoding, providerData } = input;\n\n    // [RESILIENCE] Pack strict columns into the Triple Layer (specs)\n    const specsData = {\n        contextWindow,\n        hasVision,\n        hasReasoning,\n        hasCoding,\n        lastUpdated: new Date().toISOString()\n    };\n\n    // Simple implementation with our JSON DB\n    return prisma.model.upsert({\n      where: {\n        providerId_modelId: { providerId, modelId },\n      },\n      update: {\n        name,\n        isFree,\n        // Update JSON layers instead of (possibly removed) columns\n        specs: specsData as Prisma.InputJsonValue,\n        providerData: providerData as Prisma.InputJsonValue,\n      },\n      create: {\n        providerId,\n        modelId,\n        name,\n        isFree,\n        specs: specsData as Prisma.InputJsonValue,\n        providerData: providerData as Prisma.InputJsonValue,\n      },\n    });\n  }\n\n  async listModels() {\n    return prisma.model.findMany({\n      include: {\n        provider: true,\n      },\n    });\n  }\n\n  async importModels(models: ModelInput[]) {\n    let successCount = 0;\n    for (const model of models) {\n      const { providerId, modelId, name, isFree, contextWindow, hasVision, hasReasoning, hasCoding, providerData } = model;\n      const specsData = {\n          contextWindow,\n          hasVision,\n          hasReasoning,\n          hasCoding,\n          lastUpdated: new Date().toISOString()\n      };\n      await prisma.model.upsert({\n        where: {\n          providerId_modelId: { providerId, modelId },\n        },\n        update: {\n          name,\n          isFree,\n          specs: specsData as Prisma.InputJsonValue,\n          providerData: providerData as Prisma.InputJsonValue,\n        },\n        create: {\n          providerId,\n          modelId,\n          name,\n          isFree,\n          specs: specsData as Prisma.InputJsonValue,\n          providerData: providerData as Prisma.InputJsonValue,\n        },\n      });\n      successCount++;\n    }\n    return { imported: successCount, total: models.length };\n  }\n\n  async clearCoreModels() {\n    await prisma.model.deleteMany({});\n    return { success: true, message: 'Unified Model table cleared.' };\n  }\n\n  async saveTableMapping(tableName: string, mapping: Record<string, string>) {\n    await prisma.tableMapping.upsert({\n      where: { tableName },\n      create: { tableName, mapping },\n      update: { mapping }\n    });\n    return { success: true };\n  }\n\n  async mergeFromTable(sourceTableName: string, providerId?: string) {\n    // A. Fetch Raw Data using Unsafe Query\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const rows = await prisma.$queryRawUnsafe<any[]>(`SELECT * FROM \"${sourceTableName}\"`);\n    if (!rows.length) throw new Error(`Table ${sourceTableName} is empty.`);\n\n    // B. Fetch Saved Mapping (if any)\n    const savedMap = await prisma.tableMapping.findUnique({\n      where: { tableName: sourceTableName }\n    });\n    const mapping = (savedMap?.mapping as Record<string, string>) || {};\n\n    let successCount = 0;\n\n    for (const row of rows) {\n      // C. Construct Model Object using Mapping + Fuzzy Matching\n      const safeRow = row as Record<string, unknown>;\n      const modelData: Record<string, any> = {\n         providerId: providerId || 'generic-import',\n         providerData: safeRow\n      };\n\n      const getValue = (targetField: string) => {\n        // 1. Explicit mapping\n        const mappedCol = Object.keys(mapping).find(key => mapping[key] === targetField);\n        if (mappedCol && safeRow[mappedCol] !== undefined) return safeRow[mappedCol];\n        // 2. Exact match\n        if (safeRow[targetField] !== undefined) return safeRow[targetField];\n        // 3. Fuzzy Match\n        const normalize = (s: string) => s.toLowerCase().replace(/[^a-z0-9]/g, '');\n        const rowKey = Object.keys(safeRow).find(k => {\n           const normK = normalize(k);\n           const normT = normalize(targetField);\n           if (targetField === 'contextWindow' && (normK.includes('length') || normK.includes('context'))) return true;\n           if (targetField === 'modelId' && (normK === 'id' || normK === 'slug')) return true;\n           return normK === normT;\n        });\n        return rowKey ? safeRow[rowKey] : undefined;\n      };\n\n      modelData.name = getValue('name') || safeRow.id || 'Unknown';\n      modelData.modelId = getValue('modelId') || safeRow.id;\n      modelData.contextWindow = Number(getValue('contextWindow')) || 4096;\n      modelData.costPer1k = Number(getValue('costPer1k')) || 0;\n\n      // D. Upsert into Unified Table\n      if (modelData.modelId && providerId) {\n          await prisma.model.upsert({\n              where: { providerId_modelId: { providerId: providerId, modelId: modelData.modelId } },\n              create: {\n                  providerId: String(modelData.providerId),\n                  modelId: String(modelData.modelId),\n                  name: String(modelData.name),\n                  isFree: true,\n                  isActive: true,\n                  specs: { \n                      contextWindow: Number(modelData.contextWindow || 4096),\n                      costPer1k: Number(modelData.costPer1k || 0)\n                  },\n                  providerData: safeRow as Prisma.InputJsonValue,\n                  source: 'MANUAL'\n              },\n              update: {\n                  name: String(modelData.name),\n                  providerData: safeRow as Prisma.InputJsonValue,\n                  specs: { \n                      contextWindow: Number(modelData.contextWindow || 4096),\n                      costPer1k: Number(modelData.costPer1k || 0)\n                  }\n              }\n          });\n          successCount++;\n      }\n    }\n\n    return { imported: successCount, total: rows.length };\n  }\n\n\n\n  async listRefinedModels() {\n    try {\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const rows = await prisma.$queryRaw<FreeModelRow[]>`SELECT * FROM \"my_free_models\"`;\n      return rows.map((row) => ({\n        id: row.id || row.model_id || row.name || 'unknown',\n        name: row.name || row.model_name || 'Unknown Model',\n        contextLength: Number(row.context_length || row.context_window || row.contextWindow || 0),\n        provider: row.provider || 'unknown'\n      }));\n    } catch (error: any) {\n      if (error?.meta?.code === '42P01' || error?.code === '42P01') {\n        console.warn(\"Table 'my_free_models' does not exist yet.\");\n        return [];\n      }\n      console.error(\"Failed to fetch my_free_models table:\", error);\n      return [];\n    }\n  }\n\n  async getUnifiedModelList() {\n    try {\n      // 1. Get all dynamic tables that are registered\n      const tables = await prisma.flattenedTable.findMany({\n        select: { name: true }\n      });\n\n      if (tables.length === 0) {\n        return [];\n      }\n\n      // 2. For each table, detect its columns and build a compatible query\n      const queries: string[] = [];\n\n      for (const t of tables) {\n        try {\n          // Get columns for this table\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          const columnsRaw = await prisma.$queryRawUnsafe<{ column_name: string }[]>(\n            `SELECT column_name FROM information_schema.columns\n             WHERE table_name = '${t.name}'\n             AND table_schema = 'public'`\n          );\n          const columns = columnsRaw.map(c => c.column_name);\n\n          // Detect common columns with fallbacks\n          const idCol = ['id', 'model_id', 'modelId'].find(c => columns.includes(c)) || 'id';\n          const nameCol = ['name', 'model_name', 'modelName', 'model_id', 'id'].find(c => columns.includes(c)) || idCol;\n          const contextCol = ['context_length', 'context_window', 'contextWindow', 'contextLength'].find(c => columns.includes(c));\n          const providerCol = ['provider', 'provider_id', 'providerId', 'data_source'].find(c => columns.includes(c));\n\n          // Build query with COALESCE for safety\n          const selectParts = [\n            `'${t.name}' as source`,\n            `COALESCE(\"${idCol}\"::text, 'unknown') as id`,\n            `COALESCE(\"${nameCol}\"::text, \"${idCol}\"::text, 'unknown') as name`,\n            contextCol ? `COALESCE(\"${contextCol}\"::numeric, 0) as context_length` : '0 as context_length',\n            providerCol ? `COALESCE(\"${providerCol}\"::text, 'unknown') as provider` : `'unknown' as provider`\n          ];\n\n          queries.push(`SELECT ${selectParts.join(', ')} FROM \"${t.name}\"`);\n        } catch (err) {\n          console.error(`Failed to build query for table ${t.name}:`, err);\n          continue;\n        }\n      }\n\n      if (queries.length === 0) {\n        return [];\n      }\n\n      const fullQuery = queries.join(' UNION ALL ');\n\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const rows = await prisma.$queryRawUnsafe<UnifiedModelRow[]>(fullQuery);\n\n      return rows.map((row) => ({\n        id: row.id,\n        name: row.name,\n        contextLength: Number(row.context_length || 0),\n        provider: row.provider,\n        source: row.source\n      }));\n\n    } catch (error) {\n      console.error(\"Failed to fetch unified model list:\", error);\n      return [];\n    }\n  }\n\n  async runDoctor(force: boolean = false) {\n    const doctor = new ModelDoctor();\n    return await doctor.healModels(force);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/modelManager.mocks.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":2,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":2,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[88,91],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[88,91],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// This file is a placeholder to resolve a build error.\nexport type RawProviderOutput = any;\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/modelManager.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":63,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":63,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1913,1916],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1913,1916],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":92,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":92,"endColumn":50},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":92,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":92,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2771,2774],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2771,2774],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":93,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":93,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .capabilities on an `any` value.","line":93,"column":35,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":93,"endColumn":47},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2888,2891],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2888,2891],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .length on an `any` value.","line":109,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":109,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .capabilityTags on an `any` value.","line":110,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":110,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":111,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":111,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":117,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":117,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client';\nimport { DEFAULT_MODEL_TEMP, DEFAULT_MAX_TOKENS, DEFAULT_MODEL_TAKE_LIMIT } from '../config/constants.js';\n\n// Define a basic interface for the expected data structure.\ninterface RawProviderOutput {\n  modelId: string;\n  roleId: string;\n  userId: string;\n  usage?: {\n    prompt_tokens: number;\n    completion_tokens: number;\n  };\n  cost?: number;\n  [key: string]: unknown; // Using unknown instead of any\n}\n\n// Define interface for ModelSelectionResult\nexport interface ModelSelectionResult {\n  modelId: string;\n  providerId: string;\n  model: unknown; // Using unknown as it could be a Prisma model or a mocked object\n  temperature: number;\n  maxTokens: number;\n}\n\n// This would be your singleton Prisma client, passed in or imported\nconst prisma = new PrismaClient();\n\n/**\n * The \"Metadata Parsing\" function.\n * This function is the solution to the \"messy data\" problem.\n * It uses the \"rest\" operator to catch all unknown fields.\n */\nexport async function logUsage(data: RawProviderOutput) {\n  // Validate basic requirements before use if needed, or rely on destructuring\n  // 1. Destructure the *known* fields and capture the \"rest\"\n  const {\n    modelId,\n    roleId,\n    userId,\n    usage,\n    cost,\n    ...metadata // This catches `router_metadata` or any other unknown fields\n  } = data;\n\n  // 2. Map the data to the flexible Prisma schema\n  try {\n    const newLog = await prisma.modelUsage.create({\n      data: {\n        userId,\n        modelId, // Relation to Model\n        roleId,          // Relation to Role\n\n        // Handle null usage from free providers\n        promptTokens: usage?.prompt_tokens ?? null,\n        completionTokens: usage?.completion_tokens ?? null,\n\n        // Handle null cost\n        cost: cost ?? 0.0,\n\n        // This is the \"escape hatch.\"\n        // All leftover fields are stored in the Json blob.\n        metadata: metadata as any,\n      },\n    });\n    console.log('Usage log created:', newLog.id);\n    return newLog;\n  } catch (error) {\n    console.error('Failed to log model usage:', error);\n    // Handle specific Prisma errors if needed\n  }\n}\n\n/**\n * Selects a model from the model_registry based on Role criteria.\n * Uses Ghost Records pattern: only considers active models.\n * Supports \"Exhaustive Fallback\" by excluding failed models/providers.\n */\nexport async function selectModelFromRegistry(roleId: string, failedModels: string[] = [], failedProviders: string[] = []) {\n  try {\n    // Fetch the role to get its criteria\n    const role = await prisma.role.findUnique({\n      where: { id: roleId }\n    });\n\n    if (!role) {\n      console.warn(`Role ${roleId} not found`);\n      return null;\n    }\n\n    // Parse metadata for capabilities\n    const metadata = (role.metadata as any) || {};\n    const capabilities = metadata.capabilities || [];\n\n    // Build query filters\n    const whereClause: any = {\n      isActive: true, // Ghost Records: only active models\n      provider: {\n        isEnabled: true // Only enabled providers\n      },\n      // Exclude failed models and providers\n      NOT: [\n        ...(failedModels.length > 0 ? [{ modelId: { in: failedModels } }] : []),\n        ...(failedProviders.length > 0 ? [{ providerId: { in: failedProviders } }] : [])\n      ]\n    };\n\n    // Add capability filters if specified\n    if (capabilities.length > 0) {\n      whereClause.capabilityTags = {\n        hasSome: capabilities\n      };\n    }\n\n    // Fetch candidate models\n    const candidates = await prisma.model.findMany({\n      where: whereClause,\n      include: {\n        provider: true\n      },\n      orderBy: [\n        { isFree: 'desc' }, // Prefer free models (Zero-Burn)\n        { lastSeenAt: 'desc' }, // Recently seen models first\n      ],\n      take: DEFAULT_MODEL_TAKE_LIMIT // Limit for performance\n    });\n\n    if (candidates.length === 0) {\n      console.warn(`No active models found for role ${roleId}`);\n      return null;\n    }\n\n    // Pick random for load balancing\n    const selected = candidates[Math.floor(Math.random() * candidates.length)];\n    \n    console.log(`‚úÖ Selected model: ${selected.provider.label}/${selected.name} (source: ${selected.source}, free: ${selected.isFree})`);\n\n    return {\n      modelId: selected.modelId,\n      internalId: selected.id,\n      providerId: selected.providerId,\n      name: selected.name,\n      isFree: selected.isFree,\n      source: selected.source,\n      provider: selected.provider,\n      specs: selected.specs,\n    };\n  } catch (error) {\n    console.error('Failed to select model from registry:', error);\n    return null;\n  }\n}\n\n/**\n * The \"Brain\" for model selection.\n * Finds the best, non-rate-limited model for a given role.\n * UPDATED: Uses Dynamic Registry first, falls back to legacy preferredModels.\n */\nexport async function getBestModel(roleId?: string, failedModels: string[] = [], failedProviders: string[] = []): Promise<ModelSelectionResult | null> {\n  // If a roleId wasn't provided, fall back to selecting any enabled model.\n  if (!roleId) {\n    const fallback = await prisma.model.findFirst({\n      where: { provider: { isEnabled: true } },\n      include: { provider: true },\n    });\n    if (!fallback) return null;\n    return {\n      modelId: fallback.modelId,\n      providerId: fallback.providerId,\n      model: fallback,\n      temperature: DEFAULT_MODEL_TEMP,\n      maxTokens: DEFAULT_MAX_TOKENS,\n    };\n  }\n\n  // 1. Try Dynamic Registry\n  try {\n    const dynamicModel = await selectModelFromRegistry(roleId, failedModels, failedProviders);\n    if (dynamicModel) {      \n      // We need to return it in a format compatible with the rest of the system.\n      // The system expects a ModelConfig-like object with a nested 'model' and 'provider'.\n      // Since we are bypassing the strict Prisma relations, we might need to mock that structure \n      // OR update the caller to handle raw objects.\n      \n      // Let's check if this provider/model exists in our strict DB to return a proper object\n      const strictModel = await prisma.model.findUnique({\n        where: { providerId_modelId: { providerId: dynamicModel.providerId, modelId: dynamicModel.modelId } },\n        include: { provider: true }\n      });\n\n      if (strictModel) {\n        return {\n          modelId: strictModel.modelId,\n          providerId: strictModel.providerId,\n          model: strictModel,\n          // Mock config values\n          temperature: DEFAULT_MODEL_TEMP,\n          maxTokens: DEFAULT_MAX_TOKENS\n        };\n      }\n      \n      // If not in strict DB, we might be in \"SimpleDB\" mode or using a raw table.\n      // We'll return a constructed object and hope the caller (AgentFactory) can handle it.\n      // AgentFactory looks up the provider via ProviderManager, so as long as providerId is valid, we are good.\n      return {        \n        modelId: dynamicModel.modelId,\n        providerId: dynamicModel.providerId,\n        model: {\n            id: dynamicModel.modelId,\n            providerId: dynamicModel.providerId,\n            provider: { id: dynamicModel.providerId, type: (dynamicModel.providerId)?.split('-')[0] || 'unknown' } // Mock provider\n        },\n        temperature: DEFAULT_MODEL_TEMP,\n        maxTokens: DEFAULT_MAX_TOKENS\n      };\n    }\n  } catch (e: unknown) {\n    console.warn(\"Dynamic selection failed, falling back to legacy:\", e);\n  }\n\n  // Exported helper: record a failure for a model\n\n// Failure helpers (moved to file bottom to avoid being inside getBestModel)\n\n  // 2. Legacy Fallback (Original Logic) - REMOVED due to simplified schema\n  // If dynamic selection failed, we have no other source of truth for \"preferred models\" \n  // since ModelConfig was removed.\n  // We can fallback to \"any enabled model\" if that's desired, or just throw.\n  \n  // Try to find ANY enabled model for the requested provider if specified, or just any global model.\n  const fallbackModel = await prisma.model.findFirst({\n      where: { provider: { isEnabled: true } },\n      include: { provider: true }\n  });\n\n  if (fallbackModel) {\n      return {\n          modelId: fallbackModel.modelId,\n          providerId: fallbackModel.providerId,\n          model: fallbackModel,\n          temperature: DEFAULT_MODEL_TEMP,\n          maxTokens: DEFAULT_MAX_TOKENS\n      };\n  }\n\n  throw new Error(`No models available for role ${roleId}`);\n}\n\n/**\n * Increment persistent failure counts for a model (used to avoid retries across restarts)\n */\nexport async function recordModelFailure(providerId: string, modelId: string, roleId?: string) {\n  try {\n    // Use role-scoped unique constraint; roleId may be undefined/null to record global failure\n    await prisma.modelFailure.upsert({\n      where: { providerId_modelId_roleId: { providerId, modelId, roleId: (roleId ?? null) as string } },\n      update: { failures: { increment: 1 } },\n      create: { providerId, modelId, roleId: (roleId ?? null) as string, failures: 1 }\n    });\n    console.log(`[Model Failure] Recorded failure for ${modelId} on ${providerId} (role=${roleId ?? 'global'})`);\n  } catch (err) {\n    console.warn('[Model Failure] Failed to record model failure:', err);\n  }\n}\n\nexport async function recordProviderFailure(providerId: string, roleId?: string) {\n  try {\n    await prisma.providerFailure.upsert({\n      where: { providerId_roleId: { providerId, roleId: (roleId ?? null) as string } },\n      update: { failures: { increment: 1 } },\n      create: { providerId, roleId: (roleId ?? null) as string, failures: 1 }\n    });\n    console.log(`[Provider Failure] Recorded failure for provider ${providerId} (role=${roleId ?? 'global'})`);\n  } catch (err) {\n    console.warn('[Provider Failure] Failed to record provider failure:', err);\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/orchestration.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'StepExecutionContext' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":6,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[260,263],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[260,263],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[279,282],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[279,282],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":8,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":8,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[299,302],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[299,302],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[638,641],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[638,641],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":26,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[660,663],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[660,663],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[683,686],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[683,686],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":51,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":51,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":52,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":52,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":53,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":53,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":75,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":75,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1998,2001],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1998,2001],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tags on an `any` value.","line":78,"column":13,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":78,"endColumn":17},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .isActive on an `any` value.","line":82,"column":13,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":82,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":86,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":86,"endColumn":12},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":161,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3906,3909],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3906,3909],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":186,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":186,"endColumn":14},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":208,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":208,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5147,5150],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5147,5150],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":211,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5237,5240],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5237,5240],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":211,"column":44,"nodeType":"Property","messageId":"anyAssignment","endLine":211,"endColumn":49},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":212,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":212,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5275,5278],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5275,5278],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stepOutput on an `any` value.","line":242,"column":58,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":242,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":248,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":248,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":248,"column":39,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":248,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":250,"column":75,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":250,"endColumn":82},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":267,"column":19,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":267,"endColumn":83},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .status on an `any` value.","line":270,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":270,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .error on an `any` value.","line":271,"column":68,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":271,"endColumn":73},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stepOutput on an `any` value.","line":275,"column":51,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":275,"endColumn":61},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":314,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":314,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9035,9038],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9035,9038],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":323,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":323,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":323,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":323,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":337,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":337,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9658,9661],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9658,9661],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":339,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":339,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9722,9725],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9722,9725],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":344,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":344,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":362,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":362,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":368,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":368,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10719,10722],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10719,10722],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":373,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":373,"endColumn":20},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":374,"column":53,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":374,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":411,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":411,"endColumn":58},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":411,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":411,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12280,12283],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12280,12283],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":432,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":432,"endColumn":64},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultTemperature on an `any` value.","line":432,"column":39,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":432,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":433,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":433,"endColumn":61},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultMaxTokens on an `any` value.","line":433,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":433,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":443,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":443,"endColumn":64},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultTemperature on an `any` value.","line":443,"column":39,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":443,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":444,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":444,"endColumn":61},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultMaxTokens on an `any` value.","line":444,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":444,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":465,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":465,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultTemperature on an `any` value.","line":465,"column":43,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":465,"endColumn":61},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":466,"column":17,"nodeType":"Property","messageId":"anyAssignment","endLine":466,"endColumn":65},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .defaultMaxTokens on an `any` value.","line":466,"column":41,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":466,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":498,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":498,"endColumn":20},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":505,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":505,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15790,15793],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15790,15793],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":506,"column":9,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":506,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":520,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":520,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":564,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":564,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17534,17537],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17534,17537],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":564,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":564,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17541,17544],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17541,17544],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":569,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":569,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17662,17665],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17662,17665],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":570,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":570,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17701,17704],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17701,17704],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":574,"column":9,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":574,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":576,"column":9,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":576,"endColumn":31},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":588,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":588,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18092,18095],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18092,18095],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":589,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":589,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18125,18128],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18125,18128],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":593,"column":7,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":593,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":597,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":597,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18327,18330],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18327,18330],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":601,"column":9,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":601,"endColumn":82},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":601,"column":64,"nodeType":"Property","messageId":"anyAssignment","endLine":601,"endColumn":70},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":603,"column":9,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":603,"endColumn":39},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":611,"column":73,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":611,"endColumn":76,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18748,18751],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18748,18751],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":611,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":611,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18755,18758],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18755,18758],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":617,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":617,"endColumn":52},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":627,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":627,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19188,19191],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19188,19191],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":627,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":627,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19208,19211],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19208,19211],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":628,"column":53,"nodeType":"ChainExpression","messageId":"unsafeReturn","endLine":628,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access [key] on an `any` value.","line":628,"column":63,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":628,"endColumn":66},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":634,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":634,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19377,19380],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19377,19380],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":634,"column":76,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":634,"endColumn":79,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19406,19409],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19406,19409],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":635,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":635,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":636,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":636,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":636,"column":53,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":636,"endColumn":58}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":81,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { prisma } from '../db.js';\nimport { createVolcanoAgent } from './AgentFactory.js';\nimport type { Orchestration, OrchestrationStep, OrchestrationExecution } from '@prisma/client';\n\ninterface StepExecutionContext {\n  orchestrationContext: Record<string, any>;\n  stepInput: any;\n  stepOutput?: any;\n  error?: string;\n}\n\ninterface CreateOrchestrationInput {\n  name: string;\n  description?: string;\n  tags?: string[];\n  steps: CreateStepInput[];\n  createdBy?: string;\n}\n\ninterface CreateStepInput {\n  name: string;\n  description?: string;\n  order: number;\n  stepType?: 'sequential' | 'parallel' | 'conditional' | 'loop';\n  condition?: any;\n  inputMapping?: any;\n  outputMapping?: any;\n  maxRetries?: number;\n  retryDelay?: number;\n  timeout?: number;\n  parallelGroup?: string;\n}\n\nexport class OrchestrationService {\n  /**\n   * Create a new orchestration\n   */\n  static async createOrchestration(input: CreateOrchestrationInput): Promise<Orchestration> {\n    const orchestration = await prisma.orchestration.create({\n      data: {\n        name: input.name,\n        description: input.description,\n        tags: input.tags || [],\n        createdBy: input.createdBy,\n        steps: {\n          create: input.steps.map((step) => ({\n            name: step.name,\n            description: step.description,\n            order: step.order,\n            stepType: step.stepType || 'sequential',\n            condition: step.condition,\n            inputMapping: step.inputMapping,\n            outputMapping: step.outputMapping,\n            maxRetries: step.maxRetries || 0,\n            retryDelay: step.retryDelay,\n            timeout: step.timeout,\n            parallelGroup: step.parallelGroup,\n          })),\n        },\n      },\n      include: {\n        steps: {\n          orderBy: { order: 'asc' },\n        },\n      },\n    });\n\n    return orchestration;\n  }\n\n  /**\n   * List all orchestrations\n   */\n  static async listOrchestrations(filters?: { tags?: string[]; isActive?: boolean }) {\n    const where: any = {};\n    \n    if (filters?.tags && filters.tags.length > 0) {\n      where.tags = { hasSome: filters.tags };\n    }\n    \n    if (filters?.isActive !== undefined) {\n      where.isActive = filters.isActive;\n    }\n\n    return prisma.orchestration.findMany({\n      where,\n      include: {\n        steps: {\n          orderBy: { order: 'asc' },\n        },\n        executions: {\n          take: 5,\n          orderBy: { startedAt: 'desc' },\n        },\n      },\n      orderBy: { updatedAt: 'desc' },\n    });\n  }\n\n  /**\n   * Get a single orchestration by ID or name\n   */\n  static async getOrchestration(idOrName: string) {\n    return prisma.orchestration.findFirst({\n      where: {\n        OR: [{ id: idOrName }, { name: idOrName }],\n      },\n      include: {\n        steps: {\n          orderBy: { order: 'asc' },\n        },\n        executions: {\n          take: 10,\n          orderBy: { startedAt: 'desc' },\n        },\n      },\n    });\n  }\n\n  /**\n   * Update an orchestration\n   */\n  static async updateOrchestration(\n    id: string,\n    updates: {\n      name?: string;\n      description?: string;\n      tags?: string[];\n      isActive?: boolean;\n    }\n  ) {\n    return prisma.orchestration.update({\n      where: { id },\n      data: updates,\n      include: {\n        steps: {\n          orderBy: { order: 'asc' },\n        },\n      },\n    });\n  }\n\n  /**\n   * Delete an orchestration\n   */\n  static async deleteOrchestration(id: string) {\n    return prisma.orchestration.delete({\n      where: { id },\n    });\n  }\n\n  /**\n   * Execute an orchestration with dynamic role assignments\n   * @param orchestrationId - The orchestration to execute\n   * @param input - The initial input data\n   * @param roleAssignments - Optional map of step names to role IDs (e.g., { \"step1\": \"roleId1\" })\n   * @param userId - Optional user ID for tracking\n   */\n  static async executeOrchestration(\n    orchestrationId: string,\n    input: any,\n    roleAssignments?: Record<string, string>,\n    userId?: string\n  ): Promise<OrchestrationExecution> {\n    const orchestration = await prisma.orchestration.findUnique({\n      where: { id: orchestrationId },\n      include: {\n        steps: {\n          orderBy: { order: 'asc' },\n        },\n      },\n    });\n\n    if (!orchestration) {\n      throw new Error(`Orchestration ${orchestrationId} not found`);\n    }\n\n    if (!orchestration.isActive) {\n      throw new Error(`Orchestration ${orchestration.name} is not active`);\n    }\n\n    // Create execution record\n    const execution = await prisma.orchestrationExecution.create({\n      data: {\n        orchestrationId,\n        input,\n        userId,\n        status: 'running',\n        context: {},\n        stepLogs: [],\n      },\n    });\n\n    // Execute in background (don't await)\n    this.runOrchestration(execution.id, orchestration, input, roleAssignments).catch((error) => {\n      console.error(`[Orchestration] Execution ${execution.id} failed:`, error);\n    });\n\n    return execution;\n  }\n\n  /**\n   * Internal: Run the orchestration\n   */\n  private static async runOrchestration(\n    executionId: string,\n    orchestration: Orchestration & { steps: OrchestrationStep[] },\n    input: any,\n    roleAssignments?: Record<string, string>\n  ) {\n    const context: Record<string, any> = { input };\n    const stepLogs: any[] = [];\n\n    try {\n      // üß† INTELLIGENCE LAYER: Recall relevant past executions (Librarian)\n      const { LibrarianService } = await import('./LibrarianService.js');\n      const taskDescription = typeof input === 'string' ? input : JSON.stringify(input);\n      const memories = await LibrarianService.recall(taskDescription, 3);\n      \n      // Inject memories into context\n      if (memories.length > 0) {\n        LibrarianService.injectMemories(context, memories);\n        console.log(`[Orchestration] üìö Injected ${memories.length} memories from Librarian`);\n      }\n\n      // Group steps by parallel execution\n      const stepGroups = this.groupStepsByExecution(orchestration.steps);\n\n      for (const group of stepGroups) {\n        if (group.type === 'parallel') {\n          // Execute all steps in parallel\n          const results = await Promise.allSettled(\n            group.steps.map((step) => this.executeStep(step, context, roleAssignments))\n          );\n\n          // Process results\n          results.forEach((result, index) => {\n            const step = group.steps[index];\n            if (result.status === 'fulfilled') {\n              stepLogs.push(result.value);\n              // Apply output mapping\n              this.applyOutputMapping(step, result.value.stepOutput, context);\n            } else {\n              stepLogs.push({\n                stepId: step.id,\n                stepName: step.name,\n                status: 'failed',\n                error: result.reason?.message || 'Unknown error',\n              });\n              throw new Error(`Step ${step.name} failed: ${result.reason?.message}`);\n            }\n          });\n        } else {\n          // Execute steps sequentially\n          for (const step of group.steps) {\n            // Check condition if present\n            if (step.condition && !this.evaluateCondition(step.condition, context)) {\n              stepLogs.push({\n                stepId: step.id,\n                stepName: step.name,\n                status: 'skipped',\n                reason: 'Condition not met',\n              });\n              continue;\n            }\n\n            const stepLog = await this.executeStep(step, context, roleAssignments);\n            stepLogs.push(stepLog);\n\n            if (stepLog.status === 'failed') {\n              throw new Error(`Step ${step.name} failed: ${stepLog.error}`);\n            }\n\n            // Apply output mapping\n            this.applyOutputMapping(step, stepLog.stepOutput, context);\n          }\n        }\n      }\n\n      // Mark as completed\n      await prisma.orchestrationExecution.update({\n        where: { id: executionId },\n        data: {\n          status: 'completed',\n          completedAt: new Date(),\n          context,\n          stepLogs,\n          output: context,\n        },\n      });\n\n      // ‚öñÔ∏è INTELLIGENCE LAYER: Evaluate execution quality (Judge)\n      const { AssessmentService } = await import('./AssessmentService.js');\n      console.log('[Orchestration] ‚öñÔ∏è  Triggering Judge evaluation...');\n      \n      // Run evaluation in background (don't block)\n      AssessmentService.evaluateExecution(executionId)\n        .then(async (assessment) => {\n          console.log(`[Orchestration] Judge score: ${assessment.score}, Passed: ${assessment.passed}`);\n          \n          // üìö INTELLIGENCE LAYER: Store as Golden Record if high quality (Librarian)\n          if (assessment.passed && assessment.score >= 0.7) {\n            await LibrarianService.storeGoldenRecord(\n              executionId,\n              assessment.score,\n              orchestration.tags\n            );\n          }\n        })\n        .catch((error) => {\n          console.error('[Orchestration] Judge evaluation failed:', error);\n        });\n\n    } catch (error: any) {\n      // Mark as failed\n      await prisma.orchestrationExecution.update({\n        where: { id: executionId },\n        data: {\n          status: 'failed',\n          completedAt: new Date(),\n          context,\n          stepLogs,\n          error: error.message,\n        },\n      });\n    }\n  }\n\n  /**\n   * Execute a single step with retry logic\n   * @param step - The orchestration step to execute\n   * @param context - The current execution context\n   * @param roleAssignments - Optional map of step names to role IDs\n   */\n  private static async executeStep(\n    step: OrchestrationStep,\n    context: Record<string, any>,\n    roleAssignments?: Record<string, string>\n  ): Promise<any> {\n    const startTime = Date.now();\n    let lastError: Error | null = null;\n\n    // Prepare input\n    const stepInput = this.applyInputMapping(step, context);\n\n    // [NEW] Check for Sub-Orchestration (Russian Doll Nesting)\n    if (step.stepType === 'sub_orchestration' && step.subOrchestrationId) {\n      console.log(`[Orchestration] Executing sub-orchestration: ${step.subOrchestrationId}`);\n      \n      try {\n        // Recursively execute the sub-orchestration\n        const subExecution = await this.executeOrchestration(\n          step.subOrchestrationId,\n          stepInput,\n          roleAssignments\n        );\n        \n        return {\n          stepId: step.id,\n          stepName: step.name,\n          status: subExecution.status === 'completed' ? 'completed' : 'failed',\n          stepInput,\n          stepOutput: subExecution.output,\n          subExecutionId: subExecution.id,\n          duration: Date.now() - startTime,\n          attempts: 1,\n        };\n      } catch (error: any) {\n        return {\n          stepId: step.id,\n          stepName: step.name,\n          status: 'failed',\n          stepInput,\n          error: `Sub-orchestration failed: ${error.message}`,\n          duration: Date.now() - startTime,\n          attempts: 1,\n        };\n      }\n    }\n\n    // Retry logic\n    for (let attempt = 0; attempt <= step.maxRetries; attempt++) {\n      try {\n        // Dynamic Role Selection\n        let role;\n        \n        // 1. Check if a role is assigned for this step\n        if (roleAssignments && roleAssignments[step.name]) {\n          role = await prisma.role.findUnique({ where: { id: roleAssignments[step.name] } });\n          if (!role) {\n            throw new Error(`Assigned role ${roleAssignments[step.name]} not found for step ${step.name}`);\n          }\n        } else {\n          // 2. Fallback strategy: Try to find a suitable role\n          // First try 'general_worker'\n          role = await prisma.role.findFirst({ where: { name: 'general_worker' } });\n          \n          if (!role) {\n            // Last resort: use any available role\n            role = await prisma.role.findFirst();\n          }\n\n          if (!role) {\n            throw new Error(`No available role found for step ${step.name}. Please provide roleAssignments or create a 'general_worker' role.`);\n          }\n          \n          console.warn(`[Orchestration] No role assigned for step \"${step.name}\". Using fallback role \"${role.name}\".`);\n        }\n\n        // Create agent for this role\n        const roleMetadata = (role.metadata as any) || {};\n\n        // [NEW] Tier-based Agent Creation\n        const tier = (step.tier as 'Executive' | 'Manager' | 'Worker') || 'Worker';\n        \n        let agent;\n        if (tier !== 'Worker') {\n          // Use tier-based creation for Executive/Manager\n          const { AgentFactoryService } = await import('./AgentFactory.js');\n          const { ProviderManager } = await import('./ProviderManager.js');\n          const { PrismaAgentConfigRepository } = await import('../repositories/PrismaAgentConfigRepository.js');\n          \n          const factory = new AgentFactoryService(\n            ProviderManager.getInstance(),\n            new PrismaAgentConfigRepository()\n          );\n          \n          agent = await factory.createVolcanoAgentWithTier({\n            roleId: role.id,\n            modelId: null,\n            isLocked: false,\n            temperature: roleMetadata.defaultTemperature || 0.7,\n            maxTokens: roleMetadata.defaultMaxTokens || 2048,\n          }, tier);\n          \n          console.log(`[Orchestration] Created ${tier} tier agent for step \"${step.name}\"`);\n        } else {\n          // Standard worker agent\n          agent = await createVolcanoAgent({\n            roleId: role.id,\n            modelId: null, // Let orchestrator pick best model\n            isLocked: false,\n            temperature: roleMetadata.defaultTemperature || 0.7,\n            maxTokens: roleMetadata.defaultMaxTokens || 2048,\n          });\n        }\n\n        const prompt = typeof stepInput === 'string' ? stepInput : JSON.stringify(stepInput);\n\n        // [NEW] Confidence-based Execution\n        const minConfidence = step.minConfidence ?? 0.8;\n        let output: string;\n        let confidence = 1.0;\n        \n        if (minConfidence > 0 && minConfidence < 1.0) {\n          // Use ConfidenceAgent wrapper\n          const { confidenceAgent } = await import('./ConfidenceAgent.js');\n          \n          const result = await this.executeWithTimeout(\n            confidenceAgent.executeWithConfidence(\n              {\n                roleId: role.id,\n                modelId: null,\n                isLocked: false,\n                temperature: roleMetadata.defaultTemperature || 0.7,\n                maxTokens: roleMetadata.defaultMaxTokens || 2048,\n              },\n              prompt,\n              { minConfidence }\n            ),\n            step.timeout || 300000 // Default 5 minutes\n          );\n          \n          output = result.output;\n          confidence = result.confidence;\n          \n          console.log(`[Orchestration] Step \"${step.name}\" completed with confidence ${confidence.toFixed(2)}`);\n        } else {\n          // Standard execution without confidence checking\n          output = await this.executeWithTimeout(\n            agent.generate(prompt),\n            step.timeout || 300000 // Default 5 minutes\n          );\n        }\n\n        // Update step's last confidence score\n        if (confidence !== 1.0) {\n          await prisma.orchestrationStep.update({\n            where: { id: step.id },\n            data: { lastConfidence: confidence }\n          }).catch(err => console.warn('[Orchestration] Failed to update lastConfidence:', err));\n        }\n\n        return {\n          stepId: step.id,\n          stepName: step.name,\n          status: 'completed',\n          stepInput,\n          stepOutput: output,\n          confidence,\n          tier,\n          duration: Date.now() - startTime,\n          attempts: attempt + 1,\n        };\n      } catch (error: any) {\n        lastError = error;\n        \n        // If not the last attempt, wait and retry\n        if (attempt < step.maxRetries) {\n          await this.sleep(step.retryDelay || 1000);\n        }\n      }\n    }\n\n    // All retries failed\n    return {\n      stepId: step.id,\n      stepName: step.name,\n      status: 'failed',\n      stepInput,\n      error: lastError?.message || 'Unknown error',\n      duration: Date.now() - startTime,\n      attempts: step.maxRetries + 1,\n    };\n  }\n\n  /**\n   * Group steps by execution type (parallel vs sequential)\n   */\n  private static groupStepsByExecution(steps: OrchestrationStep[]) {\n    const groups: Array<{ type: 'parallel' | 'sequential'; steps: OrchestrationStep[] }> = [];\n    let currentGroup: { type: 'parallel' | 'sequential'; steps: OrchestrationStep[] } | null = null;\n\n    for (const step of steps) {\n      if (step.parallelGroup) {\n        // Start or continue parallel group\n        if (!currentGroup || currentGroup.type !== 'parallel') {\n          if (currentGroup) groups.push(currentGroup);\n          currentGroup = { type: 'parallel', steps: [step] };\n        } else {\n          currentGroup.steps.push(step);\n        }\n      } else {\n        // Sequential step\n        if (currentGroup?.type === 'parallel') {\n          groups.push(currentGroup);\n          currentGroup = null;\n        }\n        if (!currentGroup) {\n          currentGroup = { type: 'sequential', steps: [step] };\n        } else {\n          currentGroup.steps.push(step);\n        }\n      }\n    }\n\n    if (currentGroup) groups.push(currentGroup);\n    return groups;\n  }\n\n  /**\n   * Apply input mapping using template variables\n   */\n  private static applyInputMapping(step: OrchestrationStep, context: Record<string, any>): any {\n    if (!step.inputMapping) {\n      return context;\n    }\n\n    const mapping = step.inputMapping as Record<string, any>;\n    const result: Record<string, any> = {};\n\n    for (const [key, template] of Object.entries(mapping)) {\n      if (typeof template === 'string') {\n        result[key] = this.resolveTemplate(template, context);\n      } else {\n        result[key] = template;\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Apply output mapping to context\n   */\n  private static applyOutputMapping(\n    step: OrchestrationStep,\n    output: any,\n    context: Record<string, any>\n  ) {\n    if (!step.outputMapping) {\n      // Default: store output under step name\n      context[step.name] = output;\n      return;\n    }\n\n    const mapping = step.outputMapping as Record<string, any>;\n    \n    for (const [contextKey, template] of Object.entries(mapping)) {\n      if (typeof template === 'string') {\n        context[contextKey] = this.resolveTemplate(template, { output, context });\n      } else {\n        context[contextKey] = template;\n      }\n    }\n  }\n\n  /**\n   * Resolve template variables like {{context.userQuery}}\n   */\n  private static resolveTemplate(template: string, data: Record<string, any>): any {\n    const matches = template.matchAll(/\\{\\{([^}]+)\\}\\}/g);\n    let result = template;\n\n    for (const match of matches) {\n      const path = match[1].trim();\n      const value = this.getNestedValue(data, path);\n      result = result.replace(match[0], value !== undefined ? String(value) : '');\n    }\n\n    return result;\n  }\n\n  /**\n   * Get nested value from object using dot notation\n   */\n  private static getNestedValue(obj: any, path: string): any {\n    return path.split('.').reduce((current, key) => current?.[key], obj);\n  }\n\n  /**\n   * Evaluate a condition\n   */\n  private static evaluateCondition(condition: any, context: Record<string, any>): boolean {\n    const { field, operator, value } = condition;\n    const fieldValue = this.getNestedValue(context, field);\n\n    switch (operator) {\n      case '>':\n        return fieldValue > value;\n      case '<':\n        return fieldValue < value;\n      case '>=':\n        return fieldValue >= value;\n      case '<=':\n        return fieldValue <= value;\n      case '==':\n      case '===':\n        return fieldValue === value;\n      case '!=':\n      case '!==':\n        return fieldValue !== value;\n      case 'contains':\n        return String(fieldValue).includes(String(value));\n      case 'exists':\n        return fieldValue !== undefined && fieldValue !== null;\n      default:\n        return false;\n    }\n  }\n\n  /**\n   * Execute a promise with timeout\n   */\n  private static executeWithTimeout<T>(promise: Promise<T>, timeout: number): Promise<T> {\n    return Promise.race([\n      promise,\n      new Promise<T>((_, reject) =>\n        setTimeout(() => reject(new Error('Step execution timeout')), timeout)\n      ),\n    ]);\n  }\n\n  /**\n   * Sleep utility\n   */\n  private static sleep(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  }\n\n  /**\n   * Get execution status\n   */\n  static async getExecutionStatus(executionId: string) {\n    return prisma.orchestrationExecution.findUnique({\n      where: { id: executionId },\n      include: {\n        orchestration: {\n          include: {\n            steps: {\n              orderBy: { order: 'asc' },\n            },\n          },\n        },\n      },\n    });\n  }\n\n  /**\n   * List executions for an orchestration\n   */\n  static async listExecutions(orchestrationId: string, limit = 50) {\n    return prisma.orchestrationExecution.findMany({\n      where: { orchestrationId },\n      orderBy: { startedAt: 'desc' },\n      take: limit,\n    });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/protocols/LocalProtocol.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/provider.service.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ProviderManager' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":31,"column":10,"nodeType":"Property","messageId":"anyAssignment","endLine":31,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":31,"column":14,"nodeType":"Identifier","messageId":"unsafeCall","endLine":31,"endColumn":20},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":116,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":116,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":116,"column":17,"nodeType":"Identifier","messageId":"unsafeCall","endLine":116,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":121,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4315,4318],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4315,4318],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":130,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4623,4626],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4623,4626],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":150,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":150,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":150,"column":17,"nodeType":"Identifier","messageId":"unsafeCall","endLine":150,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { v4 as uuidv4 } from 'uuid';\nimport { db } from '../db.js';\nimport { providerConfigs, modelRegistry, modelCapabilities } from '../db/schema.js';\nimport { eq } from 'drizzle-orm';\nimport { encrypt, decrypt } from '../utils/encryption.js';\nimport { ProviderFactory, LLMModel } from '../utils/ProviderFactory.js';\nimport { ProviderManager } from './ProviderManager.js';\n\nexport class ProviderService {\n  async listProviders() {\n    return db.select().from(providerConfigs);\n  }\n\n  // [NEW] Manage Providers via UI\n  async upsertProviderConfig(input: { id?: string, label: string, type: string, baseURL: string, apiKey?: string }) {\n    const encryptedKey = input.apiKey ? encrypt(input.apiKey) : undefined;\n    \n    if (input.id) {\n       return db.update(providerConfigs)\n         .set({\n           label: input.label,\n           type: input.type,\n           baseURL: input.baseURL,\n           ...(encryptedKey ? { apiKey: encryptedKey } : {}),\n           updatedAt: new Date()\n         })\n         .where(eq(providerConfigs.id, input.id))\n         .returning();\n    } else {\n       return db.insert(providerConfigs).values({\n         id: uuidv4(),\n         label: input.label,\n         type: input.type,\n         baseURL: input.baseURL,\n         apiKey: encryptedKey || '',\n         isEnabled: true,\n         updatedAt: new Date()\n       }).returning();\n    }\n  }\n\n  async addProvider(input: { name: string, providerType: string, baseURL: string, apiKey?: string }) {\n      return this.upsertProviderConfig({\n        label: input.name,\n        type: input.providerType,\n        baseURL: input.baseURL,\n        apiKey: input.apiKey,\n      });\n  }\n\n  async deleteProvider(id: string) {\n    return db.delete(providerConfigs).where(eq(providerConfigs.id, id));\n  }\n\n  async listAllAvailableModels() {\n    // We query the database, not the raw provider API\n    const models = await db.query.modelRegistry.findMany({\n      where: eq(modelRegistry.isActive, true),\n      with: {\n        provider: true,\n        capabilities: true\n      },\n      orderBy: (model, { desc }) => [desc(model.lastSeenAt)]\n    });\n\n    return models.map((model) => ({\n      id: model.modelId, // The actual model ID string (e.g. \"gpt-4\")\n      name: model.modelName || model.modelId,\n      providerId: model.providerId,\n      providerLabel: model.provider.label,\n      // Include capabilities for UI hints if needed\n      contextWindow: model.capabilities?.contextWindow || 0\n    }));\n  }\n\n  // [UPDATED] Ingest Logic - \"Fail-Open\" & Populate Capabilities\n  async fetchAndNormalizeModels(providerId: string) {\n      const providerConfig = await db.query.providerConfigs.findFirst({\n        where: eq(providerConfigs.id, providerId),\n      });\n      if (!providerConfig) throw new Error('Provider not found');\n\n      let apiKey: string;\n      try {\n        apiKey = decrypt(providerConfig.apiKey);\n      } catch (error) {\n        console.warn(`Failed to decrypt API key for provider ${providerConfig.id}.`, error);\n        throw new Error('Invalid API key configuration');\n      }\n\n      const providerInstance = ProviderFactory.createProvider(providerConfig.type, {\n        id: providerConfig.id,\n        apiKey,\n        baseURL: providerConfig.baseURL || undefined,\n      });\n\n      console.log(`[Ingestion] Fetching models for ${providerConfig.label} (${providerConfig.type})...`);\n      const rawModelList = await providerInstance.getModels();\n      console.log(`[Ingestion] Found ${rawModelList.length} models.`);\n\n      // HEURISTIC: Quick detection for Groq/Free models based on ID\n      const isLikelyFree = (id: string) => {\n         const lower = id.toLowerCase();\n         if (providerConfig.type === 'groq') return true; \n         if (lower.includes('free') || lower.includes('beta')) return true;\n         return false;\n      };\n\n      const upsertPromises = rawModelList.map(async (model: LLMModel) => {\n        const modelId = model.id;\n        if (!modelId) return;\n\n        // 1. Create/Update the Core Identity\n        const results = await db.insert(modelRegistry)\n          .values({\n            id: uuidv4(),\n            modelId: modelId,\n            providerId: providerConfig.id,\n            modelName: (model.name as string) || modelId,\n            isFree: isLikelyFree(modelId),\n            providerData: model as any,\n            isActive: true,\n            updatedAt: new Date(),\n          })\n          .onConflictDoUpdate({\n            target: [modelRegistry.modelId, modelRegistry.providerId],\n            set: {\n              isActive: true,\n              lastSeenAt: new Date(),\n              providerData: model as any,\n              updatedAt: new Date(),\n            }\n          })\n          .returning({ id: modelRegistry.id });\n\n        const dbModel = results[0];\n        if (!dbModel) return;\n\n        // 2. Populate/Update the Related Capabilities Table\n        // Use safe defaults (4096)\n        const contextWindow = (model.specs?.contextWindow as number) || (model.context_window as number) || 4096;\n        const maxOutput = (model.specs?.maxOutput as number) || (model.max_tokens as number) || 4096;\n        \n        const hasVision = modelId.toLowerCase().includes('vision') || \n                         modelId.toLowerCase().includes('vl') || \n                         !!model.specs?.hasVision;\n        \n        await db.insert(modelCapabilities)\n          .values({\n            id: uuidv4(),\n            modelId: dbModel.id,\n            contextWindow,\n            maxOutput,\n            hasVision,\n            hasAudioInput: modelId.toLowerCase().includes('whisper') || modelId.toLowerCase().includes('audio'),\n            updatedAt: new Date(),\n          })\n          .onConflictDoUpdate({\n            target: [modelCapabilities.modelId],\n            set: {\n              contextWindow: contextWindow,\n              maxOutput: maxOutput,\n              hasVision: hasVision,\n              updatedAt: new Date(),\n            }\n          });\n      });\n\n      await Promise.all(upsertPromises);\n      return { count: rawModelList.length };\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/tools/NativeToolsRegistry.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":20,"column":13,"nodeType":"Property","messageId":"anyAssignment","endLine":20,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":32,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":32,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":101,"column":17,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":101,"endColumn":81},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":101,"column":31,"nodeType":"TSAsExpression","messageId":"unsafeCall","endLine":101,"endColumn":67},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":101,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4090,4093],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4090,4093],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ToolDefinition } from '../protocols/LocalProtocol.js';\nimport { createFsTools } from '../../tools/filesystem.js';\nimport { browserTools } from '../../tools/browser.js';\nimport { webScraperTool } from '../../tools/webScraper.js';\nimport { complexityTool } from '../../tools/complexityTool.js';\nimport { terminalTools } from '../../tools/terminal.js';\nimport { getComponentRegistrySpec } from '../../tools/componentScanner.js';\nimport { listFilesTree, searchCodebase } from '@repo/mcp-server-vfs';\nimport { vfsSessionService } from '../vfsSession.service.js';\nimport { nebulaTool } from '../../tools/nebulaTool.js';\nimport { typescriptInterpreterTool } from '../../tools/typescriptInterpreter.js';\nimport { themeEditorTool } from '../../tools/themeEditor.js';\n\nexport function getNativeTools(rootPath: string, fsTools: ReturnType<typeof createFsTools>): ToolDefinition[] {\n     return [\n        {\n            name: themeEditorTool.name,\n            handler: themeEditorTool.handler,\n            description: themeEditorTool.description,\n            input_schema: themeEditorTool.inputSchema\n        },\n        {\n            name: nebulaTool.name,\n            handler: nebulaTool.handler,\n            description: nebulaTool.description,\n            input_schema: nebulaTool.input_schema\n        },\n        {\n          name: typescriptInterpreterTool.name,\n          handler: typescriptInterpreterTool.handler,\n          description: typescriptInterpreterTool.description,\n          input_schema: typescriptInterpreterTool.inputSchema\n        },\n        {\n            name: 'read_file',\n            handler: async (args: unknown) => fsTools.readFile(args as { path: string }),\n            description: 'Read a file',\n            input_schema: {\n                type: 'object',\n                properties: {\n                    path: { type: 'string' }\n                },\n                required: ['path']\n            }\n        },\n        {\n            name: 'write_file',\n            handler: async (args: unknown) => fsTools.writeFile(args as { path: string; content: string }),\n            description: 'Write to a file',\n            input_schema: {\n                type: 'object',\n                properties: {\n                    path: { type: 'string' },\n                    content: { type: 'string' }\n                },\n                required: ['path', 'content']\n            }\n        },\n        {\n            name: 'list_files',\n            handler: async (args: unknown) => fsTools.listFiles(args as { path: string }),\n            description: 'List files in a directory',\n            input_schema: {\n                type: 'object',\n                properties: {\n                    path: { type: 'string' }\n                },\n                required: ['path']\n            }\n        },\n        {\n            name: 'browse',\n            handler: async (args: unknown) => browserTools.fetchPage(args as { url: string }),\n            description: 'Fetch a web page',\n            input_schema: {\n                type: 'object',\n                properties: {\n                    url: { type: 'string' }\n                },\n                required: ['url']\n            }\n        },\n        {\n          name: webScraperTool.name,\n          handler: async (args: unknown) => webScraperTool.handler(args as { url: string }),\n          description: webScraperTool.description,\n          input_schema: webScraperTool.input_schema\n        },\n        {\n          name: complexityTool.name,\n          handler: async (args: unknown) => complexityTool.handler(args as { taskDescription: string }),\n          description: complexityTool.description,\n          input_schema: complexityTool.input_schema\n        },\n        {\n            name: 'terminal_execute',\n            handler: async (args: unknown) => {\n                // delegate to the centralized terminal tool implementation\n                // Use zod validation instead of casting\n                const parsedArgs = terminalTools.execute.inputSchema.parse(args);\n                return await (terminalTools.execute.handler as any)(parsedArgs);\n            },\n            description: terminalTools.execute.description,\n            input_schema: terminalTools.execute.inputSchema as unknown as Record<string, unknown>\n        },\n        {\n            name: 'search_codebase',\n            handler: async (args: unknown) => {\n                const typedArgs = args as { query: string };\n                const fs = await vfsSessionService.getProvider({ provider: 'local', rootPath: rootPath });\n                return searchCodebase(fs, typedArgs.query);\n            },\n            description: 'Search the codebase for a string',\n            input_schema: {\n                type: 'object',\n                properties: {\n                    query: { type: 'string' }\n                },\n                required: ['query']\n            }\n        },\n        {\n            name: 'list_files_tree',\n            handler: async () => {\n                const fs = await vfsSessionService.getProvider({ provider: 'local', rootPath: rootPath });\n                return listFilesTree(fs, '/');\n            },\n            description: 'List files in a tree structure',\n            input_schema: {\n                type: 'object',\n                properties: {},\n                required: []\n            }\n        },\n        {\n            name: 'scan_ui_components',\n            handler: async () => getComponentRegistrySpec(),\n            description: 'Returns a list of available UI components and their import paths',\n            input_schema: {\n                type: 'object',\n                properties: {},\n                required: []\n            }\n        }\n     ];\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/tools/ToolDocumentationLoader.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":25,"column":77,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":25,"endColumn":81},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":38,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ToolDefinition } from '../protocols/LocalProtocol.js';\n\nexport async function loadToolDocs(tools: string[], nativeTools: ToolDefinition[]): Promise<string> {\n    const docs: string[] = [];\n    const fs = await import('fs/promises');\n    const path = await import('path');\n\n    // Resolve path to .domoreai/tools\n    let rootDir = process.cwd();\n    if (rootDir.endsWith('apps/api')) {\n        rootDir = path.resolve(rootDir, '../../');\n    }\n    const toolsDir = path.join(rootDir, '.domoreai/tools');\n\n    for (const tool of tools) {\n        // 1. Native Tools\n        const nativeTool = nativeTools.find(t => t.name === tool);\n        if (nativeTool) {\n            docs.push(`### Tool: \\`system.${nativeTool.name}\\``);\n            docs.push(`**Description:** ${nativeTool.description}`);\n            docs.push('**Signature:**');\n            docs.push('```typescript');\n            // Simplified signature generation\n            const props = nativeTool.input_schema?.properties || {};\n            const args = Object.entries(props).map(([k, v]) => `${k}: ${(v).type}`).join(', ');\n            docs.push(`await system.${nativeTool.name}({ ${args} })`);\n            docs.push('```');\n            docs.push('---');\n            continue;\n        }\n\n        // 2. MCP Tools (Server Names)\n        // We assume the tool string IS the server name for MCP tools in this context\n        // (AgentRuntime init receives server names)\n        try {\n            const content = await fs.readFile(path.join(toolsDir, `${tool}_examples.md`), 'utf-8');\n            docs.push(content);\n        } catch (e) {\n            // Ignore if no doc found\n        }\n    }\n\n    return docs.join('\\n\\n');\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/vector.service.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":7,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[216,219],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[216,219],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2279,2282],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2279,2282],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2294,2297],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2294,2297],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":68,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":68,"endColumn":15},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":68,"column":13,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":68,"endColumn":15},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":70,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":70,"endColumn":74},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .metadata on an `any` value.","line":70,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":70,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":70,"column":34,"nodeType":"Property","messageId":"anyAssignment","endLine":70,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .content on an `any` value.","line":70,"column":43,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":70,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":70,"column":52,"nodeType":"Property","messageId":"anyAssignment","endLine":70,"endColumn":72},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .filePath on an `any` value.","line":70,"column":64,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":70,"endColumn":72},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":71,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":71,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .similarity on an `any` value.","line":71,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":71,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any[]`.","line":128,"column":5,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":128,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `Promise<any>`.","line":131,"column":3,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":156,"endColumn":6},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":150,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":150,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .embedding on an `any` value.","line":150,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":150,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":17,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// A simple in-memory vector store for demonstration purposes.\n// TODO: Replace this with a more robust solution like pgvector.\n\nexport interface Vector {\n  id: string;\n  vector: number[];\n  metadata: Record<string, any>;\n}\n\nexport class InMemoryVectorStore {\n  private vectors: Vector[] = [];\n\n  add(vectors: Vector[]) {\n    this.vectors.push(...vectors);\n    console.log(`Added ${vectors.length} vectors to the store. Total vectors: ${this.vectors.length}`);\n  }\n\n  // A simple cosine similarity search\n  search(queryVector: number[], topK: number): Vector[] {\n    const similarities = this.vectors.map(v => {\n      const dotProduct = v.vector.reduce((acc, val, i) => acc + val * queryVector[i], 0);\n      const magnitudeA = Math.sqrt(v.vector.reduce((acc, val) => acc + val * val, 0));\n      const magnitudeB = Math.sqrt(queryVector.reduce((acc, val) => acc + val * val, 0));\n      return { ...v, similarity: dotProduct / (magnitudeA * magnitudeB) };\n    });\n\n    return similarities.sort((a, b) => b.similarity - a.similarity).slice(0, topK);\n  }\n}\n\nimport { prisma } from '../db.js';\n\nexport class PgVectorStore {\n  async add(vectors: Vector[]) {\n    for (const v of vectors) {\n      const vectorString = JSON.stringify(v.vector);\n      // Store vector as JSON string instead of pgvector type\n      await prisma.$executeRawUnsafe(\n        `INSERT INTO \"VectorEmbedding\" (\"id\", \"vector\", \"content\", \"filePath\", \"metadata\")\n         VALUES ($1, $2, $3, $4, $5)\n         ON CONFLICT (\"id\") DO UPDATE SET\n         \"vector\" = EXCLUDED.\"vector\",\n         \"content\" = EXCLUDED.\"content\",\n         \"metadata\" = EXCLUDED.\"metadata\"`,\n        v.id,\n        vectorString,\n        v.metadata.chunk || '',\n        v.metadata.filePath || '',\n        v.metadata\n      );\n    }\n    console.log(`Added ${vectors.length} vectors to PG store.`);\n  }\n\n  async search(queryVector: number[], topK: number): Promise<Vector[]> {\n    const vectorString = `[${queryVector.join(',')}]`;\n    const results = await prisma.$queryRawUnsafe(\n      `SELECT \"id\", \"content\", \"filePath\", \"metadata\", \n              1 - (\"vector\" <=> $1::vector) as similarity\n       FROM \"VectorEmbedding\"\n       ORDER BY \"vector\" <=> $1::vector\n       LIMIT $2`,\n      vectorString,\n      topK\n    );\n\n    return (results as any[]).map((r: any) => ({\n      id: r.id,\n      vector: [], // Optimization: don't return the full vector\n      metadata: { ...r.metadata, chunk: r.content, filePath: r.filePath },\n      similarity: r.similarity\n    }));\n  }\n}\n\nexport const vectorStore = new PgVectorStore();\n\n// A simple text chunking function\nexport const chunkText = (text: string, chunkSize: number = 512, overlap: number = 100): string[] => {\n  const chunks: string[] = [];\n  let i = 0;\n  while (i < text.length) {\n    chunks.push(text.slice(i, i + chunkSize));\n    i += chunkSize - overlap;\n  }\n  return chunks;\n};\n\n// A placeholder for embedding generation\n// TODO: Replace this with a real embedding model. Consider using a library like sentence-transformers.\nimport axios from 'axios';\nimport { ProviderManager } from './ProviderManager.js';\nimport { OllamaProvider } from '../utils/OllamaProvider.js';\n\n// A placeholder for embedding generation\n// TODO: Replace this with a real embedding model. Consider using a library like sentence-transformers.\n// Simple concurrency limiter to prevent overwhelming local Ollama\nclass ConcurrencyLimiter {\n  private queue: (() => void)[] = [];\n  private activeCount = 0;\n  private maxConcurrency: number;\n\n  constructor(maxConcurrency: number) {\n    this.maxConcurrency = maxConcurrency;\n  }\n\n  async run<T>(fn: () => Promise<T>): Promise<T> {\n    if (this.activeCount >= this.maxConcurrency) {\n      await new Promise<void>(resolve => this.queue.push(resolve));\n    }\n    this.activeCount++;\n    try {\n      return await fn();\n    } finally {\n      this.activeCount--;\n      if (this.queue.length > 0) {\n        const next = this.queue.shift();\n        next?.();\n      }\n    }\n  }\n}\n\nconst embeddingLimiter = new ConcurrencyLimiter(1); // Limit to 1 concurrent request\n\nexport const createEmbedding = async (text: string): Promise<number[]> => {\n  if (!text || !text.trim()) {\n    return Array(1024).fill(0);\n  }\n\n  return embeddingLimiter.run(async () => {\n    // console.log(`Creating embedding for text: \"${text.substring(0, 50)}...\"`);\n    \n    // Try to get the 'local' provider first\n    const provider = ProviderManager.getProvider('local');\n    if (provider && provider instanceof OllamaProvider) {\n      try {\n        return await provider.generateEmbedding(text);\n      } catch (err) {\n        console.warn('Failed to use local provider for embedding, falling back to default localhost', err);\n      }\n    }\n\n    try {\n      const baseUrl = process.env.OLLAMA_BASE_URL || 'http://localhost:11434';\n      const response = await axios.post(`${baseUrl}/api/embeddings`, {\n        model: 'mxbai-embed-large',\n        prompt: text,\n      }, { timeout: 10000 }); // Add timeout\n      return response.data.embedding;\n    } catch (error) {\n      console.error(`Error creating embedding for text (${text.length} chars): \"${text.substring(0, 20)}...\"`, error);\n      // Fallback to random vector if Ollama fails, to keep the app running\n      return Array.from({ length: 1024 }, () => Math.random());\n    }\n  });\n};\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/vfs/IVfsProvider.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/vfs/LocalProvider.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/vfs/SshProvider.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":25,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[872,875],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[872,875],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":26,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":26,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":26,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":26,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .type on an `any` value.","line":27,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":27,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":28,"column":38,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":28,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":28,"column":43,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":28,"endColumn":47},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":29,"column":7,"nodeType":"Property","messageId":"anyAssignment","endLine":29,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .size on an `any` value.","line":29,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":29,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import Client from 'ssh2-sftp-client';\nimport path from 'path';\nimport { IVfsProvider, FileEntry } from './IVfsProvider.js';\nimport { emitFileWriteEvent } from './events.js';\n\nexport class SshProvider implements IVfsProvider {\n  private client: Client;\n  private rootPath: string;\n\n  constructor(client: Client, rootPath: string = '.') {\n    this.client = client;\n    this.rootPath = rootPath;\n  }\n\n  private resolvePath(relativePath: string): string {\n    // Always use posix for SSH as it's the standard for SFTP\n    // If rootPath is absolute (e.g. /home/user), join works.\n    // If rootPath is relative (e.g. .), join works.\n    return path.posix.join(this.rootPath, relativePath);\n  }\n\n  async list(dirPath: string): Promise<FileEntry[]> {\n    const fullPath = this.resolvePath(dirPath);\n    const list = await this.client.list(fullPath);\n    return list.map((item: any) => ({\n      name: item.name,\n      type: item.type === 'd' ? 'directory' : 'file',\n      path: path.posix.join(dirPath, item.name),\n      size: item.size\n    }));\n  }\n\n  async read(filePath: string): Promise<string> {\n    const fullPath = this.resolvePath(filePath);\n    const buffer = await this.client.get(fullPath);\n    if (buffer instanceof Buffer) {\n      return buffer.toString('utf-8');\n    }\n    throw new Error('Unexpected return type from sftp.get');\n  }\n\n  async write(filePath: string, content: string | Buffer): Promise<void> {\n    const fullPath = this.resolvePath(filePath);\n    const dir = path.posix.dirname(fullPath);\n    const contentBuffer = Buffer.isBuffer(content) ? content : Buffer.from(content, 'utf-8');\n    \n    // Ensure directory exists\n    const dirExists = await this.client.exists(dir);\n    if (!dirExists) {\n        await this.client.mkdir(dir, true);\n    }\n    \n    await this.client.put(contentBuffer, fullPath);\n\n    // Emit the file write event for ingestion\n    emitFileWriteEvent(this, filePath, contentBuffer);\n  }\n\n  async mkdir(dirPath: string): Promise<void> {\n    const fullPath = this.resolvePath(dirPath);\n    await this.client.mkdir(fullPath, true);\n  }\n\n  async exists(filePath: string): Promise<boolean> {\n    const fullPath = this.resolvePath(filePath);\n    const result = await this.client.exists(fullPath);\n    return !!result; // exists returns false | 'd' | '-' etc.\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/vfs/events.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/vfsSession.service.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/websocket.service.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":26,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[903,906],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[903,906],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":81,"column":23,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":81,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .toString on an `any` value.","line":81,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":81,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":89,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":89,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":89,"column":20,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":89,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .toString on an `any` value.","line":89,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":89,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":108,"column":17,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":108,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .resize on an `any` value.","line":111,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":111,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":116,"column":17,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":116,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .command on an `any` value.","line":116,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":116,"endColumn":39},{"ruleId":"@typescript-eslint/restrict-template-expressions","severity":2,"message":"Invalid type \"Buffer<ArrayBufferLike>\" of template literal expression.","line":159,"column":78,"nodeType":"Identifier","messageId":"invalidType","endLine":159,"endColumn":84}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { WebSocketServer, WebSocket } from 'ws';\nimport { Server } from 'http';\nimport type { IncomingMessage } from 'http';\nimport { spawn } from 'child_process';\n\n/**\n * Manages the WebSocket server for handling Virtual File System (VFS) operations.\n * It initializes the server, handles incoming connections, and validates VFS session tokens.\n */\nexport class WebSocketService {\n  private wss: WebSocketServer;\n\n  /**\n   * Creates an instance of WebSocketService and initializes the WebSocket server.\n   * @param server - The HTTP server instance to attach the WebSocket server to.\n   */\n  constructor(server: Server) {\n    this.wss = new WebSocketServer({ server, path: '/vfs' });\n    this.initialize();\n  }\n\n  /**\n   * Broadcast a JSON-serializable payload to all connected WebSocket clients.\n   * Used for lightweight app events such as ingest progress messages.\n   */\n  public broadcast(payload: any): void {\n    try {\n      const message = JSON.stringify(payload);\n      this.wss.clients.forEach((client) => {\n        if (client.readyState === WebSocket.OPEN) {\n          client.send(message);\n        }\n      });\n    } catch (err) {\n      console.error('Failed to broadcast WebSocket message:', err);\n    }\n  }\n\n  /**\n   * Initializes the WebSocket server and sets up connection handling.\n   * @private\n   */\n  private initialize(): void {\n    this.wss.on('connection', (ws: WebSocket, req: IncomingMessage) => {\n      console.log('WebSocket client connected');\n      const url = new URL(req.url || '', `http://${req.headers.host}`);\n      const vfsToken = url.searchParams.get('vfs_token');\n\n      if (!vfsToken) {\n        console.log('WebSocket client disconnected: No VFS token provided.');\n        ws.close(1008, 'No VFS token provided');\n        return;\n      }\n\n      console.log('VFS session validated for WebSocket client. Spawning shell...');\n\n      // Fallback to raw bash spawn since node-pty failed to build and python3 is missing/broken.\n      // We implement a custom \"Line Editor\" in TypeScript to simulate PTY behavior (echo, line buffering).\n      const shell = spawn('/bin/bash', [], {\n        env: { ...process.env, TERM: 'xterm-256color' },\n        cwd: process.cwd()\n      });\n\n      // Send a fake prompt on connection (delayed to ensure client is ready)\n      setTimeout(() => {\n        const prompt = '\\r\\n\\x1b[32m$ \\x1b[0m';\n        if (ws.readyState === WebSocket.OPEN) {\n            ws.send(JSON.stringify({\n                timestamp: new Date().toISOString(),\n                type: 'info',\n                message: prompt\n            }));\n        }\n      }, 100);\n\n      // Handle shell output\n      shell.stdout.on('data', (data) => {\n        ws.send(JSON.stringify({\n          timestamp: new Date().toISOString(),\n          type: 'info',\n          message: `${data.toString()}\\r\\n\\x1b[32m$ \\x1b[0m` // Append prompt after output\n        }));\n      });\n\n      shell.stderr.on('data', (data) => {\n        ws.send(JSON.stringify({\n          timestamp: new Date().toISOString(),\n          type: 'error',\n          message: data.toString()\n        }));\n      });\n\n      shell.on('exit', (code) => {\n        console.log(`Shell exited with code ${code}`);\n        ws.close();\n      });\n      \n      ws.on('error', (err) => {\n          console.error('WebSocket error:', err);\n      });\n\n      // Line buffer for editing\n      let currentLine = '';\n\n      // Handle incoming messages (input to shell)\n      ws.on('message', (message: string) => {\n        try {\n          const parsed = JSON.parse(message);\n          \n          // Handle resize (ignored for raw spawn)\n          if (parsed.resize) {\n            return;\n          }\n\n          // Handle input\n          const input = parsed.command || parsed;\n          \n          if (typeof input === 'string') {\n             // Implement basic line discipline (Echo + Editing)\n             for (const char of input) {\n               if (char === '\\r' || char === '\\n') {\n                 // Enter key: Echo newline, send line to shell, clear buffer\n                 ws.send(JSON.stringify({\n                    timestamp: new Date().toISOString(),\n                    type: 'info',\n                    message: '\\r\\n'\n                 }));\n                 shell.stdin.write(currentLine + '\\n');\n                 currentLine = '';\n               } else if (char === '\\x7f' || char === '\\b') {\n                 // Backspace: Remove last char from buffer, echo backspace sequence\n                 if (currentLine.length > 0) {\n                   currentLine = currentLine.slice(0, -1);\n                   // Move back, print space, move back\n                   ws.send(JSON.stringify({\n                      timestamp: new Date().toISOString(),\n                      type: 'info',\n                      message: '\\b \\b'\n                   }));\n                 }\n               } else if (char >= ' ') {\n                 // Printable character: Add to buffer, echo\n                 currentLine += char;\n                 ws.send(JSON.stringify({\n                    timestamp: new Date().toISOString(),\n                    type: 'info',\n                    message: char\n                 }));\n               }\n             }\n          }\n        } catch (e) {\n            // If parse fails, treat as raw string\n            console.error('Failed to parse message:', e);\n        }\n      });\n\n      ws.on('close', (code, reason) => {\n        console.log(`WebSocket client disconnected. Code: ${code}, Reason: ${reason}`);\n        shell.kill();\n      });\n    });\n  }\n\n  /**\n   * Closes the WebSocket server and terminates all client connections.\n   */\n  public close(): void {\n    console.log('Closing WebSocket server...');\n    this.wss.close();\n  }\n}\n  ","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/services/websocket.singleton.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/testing/seed-test-db.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tokenizer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/browser.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/complexityTool.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/componentScanner.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/filesystem.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/meta.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":60,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2217,2220],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2217,2220],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":63,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":63,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":63,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":63,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":64,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":64,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .basePrompt on an `any` value.","line":64,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":64,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":65,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":65,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tools on an `any` value.","line":65,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":65,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":118,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":118,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3568,3571],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3568,3571],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":120,"column":18,"nodeType":"Property","messageId":"anyAssignment","endLine":120,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .roleId on an `any` value.","line":120,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":120,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":122,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":122,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .updates on an `any` value.","line":122,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":122,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":123,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":123,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .updates on an `any` value.","line":123,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":123,"endColumn":30},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":144,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":144,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4191,4194],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4191,4194],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":146,"column":18,"nodeType":"Property","messageId":"anyAssignment","endLine":146,"endColumn":33},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .roleId on an `any` value.","line":146,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":146,"endColumn":33},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":213,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":213,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6738,6741],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6738,6741],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":215,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":215,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":215,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":215,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":216,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":216,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":216,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":216,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":217,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":217,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tags on an `any` value.","line":217,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":217,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":218,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":218,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .steps on an `any` value.","line":218,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":218,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .steps on an `any` value.","line":223,"column":118,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":223,"endColumn":123},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":245,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":245,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7594,7597],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7594,7597],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":247,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":247,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tags on an `any` value.","line":247,"column":20,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":247,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":248,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":248,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .activeOnly on an `any` value.","line":248,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":248,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":251,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":251,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7797,7800],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7797,7800],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":252,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":252,"endColumn":17},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":252,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":252,"endColumn":17},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":253,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":253,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":253,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":253,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":254,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":254,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .description on an `any` value.","line":254,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":254,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":255,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":255,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .steps on an `any` value.","line":255,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":255,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":256,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":256,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .tags on an `any` value.","line":256,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":256,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":257,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":257,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .isActive on an `any` value.","line":257,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":257,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":258,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":258,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .executions on an `any` value.","line":258,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":258,"endColumn":36},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":278,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":278,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8462,8465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8462,8465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":279,"column":73,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":279,"endColumn":86},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .nameOrId on an `any` value.","line":279,"column":78,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":279,"endColumn":86},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .nameOrId on an `any` value.","line":284,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":284,"endColumn":50},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":309,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":309,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9291,9294],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9291,9294],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":311,"column":9,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":311,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestrationId on an `any` value.","line":311,"column":14,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":311,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .input on an `any` value.","line":312,"column":14,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":312,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":332,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":332,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9977,9980],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9977,9980],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":333,"column":71,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":333,"endColumn":87},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .executionId on an `any` value.","line":333,"column":76,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":333,"endColumn":87},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .executionId on an `any` value.","line":338,"column":38,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":338,"endColumn":49},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":377,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":377,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11164,11167],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11164,11167],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":379,"column":9,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":379,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestrationId on an `any` value.","line":379,"column":14,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":379,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ name?: string | undefined; description?: string | undefined; tags?: string[] | undefined; isActive?: boolean | undefined; }`.","line":380,"column":9,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":380,"endColumn":21},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .updates on an `any` value.","line":380,"column":14,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":380,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":400,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":400,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11718,11721],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11718,11721],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":401,"column":76,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":401,"endColumn":96},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .orchestrationId on an `any` value.","line":401,"column":81,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":401,"endColumn":96}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":67,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { prisma } from '../db.js';\nimport { OrchestrationService } from '../services/orchestration.service.js';\nimport type { SandboxTool } from '../types.js';\n\n/**\n * Meta-tools that allow agents to create roles and orchestrations\n * These are only exposed to agents that have been granted these capabilities\n */\n\nexport const metaTools: SandboxTool[] = [\n  {\n    name: 'create_role',\n    description: 'Create a new AI role with specific capabilities and constraints. Use this to define new agent personas.',\n    inputSchema: {\n      type: 'object',\n      properties: {\n        name: {\n          type: 'string',\n          description: 'Unique name for the role (e.g., \"Code Reviewer\", \"Research Assistant\")',\n        },\n        basePrompt: {\n          type: 'string',\n          description: 'System prompt that defines this role\\'s behavior and responsibilities',\n        },\n        capabilities: {\n          type: 'object',\n          properties: {\n            needsVision: { type: 'boolean', default: false },\n            needsReasoning: { type: 'boolean', default: false },\n            needsCoding: { type: 'boolean', default: false },\n            needsTools: { type: 'boolean', default: false },\n            needsJson: { type: 'boolean', default: false },\n            needsUncensored: { type: 'boolean', default: false },\n          },\n          description: 'Capabilities required for this role',\n        },\n        contextLimits: {\n          type: 'object',\n          properties: {\n            minContext: { type: 'number', description: 'Minimum context window' },\n            maxContext: { type: 'number', description: 'Maximum context window' },\n          },\n        },\n        tools: {\n          type: 'array',\n          items: { type: 'string' },\n          description: 'List of MCP tools this role can access (e.g., [\"git\", \"postgres\"])',\n        },\n        hyperparameters: {\n          type: 'object',\n          properties: {\n            temperature: { type: 'number', minimum: 0, maximum: 2 },\n            maxTokens: { type: 'number' },\n            topP: { type: 'number', minimum: 0, maximum: 1 },\n          },\n        },\n      },\n      required: ['name', 'basePrompt'],\n    },\n    handler: async (args: any) => {\n      const role = await prisma.role.create({\n        data: {\n          name: args.name,\n          basePrompt: args.basePrompt,\n          tools: args.tools || [],\n        },\n      });\n\n      return [{\n        type: 'text',\n        text: `‚úÖ Role \"${role.name}\" created successfully.\\nID: ${role.id}`,\n      }];\n    },\n  },\n\n  {\n    name: 'list_roles',\n    description: 'List all available roles in the system',\n    inputSchema: {\n      type: 'object',\n      properties: {},\n    },\n    handler: async () => {\n      const roles = await prisma.role.findMany({\n        select: {\n          id: true,\n          name: true,\n          basePrompt: true,\n          tools: true,\n        },\n        orderBy: { name: 'asc' },\n      });\n\n      return [{\n        type: 'text',\n        text: JSON.stringify(roles, null, 2),\n      }];\n    },\n  },\n\n  {\n    name: 'update_role',\n    description: 'Update an existing role\\'s configuration',\n    inputSchema: {\n      type: 'object',\n      properties: {\n        roleId: { type: 'string', description: 'ID of the role to update' },\n        updates: {\n          type: 'object',\n          properties: {\n            basePrompt: { type: 'string' },\n            tools: { type: 'array', items: { type: 'string' } },\n          },\n        },\n      },\n      required: ['roleId', 'updates'],\n    },\n    handler: async (args: any) => {\n      const role = await prisma.role.update({\n        where: { id: args.roleId },\n        data: {\n          basePrompt: args.updates.basePrompt,\n          tools: args.updates.tools,\n        },\n      });\n\n      return [{\n        type: 'text',\n        text: `‚úÖ Role \"${role.name}\" updated successfully.`,\n      }];\n    },\n  },\n\n  {\n    name: 'delete_role',\n    description: 'Delete a role from the system',\n    inputSchema: {\n      type: 'object',\n      properties: {\n        roleId: { type: 'string', description: 'ID of the role to delete' },\n      },\n      required: ['roleId'],\n    },\n    handler: async (args: any) => {\n      const role = await prisma.role.delete({\n        where: { id: args.roleId },\n      });\n\n      return [{\n        type: 'text',\n        text: `‚úÖ Role \"${role.name}\" deleted successfully.`,\n      }];\n    },\n  },\n\n  {\n    name: 'create_orchestration',\n    description: 'Create a multi-step workflow that chains multiple roles together. Use this to define complex agent workflows.',\n    inputSchema: {\n      type: 'object',\n      properties: {\n        name: {\n          type: 'string',\n          description: 'Unique name for the orchestration (e.g., \"Code Review Pipeline\")',\n        },\n        description: {\n          type: 'string',\n          description: 'Description of what this orchestration does',\n        },\n        tags: {\n          type: 'array',\n          items: { type: 'string' },\n          description: 'Tags for categorizing this orchestration (e.g., [\"coding\", \"review\"])',\n        },\n        steps: {\n          type: 'array',\n          items: {\n            type: 'object',\n            properties: {\n              name: { type: 'string', description: 'Name of this step' },\n              description: { type: 'string' },\n              order: { type: 'number', description: 'Execution order (0, 1, 2, ...)' },\n              roleName: { type: 'string', description: 'Name of the role to use for this step' },\n              stepType: {\n                type: 'string',\n                enum: ['sequential', 'parallel', 'conditional', 'loop'],\n                description: 'Execution type',\n              },\n              inputMapping: {\n                type: 'object',\n                description: 'Map orchestration context to step input using {{template}} syntax',\n                additionalProperties: { type: 'string' },\n              },\n              outputMapping: {\n                type: 'object',\n                description: 'Map step output to orchestration context',\n              },\n              condition: {\n                type: 'object',\n                description: 'Conditional logic: { field: \"path.to.value\", operator: \">\", value: 0.8 }',\n              },\n              maxRetries: { type: 'number', default: 0 },\n              timeout: { type: 'number', description: 'Timeout in milliseconds' },\n              parallelGroup: { type: 'string', description: 'Group ID for parallel execution' },\n            },\n            required: ['name', 'order'],\n          },\n          description: 'Steps in the orchestration',\n        },\n      },\n      required: ['name', 'steps'],\n    },\n    handler: async (args: any) => {\n      const orchestration = await OrchestrationService.createOrchestration({\n        name: args.name,\n        description: args.description,\n        tags: args.tags || [],\n        steps: args.steps,\n      });\n\n      return [{\n        type: 'text',\n        text: `‚úÖ Orchestration \"${orchestration.name}\" created successfully.\\nID: ${orchestration.id}\\nSteps: ${args.steps.length}`,\n      }];\n    },\n  },\n\n  {\n    name: 'list_orchestrations',\n    description: 'List all available orchestrations',\n    inputSchema: {\n      type: 'object',\n      properties: {\n        tags: {\n          type: 'array',\n          items: { type: 'string' },\n          description: 'Filter by tags',\n        },\n        activeOnly: {\n          type: 'boolean',\n          description: 'Only show active orchestrations',\n        },\n      },\n    },\n    handler: async (args: any) => {\n      const orchestrations = await OrchestrationService.listOrchestrations({\n        tags: args.tags,\n        isActive: args.activeOnly,\n      });\n\n      const summary = orchestrations.map((o: any) => ({\n        id: o.id,\n        name: o.name,\n        description: o.description,\n        steps: o.steps.length,\n        tags: o.tags,\n        isActive: o.isActive,\n        lastExecution: o.executions[0]?.startedAt,\n      }));\n\n      return [{\n        type: 'text',\n        text: JSON.stringify(summary, null, 2),\n      }];\n    },\n  },\n\n  {\n    name: 'get_orchestration',\n    description: 'Get detailed information about a specific orchestration',\n    inputSchema: {\n      type: 'object',\n      properties: {\n        nameOrId: { type: 'string', description: 'Orchestration name or ID' },\n      },\n      required: ['nameOrId'],\n    },\n    handler: async (args: any) => {\n      const orchestration = await OrchestrationService.getOrchestration(args.nameOrId);\n\n      if (!orchestration) {\n        return [{\n          type: 'text',\n          text: `‚ùå Orchestration \"${args.nameOrId}\" not found.`,\n        }];\n      }\n\n      return [{\n        type: 'text',\n        text: JSON.stringify(orchestration, null, 2),\n      }];\n    },\n  },\n\n  {\n    name: 'execute_orchestration',\n    description: 'Execute an orchestration with given input',\n    inputSchema: {\n      type: 'object',\n      properties: {\n        orchestrationId: { type: 'string', description: 'ID of the orchestration to execute' },\n        input: {\n          type: 'object',\n          description: 'Input data for the orchestration',\n        },\n      },\n      required: ['orchestrationId', 'input'],\n    },\n    handler: async (args: any) => {\n      const execution = await OrchestrationService.executeOrchestration(\n        args.orchestrationId,\n        args.input\n      );\n\n      return [{\n        type: 'text',\n        text: `‚úÖ Orchestration execution started.\\nExecution ID: ${execution.id}\\nStatus: ${execution.status}\\n\\nUse get_execution_status with this ID to check progress.`,\n      }];\n    },\n  },\n\n  {\n    name: 'get_execution_status',\n    description: 'Check the status of an orchestration execution',\n    inputSchema: {\n      type: 'object',\n      properties: {\n        executionId: { type: 'string', description: 'Execution ID' },\n      },\n      required: ['executionId'],\n    },\n    handler: async (args: any) => {\n      const execution = await OrchestrationService.getExecutionStatus(args.executionId);\n\n      if (!execution) {\n        return [{\n          type: 'text',\n          text: `‚ùå Execution \"${args.executionId}\" not found.`,\n        }];\n      }\n\n      const status = {\n        status: execution.status,\n        startedAt: execution.startedAt,\n        completedAt: execution.completedAt,\n        output: execution.output,\n        error: execution.error,\n        stepLogs: execution.stepLogs,\n      };\n\n      return [{\n        type: 'text',\n        text: JSON.stringify(status, null, 2),\n      }];\n    },\n  },\n\n  {\n    name: 'update_orchestration',\n    description: 'Update an orchestration\\'s metadata',\n    inputSchema: {\n      type: 'object',\n      properties: {\n        orchestrationId: { type: 'string' },\n        updates: {\n          type: 'object',\n          properties: {\n            name: { type: 'string' },\n            description: { type: 'string' },\n            tags: { type: 'array', items: { type: 'string' } },\n            isActive: { type: 'boolean' },\n          },\n        },\n      },\n      required: ['orchestrationId', 'updates'],\n    },\n    handler: async (args: any) => {\n      const orchestration = await OrchestrationService.updateOrchestration(\n        args.orchestrationId,\n        args.updates\n      );\n\n      return [{\n        type: 'text',\n        text: `‚úÖ Orchestration \"${orchestration.name}\" updated successfully.`,\n      }];\n    },\n  },\n\n  {\n    name: 'delete_orchestration',\n    description: 'Delete an orchestration',\n    inputSchema: {\n      type: 'object',\n      properties: {\n        orchestrationId: { type: 'string' },\n      },\n      required: ['orchestrationId'],\n    },\n    handler: async (args: any) => {\n      const orchestration = await OrchestrationService.deleteOrchestration(args.orchestrationId);\n\n      return [{\n        type: 'text',\n        text: `‚úÖ Orchestration \"${orchestration.name}\" deleted successfully.`,\n      }];\n    },\n  },\n];\n\n/**\n * Check if a role has permission to use meta-tools\n */\nexport async function canUseMetaTools(roleId: string): Promise<boolean> {\n  const role = await prisma.role.findUnique({\n    where: { id: roleId },\n    select: { tools: true },\n  });\n\n  // Meta-tools are available if the role includes 'meta' in its tools array\n  return role?.tools.includes('meta') || false;\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/nebulaTool.ts","messages":[{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'handler' has no 'await' expression.","line":94,"column":5,"nodeType":"ArrowFunctionExpression","messageId":"missingAwait","endLine":94,"endColumn":20,"suggestions":[{"messageId":"removeAsync","fix":{"range":[3890,3896],"text":""},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3966,3969],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3966,3969],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\nexport const nebulaTool = {\n    name: 'nebula',\n    description: `A layout engine tool for manipulating the Nebula UI tree. \n    \n    NEBULA CODE MODE v2.0:\n    When writing TypeScript to manipulate the UI, use the global 'nebula' and 'ast' objects.\n    \n    1. addNode(parentId, node): Adds a node and RETURNS a unique nodeId. ALWAYS capture this ID.\n    2. updateNode(nodeId, update): Updates an existing node.\n    3. moveNode(nodeId, targetParentId, index): Moves a node.\n    4. deleteNode(nodeId): Deletes a node.\n    5. ast.parse(jsx): Parses raw JSX into a fragment for ingestion.\n    \n    Example:\n    const cardId = nebula.addNode('root', { type: 'Box', props: { className: 'p-4' } });\n    nebula.addNode(cardId, { type: 'Text', props: { children: 'Hello v2.0' } });`,\n    input_schema: {\n        type: 'object',\n        properties: {\n            action: { \n                type: 'string', \n                enum: ['addNode', 'updateNode', 'moveNode', 'deleteNode', 'ingest', 'setTheme'],\n                description: 'The operation to perform on the layout.'\n            },\n            parentId: { \n                type: 'string',\n                description: 'The ID of the parent node (required for addNode and ingest).'\n            },\n            nodeId: {\n                type: 'string',\n                description: 'The ID of the node to manipulate (required for updateNode, moveNode, deleteNode).'\n            },\n            node: {\n                type: 'object',\n                description: 'The node definition (required for addNode). Should include type, props, style, layout, bindings, and actions.',\n                properties: {\n                    type: { type: 'string', enum: ['Box', 'Text', 'Button', 'Card', 'Image', 'Input', 'Icon'] },\n                    props: { type: 'object' },\n                    style: { type: 'object' },\n                    layout: { type: 'object' },\n                    bindings: { \n                        type: 'array',\n                        items: {\n                            type: 'object',\n                            properties: {\n                                propName: { type: 'string' },\n                                sourcePath: { type: 'string' }\n                            }\n                        }\n                    },\n                    actions: {\n                        type: 'array',\n                        items: {\n                            type: 'object',\n                            properties: {\n                                trigger: { type: 'string', enum: ['onClick', 'onSubmit'] },\n                                type: { type: 'string', enum: ['navigate', 'mutation', 'toast'] },\n                                payload: { type: 'object' }\n                            }\n                        }\n                    },\n                    meta: { type: 'object' }\n                }\n            },\n            rawJsx: {\n              type: 'string',\n              description: 'The raw JSX string to ingest (required for ingest).'\n            },\n            theme: {\n              type: 'object',\n              description: 'The theme configuration (required for setTheme).',\n              properties: {\n                primary: { type: 'string' },\n                radius: { type: 'number' },\n                font: { type: 'string' }\n              }\n            },\n            update: {\n                type: 'object',\n                description: 'The properties to update (required for updateNode).'\n            },\n            targetParentId: {\n                type: 'string',\n                description: 'The new parent ID (required for moveNode).'\n            },\n            index: {\n                type: 'number',\n                description: 'The index to insert/move the node to (required for moveNode).'\n            }\n        },\n        required: ['action']\n    },\n    handler: async (args: unknown) => {\n        const typedArgs = args as Record<string, any>;\n        // Return structured action for the UI to consume\n        return {\n            status: 'success',\n            ui_action: {\n                tool: 'nebula',\n                ...typedArgs\n            },\n            message: `Nebula operation '${typedArgs.action}' queued for UI execution.`\n        };\n    }\n};\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/search.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":82,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":85,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[880,883],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[880,883],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { SandboxTool } from '../types.js';\n\nexport const searchCodebaseTool: SandboxTool = {\n  name: 'search_codebase',\n  description: 'Semantic search over the codebase using vector embeddings. Use this to find relevant code snippets or documentation.',\n  inputSchema: {\n    type: 'object',\n    properties: {\n      query: { type: 'string', description: 'The search query' },\n      limit: { type: 'number', description: 'Max results to return (default 5)' }\n    },\n    required: ['query']\n  },\n  handler: async (args: { query: string; limit?: number }) => {\n    // Import dynamically to avoid circular dependencies or aggressive startup loading\n    const { vectorStore, createEmbedding } = await import('../services/vector.service.js');\n    const queryEmbedding = await createEmbedding(args.query);\n    const results = await vectorStore.search(queryEmbedding, args.limit || 5) as any[];\n    \n    return results.map((r: { metadata: { filePath: string; chunk: string }; similarity: number }) => `File: ${r.metadata.filePath}\\nSimilarity: ${r.similarity.toFixed(4)}\\nContent:\\n${r.metadata.chunk}\\n---`).join('\\n');\n  }\n};\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/terminal.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1318,1321],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1318,1321],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stdout on an `any` value.","line":31,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":31,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stdout on an `any` value.","line":31,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":31,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":32,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":32,"endColumn":98},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stderr on an `any` value.","line":32,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":32,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .stderr on an `any` value.","line":32,"column":47,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":32,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":32,"column":71,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":32,"endColumn":78},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":33,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":33,"endColumn":68},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .code on an `any` value.","line":33,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":33,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .code on an `any` value.","line":33,"column":60,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":33,"endColumn":64}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { exec } from 'child_process';\nimport { promisify } from 'util';\nimport { z } from 'zod';\n\nconst execAsync = promisify(exec);\n\nconst ExecuteInputSchema = z.object({\n  command: z.string().describe('The bash command to run'),\n  cwd: z.string().optional().describe('Optional working directory (relative to repo root)')\n});\n\nexport const terminalTools = {\n  execute: {\n    name: 'terminal_execute',\n    description: 'EXECUTE: Run a bash command in the project root.\\n\\nRULES:\\n1. You are in a secure environment.\\n2. Output (stdout/stderr) is captured and returned to you.\\n3. Use this to run tests, install packages (npm install), or manage git.\\n4. Do NOT run interactive commands (like `top` or `nano`).\\n5. Commands run with a 30s timeout; long-running tasks should be broken into smaller steps.',\n    inputSchema: ExecuteInputSchema,\n    handler: async ({ command, cwd }: { command: string; cwd?: string }) => {\n      try {\n        console.log(`[Terminal] üíª Executing: ${command}`);\n        const { stdout, stderr } = await execAsync(command, { cwd: cwd || process.cwd(), timeout: 30000 });\n        return {\n          status: 'success',\n          stdout: stdout ? stdout.toString().trim() : '',\n          stderr: stderr ? stderr.toString().trim() : '',\n          exitCode: 0,\n        };\n      } catch (error: any) {\n        console.warn(`[Terminal] ‚ö†Ô∏è Error executing: ${command}`);\n        return {\n          status: 'error',\n          stdout: error.stdout ? String(error.stdout).trim() : '',\n          stderr: error.stderr ? String(error.stderr).trim() : (error.message || 'Unknown error'),\n          exitCode: typeof error.code === 'number' ? error.code : 1,\n          hint: 'Check command syntax, working directory, and avoid interactive commands.'\n        };\n      }\n    }\n  }\n};\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/themeEditor.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":38,"column":9,"nodeType":"AssignmentExpression","messageId":"anyAssignment","endLine":38,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access [key] on an `any` value.","line":51,"column":13,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":51,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from \"fs/promises\";\nimport path from \"path\";\nimport type { SandboxTool } from \"../types.js\";\n\n// Resolve the path to theme.json relative to the current module\n// This assumes the tool is running from within the 'api' project's structure\nconst themeJsonPath = path.resolve(process.cwd(), \"../ui/src/theme/theme.json\");\n\nexport const themeEditorTool: SandboxTool = {\n  name: \"updateThemeValue\",\n  description:\n    \"Updates a specific key-value pair in the theme.json file to change the UI's appearance. Use this to modify global colors, fonts, and other theme-level settings.\",\n\n  inputSchema: {\n    type: \"object\",\n    properties: {\n      key: {\n        type: \"string\",\n        description:\n          'The theme variable key to update (e.g., \"color-primary\").',\n      },\n      value: {\n        type: \"string\",\n        description: 'The new value to set for the key (e.g., \"#FF0000\").',\n      },\n    },\n    required: [\"key\", \"value\"],\n  },\n\n  handler: async (args: Record<string, unknown>) => {\n    const { key, value } = args as { key: string; value: string };\n\n    try {\n      // Read the theme file\n      let theme;\n      try {\n        const themeJsonContent = await fs.readFile(themeJsonPath, \"utf-8\");\n        theme = JSON.parse(themeJsonContent);\n      } catch (readError) {\n        return {\n          status: \"error\",\n          message: `‚ùå Failed to read theme file: ${\n            (readError as Error).message\n          }`,\n        };\n      }\n\n      // Allow any key - no validation constraints\n\n      // Update the value\n      theme[key] = value;\n\n      // Write the updated theme back to the file\n      await fs.writeFile(\n        themeJsonPath,\n        JSON.stringify(theme, null, 2),\n        \"utf-8\"\n      );\n\n      return {\n        status: \"success\",\n        message: `‚úÖ Theme updated successfully: Set \"${key}\" to \"${value}\". The UI will now reflect this change.`,\n      };\n    } catch (error) {\n      return {\n        status: \"error\",\n        message: `‚ùå An unexpected error occurred: ${(error as Error).message}`,\n      };\n    }\n  },\n};\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/typescriptInterpreter.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/tools/webScraper.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":1,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":2,"column":1,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":2,"endColumn":14,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[66,79],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an error typed value.","line":7,"column":7,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":10,"endColumn":3},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe construction of a(n) `error` type typed value.","line":7,"column":18,"nodeType":"NewExpression","messageId":"unsafeNew","endLine":10,"endColumn":3},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an error typed value.","line":25,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":25,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `error` type typed value.","line":25,"column":22,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":25,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .turndown on an `error` typed value.","line":25,"column":31,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":25,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an error typed value.","line":27,"column":41,"nodeType":"Property","messageId":"anyAssignment","endLine":27,"endColumn":49},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":28,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1186,1189],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1186,1189],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":29,"column":30,"nodeType":"Property","messageId":"anyAssignment","endLine":29,"endColumn":64},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":29,"column":42,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":29,"endColumn":49},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":31,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ url: string; timeoutMs?: number | undefined; }`.","line":40,"column":38,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":40,"endColumn":49},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":40,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1633,1636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1633,1636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":13,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// turndown has no bundled types in this project; silence TS here\n// @ts-ignore\nimport TurndownService from 'turndown';\nimport * as cheerio from 'cheerio';\nimport puppeteer from 'puppeteer';\n\nconst turndown = new TurndownService({\n  headingStyle: 'atx',\n  codeBlockStyle: 'fenced'\n});\n\nexport async function fetchPageAsMarkdown(args: { url: string, timeoutMs?: number }) {\n  const { url, timeoutMs = 30000 } = args;\n  const browser = await puppeteer.launch({ args: ['--no-sandbox', '--disable-setuid-sandbox'] });\n  try {\n    const page = await browser.newPage();\n    await page.setUserAgent('Mozilla/5.0 (compatible; Bot/1.0)');\n    await page.goto(url, { waitUntil: 'networkidle2', timeout: timeoutMs });\n    const html = await page.content();\n    const $ = cheerio.load(html);\n    const title = $('title').first().text() || '';\n    // Attempt to extract main article with common selectors\n    const mainHtml = $('article').html() || $('main').html() || $('body').html() || html;\n    // Convert to markdown\n    const markdown = turndown.turndown(mainHtml);\n    const text = $(mainHtml).text();\n    return { success: true, url, title, markdown, text, html: mainHtml };\n  } catch (err: any) {\n    return { success: false, error: err?.message || String(err) };\n  } finally {\n    try { await browser.close(); } catch (_) {}\n  }\n}\n\n// Tool wrapper compatible with AgentRuntime native tool registration\nexport const webScraperTool = {\n  name: 'research.web_scrape',\n  description: 'Fetch a URL and return extracted content as markdown and text',\n  handler: async (args: { url: string }) => {\n    return await fetchPageAsMarkdown(args as any);\n  },\n  input_schema: {\n    type: 'object',\n    properties: { url: { type: 'string' } },\n    required: ['url']\n  }\n};\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/trpc.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/types.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1046,1049],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1046,1049],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":13,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":16,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1134,1137],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1134,1137],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1349,1352],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1349,1352],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1373,1376],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1373,1376],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":43,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1389,1392],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1389,1392],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Represents a session token for the Virtual File System (VFS).\n * It's a string that uniquely identifies a user's VFS session.\n */\nexport type VfsSessionToken = string;\n\n/**\n * Represents an LLM provider configuration stored in the database.\n */\nexport interface Provider {\n  /** The unique identifier for the provider. */\n  id: string;\n  /** The display name of the provider. */\n  name: string;\n  /** The type of the provider (e.g., 'openai', 'mistral'). */\n  providerType: string;\n  /** The base URL for the provider's API. */\n  baseUrl: string;\n  /** The API key for the provider. This is encrypted in the database. */\n  apiKey: string;\n  /** A flag indicating if the provider is currently healthy and accessible. */\n  isHealthy: boolean;\n  /** The timestamp of the last health check. */\n  lastCheckedAt: Date | null;\n  /** The timestamp when the provider was created. */\n  createdAt: Date;\n  /** The timestamp when the provider was last updated. */\n  updatedAt: Date;\n  /** An array of models available from this provider. */\n  models: any[];\n}\n\nexport interface ProviderError extends Error {\n  status?: number;\n  headers?: any; // Using any for headers as they can be complex objects or Maps depending on the library\n  error?: { message: string };\n}\n\nexport interface SandboxTool {\n  name: string;\n  description?: string;\n  inputSchema?: any;\n  handler?: (args: any) => Promise<any>;\n}\n\n// Represents the state of a single Card's brain\nexport interface CardAgentState {\n  roleId: string;\n  modelId: string | null;\n  isLocked: boolean;\n  temperature: number;\n  maxTokens: number;\n  userGoal?: string; // Optional context for memory injection\n  projectPrompt?: string; // Optional project-specific system prompt\n  tools?: string[];\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/utils/AnthropicProvider.ts","messages":[{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'getModels' has no 'await' expression.","line":10,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":10,"endColumn":18,"suggestions":[{"messageId":"removeAsync","fix":{"range":[267,305],"text":"getModels(): LLMModel[]"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/require-await","severity":1,"message":"Async method 'generateCompletion' has no 'await' expression.","line":14,"column":3,"nodeType":"FunctionExpression","messageId":"missingAwait","endLine":14,"endColumn":27,"suggestions":[{"messageId":"removeAsync","fix":{"range":[376,445],"text":"generateCompletion(request: CompletionRequest): string"},"desc":"Remove 'async'."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'request' is defined but never used. Allowed unused args must match /^_/u.","line":14,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { BaseLLMProvider, CompletionRequest, LLMModel } from './BaseLLMProvider.js';\n\nexport class AnthropicProvider implements BaseLLMProvider {\n  id: string;\n\n  constructor(config: { id: string; apiKey: string; baseURL?: string }) {\n    this.id = config.id;\n  }\n\n  async getModels(): Promise<LLMModel[]> {\n    throw new Error(\"Anthropic getModels not implemented.\");\n  }\n\n  async generateCompletion(request: CompletionRequest): Promise<string> {\n    throw new Error(\"Anthropic generateCompletion not implemented.\");\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/utils/BaseLLMProvider.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/utils/GoogleGenAIProvider.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Part' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":50,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":54},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'collector' is defined but never used. Allowed unused args must match /^_/u.","line":23,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":30},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[907,910],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[907,910],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":32,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":32,"endColumn":91},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1249,1252],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1249,1252],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .models on an `any` value.","line":32,"column":40,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":32,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":34,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":47,"endColumn":10},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":34,"column":14,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":34,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .map on an `any` value.","line":34,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":34,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":34,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1336,1339],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1336,1339],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":36,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":36,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":36,"column":20,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":36,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":36,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":36,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":36,"column":51,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":36,"endColumn":63},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":36,"column":53,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":36,"endColumn":57},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":36,"column":71,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":36,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":39,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":39,"endColumn":17},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":40,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":40,"endColumn":36},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .displayName on an `any` value.","line":40,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":40,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":41,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":41,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .inputTokenLimit on an `any` value.","line":41,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":41,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":43,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":43,"endColumn":87},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":43,"column":19,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":43,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .includes on an `any` value.","line":43,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":43,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":43,"column":43,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":43,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .includes on an `any` value.","line":43,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":43,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":43,"column":65,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":43,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .includes on an `any` value.","line":43,"column":68,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":43,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":45,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":45,"endColumn":26},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2053,2056],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2053,2056],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":84,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":87,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2101,2104],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2101,2104],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2178,2181],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2178,2181],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":59,"column":51,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":59,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":61,"column":51,"nodeType":"MemberExpression","messageId":"unsafeReturn","endLine":61,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .content on an `any` value.","line":61,"column":53,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":61,"endColumn":60},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":68,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":68,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":70,"column":11,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":70,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .content on an `any` value.","line":70,"column":25,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":70,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":73,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":73,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":77,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":77,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":82,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":82,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":83,"column":19,"nodeType":"Property","messageId":"anyAssignment","endLine":83,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .thinkingConfig on an `any` value.","line":105,"column":32,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":105,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3955,3958],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3955,3958],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":105,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":105,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3742,3745],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3742,3745],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":44,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { GoogleGenAI, GenerateContentParameters, Part } from '@google/genai';\nimport { BaseLLMProvider, CompletionRequest, LLMModel } from './BaseLLMProvider.js';\n\nexport class GoogleGenAIProvider implements BaseLLMProvider {\n  id: string;\n  private client: GoogleGenAI;\n  private projectConfig: { projectId?: string, location?: string } = {};\n\n  constructor(config: { id: string; apiKey: string; baseURL?: string; projectId?: string; location?: string }) {\n    this.id = config.id;\n    \n    // Initialize the new unified client\n    this.client = new GoogleGenAI({\n      apiKey: config.apiKey, // Used for AI Studio / simplest API key auth\n      // The SDK automatically uses GOOGLE_CLOUD_PROJECT/LOCATION env vars if set,\n      // or falls back to API Key.\n    });\n\n    this.projectConfig.projectId = config.projectId;\n    this.projectConfig.location = config.location;\n  }\n\n  setUsageCollector(collector: any) {\n    // Implement if needed for sniffing headers (Google doesn't usually use headers)\n  }\n\n  async getModels(): Promise<LLMModel[]> {\n    try {\n      const response = await this.client.models.list();\n      \n      // Handle SDK response structure (it usually returns an object with a 'models' property)\n      const models = (response as any).models || (Array.isArray(response) ? response : []);\n\n      return models.map((m: any) => {\n        // Google model names are typically \"models/gemini-pro\". We strip the prefix for the ID.\n        const id = m.name.startsWith('models/') ? m.name.slice(7) : m.name;\n        \n        return {\n          id: id,\n          name: m.displayName || id,\n          contextWindow: m.inputTokenLimit || 32000,\n          // Simple heuristic for free tier, similar to how we handle other providers\n          isFree: id.includes('flash') || id.includes('exp') || id.includes('preview'), \n          providerId: this.id,\n          providerData: m\n        };\n      });\n    } catch (error) {\n      console.error(\"Failed to fetch Google models:\", error);\n      return [];\n    }\n  }\n\n  private formatMessages(messages: any[]): { systemInstruction?: string, contents: any[] } {\n    let systemInstruction: string | undefined;\n    const contents: any[] = [];\n\n    // 1. Extract System Prompt (if any)\n    const systemMessages = messages.filter(m => m.role === 'system');\n    if (systemMessages.length > 0) {\n      systemInstruction = systemMessages.map(m => m.content).join('\\n');\n    }\n\n    // 2. Format User/Assistant Messages\n    let isFirstUserMessage = true;\n    \n    for (const msg of messages) {\n      if (msg.role === 'system') continue; // Handled above\n\n      let content = msg.content;\n      \n      // Merge system prompt into first user message\n      if (isFirstUserMessage && msg.role === 'user' && systemInstruction) {\n        content = `${systemInstruction}\\n\\n${content}`;\n        systemInstruction = undefined; // Clear it so we don't use it again\n        isFirstUserMessage = false;\n      } else if (msg.role === 'user') {\n        isFirstUserMessage = false;\n      }\n\n      contents.push({\n        role: msg.role === 'assistant' ? 'model' : 'user',\n        parts: [{ text: content }]\n      });\n    }\n    \n    return { contents };\n  }\n\n  async generateCompletion(request: CompletionRequest): Promise<string> {\n    const { contents } = this.formatMessages(request.messages);\n\n    const params: GenerateContentParameters = { \n      model: request.modelId,\n      contents: contents,\n      config: {\n        temperature: request.temperature,\n        maxOutputTokens: request.max_tokens,\n      },\n    };\n\n    // ANTIGRAVITY: Enable Thinking for Gemini 3\n    if (request.modelId.includes('gemini-3')) {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        (params.config as any).thinkingConfig = {\n            thinkingLevel: \"high\"\n        };\n    }\n\n    try {\n      const response = await this.client.models.generateContent(params);\n      return response.text || \"\";\n    } catch (error: any) {\n      console.error(\"GoogleGenAIProvider Error:\", error);\n      throw error;\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/utils/MistralProvider.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `RequestInit | undefined`.","line":21,"column":62,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":27,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[914,917],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[914,917],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":33,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":33,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":35,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":42,"endColumn":11},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":35,"column":14,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":35,"endColumn":27},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .data on an `any` value.","line":35,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":35,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1112,1115],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1112,1115],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":36,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":36,"endColumn":17},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":36,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":36,"endColumn":17},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":38,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":38,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .context_window on an `any` value.","line":38,"column":26,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":38,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":40,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":40,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":40,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":40,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":41,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":41,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `RequestInit | undefined`.","line":54,"column":72,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":68,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":68,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2180,2183],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2180,2183],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":78,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":78,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":82,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":82,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":83,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":83,"endColumn":54},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .choices on an `any` value.","line":83,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":83,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":20,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { HttpsProxyAgent } from 'https-proxy-agent';\nimport { BaseLLMProvider, CompletionRequest, LLMModel } from './BaseLLMProvider.js';\nimport { UsageCollector } from '../services/UsageCollector.js';\n\nexport class MistralProvider implements BaseLLMProvider {\n  id: string;\n  private apiKey: string;\n  private baseUrl: string;\n\n  constructor(config: { id: string; apiKey: string; baseURL?: string }) {\n    this.id = config.id;\n    this.apiKey = config.apiKey;\n    this.baseUrl = config.baseURL || 'https://api.mistral.ai/v1';\n  }\n\n  async getModels(): Promise<LLMModel[]> {\n    try {\n      const proxy = process.env.HTTPS_PROXY;\n      const agent = proxy ? new HttpsProxyAgent(proxy) : undefined;\n\n      const response = await fetch(`${this.baseUrl}/models`, {\n        agent,\n        headers: {\n          'Authorization': `Bearer ${this.apiKey}`,\n          'Content-Type': 'application/json'\n        }\n      } as any);\n      \n      if (!response.ok) {\n        throw new Error(`Mistral API error: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      \n      return data.data.map((m: any) => ({\n        id: m.id,\n        providerId: this.id,\n        contextWindow: m.context_window || 32000, // Mistral default\n        isFree: false, // Mistral API is generally paid, but we can check if they add pricing fields\n        name: m.id,\n        providerData: m\n      }));\n    } catch (error) {\n      console.error(\"Failed to fetch Mistral models:\", error);\n      return [];\n    }\n  }\n\n  async generateCompletion(request: CompletionRequest): Promise<string> {\n    try {\n      const proxy = process.env.HTTPS_PROXY;\n      const agent = proxy ? new HttpsProxyAgent(proxy) : undefined;\n\n      const response = await fetch(`${this.baseUrl}/chat/completions`, {\n        method: 'POST',\n        agent,\n        headers: {\n          'Authorization': `Bearer ${this.apiKey}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          model: request.modelId,\n          messages: request.messages,\n          temperature: request.temperature,\n          max_tokens: request.max_tokens,\n          stream: false\n        })\n      } as any);\n\n      // Extract headers for rate limiting\n      const headers: Record<string, string> = {};\n      response.headers.forEach((value, key) => {\n        headers[key.toLowerCase()] = value;\n      });\n      await UsageCollector.updateDynamicLimits(this.id, headers);\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(`Mistral API error: ${JSON.stringify(errorData)}`);\n      }\n\n      const data = await response.json();\n      return data.choices[0]?.message?.content || '';\n    } catch (error) {\n      console.error(\"Mistral generation failed:\", error);\n      throw error;\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/utils/OllamaProvider.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[660,663],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[660,663],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":25,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":25,"endColumn":49},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .models on an `any` value.","line":25,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":25,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":26,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":34,"endColumn":11},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":26,"column":14,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":26,"endColumn":24},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .map on an `any` value.","line":26,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":26,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":26,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":26,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[867,870],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[867,870],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":27,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":27,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":27,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":27,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":28,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":28,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":28,"column":15,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":28,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .name on an `any` value.","line":28,"column":18,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":28,"endColumn":22},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .replace on an `any` value.","line":28,"column":30,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":28,"endColumn":37},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":30,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":30,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .details on an `any` value.","line":30,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":30,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":31,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":31,"endColumn":50},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .details on an `any` value.","line":31,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":31,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":33,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":33,"endColumn":24},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":35,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1140,1143],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1140,1143],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":36,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":36,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":36,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":36,"endColumn":29},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":53,"column":5,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":53,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .response on an `any` value.","line":53,"column":23,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":53,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":62,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":62,"endColumn":38},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .embedding on an `any` value.","line":62,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":62,"endColumn":37},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":63,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2149,2152],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2149,2152],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":64,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":64,"endColumn":48},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":64,"column":22,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":64,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":28,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import axios from 'axios';\nimport { BaseLLMProvider, CompletionRequest, LLMModel } from './BaseLLMProvider.js';\n\n/**\n * OllamaProvider - Minimal provider for local Ollama servers.\n * Notes:\n * - Uses Ollama native endpoints: /api/tags and /api/generate\n * - Expects baseURL like http://<host>:11434/\n */\nexport class OllamaProvider implements BaseLLMProvider {\n  id: string;\n  private baseURL: string;\n\n  constructor(config: { id?: string; apiKey?: string; baseURL: string }) {\n    this.id = config.id || 'ollama';\n    this.baseURL = config.baseURL.endsWith('/') ? config.baseURL : config.baseURL + '/';\n  }\n\n  // no-op for now\n  setUsageCollector(_collector: any) {}\n\n  async getModels(): Promise<LLMModel[]> {\n    try {\n      const response = await axios.get(this.baseURL + 'api/tags');\n      const models = response.data?.models || [];\n      return models.map((m: any) => ({\n        id: m.name,\n        name: (m.name || '').replace(':latest', ''),\n        providerId: this.id,\n        family: m.details?.family,\n        parameter_size: m.details?.parameter_size,\n        isFree: true,\n        providerData: m,\n      }));\n    } catch (e: any) {\n      const msg = e?.message || 'unknown error';\n      throw new Error(`Ollama connection failed at ${this.baseURL}. Ensure Ollama is running and reachable. Error: ${msg}`);\n    }\n  }\n\n  async generateCompletion(request: CompletionRequest): Promise<string> {\n    const userMessage = request.messages?.[request.messages.length - 1]?.content || '';\n    const resp = await axios.post(this.baseURL + 'api/generate', {\n      model: request.modelId,\n      prompt: userMessage,\n      options: {\n        temperature: request.temperature,\n        num_ctx: request.max_tokens,\n      },\n      stream: false,\n    });\n    // Non-streaming response has { response: string, done: boolean }\n    return resp.data?.response || '';\n  }\n\n  async generateEmbedding(text: string, model: string = 'mxbai-embed-large'): Promise<number[]> {\n    try {\n      const response = await axios.post(this.baseURL + 'api/embeddings', {\n        model,\n        prompt: text,\n      });\n      return response.data.embedding;\n    } catch (e: any) {\n      const msg = e?.message || 'unknown error';\n      throw new Error(`Ollama embedding failed at ${this.baseURL}. Error: ${msg}`);\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/utils/OpenAIProvider.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":1,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":2,"column":1,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":2,"endColumn":14,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[53,66],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `ClientOptions | undefined`.","line":16,"column":30,"nodeType":"TSAsExpression","messageId":"unsafeArgument","endLine":21,"endColumn":13},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[717,720],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[717,720],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any[]`.","line":27,"column":9,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":38,"endColumn":12},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":27,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[868,871],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[868,871],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .pricing on an `any` value.","line":30,"column":19,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":30,"endColumn":26},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":31,"column":43,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":31,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .pricing on an `any` value.","line":31,"column":45,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":31,"endColumn":52},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":32,"column":47,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":32,"endColumn":67},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .pricing on an `any` value.","line":32,"column":49,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":32,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":37,"column":13,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":37,"endColumn":85},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":37,"column":22,"nodeType":"Property","messageId":"anyAssignment","endLine":37,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .id on an `any` value.","line":37,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":37,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":37,"column":61,"nodeType":"Property","messageId":"anyAssignment","endLine":37,"endColumn":76},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":56,"column":9,"nodeType":"Property","messageId":"anyAssignment","endLine":56,"endColumn":42},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1951,1954],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1951,1954],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":70,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":70,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":71,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":71,"endColumn":62},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .choices on an `any` value.","line":71,"column":28,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":71,"endColumn":35},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":77,"column":7,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":77,"endColumn":22},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":78,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":78,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2611,2614],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2611,2614],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":80,"column":13,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":80,"endColumn":82},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .message on an `any` value.","line":80,"column":34,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":80,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .error on an `any` value.","line":80,"column":51,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":80,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-call","severity":1,"message":"Unsafe call of a(n) `any` typed value.","line":81,"column":11,"nodeType":"MemberExpression","messageId":"unsafeCall","endLine":81,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .includes on an `any` value.","line":81,"column":24,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":81,"endColumn":32},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":89,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":89,"endColumn":42},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":89,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":89,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3234,3237],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3234,3237],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":94,"column":15,"nodeType":"VariableDeclarator","messageId":"anyAssignment","endLine":94,"endColumn":43},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":95,"column":9,"nodeType":"ReturnStatement","messageId":"unsafeReturn","endLine":95,"endColumn":56},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .choices on an `any` value.","line":95,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":95,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":101,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3535,3538],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3535,3538],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":101,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3543,3546],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3543,3546],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":102,"column":51,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":102,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-return","severity":1,"message":"Unsafe return of a value of type `any`.","line":105,"column":50,"nodeType":"MemberExpression","messageId":"unsafeReturn","endLine":105,"endColumn":59},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .content on an `any` value.","line":105,"column":52,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":105,"endColumn":59},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3771,3774],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3771,3774],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":110,"column":15,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":110,"endColumn":19},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":112,"column":37,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":112,"endColumn":41},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .content on an `any` value.","line":115,"column":46,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":115,"endColumn":53},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .role on an `any` value.","line":120,"column":17,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":120,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":41,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { HttpsProxyAgent } from 'https-proxy-agent';\n// @ts-ignore\nimport { OpenAI } from 'openai';\nimport { BaseLLMProvider, CompletionRequest, LLMModel } from './BaseLLMProvider.js';\nimport { UsageCollector } from '../services/UsageCollector.js';\n\nexport class OpenAIProvider implements BaseLLMProvider {\n  id: string;\n  private client: OpenAI;\n\n  constructor(config: { id: string; apiKey: string; baseURL?: string }) {\n    this.id = config.id;\n    const proxy = process.env.HTTPS_PROXY;\n    const agent = proxy ? new HttpsProxyAgent(proxy) : undefined;\n\n    this.client = new OpenAI({\n      apiKey: config.apiKey,\n      baseURL: config.baseURL,\n      timeout: 60000, // 60 seconds\n      httpAgent: agent,\n    } as any);\n  }\n\n  async getModels(): Promise<LLMModel[]> {\n    try {\n        const list = await this.client.models.list();\n        return list.data.map((m: any) => {\n            // OpenRouter specific: Check pricing\n            let isFree = false;\n            if (m.pricing) {\n                const prompt = parseFloat(m.pricing.prompt);\n                const completion = parseFloat(m.pricing.completion);\n                if (prompt === 0 && completion === 0) {\n                    isFree = true;\n                }\n            }\n            return { id: m.id, providerId: this.id, isFree, providerData: m, ...m };\n        });\n    } catch (e) {\n        console.error(\"Failed to fetch OpenAI models\", e);\n        return [];\n    }\n  }\n\n  async generateCompletion(request: CompletionRequest): Promise<string> {\n    // Validate model ID is provided\n    if (!request.modelId || request.modelId.trim() === '') {\n      throw new Error(`OpenAIProvider: modelId is required but got: \"${request.modelId}\"`);\n    }\n\n    console.log(`[OpenAIProvider] Calling API with model: \"${request.modelId}\"`);\n    \n    try {\n      const response = await this.client.chat.completions.create({\n        model: request.modelId,\n        messages: request.messages as any,\n        temperature: request.temperature,\n        max_tokens: request.max_tokens,\n      }).asResponse();\n\n      // Extract headers\n      const headers: Record<string, string> = {};\n      response.headers.forEach((value, key) => {\n        headers[key.toLowerCase()] = value;\n      });\n\n      // Update dynamic limits\n      await UsageCollector.updateDynamicLimits(this.id, headers);\n      \n      const json = await response.json();\n      const content = json.choices[0]?.message?.content || '';\n      \n      if (!content) {\n        console.warn('[OpenAIProvider] Empty response from model:', json);\n      }\n      \n      return content;\n    } catch (error: any) {\n      // FIX: Handle Google models on OpenRouter rejecting system prompts\n      const errorMessage = error.message || error.error?.message || String(error);\n      if (errorMessage.includes(\"Developer instruction is not enabled\")) {\n        console.warn(`[OpenAIProvider] Model rejected system prompt. Retrying with merged prompt...`);\n        \n        // Merge system prompt into user message\n        const mergedMessages = this.mergeSystemPrompt(request.messages);\n        \n        const response = await this.client.chat.completions.create({\n          model: request.modelId,\n          messages: mergedMessages as any,\n          temperature: request.temperature,\n          max_tokens: request.max_tokens,\n        }).asResponse();\n        \n        const json = await response.json();\n        return json.choices[0]?.message?.content || '';\n      }\n      throw error;\n    }\n  }\n\n  private mergeSystemPrompt(messages: any[]): any[] {\n    const systemMessages = messages.filter(m => m.role === 'system');\n    if (systemMessages.length === 0) return messages;\n\n    const systemPrompt = systemMessages.map(m => m.content).join('\\n');\n    const newMessages: any[] = [];\n    let isFirstUserMessage = true;\n\n    for (const msg of messages) {\n      if (msg.role === 'system') continue;\n      \n      if (isFirstUserMessage && msg.role === 'user') {\n        newMessages.push({\n          role: 'user',\n          content: `${systemPrompt}\\n\\n${msg.content}`\n        });\n        isFirstUserMessage = false;\n      } else {\n        newMessages.push(msg);\n        if (msg.role === 'user') isFirstUserMessage = false;\n      }\n    }\n    return newMessages;\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/utils/ProviderFactory.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":13,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":13,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[465,468],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[465,468],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .baseURL on an `any` value.","line":14,"column":68,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":14,"endColumn":75},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ id: string; apiKey: string; baseURL?: string | undefined; }`.","line":19,"column":36,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":19,"endColumn":42},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ id: string; apiKey: string; baseURL?: string | undefined; }`.","line":21,"column":38,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":21,"endColumn":44},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ id: string; apiKey: string; baseURL?: string | undefined; projectId?: string | undefined; location?: string | undefined; }`.","line":26,"column":40,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":26,"endColumn":46},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ id: string; apiKey: string; baseURL?: string | undefined; }`.","line":36,"column":35,"nodeType":"ObjectExpression","messageId":"unsafeArgument","endLine":41,"endColumn":10},{"ruleId":"@typescript-eslint/no-unsafe-assignment","severity":1,"message":"Unsafe assignment of an `any` value.","line":40,"column":11,"nodeType":"Property","messageId":"anyAssignment","endLine":40,"endColumn":66},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .baseURL on an `any` value.","line":40,"column":27,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":40,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-member-access","severity":1,"message":"Unsafe member access .baseURL on an `any` value.","line":44,"column":21,"nodeType":"Identifier","messageId":"unsafeMemberExpression","endLine":44,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `{ id?: string | undefined; apiKey?: string | undefined; baseURL: string; }`.","line":45,"column":35,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":45,"endColumn":41}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { BaseLLMProvider } from './BaseLLMProvider.js';\nimport { OpenAIProvider } from './OpenAIProvider.js';\nimport { AnthropicProvider } from './AnthropicProvider.js';\nimport { GoogleGenAIProvider } from './GoogleGenAIProvider.js';\nimport { OllamaProvider } from './OllamaProvider.js';\nimport { MistralProvider } from './MistralProvider.js';\n\nexport * from './BaseLLMProvider.js';\n\n\nexport class ProviderFactory {\n  \n  static createProvider(type: string, config: any): BaseLLMProvider {\n    console.log(`[ProviderFactory] Initializing: ${type} (${config.baseURL || 'default url'})`);\n\n    switch (type) {\n      // --- GROUP 1: NATIVE PROVIDERS ---\n      case 'mistral':\n        return new MistralProvider(config);\n      case 'anthropic':\n        return new AnthropicProvider(config);\n        \n      case 'google': // Gemini Developer API (AI Studio)\n      case 'vertex': // Google Vertex AI (Enterprise)\n      case 'vertex-studio': // Legacy handling\n        return new GoogleGenAIProvider(config);\n\n      // --- GROUP 2: OPENAI COMPATIBLE (The \"Universal\" Group) ---\n      // The UI sends these specific names, but they all speak \"OpenAI\"\n      case 'openai':\n      case 'openrouter':\n      case 'mistral':\n      case 'groq':\n      case 'deepseek':\n      case 'generic-openai': // For custom endpoints\n        return new OpenAIProvider({\n          ...config,\n          // 1. Trust the Base URL from the Database (which came from UI)\n          // 2. Fallback to defaults ONLY if DB is empty\n          baseURL: config.baseURL || this.getDefaultBaseURL(type)\n        });\n\n      case 'ollama':\n        if (!config.baseURL) throw new Error('Ollama requires a baseURL accessible from the API runtime.');\n        return new OllamaProvider(config);\n\n      default:\n        throw new Error(`Provider type '${type}' is not supported yet.`);\n    }\n  }\n\n  // Helper to keep the switch clean\n  private static getDefaultBaseURL(type: string): string | undefined {\n    switch (type) {\n      case 'openrouter': return 'https://openrouter.ai/api/v1';\n      case 'mistral':    return 'https://api.mistral.ai/v1';\n      case 'groq':       return 'https://api.groq.com/openai/v1';\n      default:           return undefined; // Let SDK default to api.openai.com\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/utils/encryption.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/src/utils/healthCheck.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/sync_registry.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/sync_registry.ts","messages":[{"ruleId":"@typescript-eslint/ban-ts-comment","severity":1,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":25,"column":3,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":25,"endColumn":16,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[743,756],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as dotenv from 'dotenv';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\n// Load env vars BEFORE importing db\ndotenv.config({ path: path.resolve(__dirname, '../../.env.local') });\n\nasync function main() {\n  // Dynamic imports to ensure env vars are loaded\n  const { ProviderManager } = await import('./src/services/ProviderManager.js');\n  const { db } = await import('./src/db.js');\n\n  console.log('Initializing ProviderManager...');\n  await ProviderManager.initialize();\n  \n  console.log('Syncing models to registry...');\n  await ProviderManager.syncModelsToRegistry();\n  \n  console.log('Done.');\n  \n  // Close the pool\n  // @ts-ignore\n  await db.$client.end(); \n}\n\nmain().catch(console.error);\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/test-corporate-recruiter.ts","messages":[{"ruleId":"@typescript-eslint/no-floating-promises","severity":1,"message":"Promises must be awaited, end with a call to .catch, end with a call to .then with a rejection handler or be explicitly marked as ignored with the `void` operator.","line":83,"column":1,"nodeType":"ExpressionStatement","messageId":"floatingVoid","endLine":83,"endColumn":8,"suggestions":[{"messageId":"floatingFixVoid","fix":{"range":[2621,2621],"text":"void "},"desc":"Add void operator to ignore."},{"messageId":"floatingFixAwait","fix":{"range":[2621,2621],"text":"await "},"desc":"Add await operator."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"#!/usr/bin/env node\n/**\n * Test script for the Corporate Recruiter (onboardProject)\n * \n * This script demonstrates how the Corporate Recruiter scans a project,\n * identifies departments based on package.json dependencies, and creates\n * specialized roles with tech-stack-specific prompts.\n */\n\nimport { PrismaClient } from '@prisma/client';\nimport { onboardProject } from './src/services/RoleIngestionService.js';\nimport * as path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nconst prisma = new PrismaClient();\n\nasync function main() {\n  console.log('üöÄ Corporate Recruiter Test\\n');\n  console.log('This will scan the monorepo and automatically create roles based on detected tech stacks.\\n');\n\n  // Use the monorepo root as the target\n  const rootPath = path.join(__dirname, '../..');\n  \n  console.log(`Target directory: ${rootPath}\\n`);\n  console.log('‚îÄ'.repeat(80));\n  \n  try {\n    const stats = await onboardProject(rootPath, prisma);\n    \n    console.log('\\n' + '‚îÄ'.repeat(80));\n    console.log('\\nüìà Final Results:');\n    console.log(`   ‚úì Package.json files scanned: ${stats.scanned}`);\n    console.log(`   ‚úì Departments identified: ${stats.departments}`);\n    console.log(`   ‚úì Roles created: ${stats.rolesCreated}`);\n    console.log(`   ‚úì Roles updated: ${stats.rolesUpdated}`);\n    \n    if (stats.errors.length > 0) {\n      console.log(`\\n‚ö†Ô∏è  Errors encountered: ${stats.errors.length}`);\n      stats.errors.forEach((err, i) => {\n        console.log(`   ${i + 1}. ${err}`);\n      });\n    }\n    \n    // Display the created roles\n    console.log('\\nüìã Checking created roles...\\n');\n    const roles = await prisma.role.findMany({\n      where: {\n        OR: [\n          { name: 'Frontend Lead' },\n          { name: 'Backend Architect' },\n        ],\n      },\n      include: {\n        category: true,\n      },\n    });\n    \n    for (const role of roles) {\n      console.log(`\\nüé≠ Role: ${role.name}`);\n      console.log(`   Category: ${role.category?.name || 'N/A'}`);\n      console.log(`   Tools: ${role.tools.join(', ')}`);\n      console.log(`   Description: ${role.description || 'N/A'}`);\n      \n      // Show a snippet of the system prompt\n      const promptSnippet = role.basePrompt.substring(0, 200);\n      console.log(`   System Prompt (first 200 chars):`);\n      console.log(`   ${promptSnippet}...`);\n    }\n    \n    console.log('\\n‚úÖ Test complete!\\n');\n    \n  } catch (error) {\n    console.error('\\n‚ùå Error during test:', error);\n    process.exit(1);\n  } finally {\n    await prisma.$disconnect();\n  }\n}\n\nmain();\n","usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/test-model-json.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/test-model-json.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/tests/manual/check_prompt_engineer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/tests/manual/simple-groq-check.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/tests/manual/smoke-context.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/tests/manual/test-doctor-health.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/tests/manual/test-embedding.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/tests/manual/test_prompt_gen.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/vitest.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"/home/guy/mono/apps/api/vitest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
