# Database Architecture Cleanup Plan

## Current Situation
- **Active**: SimpleDB (JSON file-based) in `apps/api/src/db.ts`
- **Zombie**: Multiple PrismaClient instances scattered across services

## Files Using Prisma (RESIDUAL - NOT CONNECTED TO MAIN APP):

### 1. `apps/api/src/services/modelManager.service.ts`
- **Status**: Creates own `PrismaClient` instance
- **Issue**: Not used by any router
- **Action**: DELETE or refactor to use SimpleDB

### 2. `apps/api/src/services/dataRefinement.service.ts`
- **Status**: Creates own `PrismaClient` instance  
- **Issue**: Not imported/used anywhere
- **Action**: DELETE (functionality moved to `dataRefinement.router.ts`)

### 3. Type Declaration Files (`.d.ts`)
- **Status**: Generated by TypeScript, reference Prisma types
- **Issue**: Misleading - suggest Prisma is used when it's not
- **Action**: Will auto-update when we remove Prisma imports

## Recommended Actions:

### Option A: Full SimpleDB (Current Path)
1. ✅ Keep `db.ts` (SimpleDB) as-is
2. ❌ DELETE `apps/api/src/services/modelManager.service.ts`
3. ❌ DELETE `apps/api/src/services/dataRefinement.service.ts`
4. ✅ Keep using SimpleDB in all routers
5. ⚠️ SQL transformations won't work (need real DB)

### Option B: Switch to Prisma + Postgres
1. ❌ Remove SimpleDB from `db.ts`
2. ✅ Replace with: `export const db = new PrismaClient()`
3. ✅ Start Postgres: `docker-compose -f docker-compose.db.yml up -d`
4. ✅ Run migrations: `npx prisma migrate dev`
5. ✅ Enable SQL transformations in DataNode
6. ✅ Use `db.$queryRawUnsafe()` for dynamic tables

## Current Dependencies Using Each:

### SimpleDB Users:
- `routers/providers.router.ts` → `ctx.db.providerConfig`
- `routers/dataRefinement.router.ts` → `ctx.db.data.rawDataLake`
- `services/ProviderManager.ts` → Indirectly via routers

### Prisma Users (Zombie):
- `services/modelManager.service.ts` → Own instance, not exported
- `services/dataRefinement.service.ts` → Own instance, not imported

## Recommendation:
**Go with Option B** - You already have Postgres configured and the infrastructure is there. 
The SimpleDB is limiting your DataNode's SQL transformation capabilities.
